   COMMENT &

                              ÚÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂ¿
                              ÃÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅ´
                              ÃÅÅÅÅÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÅÅÅÅ´
                              ÃÅÅÅ´ .NET/dotNET virus ÃÅÅÅ´
                              ÃÅÅÅ´    by Benny/29A   ÃÅÅÅ´
                              ÃÅÅÅÅÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÂÅÅÅÅ´
                              ÃÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅÅ´
                              ÀÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÁÙ


   Hello reader,

   lemme introduce you my first Windows virus for .NET CLR architecture!
   For next informationz read my article "Microsoft .NET Common Language
   Runtime Overview.

   .
   Everything began when I started to explore the .NET Common Language Runtime
   platform, designed by Microsoft. I wrote an article about it and started to
   work on one very trivial virus that could show how to use class librariez.
   Everything in C#.
   The idea was very simple - create sample of prepender written in C#. How easy
   it sounded, so hard to code it was. C#, such like Java have VERY STRICT type
   checking. And I figured out that there's NO easy way how to work with
   stringz - once a string is defined, you CAN'T change it - and I needed to
   do that, becoz it was very important for viral functionality.

   That sucked. I decided to forget that and go to my favourite techno-pub, talk
   with some friendz and get some weed, becoz I hadn't smoked for long time.
   Well, one my friend that I hadn't seen for a half a year brought me some very
   good skunk....
   when I came home, I couldn't sleep, even it was after midnight. I was very
   tired, but becoz of that weed, 2 litres of Coke inside my stomach and
   unfinished C# virus it was unable for me to fall alseep. Then I saw the
   CLEAR light...for a few secondz I watched only that but then I saw whole MSIL PE
   structure and there my virus how fits there. It was wonderful idea how to
   modify PE structure and CLR header and keep it working, together with virus.
   And that time everything began..
   For curious ppl I can say that after that I stayed awake for next two and half
   of hour :-) Heh, Paul McCartney composed Yesterday song while he was sleeping,
   so why shouldn't I get some kewl idea in the bed too? <BP>
   .

   But now let's talk about more technical thingz - the virus itself. The 95
   percentz of whole virus is written in win32 assembler, the rest is in MSIL.
   How the virus worx? Virus can work only with some specific MSIL PE filez, mostly
   generated by C# compiler. The virus aint complex much, but it shows some very
   interesting thingz that can be done in .NET environment.

   So, how does it can infect MSIL PE filez?
   Virus enlargez the (last) relocation section and copiez its body there. Then
   it locatez CLR header, save host's metadata and overwritez them by viral
   metadata. The virus also uses EPO (EntryPoint Obscuring) for setting entrypoint
   - it overwritez CLR dispatcher by JMP <virus> code and removez CLR descriptor.
   After execution such infected file the virus code instead of CLR dispatcher
   is called. Virus, after it finishes all needed actionz, repairz CLR descriptor
   and executez the file - by this the viral metadata are executed. And in the
   3rd stage the virus also repairz CLR descriptor and JMP <dispatcher> so
   original (host's) metadata are executed. Easy and effective ;-)


   Here follows the algorithm:

   <main>
   01) initialization - SEH frame, delta offset, K32 base, API addresses
   02) infect all filez in current directory               *1*
   03) infect so up to 20 directoriez by .. (dotdot) method.
   04) create "drive:\path\hostfile .exe"
   05) correct CLR descriptor field in data directory in PE header
   06) save the file and execute it (viral metadata is activated)  *2*
   07) wait for its termination
   08) restore JMP DWORD PTR [dispatcher_entry] and CLR descriptor
   09) create command line, save the file and execute it (host is activated)
   10) wait for hosts termination and delete temporarz file ("hostfile .exe")
   11) terminate viral process

   <*1* - infection stage>
   01) open the file (and enlarge it)
   02) check PE header
   03) erase base relocation record
   04) check CLR header and structure
   05) locate entrypoint and create JMP <virus>
   06) save hosts metadata and copy there viral metadata
   07) correct PE header and calculate new checksum
   08) close file and quit

   <*2* - viral metadata>
   01) create new instance of System.Random class
   02) call its constructor - System.Random::.ctor()
   02) get random number (System.Random.Next())
   03) 1:10 that virus will show Windows message box - payload


   As you can see, my vision wasn't to code some super-spreading virus, but
   only to show how it is possible to infect .NET applicationz - changing
   PE structure, CLR header structure, implanting viral metadata etc...
   The virus also ain't optimized much, becoz I wanted to have the source
   readable also for not skilled coderz.

   NOTE: if you will try to execute 1st generation code, the system loader
   should 2 timez report errorz with loading - virus triez to execute those
   2 repaired filez. Becoz there ain't any CLR header inside 1st generation
   code, loader won't be able to load it. But for creating copiez of my
   virus it ain't serious problem - virus can infect filez and since 2nd
   generation it worx properly.
   It is possible that virus containz some minor bugz (I have only 1 machine
   with .NET architecture), but it shouldn't be anything that would cause
   problemz with infection.


   Well, I hope you will like my code. If you will have any commentz and/or
   suggestionz, feel free to contact me.



           ....................................................
           .           Benny / 29A
           .           benny@post.cz
           .           http://benny29a.cjb.net
           .
           ... perfectionist, maximalist, idealist, dreamer ...
