			 NPE32 v. 1.00 (c) necr0mancer
			 ------------------------------


I present to you my first creation from polymorphic area - NPE32.
It is polymorphic engine which crypt the data and creating decryptor under 
these data (for example, code of a virus).In decryptor it can use all registers 
except  ESP (beakose algorithm is push/pop type) and about 10 commands for 
crypting ( ADD, SUB, INC, DEC, XOR...).Also  garbage is generates.
The principle of work decryptor is those (Kaspersky is see):

		....
		 Call d
	 D:
		 Pop _random_delta_ reg
		 Sub _random_delta_reg, xxxxx
		...
		 Lea _random_reg32, [_ random_delta_reg + xxxxx]       ; xxxxx-displacement
								       ; of crypted code
		 Xchg _one_some_rand_reg, esp
		....
		 Mov _index_reg, crypted_code_size
		....
		 Pop reg1
		...
		 Pop reg2
		...
		 Pop regN

		...... 			; let's transform a code
		 Push regN
		...
		...
		...

		 Jmp kakayato _ huynya 			; loop-alike
		...

		 Xchg _one_some_rand_reg, esp
		...

Xxxxx: 		 Mov eax, 12345678h 			; actually code
		 Ret

Of course,uses garbage between command of decryptor.

THE DESCRIPTION of WORK:
~~~~~~~~~~~~~~~~~~~~~~~ 		
On an input npe receives of the following kind parameters (I bring the 
description):

Stdcall
Int NPE _ main (
               DWORD *offset data // pointer on the necessary code
               DWORD *offset bufer // pointer on the buffer
               DWORD count _ bytes // the size of a code
               DWORD seed // seed
               DWORD flags // flags
           );

The buffer is used during its work  (particularly engine use 3 kb;)) so, 
that to allocate it is more memory, than it is necessary on 3-4 kb.
At the first start, it is necessary to place in parameter seed number
for initialization of RANDOMIZER (use standard method).In future this 
parameter must be 0.
The work NPE drives by flags, the format them is those:


				=Flags=
         bits:
        ÚÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
        ³  0..6   ³ Using regs32                          ³
        ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
        ³  7      ³ Antidebug functions enabled           ³
        ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
        ³  8..11  ³ number of commands in using commands  ³
        ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
        ³  11..16 ³ number of commands in using garbage   ³
        ÀÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Comment.
   	 Count of used registers should be a minimum 3.


 	  Regs32 (bits 0..6):
        ÚÄÄÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄ¿
        ³ bit ³ 0 ³ 1 ³ 2 ³ 3 ³ 4 ³ 5 ³ 6 ³
        ÃÄÄÄÄÄÅÄÄÄÅÄÄÄÅÄÄÄÅÄÄÄÅÄÄÄÅÄÄÄÅÄÄÄ´
        ³ reg ³EAX³EBX³EDX³ECX³ESI³EDI³EBP³
        ÀÄÄÄÄÄÁÄÄÄÁÄÄÄÁÄÄÄÁÄÄÄÁÄÄÄÁÄÄÄÁÄÄÄÙ

The flags is useful in case of presence of desire for long-time exploring PE.
And virus would disasmed & it's possible also disasmed Engine.
The focus consists in CPUID command, which as it is known is unique for each 
computer. Therefore at identical flags will be use one commands and registers
(but it does not mean, that commands be in one sequence).
Heh, method in 1000 samples & analysis it not correct ,AVERs ;).
The diagnosis - total disasm & patch virii-code(but it is time...) or
reverse on random value (I use simple congruent method...so it possible).
During work engine creates cryptor & crypt by it the data/code. 
Then on a basis of it create decryptor and write in all-decryptor.    
On an output of NPE in eax we have the size of (genned decryptor+size_of_the_data).

CF = 1, if there was a mistake, differently cf = 0.

NOTE:
~~~~
MMg..I know one 'cool' bug in engine that generate a wrong decryptor(in many-layer mode).
But I can find it and know that it is possible problem with many-layers use
in which decryptor more than 3 kb.

P.S.

Do not use NPE32 in viruses!!! This is unlawful! And in general
I recommend to apply it for crypting tetris' section .debug.:)


							 (C) necr0mancer 2001
                            			  necr0mancer2001@hotmail.com