define("io.ox/core/desktop",["io.ox/core/event","io.ox/core/extensions","io.ox/core/extPatterns/links","io.ox/core/cache","io.ox/core/notifications","io.ox/core/upsell","io.ox/core/adaptiveLoader","io.ox/core/folder/api","settings!io.ox/core","gettext!io.ox/core"],function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=null,l=0,m=new d.SimpleCache("app-cache",!0);ox.ui.apps=new Backbone.Collection;var n=Backbone.Model.extend({defaults:{title:""},initialize:function(a){var b=this;this.guid=l++,this.id=this.id||"app-"+l,this.options=a||{},this.getInstance=function(){return b}},getName:function(){return this.get("name")},setTitle:function(a){return this.set("title",a),this},getTitle:function(){return this.get("title")},saveRestorePoint:$.noop,call:$.noop});ox.ui.AppPlaceholder=n.extend({initialize:function(){n.prototype.initialize.apply(this,arguments)},launch:function(){var a=this,b=(this.get("name")||this.id)+"/main",c=this.get("requires");if(f.has(c)){var d=$.Deferred();return ox.launch(b,{launched:d.promise()}).then(function(){a.quit()}).always(d.resolve)}return f.trigger({type:"app",id:b,missing:f.missing(c)}),$.when()},quit:function(){this.set("state","stopped"),ox.ui.apps.remove(this)}});var o={LIMIT:6e4,length:function(a){return JSON.stringify(a).length},crop:function(a,b,c){var d=o.length,f=a[c],g=o.LIMIT<d(a)-d(f||"")+d(b);return g?(f?b=f:b.point.data={},"exceeded"in b||(e.yell("warning",j("Failed to automatically save current stage of work. Please save your work to avoid data loss in case the browser closes unexpectedly.")),b.exceeded=!0)):delete b.exceeded,b}};return ox.ui.App=n.extend({defaults:{window:null,state:"ready",saveRestorePointTimer:null,launch:function(){return $.when()},quit:function(){return $.when()}},initialize:function(){var a=this;n.prototype.initialize.apply(this,arguments),this.set("uniqueID",_.now()+"."+String(Math.random()).substr(3,4));var b=$.proxy(this.saveRestorePoint,this);$(window).on("unload",b),this.set("saveRestorePointTimer",setInterval(b,1e4)),this.folder=function(){var b,c,d=null,e=null,f=null,g=$.Deferred();return b={initialized:g.promise(),unset:function(){d=null,e&&e.setTitle(_.noI18n("")),f&&f.clear()},set:function(){function b(b,c,i,j){var k=_.url.hash("app")!==i;d=String(b),k||(e&&(e.setTitle(_.noI18n(c.title||"")),e.updateToolbar()),f&&f.prop("folder")!==d&&(f.busy().prop("folder",d),e&&e.search.active&&e.search.close(),f.refresh(),h.reload(b)),_.url.hash("folder",d),a.trigger("folder:change",d,c)),j.resolve(c,k),"resolved"!==g.state()&&g.resolve(d,c)}return function(a){var c=$.Deferred();if(void 0!==a&&null!==a&&String(a)!==d){var e=_.url.hash("app"),f=h.pool.getModel(a),g=f.toJSON();f.has("title")?b(a,g,e,c):h.get(a).then(function(d){b(a,d,e,c)},function(){console.warn("Failed to change folder",a),c.reject()})}else if(String(a)===d){var f=h.pool.getModel(a),g=f.toJSON();c.resolve(g,!1)}else c.reject();return c}}(),setType:function(a){return c=a,this},setDefault:function(){var a=new $.Deferred;return require(["settings!io.ox/mail"],function(d){var e="mail"===c?d.get("folder/inbox"):i.get("folder/"+c);e?b.set(e).done(a.resolve).fail(a.reject):a.reject({error:j("Could not get a default folder for this application.")})}),a},get:function(){return d},getData:function(){if(null===d)return $.Deferred().resolve({});var a=h.pool.getModel(d);return $.Deferred().resolve(a.toJSON())},can:function(a){return null===d?$.when(!1):require(["io.ox/core/folder/api"]).then(function(b){return b.get(d).then(function(c){return b.can(a,c)})})},updateTitle:function(a){return e=a,this},updateGrid:function(a){return f=a,this},destroy:function(){b=e=f=null}}}()},setLauncher:function(a){return this.set("launch",a),this},setQuit:function(a){return this.set("quit",a),this},setWindow:function(a){return this.set("window",a),a.app=this,this.has("name")&&a.nodes.outer.attr("data-app-name",this.get("name")),this},getWindow:function(){return this.get("window")},getWindowNode:function(){return this.has("window")?this.get("window").nodes.main:$()},getWindowTitle:function(){return this.has("window")?this.has("window").getTitle():""},mediator:function(a){ox.ui.App.mediator(this.getName(),a)},mediate:function(){var a=this;return b.point(this.getName()+"/mediator").each(function(b){try{b.setup&&b.setup(a)}catch(c){console.error("mediate",b.id,c.message,c)}})},registerGlobalEventHandler:function(a,b,c){var d={show:function(){$(a).on(b,c),c()},hide:function(){$(a).off(b,c)}};return this.getWindow().on(d).state.visible&&d.show(),this},registerWindowResizeHandler:function(a){return this.registerGlobalEventHandler(window,"resize",a)},setState:function(a){for(var b in a)_.url.hash(b,null!==a[b]?String(a[b]):null)},getState:function(){return _.url.hash()},launch:function(a){var c=$.when(),d=this,e=this.getName(),f=ox.manifests.isDisabled(e+"/main");if(e!==_.url.hash("app")&&_.url.hash({folder:null,perspective:null,id:null}),e&&_.url.hash("app",e),"ready"===this.get("state")){if(this.set("state","initializing"),ox.trigger("app:init",this),f)c=$.Deferred().reject();else{_.extend(this.options,a),e&&b.point(e+"/main").invoke("launch",this,this.options);try{var g=this.get("launch");c=g.call(this,this.options)||$.when()}catch(h){console.error("Error while launching application:",h.message,h,this)}}c.then(function(){ox.ui.apps.add(d),d.set("state","running"),d.trigger("launch",d),ox.trigger("app:start",d)},function(){ox.launch(require("settings!io.ox/core").get("autoStart"))})}else this.has("window")&&(this.get("window").show(),this.trigger("resume",this),ox.trigger("app:resume",this));return c.pipe(function(){return $.Deferred().resolveWith(d,arguments)})},quit:function(a){var b,c=a?$.when():this.get("quit").call(this)||$.when(),d=this;return c.done(function(){a&&d.destroy&&d.destroy(),!d.getWindow()||!d.getWindow().state.visible||_.url.hash("app")&&d.getName()!==_.url.hash("app").split(":",1)[0]||_.url.hash({app:null,folder:null,perspective:null,id:null}),clearInterval(d.get("saveRestorePointTimer")),d.removeRestorePoint(),$(window).off("unload",$.proxy(d.saveRestorePoint,d)),d.folder.destroy(),d.has("window")&&(b=d.get("window"),b.trigger("quit"),ox.ui.windowManager.trigger("window.quit",b),b.destroy()),ox.ui.apps.remove(d),d.trigger("quit"),ox.trigger("app:stop",d),d.set("state","stopped");for(var c in d)delete d[c];d=b=null})},saveRestorePoint:function(){var a=this,b=a.get("uniqueID");return this.failSave?ox.ui.App.getSavePoints().then(function(c){c=c||[];var d,e,f;try{d=a.failSave(),e=_(c).pluck("id"),f=_(e).indexOf(b),d&&(d.id=b,d.timestamp=_.now(),d.version=ox.version,d.ua=navigator.userAgent,d=o.crop(c,d,f),f>-1?c.splice(f,1,d):c.push(d))}catch(g){f>-1&&(c.splice(f,1),delete a.failSave)}return c.length>0?ox.ui.App.setSavePoints(c):$.when()}):$.when()},removeRestorePoint:function(){var a=this.get("uniqueID");ox.ui.App.removeRestorePoint(a)}}),_.extend(ox.ui.App,{mediator:function(a,c){var d=b.point(a+"/mediator"),e=0;_(c).each(function(a,b){d.extend({id:b,index:e+=100,setup:a})})},canRestore:function(){return this.getSavePoints().then(function(a){return a&&a.length})},getSavePoints:function(){return m.get("savepoints").then(function(a){return(!a||_.isEmpty(a))&&(a=i.get("savepoints",[])),_(a||[]).filter(function(a){var b="point"in a,c=a.ua===navigator.userAgent;return b&&c})})},setSavePoints:function(a){return a=a||[],i.set("savepoints",a).save(),m.add("savepoints",a)},removeAllRestorePoints:function(){return this.setSavePoints([])},removeRestorePoint:function(a){var b=this;return this.getSavePoints().then(function(c){c=c||[];var d=_(c).pluck("id"),e=_(d).indexOf(a);return c=c.slice(),e>-1&&c.splice(e,1),b.setSavePoints(c).then(function(){return c})})},restore:function(){var a=this;return this.getSavePoints().then(function(b){return $.when.apply($,_(b).map(function(a){g.stop();var b=g.startAndEnhance(a.module,[a.module+"/main"]);return ox.load(b).pipe(function(b){return b.getApp().launch().then(function(){return a.id=this.get("uniqueID"),this.failRestore?this.failRestore(a.point):void 0})})})).done(function(){a.setSavePoints(b)})})},get:function(a){return ox.ui.apps.filter(function(b){return b.getName()===a})},getByCid:function(a){return ox.ui.apps.chain().filter(function(b){return b.cid===a}).first().value()},reuse:function(a){var b=ox.ui.apps.find(function(b){return b.cid===a});return b?(b.launch(),!0):!1},getCurrentApp:function(){return null!==k?k.app:null},getCurrentWindow:function(){return k}}),$("#io-ox-core").show(),window.onbeforeunload=function(){var a=ox.ui.apps.filter(function(a){return _.isFunction(a.hasUnsavedChanges)&&a.hasUnsavedChanges()});return a.length>0?j("There are unsaved changes."):void 0},ox.ui.createApp=function(a){return new ox.ui.App(a)},ox.ui.screens=function(){var b=null,c={add:function(a){return $("<div>",{id:"io-ox-"+a}).addClass("abs").hide().appendTo("#io-ox-screens")},get:function(a){return $("#io-ox-screens").find("#io-ox-"+a)},current:function(){return b},hide:function(a){this.get(a).hide(),this.trigger("hide-"+a)},show:function(a){$("#io-ox-screens").children().each(function(){var b=$(this).attr("id"),d=String(b||"").substr(6);d!==a&&c.hide(d)}),this.get(a).show(),b=a,this.trigger("show-"+a)}};return a.extend(c),c}(),ox.ui.Perspective=function(){function a(a,b,c,d){var e=a.getWindow().getPerspective();e&&_.isFunction(e.save)&&e.save(),c&&(c.show(a,_.extend({perspective:b},d)),_.isFunction(c.restore)&&c.restore())}var b=function(a){this.main=$(),this.name=a,this.rendered=!1,this.render=$.noop,this.save=$.noop,this.restore=$.noop,this.afterShow=$.noop,this.afterHide=$.noop,this.show=function(b,c){var d=b.getWindow(),e=c.animation?{animation:c.animation}:{},f=this,g=c.perspective.split(":")[0];c.disableAnimations&&(e.disableAnimations=!0),c.perspective!==d.currentPerspective&&(this.main=b.pages.getPage(g),b.pages.getPageObject(g).perspective||(b.pages.getPageObject(g).perspective=this),d.addPerspective(this),"main"!==d.currentPerspective?d.trigger("change:perspective",a,c.perspective):d.trigger("change:initialPerspective",a),_.url.hash("perspective",c.perspective),this.rendered||(this.render(b,c),this.rendered=!0),b.pages.getPage(g).one("pageshow",function(){f.afterShow(b,c),d.currentPerspective=c.perspective,d.updateToolbar()}),b.pages.getCurrentPage().name===g&&(this.afterShow(b,c),d.currentPerspective=c.perspective,d.updateToolbar()),b.pages.changePage(g,e))},this.hide=function(){this.afterHide()}};return b.show=function(b,c,d){return require([b.get("name")+"/"+c.split(":")[0]+"/perspective"],function(e){a(b,c,e,d)})},b}(),ox.ui.windowManager=function(){var b=a.extend({}),c=[],d=function(){return _(c).inject(function(a,b){return a+(b.state.open?1:0)},0)};return b.getWindows=function(){return c.slice()},ox.ui.screens.on("hide-windowmanager",function(){k&&k.hide()}),b.hide=function(){ox.ui.screens.hide("windowmanager")},b.show=function(){ox.ui.screens.show("windowmanager")},b.on("window.open window.show",function(a,b){if(this.show(),c=_(c).without(b),c.unshift(b),c.length>1){var d=_(c).map(function(a){return a.name});m.add("windows",d||[])}}),b.on("window.beforeshow",function(){b.trigger("empty",!1)}),b.on("window.close window.quit window.pre-quit",function(a,e,f){f||(f=a.type+"."+a.namespace);var g,h,i,j=_(c).indexOf(e);if(-1!==j){for("window.quit"===f?c.splice(j,1):("window.close"===f||"window.pre-quit"===f)&&(c=_(c).without(e),c.push(e)),g=0,h=c.length;h>g;g++)if(i=c[g],i!==e&&i.state.open){i.show();break}m.get("windows").done(function(a){var b=_.indexOf(a,e.name);b>-1&&(a.splice(b,1),m.add("windows",a||[]))})}var k=0===d();k?m.get("windows").done(function(a){b.trigger("empty",!0,a?a[1]||null:null)}):b.trigger("empty",!1)}),b}(),ox.ui.createWindow=function(){var d=0,f=$("#io-ox-windowmanager-pane"),g=function(a){this.options=a||{},this.id=a.id,this.name=a.name||"generic",this.nodes={title:$(),toolbar:$(),controls:$(),closeButton:$(),facetedsearch:{}},this.search={query:"",active:!1},this.state={visible:!1,running:!1,open:!1},this.app=null,this.detachable=!1,this.simple=!1;var c=!1,d={},e=this,g=!0,h=$.Deferred(),i=this.name;this.updateToolbar=function(){var a=this.app&&this.app.folder?this.app.folder.get():null,c=b.Baton({window:this,$:this.nodes,app:this.app,folder:a});b.point(i+"/toolbar").invoke("draw",this.nodes.toolbar.empty(),c)},b.point(i+"/window-title").extend({id:"default",draw:function(){return $('<h1 class="window-title">').append(b.point(i+"/window-title-label").invoke("draw",this).first().value()||$())}}),b.point(i+"/window-title-label").extend({id:"default",draw:function(){return $('<span class="window-title-label">')}}),b.point(i+"/window-toolbar").extend({id:"default",draw:function(){return $('<nav class="window-toolbar">').addClass("f6-target").attr({role:"toolbar","aria-label":j("Application Toolbar")})}}),b.point(i+"/window-head").extend({id:"default",draw:function(){return this.head.append(this.toolbar=b.point(i+"/window-toolbar").invoke("draw",this).first().value()||$())}}),b.point(i+"/window-body").extend({id:"default",draw:function(){return this.body.append(this.search=$('<div class="window-search">'),this.main=$('<div class="abs window-content">'))}}),this.shown=h.promise(),this.setHeader=function(a){return this.nodes.header.append(a),this.nodes.outer.addClass("header-top"),this.nodes.header},this.show=function(a){var b=!1;k&&_.url.hash("app")&&e.name!==_.url.hash("app").split(":",1)[0]&&(b=!0);var c=this.nodes.outer,d=c.parent();if(b||!e||k===this&&0!==d.length)_.call(a);else{if(0===c.parent().length&&(this.simple?(c.insertAfter("#io-ox-topbar"),$("body").css("overflowY","auto")):c.appendTo(f)),ox.ui.windowManager.trigger("window.beforeshow",e),this.trigger("beforeshow"),this.updateToolbar(),_.url.hash("app")&&e.app.getName()===_.url.hash("app").split(":",1)[0]||_.url.hash("app",e.app.getName()),c.show(),null===e)return;k&&k!==e&&k.hide(),k=e,_.call(a),e.state.visible=!0,e.state.open=!0,e.trigger("show"),document.title=document.customTitle=_.device("!small")?j.format(j.pgettext("window title","%1$s %2$s"),_.noI18n(ox.serverConfig.pageTitle),_.noI18n(e.getTitle())):_.noI18n(ox.serverConfig.pageTitle),g&&(h.resolve(),e.trigger("show:initial"),e.trigger("open"),e.state.running=!0,ox.ui.windowManager.trigger("window.open",e),ox.trigger("app:ready",e.app),g=!1),ox.ui.windowManager.trigger("window.show",e),ox.ui.apps.trigger("resume",e.app)}return this},this.hide=function(){return this.trigger("beforehide"),this.simple||this.detachable&&0===this.nodes.outer.find("iframe").length?(this.nodes.outer.detach(),$("body").css("overflowY","")):this.nodes.outer.hide(),this.state.visible=!1,this.trigger("hide"),ox.ui.windowManager.trigger("window.hide",this),k===this&&(k=null,document.title=document.customTitle=_.noI18n(ox.serverConfig.pageTitle)),this},this.toggle=function(){return k===this?this.hide():this.show(),this},this.preQuit=function(){return this.hide(),this.state.open=!1,this.trigger("pre-quit"),ox.ui.windowManager.trigger("window.pre-quit",this),this},this.close=function(){var a=this;return c&&null!==this.app?(this.trigger("beforequit"),this.app.quit().done(function(){a.state.open=!1,a.state.running=!1,a=null})):(this.hide(),this.state.open=!1,this.trigger("close"),ox.ui.windowManager.trigger("window.close",this)),this};var l='input:not([type="file"], [type="hidden"]), select, textarea, button',m="toggle-disabled";this.busy=function(a,b,c){var d;return e&&(d=e.nodes.blocker,$("body").focus(),e.nodes.main.find(l).not(":disabled").prop("disabled",!0).addClass(m),_.isNumber(a)?(a=Math.max(0,Math.min(a,1)),d.idle().find(".progress-bar").eq(0).css("width",100*a+"%").parent().show(),_.isNumber(b)&&d.find(".progress-bar").eq(1).css("width",100*b+"%").parent().show(),d.show()):(d.find(".progress").hide(),d.busy().show()),_.isFunction(c)&&c.call(d),e.trigger("busy")),this},this.idle=function(){return e&&(e.nodes.blocker.find(".progress").hide().end().idle().hide().find(".header, .footer").empty(),e.nodes.main.find(l).filter("."+m).prop("disabled",!1).removeClass(m),e.trigger("idle")),this},this.destroy=function(){return this.hide(),this.trigger("destroy"),null!==this.app&&(this.app.win=null,this.app=null),this.events.destroy(),this.show=this.busy=this.idle=$.noop,this.nodes.outer.remove(),this.nodes=e=null,this},this.setQuitOnClose=function(a){return c=!!a,this};var n="";this.getTitle=function(){return n},this.setTitle=function(a){return _.isString(a)?(n=a,e.nodes.title.find("span").first().text(n),this===k&&(document.title=document.customTitle=_.device("!small")?j.format(j.pgettext("window title","%1$s %2$s"),_.noI18n(ox.serverConfig.pageTitle),_.noI18n(n)):_.noI18n(ox.serverConfig.pageTitle)),this.trigger("change:title")):console.error("window.setTitle(str) expects string!",a),this},this.search={active:!1,query:"",previous:"",lastFocus:"",open:function(){return this.active||(this.lastFocus=$(document.activeElement),e.trigger("search:open"),e.nodes.body.addClass("search-open"),e.nodes.searchField.focus(),this.active=!0),this},close:function(){return this.active&&(e.trigger("search:close"),e.nodes.body.removeClass("search-open"),this.active=!1,e.nodes.searchField.val(""),e.trigger("search:cancel cancel-search"),this.query=this.previous="",this.lastFocus.focus()),this},clear:function(){this.active&&(e.trigger("search:clear"),e.nodes.searchField.val(""),this.query=this.previous="")},toggle:function(){return this.active?this.close():this.open(),this},getOptions:function(){var a={},b=e.nodes.search.find(".search-options").data();return b&&b.options&&_.each(b.options,function(b){void 0!==b.checked&&(a[b.name]=b.checked?"on":"off")}),a},getQuery:function(){return e.nodes.searchField.val()},setQuery:function(a){return e.nodes.searchField.val(this.query=a),this},start:function(a){return this.open().setQuery(a),e.trigger("search",a),this},stop:function(){return this.close(),this}},this.facetedsearch={active:!1,lastFocus:"",ready:$.Deferred(),selectors:{facets:".search-facets:first",facetsadv:".search-facets-advanced"},init:function(){},toggle:function(){var a=".folder-tree, .generic-toolbar.bottom, .search-container",b=e.nodes.sidepanel.find(a);b.toggle(),this.active=!this.active},open:function(){var a=e.nodes.facetedsearch.container,b=a.find(this.selectors.facets),c=a.find(this.selectors.facetsadv),d=e.facetedsearch.view.baton;return this.active||this.toggle(),require(["io.ox/search/facets/extensions"],function(a){a.facets.call(b.empty(),d),a.advfacets.call(c.empty(),d)}),this},close:function(){return this.active&&this.toggle(),this},focus:function(){e.nodes.facetedsearch.container.find(".facet > a").focus()},clear:function(){e.nodes.facetedsearch.toolbar.find(".search-field").val("")},cancel:function(){e.facetedsearch.clear(),e.facetedsearch.view.model.reset(),e.facetedsearch.close(),e.trigger("search:cancel")}},b.point(this.name+"/facetedsearch").extend({id:"searchfield",index:100,draw:function(a){var b=a.nodes.sidepanel,c=a.nodes.facetedsearch;c.toolbar=$('<div class="generic-toolbar top inplace-search io-ox-search">'),b.append(c.toolbar)}}),b.point(this.name+"/facetedsearch").extend({id:"container",index:100,draw:function(a){var b=a.nodes.sidepanel,c=a.nodes.facetedsearch;c.container=$('<div class="abs search-container">').hide().append($('<div class="default">').append($('<ul class="search-facets">').attr({"aria-label":j("Common Facets"),tabIndex:1,role:"group"})),$('<div class="advanced">').append($('<ul class="search-facets search-facets-advanced">').attr({"aria-label":j("Advanced Facets"),tabIndex:1,role:"group"})),$("<div>").attr({"aria-label":j("Actions"),tabIndex:1,role:"group"}).append($('<a data-action="close">').text(j("Close search")).attr({tabindex:1,role:"button",href:"#"}).on("click",function(b){b.preventDefault(),a.facetedsearch.view.trigger("button:cancel")}))).addClass("f6-target").attr({role:"navigation","aria-label":j("Search Options")}),b.append(c.container)}}),this.addClass=function(){var a=this.nodes.outer;return a.addClass.apply(a,arguments)},this.addButton=function(a){var b=$.extend({label:"Action",action:$.noop},a||{});return $("<div>").addClass("io-ox-toolbar-link").text(String(b.label)).on("click",b.action).appendTo(this.nodes.toolbar)},this.addPerspective=function(a){d[a.name]||(d[a.name]=a)},this.getPerspective=function(){var a=this.currentPerspective.split(":")[0];return d[a]},this.currentPerspective="main",this.setChromeless=function(a){a?(this.nodes.outer.addClass("chromeless-window"),this.nodes.head.hide(),this.nodes.body.css("left","0px")):(this.nodes.outer.removeClass("chromeless-window"),this.nodes.head.show(),this.nodes.body.css("left",""))}};return function(f){var h=$.extend({chromeless:!1,classic:!1,id:"window-"+d,name:"",search:!1,facetedsearch:!1,searchShortcut:!1,title:"",toolbar:!1,width:0},f),i=(String(h.width).match(/^(\d+)(px|%)$/)||["","100","%"]).splice(1),k=i[0],l=i[1],m=new g(h);if(m.nodes.outer=$('<div class="window-container">').attr({id:h.id,"data-window-nr":d}),h.simple?(m.simple=!0,m.nodes.outer.addClass("simple-window").append(m.nodes.main=$('<div class="window-content" tabindex="-1">')),m.nodes.blocker=$(),m.nodes.sidepanel=$(),m.nodes.head=$(),m.nodes.body=$(),m.nodes.search=$(),m.nodes.facetedsearch={}):(m.nodes.outer.append($('<div class="window-container-center">').data({width:k+l}).css({width:k+l}).append(m.nodes.blocker=$('<div class="abs window-blocker">').hide().append($('<div class="abs header">'),$('<div class="progress progress-striped active first"><div class="progress-bar" style="width: 0%;"></div></div>').hide(),$('<div class="progress progress-striped progress-warning active second"><div class="progress-bar" style="width: 0%;"></div></div>').hide(),$('<div class="abs footer">')),m.nodes.head=$('<div class="window-head">'),m.nodes.header=$('<div class="window-header">'),m.nodes.sidepanel=$('<div class="window-sidepanel collapsed">'),m.nodes.body=$('<div class="window-body" role="main">').attr("aria-label",j("Main window"))).on("controller:quit",function(){m.app&&m.app.quit()})),m.nodes.facetedsearch={},h.classic&&m.nodes.outer.addClass("classic"),h.name&&m.nodes.outer.addClass(h.name.replace(/[.\/]/g,"-")+"-window"),b.point(h.name+"/window-head").invoke("draw",m.nodes),b.point(h.name+"/window-body").invoke("draw",m.nodes)),a.extend(m),h.search){var n=function(a){m.trigger("search",a)},o={keydown:function(a){27===a.which?m.search.close():13===a.which&&o.change(a)},clear:function(){m.search.clear()},change:function(a){a.stopPropagation(),m.search.query=m.search.getQuery(),m.search.options=JSON.stringify(m.search.getOptions());var b=m.search.query!==m.search.previous||m.search.options!==m.search.optionsprev;""!==m.search.query&&b?(m.search.optionsprev=m.search.options,n(m.search.previous=m.search.query)):""===m.search.query&&m.search.clear()}};$('<form class="form-search form-inline" role="search">').attr("aria-label",j("Search for items")).append($('<div class="search-query-container input-group">').append(m.nodes.searchField=$('<input type="text" class="form-control search-query">').attr({name:"query",autocomplete:"off",tabindex:"1",placeholder:j("Search")+" ...","aria-label":j("Search")}).on(o).placeholder(),$('<i class="fa fa-times clear-query">').on("click",o.clear),$('<span class="input-group-btn">').append($('<button type="submit" data-action="search" class="btn btn-default" aria-hidden="true">').on("click",o.change).append($('<i class="fa fa-search">')))),$('<a href="#" data-action="remove" tabindex="1">×</a>').addClass("close close-big").on("click",function(a){a.preventDefault(),m.search.stop()})).on("change","input",function(){m.search.previous=""}).on("submit",!1).appendTo(m.nodes.search)}return h.facetedsearch&&(b.point(m.name+"/facetedsearch/view").extend({id:"container",index:100,draw:function(){b.point(this.name+"/facetedsearch").invoke("draw",this.facetedsearch,m)}}),b.point(m.name+"/facetedsearch/view").extend({id:"input",index:200,draw:function(){var a,b=this.nodes.facetedsearch.toolbar,c=j("Search"),d=m.name+"-search-field",e=_.uniqueId("form-control-description-");b.append(a=$('<div class="input-group">').append($('<input type="text">').attr({"class":"form-control search-field f6-target",tabindex:1,role:"navigation","aria-label":j("Search within application"),id:d,placeholder:c+" ...","aria-describedby":e}),$('<label class="sr-only">').attr("for",d).text(c),$('<p class="sr-only sr-description">').attr({id:e}).text(j("Search results page lists all active facets to allow them to be easly adjustable/removable. Below theses common facets additonal advanced facets are listed. To narrow down search result please adjust active facets or add new ones"))))}}),b.point(m.name+"/facetedsearch/view").extend({id:"action",index:300,draw:function(){var a=this.nodes.facetedsearch.toolbar.find(".input-group");a.append($('<span class="input-group-btn">').append($('<button type="button">').attr({tabindex:"1","class":"btn btn-default btn-search","data-toggle":"tooltip","data-placement":"bottom","data-animation":"false","data-container":"body","data-original-title":j("Start search"),"aria-label":j("Start search")}).append($('<i class="fa fa-search"></i>')).tooltip()))}}),b.point(m.name+"/facetedsearch/view").extend({id:"lazy-load",index:400,draw:function(){var a=this.nodes.facetedsearch.toolbar.find(".search-field"),b=function(){require(["io.ox/search/quickstart"],function(a){a.run(m).done(function(){var a=m.facetedsearch.view;m.app.on("resume",function(){m.facetedsearch.active&&a.trigger("button:cancel")}),a.on({query:_.debounce(function(a,b){m.app.get("name")===b&&(m.facetedsearch.open(),"query"===a.type&&m.trigger("search:query"))},10),"button:clear":function(){m.facetedsearch.clear()},"button:cancel":function(){m.facetedsearch.cancel()}}),a.model.on({query:function(b){a.trigger("query",b)},"query:result":function(a){var b=a.results.length,c=j("No items were found. Please adjust currently used facets."),d=j.format(j.ngettext("One item was found.","%1$s items were found.",b),b);e.yell("screenreader",b?d:c)},cancel:function(b){a.trigger("button:cancel",b)}}),m.trigger("search:loaded"),ox.trigger("search:load",m)})})};a.one("focus load",b)}}),b.point(m.name+"/facetedsearch/view").invoke("draw",m,b.Baton.ensure({}))),h.chromeless?m.setChromeless(!0):h.name&&(b.point(h.name+"/toolbar").extend(new c.ToolbarLinks({id:"links",ref:h.name+"/links/toolbar"})),h.search===!0&&(new c.Action(h.name+"/actions/search",{action:function(a){var b=$(a.window.nodes.body).find(".io-ox-sidepopup");b.is(":visible")&&b.trigger("remove"),a.window.search.toggle()}}),new c.ActionLink(h.name+"/links/toolbar/search",{label:j("Toggle search"),ref:h.name+"/actions/search"}),new c.ActionGroup(h.name+"/links/toolbar",{id:"search",index:300,icon:function(){return $('<i class="fa fa-search">').attr("aria-label",j("Search"))}}),h.searchShortcut&&m.nodes.outer.on("keydown",function(a){70===a.which&&a.metaKey&&(a.preventDefault(),m.search.toggle())})),h.fullscreen===!0&&(new c.Action(h.name+"/actions/fullscreen",{action:function(a){BigScreen.enabled&&BigScreen.toggle(a.$.outer.get(0))}}),new c.ActionLink(h.name+"/links/toolbar/fullscreen",{ref:h.name+"/actions/fullscreen"}),new c.ActionGroup(h.name+"/links/toolbar",{id:"fullscreen",index:1e3,icon:function(){return $('<i class="fa fa-expand">')}}))),d++,m}}(),ox.load=function(){function a(){var a=setTimeout(function(){ox.busy(!0),e=setTimeout(function(){if(!g[0].firstChild){var c=$('<button type="button" class="btn btn-primary">').text(j("Cancel")).fadeIn();c.on("click",function(){d.reject(!0),b(a)}),g.append(c),c.focus()}},5e3)},1e3);return a}function b(a){clearTimeout(a),clearTimeout(e),a=null,e=null,setTimeout(function(){null===a&&ox.idle()},0)}function c(a){f.always(function(){b(a)})}var d,e,f,g=$("#background-loader");return function(b,e){assert(arguments.length<=1||2===arguments.length&&!_.isFunction(e),"ox.load does not support callback params."),d=$.Deferred(),f=e&&e.launched?e.launched:$.Deferred().resolve(),g.hasClass("secure")||ox.busy();var h=a();return require(b).always(c(h)).then(d.resolve,function(a){if(console.error(a),d.reject(!1),_.isArray(b))for(var c=0;c<b.length;c++)requirejs.undef(b[c])}),d}}(),ox.busy=function(a){$("#background-loader")[a?"busy":"idle"]().show().addClass("secure"+(a?" block":""))},ox.idle=function(){$("#background-loader").removeClass("secure block").hide().idle().empty()},ox.disable=function(){$("#background-loader").addClass("busy block secure").on("touchmove",function(a){return a.preventDefault(),!1}).show()},ox.launch=function(a,b){var c=$.Deferred();if(_.isString(a)){g.stop();var d=g.startAndEnhance(a.replace(/\/main$/,""),[a]);ox.load(d,b).then(function(a){a.getApp(b).launch(b).done(function(){c.resolveWith(this,arguments)})},function(){e.yell("error",j("Failed to start application. Maybe you have connection problems. Please try again.")),requirejs.undef(a)})}else c.resolve({});return c},ox.ui.apps.on("resume",function(a){g.stop(),g.listen(a.get("name"))}),{}}),define("io.ox/core/api/apps",["io.ox/core/event","io.ox/core/extensions","io.ox/core/manifests","io.ox/core/capabilities"],function(a,b,c,d){"use strict";var e,f={favorites:[],installed:[],categories:[],apps:{}};_(c.manager.apps).each(function(a){if(!a.path||!a.category)return void(ox.debug&&_.device("!karma")&&console.warn("Ignored app. Missing path/category",a));var b=a.path.substr(0,a.path.length-5);f.installed.push(b),f.apps[b]=a,f.categories.push(a.category)}),f.categories=_(f.categories).uniq();var g=["io.ox/portal","io.ox/mail","io.ox/contacts","io.ox/calendar","io.ox/tasks","io.ox/files","io.ox/office/portal/text","io.ox/office/portal/spreadsheet"];b.point("io.ox/core/apps/favorites/allFavorites").invoke("customize",g,g),_(g).each(function(a){var b=f.apps[a];b&&!c.manager.isDisabled(b.path)&&f.favorites.push(a)});var h=function(a,b){return a=_.clone(a||{}),a.id=b,a.icon=ox.base+(a.icon&&"/"===a.icon.charAt(0)?a.path.replace(/(.+)\/(.+)$/,"/apps/$1")+a.icon:"/apps/io.ox/core/images/"+(a.icon||"default.png")),a.description=a.description||"Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat...",a.visible=a.visible!==!1,a},i=function(){var a={};return _(f.apps).each(function(b){var c=b.category||"---";a[c]=(a[c]||0)+(b.visible!==!1?1:0)}),[{id:"installed",title:"Installed",count:f.installed.length,group:"Your Apps"},{id:"favorites",title:"Favorites",count:f.favorites.length,group:"Your Apps"},{id:"upgrades",title:"Upgrades",count:1,group:"Your Apps"}].concat(_(f.categories).map(function(b){return{id:b.toLowerCase(),title:b,count:a[b],group:"Categories"}})).concat(b.point("io.ox/core/apps/category").map(function(a){return a.category?a.metadata("category"):a}).value())},j=function(a){return _(f.apps).chain().map(function(a,b){return h(a,b)}).filter(function(b){return b.visible&&b.category.toLowerCase()===a}).value()},k=function(a,c){return _(c||f[a]).chain().map(function(a){return h(f.apps[a],a)}).filter(function(a){return!!a.title}).value().concat(b.point("io.ox/core/apps/"+a).map(function(a){return a.app?a.metadata("app"):a}).value())},l=null;return e={get:function(a){return h(f.apps[a],a)},getCategories:i,getByCategory:j,getInstalled:function(a){if("cached"===a&&null!==l)return $.Deferred().resolve(l);var c=[];return c.push((new $.Deferred).resolve(k("installed"))),b.point("io.ox/core/apps/store").each(function(a){a.installed&&c.push(a.installed())}),$.when.apply($,c).pipe(function(){return l=_.chain(arguments).flatten().filter(function(a){return"requires"in a?d.has(a.requires):!0}).value()})},getFavorites:function(){return k("favorites")},getAllFavorites:function(){return k("favorites",g)},getAvailable:function(){return k("installed")},isFavorite:function(a){return _(f.favorites).indexOf(a.id)>-1},markAsFavorite:function(a){-1===_(f.favorites).indexOf(a)&&(f.favorites.push(a),e.trigger("refresh.all"))},unmarkAsFavorite:function(a){var b=_(f.favorites).indexOf(a);-1!==b&&(f.favorites.splice(b,1),e.trigger("refresh.all"))
}},a.extend(e),e}),define("io.ox/core/extPatterns/stage",["io.ox/core/extensions"],function(a){"use strict";var b=$.when(),c=function(b,c){a.point(b).extend(c)};return c.run=function(c,d){function e(){if(f.length){var a=f.shift();try{((a.run||$.noop)(d)||b).then(e,g.reject)}catch(c){console.error("Stage.run()",c.message,"stage",a,"baton",d,"list",f)}}else g.resolve()}var f=a.point(c).list(),g=$.Deferred();return e(),g},c}),define.async("io.ox/core/date",["io.ox/core/gettext","settings!io.ox/core","gettext!io.ox/core"],function(a,b,c){"use strict";function d(a){return a.getDays()-(a.getDay()-D.locale.weekStart+7)%7}function e(a){return d(a)+7-D.locale.daysInFirstWeek}function f(a,b){var c=e(a),d=a.constructor,f=new d(c*D.DAY),g=new d(f.getTime()).setMonth(b?f.getMonth():0,1);return Math.floor((c-g.getDays())/7)+1}function g(a){var b=a.getYear(),c=a.getMonth(),d=f(a);return 0===c&&d>26&&b--,11===c&&26>d&&b++,b}function h(a){return a%4===0&&(a%100!==0||a%400===0)}function i(a,b){var c=b.toString();if(a-=c.length,0>=a)return c;for(var d=new Array(a+1),e=0;a>e;e++)d[e]="0";return d[a]=c,d.join("")}function j(a,b,c){return a>=4?b:c}function k(a,b){return String(a).replace(G,function(a,c,d,e){return c?H[c.charAt(0)](c.length,b):d?d.replace(/''/g,"'"):e?"'":void 0})}function l(a){return String(a).replace(/[$\^\\.*+?()\[\]{}|]/g,"\\$&")}function m(a,b){return"("+_.map(a.concat(b),l).join("|")+")"}function n(a,b){for(var c={},d=0;d<a.length;d++)c[a[d]]=d,c[b[d]]=d;return c}function o(){return K}function p(a){return a>1?"([-+\\d]\\d{1,"+(a-1)+"})":"(\\d{1,"+a+"})"}function q(a){return function(){return function(b,c){c[a]=Number(b)}}}function r(a,b,c){function e(a,b){a=Number(a);var c=a.toString().length;return 2>=c&&c===b&&(a+=P),l.bc&&(a=1-a),a}var i=[],j=a.replace(J,function(a,b,c,d,e,f){return b?(i.push(N[b.charAt(0)](b.length)),L[b.charAt(0)](b.length)):c?(i.push(N[c.charAt(0)](c.length)),M[c.charAt(0)](c.length)):d?d:e?"'":f?"\\"+f:void 0}),k=b.match(new RegExp("^\\s*"+j+"\\s*$","i"));if(!k)return null;for(var l={bc:!1,century:!1,pm:!1,y:1970,m:0,d:1,h:0,h2:0,min:0,s:0,ms:0,w:1,wd:0},m=0;m<i.length;m++)i[m](k[m+1],l);if(l.h||(l.h=Number(l.h2)+(l.pm?12:0)),l.h<0||l.h>=24||l.min<0||l.min>=60||l.s<0||l.s>=60||l.ms<0||l.ms>=1e3)return null;l.y=e(l.y,l.yStr);var n=new c(0);if("wy"in l){l.wy=e(l.wy,l.wyStr),n.setYear(l.wy);var o=n.getDays(),p=d(n);if(7-(o-p)<D.locale.daysInFirstWeek&&(p+=7),n.setTime(c.utc(D.DAY*(p+7*l.w-7+(l.wd-D.locale.weekStart+7)%7))),g(n)!==Number(l.wy)||f(n)!==Number(l.w)||n.getDay()!==Number(l.wd))return null}else if("yd"in l){if(l.yd<0||l.yd>(h(l.y)?366:365))return null;n.setYear(l.y),n.add(D.DAY*(l.yd-1))}else if(n.setYear(l.y,l.m,l.d),n.getYear()!==Number(l.y)||n.getMonth()!==Number(l.m)||n.getDate()!==Number(l.d))return null;return n.setHours(l.h,l.min,l.s,l.ms),n}function s(a,b){var c=(a-1)*D.DAY+b,d=a>59?D.DAY:0;return function(a){return Date.UTC(a,0)+c+(h(a)?d:0)}}function t(a,b){var c=a*D.DAY+b;return function(a){return Date.UTC(a,0)+c}}function u(a,b,c,d){if(5===Number(b))return function(b){var e=Date.UTC(b,a)-D.DAY,f=new Date(e).getUTCDay();return e-(f-c+7)%7*D.DAY+d};a--;var e=7*b*D.DAY+d;return function(b){var d=Date.UTC(b,a),f=new Date(d).getUTCDay();return d+(c-f+7)%7*D.DAY+e}}function v(a){function b(a){return e[a++]*D.HOUR+(e[a++]||0)*D.MINUTE+(e[a]||0)*D.SECOND}function c(a){return"-"===e[a]?b(a+1):-b(a+1)}function d(a){var c=e[a+5]?b(a+5):72e5;return e[a]?s(e[a],c):e[a+1]?t(e[a+1],c):u(e[a+2],e[a+3],e[a+4],c)}var e=Q.exec(a);if(e){var f={abbr:e[1],isdst:!1,gmtoff:c(2)};if(e[6]){var g={abbr:e[6],isdst:!0,gmtoff:e[8]?c(7):f.gmtoff+D.HOUR},h=d(11),i=d(19);return function(a,b){var c=new Date(a).getUTCFullYear(),d=h(c)-(b?0:f.gmtoff),e=i(c)-(b?0:g.gmtoff),j=e>d?a>=d&&e>a:a>=d||e>a;return j?g:f}}return function(){return f}}}function w(a){function b(){var b=a.charCodeAt(l++);return 256>b?b:k[b]}function c(){return 16777216*b()+65536*b()+256*b()+b()}function d(){var a=c();return 2147483648>a?a:a-4294967296}function e(){return 4294967296*d()+c()}function f(){if("TZif"!==a.slice(l,l+4))throw new Error("Invalid zoneinfo header.");return l+=20,{ttisgmtcnt:d(),ttisstdcnt:d(),leapcnt:d(),timecnt:d(),typecnt:d(),charcnt:d()}}function g(a,b){function c(a){return Math.max(0,Math.floor((a-d)/u))}var d,e=1/0,f=-1/0,g=[];if(a.length){f=_.last(a).start,e=_.first(a).start,d=_.find(a,function(a){return f-a.start<1e3*C}).start+C/4;for(var h=-1,i=0;i<a.length;i++){for(var j=c(a[i].start);j>h;)g[++h]=i;g[h]=i}}return function(d){if(e>d)return s;if(d>=f)return t(d,b);for(var h=g[c(d)];a[h].start>d;--h);return a[h].ttinfo}}function h(a){switch(arguments.length){case 0:this.t=(new Date).getTime()+E,this.local=h.localTime(this.t);break;case 1:this.t=new Date(a).getTime(),this.local=h.localTime(this.t);break;default:this.local=Date.UTC.apply(Date,arguments),this.t=h.utc(this.local)}}if("TZif"!==a.slice(0,4))throw new Error("Not a zoneinfo file.");var i,j,k={8364:128,8218:130,402:131,8222:132,8230:133,8224:134,8225:135,710:136,8240:137,352:138,8249:139,338:140,381:142,8216:145,8217:146,8220:147,8221:148,8226:149,8211:150,8212:151,732:152,8482:153,353:154,8250:155,339:156,382:158,376:159},l=0,m=f(),n=a.charAt(4)>="2";n?(j=e,l+=5*m.timecnt+6*m.typecnt+m.charcnt+8*m.leapcnt+m.ttisstdcnt+m.ttisgmtcnt,m=f()):j=d;var o=[];for(i=0;i<m.timecnt;i++)o.push({start:1e3*j()});for(i=0;i<m.timecnt;i++)o[i].index=b();var p=[];for(i=0;i<m.typecnt;i++)p.push({gmtoff:d()*D.SECOND,isdst:b(),abbr:b()});for(o=_.map(o,function(a){return{start:a.start,ttinfo:p[a.index]}}),i=0;i<m.typecnt;i++){var q=l+p[i].abbr;p[i].abbr=a.slice(q,a.indexOf("\x00",q))}l+=m.charcnt,l+=m.leapcnt*(n?12:8)+m.ttisstdcnt+m.ttisgmtcnt;var s=_.find(p,function(a){return!a.isdst})||_.first(p),t=n&&10===b()?v(a.slice(l,a.indexOf("\n",l))):function(){return _.last(o).ttinfo},u=C/2;if($.extend(h.prototype,R),Object.defineProperty)for(var i in R)Object.defineProperty(h.prototype,i,{enumerable:!1});h.getTTInfo=g(o),h.localTime=function(a){return a+h.getTTInfo(a).gmtoff};var w=s;return h.getTTInfoLocal=g(_.map(o,function(a){return{start:a.start+w.gmtoff,ttinfo:w=a.ttinfo}}),!0),h.utc=function(a){return a-h.getTTInfoLocal(a).gmtoff},h.parse=function(a,b){return r(D.getFormat(b),a,h)},assert(h.transitions=o),h}var x,y,z,A,B=["","E","yMd","yMEd","Hm","yMEdHm","yMdHm","yMEdHm","v","yMEdHmv","yMdHmv","yMEdHmv","Hmv","yMEdHmv","yMdHmv","yMEdHmv","Md"],C=31556952e3,D={SECOND:1e3,MINUTE:6e4,HOUR:36e5,DAY:864e5,WEEK:6048e5,DAYOFWEEK:1,DATE:2,TIME:4,TIMEZONE:8,DAYOFWEEK_DATE:3,DATE_TIME:6,DAYOFWEEK_DATE_TIME:7,TIME_TIMEZONE:12,DATE_TIME_TIMEZONE:14,FULL_DATE:15,DATE_NOYEAR:16,getFormat:function(a){return a=a||D.DATE_TIME,"number"==typeof a&&(a=B[a],D.locale.h12&&(a=a.replace("H","h")),a=D.locale.formats[a]),a},getInputFormat:function(a){return this.getFormat(a).replace(/(y+)|(M+)|(d+)/g,function(a,b,d,e){return b?c("yyyy"):d?c("MM"):e?c("dd"):a})},formatDuration:function(a,b){function d(a){return c.format(b?c.npgettext("in","%d week","%d weeks",a):c.ngettext("%d week","%d weeks",a),a)}function e(a){var b=D.DAY/D.MINUTE;if(b>a)return h(a);var c=Math.floor(a/b);return a%=b,a?g(c,a):f(c)}function f(a){return c.format(b?c.npgettext("in","%d day","%d days",a):c.ngettext("%d day","%d days",a),a)}function g(a,d){return c.format(b?c.npgettext("in","%1$d day, %2$s","%1$d days, %2$s",a):c.ngettext("%1$d day, %2$s","%1$d days, %2$s",a),a,h(d))}function h(b){if(60>b)return k(b);var c=Math.floor(a/60);return b%=60,b?j(c,b):i(c)}function i(a){return c.format(b?c.npgettext("in","%d hour","%d hours",a):c.ngettext("%d hour","%d hours",a),a)}function j(a,d){return c.format(b?c.npgettext("in","%1$d hour and %2$s","%1$d hours and %2$s",a):c.ngettext("%1$d hour and %2$s","%1$d hours and %2$s",a),a,k(d))}function k(a){return c.format(b?c.npgettext("in","%d minute","%d minutes",a):c.ngettext("%d minute","%d minutes",a),a)}var l=Math.round(a/D.MINUTE),m=D.WEEK/D.MINUTE;return l>=m&&a%m===0?d(Math.round(a/m)):e(a)}},E=0,F="GyYMwWDdFEuaHkKhmsSzZvV".split("").join("+|")+"+",G=new RegExp("("+F+")|'((?:[^']|'')+)'|('')","g"),H={a:function(a,b){return D.locale.dayPeriods[b.getHours()<12?"am":"pm"]},D:function(a,b){return i(a,b.getDays()-new b.constructor(b.getYear(),0).getDays()+1)},d:function(a,b){return i(a,b.getDate())},E:function(a,b){var c=b.getDay();return j(a,D.locale.days[c],D.locale.daysShort[c])},F:function(a,b){return i(a,Math.floor(b.getDate()/7)+1)},G:function(a,b){return D.locale.eras[b.getYear()<1?0:1]},H:function(a,b){return i(a,b.getHours())},h:function(a,b){return i(a,b.getHours()%12||12)},K:function(a,b){return i(a,b.getHours()%12)},k:function(a,b){return i(a,b.getHours()||24)},M:function(a,b){var c=b.getMonth();return a>=3?j(a,D.locale.months[c],D.locale.monthsShort[c]):i(a,c+1)},m:function(a,b){return i(a,b.getMinutes())},S:function(a,b){return i(a,b.getMilliseconds())},s:function(a,b){return i(a,b.getSeconds())},u:function(a,b){return i(a,(b.getDay()+6)%7+1)},W:function(a,b){return i(a,f(b,!0))},w:function(a,b){return i(a,f(b))},Y:function(a,b){var c=b.getYear(),d=b.getMonth(),e=f(b);return 0===d&&e>26&&c--,11===d&&26>e&&c++,1>c&&(c=1-c),i(a,2===a?c%100:c)},y:function(a,b){var c=b.getYear();return 1>c&&(c=1-c),i(a,2===a?c%100:c)},z:function(){},Z:function(){},v:function(a,b){return b.getTimeZone()},V:function(){}},I="("+F+")(?!"+F+")|("+F+")(?="+F+")|'((?:[^']|'')+)'|('')|([$^\\\\.*+?()[\\]{}|])",J=new RegExp(I,"g"),K="([+-]?\\d+)",L={a:function(){return"("+l(D.locale.dayPeriods.am)+"|"+l(D.locale.dayPeriods.pm)+")"},E:function(){return y},G:function(){return"("+l(D.locale.eras[0])+"|"+l(D.locale.eras[1])+")"},M:function(a){return a>=3?x:K},D:o,d:o,F:o,H:o,h:o,K:o,k:o,m:o,S:o,s:o,u:o,W:o,w:o,Y:o,y:o},M={M:function(a){return a>=3?x:p(a)},a:L.a,D:p,d:p,E:L.E,F:p,G:L.G,H:p,h:p,K:p,k:p,m:p,S:p,s:p,u:p,W:p,w:p,Y:p,y:p},N={a:function(){return function(a,b){b.pm=a===D.locale.dayPeriods.pm}},E:function(){return function(){}},G:function(){return function(a,b){b.bc=a===D.locale.eras[0]}},h:function(){return function(a,b){b.h2="12"===a?0:Number(a)}},k:function(){return function(a,b){b.h="24"===a?0:Number(a)}},M:function(a){return a>=3?function(a,b){b.m=z[a]}:function(a,b){b.m=a-1}},Y:function(a){return function(b,c){c.wcentury=2===a&&b.match(/^\d\d$/),c.wyStr=b.length,c.wy=Number(b)}},y:function(a){return function(b,c){c.century=2===a&&b.match(/^\d\d$/),c.yStr=b.length,c.y=Number(b)}},D:q("yd"),d:q("d"),F:$.noop,H:q("h"),K:q("h2"),m:q("min"),S:q("ms"),s:q("s"),u:$.noop,W:$.noop,w:q("w")},O=new Date,P=100*Math.floor((O.getUTCFullYear()+20)/100),Q=function(){function a(a){return"(?:"+a+")?"}var b="([^\\d,+-]{3,})",c="(\\d+)(?::(\\d+)(?::(\\d+))?)?",d="([+-])?"+c,e=",(?:J(\\d+)|(\\d+)|M(\\d+)\\.(\\d+)\\.(\\d+))(?:\\/"+c+")?";return new RegExp("^"+b+d+a(b+a(d)+e+e)+"$")}(),R={getDays:function(){return Math.floor(this.local/D.DAY)},getTimeZone:function(){return this.constructor.getTTInfo(this.t).abbr},valueOf:function(){return this.t},toString:function(){return this.format(D.FULL_DATE)},add:function(a){return this.t=this.constructor.utc(this.local+=a),this},addUTC:function(a){return this.local=this.constructor.localTime(this.t+=a),this},addMonths:function(a){var b=new Date(this.local);return b.setUTCMonth(b.getUTCMonth()+a),this.t=this.constructor.utc(this.local=b.getTime()),this},addYears:function(a){var b=new Date(this.local);return b.setUTCFullYear(b.getUTCFullYear()+a),this.t=this.constructor.utc(this.local=b.getTime()),this},setStartOfWeek:function(){return this.local=D.DAY*d(this),this.t=this.constructor.utc(this.local),this},getTime:function(){return this.t},setTime:function(a){return this.local=this.constructor.localTime(this.t=a),this},getYear:function(){return new Date(this.local).getUTCFullYear()},setYear:function(){var a=new Date(this.local);return a.setUTCFullYear.apply(a,arguments),this.t=this.constructor.utc(this.local=a.getTime()),this},getMonth:function(){return new Date(this.local).getUTCMonth()},setMonth:function(){var a=new Date(this.local);return a.setUTCMonth.apply(a,arguments),this.t=this.constructor.utc(this.local=a.getTime()),this},getDate:function(){return new Date(this.local).getUTCDate()},setDate:function(a){var b=new Date(this.local);return b.setUTCDate(a),this.t=this.constructor.utc(this.local=b.getTime()),this},getDay:function(){return new Date(this.local).getUTCDay()},getHours:function(){return new Date(this.local).getUTCHours()},setHours:function(){var a=new Date(this.local);return a.setUTCHours.apply(a,arguments),this.t=this.constructor.utc(this.local=a.getTime()),this},getMinutes:function(){return new Date(this.local).getUTCMinutes()},setMinutes:function(){var a=new Date(this.local);return a.setUTCMinutes.apply(a,arguments),this.t=this.constructor.utc(this.local=a.getTime()),this},getSeconds:function(){return new Date(this.local).getUTCSeconds()},setSeconds:function(){var a=new Date(this.local);return a.setUTCSeconds.apply(a,arguments),this.t=this.constructor.utc(this.local=a.getTime()),this},getMilliseconds:function(){return new Date(this.local).getUTCMilliseconds()},setMilliseconds:function(a){var b=new Date(this.local);return b.setUTCMilliseconds(a),this.t=this.constructor.utc(this.local=b.getTime()),this},format:function(a){return k(D.getFormat(a),this)},getIntervalFormat:function(a,b){var c=D.locale;if(!(b&D.TIME)){var d=b&D.DAYOFWEEK?c.intervals.yMMMEd:c.intervals.yMMMd;return this.getYear()!==a.getYear()?d.y:this.getMonth()!==a.getMonth()?d.m:this.getDate()!==a.getDate()?d.d:D.getFormat(b)}if(this.getDays()===a.getDays()){var d=c.intervals[(c.h12?"hm":"Hm")+(b&D.TIMEZONE?"v":"")];if(c.h12&&this.getHours()<12!=a.getHours()<12)return d.a;if(this.getHours()!==a.getHours())return d.h;if(this.getMinutes()!==a.getMinutes())return d.m;if(this.getTimeZone()===a.getTimeZone())return D.getFormat(b)}else b|=D.DATE;return b=D.getFormat(b),_.printf(c.intervals.fallback,b,b)},formatInterval:function(a,b){"number"==typeof b&&(b=this.getIntervalFormat(a,b));var c,d={};for(G.lastIndex=0;c=G.exec(b);)if(c[1]){var e=c[1].charAt(0);if(d[e])break;d[e]=!0}return G.lastIndex?this.format(b.slice(0,c.index))+a.format(b.slice(c.index)):this.format(b)}};D.getTimeZone=_.memoize(function(a){return require(["raw!io.ox/core/date/tz/zoneinfo/"+a]).pipe(w).pipe(function(b){return b.id=a,b.displayName=a,b})});var S=a.language.pipe(function(a){return require(["text!io.ox/core/date/date."+a+".json"])}).pipe(null,function(){return require(["text!io.ox/core/date/date.root.json"])}).done(function(a){D.locale=JSON.parse(a),x=m(D.locale.months,D.locale.monthsShort),y=m(D.locale.days,D.locale.daysShort),z=n(D.locale.months,D.locale.monthsShort),A=n(D.locale.days,D.locale.daysShort)});return $.when(D.getTimeZone("UTC"),D.getTimeZone(b.get("timezone","UTC")).then(null,function(){return D.getTimeZone("UTC")}),S).then(function(a,b){return D.UTC=a,D.Local=b,D})}),define("io.ox/core/yell",["gettext!io.ox/core"],function(a){"use strict";function b(){clearTimeout(j),$(".io-ox-alert").trigger("notification:removed").remove(),$(document).off(".yell")}function c(a){var c=$(".io-ox-alert");if(0!==c.length)return _.device("smartphone")?b():$.contains(c.get(0),a.target)?$(a.target).closest(".close").length?b():void 0:b()}function d(a){function b(a){var b,c=g.screenreader||5e3,d=$.find(".io-ox-alert-screenreader");d.length||(d=$('<div tabindex="-1" class="io-ox-alert-screenreader sr-only">'),$("#io-ox-core").append(d)),_.defer(function(){$(d).append(b=$('<div role="alert" aria-live="polite">').append($("<span>").text(a)))}),setTimeout(function(){b.remove(),$(d).children.length||$(d).remove()},c)}var c=$(".io-ox-alert");c.length?c.one("notification:removed",function(){b(a)}):b(a)}function e(e,k,l){if("destroy"===e||"close"===e)return b();var m={duration:0,html:!1,type:"info",focus:!1};if(_.isObject(e)?"error"in e?(m.type="error",m.message=e.message||e.error,m.headline=a("Error")):m=_.extend(m,e):(m.type=e||"info",m.message=k,m.focus=l),f.test(m.type)){var n=[];if("screenreader"===m.type)return d(m.message);clearTimeout(j),j=-1===m.duration?null:setTimeout(b,m.duration||g[m.type]||5e3),n=$(".io-ox-alert"),$(document).off(".yell"),_.defer(function(){$(document).on(_.device("touch")?"tap.yell":"mousedown.yell",c)});var o=m.html?m.message:_.escape(m.message).replace(/\n/g,"<br>"),p="io-ox-alert io-ox-alert-"+m.type,q=o.indexOf("http")>=0?"break-all":"normal",r=$('<div tabindex="-1">');return n.length&&(p+=" appear",n.remove()),r.attr("class",p).append($('<div class="icon">').append($("<i>").attr("aria-hidden",!0).addClass(i[m.type]||"fa fa-fw"))),_.defer(function(){r.append($('<div role="alert" aria-live="polite" class="message user-select-text">').append(h[m.type]?$('<span class="sr-only">').text(a(h[m.type])):[],m.headline?$('<h2 class="headline">').text(m.headline):[],$("<div>").css("word-break",q).html(o)))}),r.append($('<a href="#" role="button" class="close" tabindex="1">').append($('<i class="fa fa-times" aria-hidden="true">'),$('<span class="sr-only">').text(a("Click to close this notification")))),$("#io-ox-core").append(r),setTimeout(function(){r.trigger("notification:appear").addClass("appear"),m.focus&&r.attr("tabindex",1).focus()},_.device("touch")?300:0),r}}var f=/^(busy|error|info|success|warning|screenreader)$/,g={busy:1e4,error:3e4,info:1e4,success:4e3,warning:1e4,screenreader:5e3},h={error:"Error",info:"Info",success:"Success",warning:"Warning"},i={busy:"fa fa-refresh fa-spin",error:"fa fa-exclamation",info:"fa fa-exclamation",success:"fa fa-check",warning:"fa fa-exclamation"},j=null;return e.busy=function(b){e("busy",b+". "+a("This may take some seconds")+" ...")},e.done=function(){e("success",a("Done"))},e.close=function(){e("close")},e}),define("io.ox/core/notifications",["io.ox/core/extensions","io.ox/core/yell","settings!io.ox/core","gettext!io.ox/core"],function(a,b,c,d){"use strict";var e=Backbone.View.extend({tagName:"a",className:"notifications-icon f6-target",initialize:function(){this.model.set("a11y",""),this.model.on("change",_.bind(this.onChange,this)),this.nodes={}},onChange:function(){var a=this.model.get("count"),c=d.format(d.ngettext("%1$d notification.","%1$d notifications.",a),a);this.model.set("a11y",c,{silent:!0}),this.nodes.badge.toggleClass("empty",0===a),this.$el.attr("aria-label",c),this.nodes.number.text(_.noI18n(a>=100?"99+":a)),b("screenreader",c)},onToggle:function(a){this.nodes.icon.attr("class",a?"fa fa-caret-down":"fa fa-caret-right"),this.$el.attr({"aria-expanded":a?!0:!1})},render:function(){return this.$el.attr({href:"#",tabindex:"1",role:"button","aria-expanded":!1}).append(this.nodes.badge=$('<span class="badge">').append(this.nodes.number=$('<span class="number">'),$.txt(" "),this.nodes.icon=$('<i class="fa fa-caret-right">'))),this.onChange(),this},setNotifier:function(a){this.nodes.badge.toggleClass("active",!!a)},setCount:function(a,b){var c=a-this.model.get("count")-b;c>0?this.trigger("newNotifications"):b>0?this.trigger("newMailNotifications"):0===a&&this.model.get("count")>a&&this.trigger("lastItemDeleted"),this.model.set("count",a)}}),f=Backbone.View.extend({tagName:"div",id:"io-ox-notifications-display",initialize:function(a){a=a||{},this.subviews=a.subviews||{}},render:function(a){var b,c=this,e=!1,f=$(document.activeElement,c.$el),g=!0;if(c.$el.find(".no-news-message").remove(),f.hasClass("refocus")){var h=$("#io-ox-notifications .item"),i=f.closest(".item").attr("focus-id");if(void 0!==i)for(var j=0;j<h.length;j++){if(i===$(h[j]).attr("focus-id")){j+1<h.length&&(b=$(h[j+1]).attr("focus-id"));break}b=$(h[j]).attr("focus-id")}f=f.attr("focus-id"),e=!0}if(_.size(c.subviews)<_.size(a)&&_(a).each(function(a,b){void 0===c.subviews[b]&&(c.subviews[b]=new a.ListView({collection:a.collection}))}),_(c.subviews).each(function(a){a.$el.detach(),a.render(),a.collection.length>0&&(g=!1,c.$el.append(a.el))}),g&&c.$el.append($('<h1 class="section-title no-news-message">').text(d("No notifications"))),e){var k=c.$el.find('[focus-id="'+f+'"]');k.length>0?k.focus():(k=c.$el.find('[focus-id="'+b+'"]'),k.length>0?k.focus():$("#io-ox-notifications .refocus").first().focus())}return c}}),g=function(){this.notifications={},this.oldMailCount=0,this.badges=[],_.extend(this,Backbone.Events)};g.prototype={isOpen:function(){return this.nodes.main.hasClass("active")},toggle:function(){this.isOpen()?this.hide():this.show()},show:function(){if(!this.isOpen()){_.device("smartphone")&&$('[data-app-name="io.ox/portal"]:visible').addClass("notifications-open"),this.nodes.main.addClass("active"),this.nodes.overlay.addClass("active"),this.badgeView.onToggle(!0),$(document).on("keydown.notification",$.proxy(function(a){27!==a.which||this.nodes.overlay.prop("sidepopup")||($(document).off("keydown.notification"),this.hideList(),this.badgeView.$el.focus())},this));var a=$('#io-ox-notifications [tabindex="1"]').first();a.length>0?a.focus():this.badgeView.$el.focus(),this.trigger("show")}},hide:function(){this.isOpen()&&(_.each(this.badges,function(a){a.setNotifier(!1)}),this.nodes.main.removeClass("active"),this.nodes.overlay.empty().removeClass("active"),this.badgeView.onToggle(!1),_.device("smartphone")&&($('[data-app-name="io.ox/portal"]').removeClass("notifications-open"),this.nodes.overlay.empty().removeClass("active")),this.badgeView.$el.focus(),this.trigger("hide"))},toggleList:function(){this.toggle()},showList:function(){this.show()},hideList:function(){this.hide()},nodes:{main:$("<div>").attr({tabindex:-1,id:"io-ox-notifications"}),overlay:$("<div>").attr({id:"io-ox-notifications-overlay"}).addClass("abs notifications-overlay")},attach:function(b,g){function h(a){a=a||c.get("autoOpenNotification","noEmail"),j.badgeView.off("newNotifications newMailNotifications"),"always"===a?j.badgeView.on("newNotifications newMailNotifications",function(){j.showList()}):"noEmail"===a&&j.badgeView.on("newNotifications",function(){j.showList()})}function i(a){switch(a.which){case 13:_.defer(j.isOpen()?function(){j.badgeView.$el.focus()}:function(){var a=$('#io-ox-notifications [tabindex="1"]').first();a.length>0?a.focus():j.badgeView.$el.focus()});break;case 9:if(j.isOpen()&&!a.shiftKey){a.preventDefault();var b=$('#io-ox-notifications [tabindex="1"]').first();b.length>0&&b.focus()}}}var j=this;return this.badgeView=new e({model:new Backbone.Model({count:0})}),this.notificationsView=new f,$("#io-ox-core").prepend(j.nodes.main.append(this.notificationsView.el),j.nodes.overlay.click(function(a){a.target===this&&j.hideList()})),this.badges.push(this.badgeView),_.device("!smartphone")&&h(),c.on("change:autoOpenNotification",function(a,b){h(b)}),j.badgeView.on("lastItemDeleted",function(){j.nodes.overlay.children().length>0?j.nodes.overlay.prop("sidepopup").one("close",_.bind(j.slowClose,j)):j.hideList()}),setTimeout(function(){ox.manifests.loadPluginsFor("io.ox/core/notifications").done(function(){a.point("io.ox/core/notifications/register").invoke("register",j,j)})},g||2e3),b("right",j.badgeView.render().$el.on("keydown",i),$.proxy(this.toggleList,this)).attr({id:"io-ox-notifications-icon",role:"navigation","aria-label":d("Notifications")})},get:function(a,b){if(_.isUndefined(this.notifications[a])){var c={};c.ListView=b,c.collection=new Backbone.Collection,c.collection.on("add reset",_.bind(this.updateNotification,this)).on("remove",_.bind(this.delayedUpdate,this)),this.notifications[a]=c}return this.notifications[a]},slowClose:function(){this.nodes.overlay.off("mail-detail-closed"),this.hideList()},delayedUpdate:function(){var a=this;this.updateTimer||(this.updateTimer=setTimeout(function(){a.update(),a.updateTimer=void 0},100))},updateNotification:function(){_.each(this.badges,function(a){a.setNotifier(!0)}),this.delayedUpdate()},update:function(){var a=0,b=this;this.notificationsView.render(this.notifications);var c=_.reduce(this.notifications,function(c,d,e){return"io.ox/mail"===e&&(a=d.collection.size()-b.oldMailCount,b.oldMailCount=d.collection.size()),d.collection.size()>0?c+d.collection.size():c},0);_.each(this.badges,function(b){b.setCount(c||0,a),0===c&&b.setNotifier(!1)});var d=function(a){9===a.which&&a.shiftKey&&(a.preventDefault(),$("#io-ox-notifications-icon .notifications-icon").focus())},e=function(a){9!==a.which||a.shiftKey||(a.preventDefault(),$("#io-ox-refresh-icon .apptitle").focus())};this.lastItem&&(this.lastItem.off("keydown",d),this.lastItem=void 0),this.lastItem=this.notificationsView.$el.find('[tabindex="1"]').last(),this.lastItem.on("keydown",e),this.firstItem&&(this.firstItem.off("keydown",d),this.firstItem=void 0),this.firstItem=this.notificationsView.$el.find('[tabindex="1"]').first(),this.firstItem.on("keydown",d)},yell:b};var h=new g;return ox.on("app:start app:resume",function(){h.badgeView&&h.hideList()}),h}),define("io.ox/core/commons",["io.ox/core/extensions","io.ox/core/extPatterns/links","gettext!io.ox/core","io.ox/core/folder/api","io.ox/core/api/account"],function(a,b,c,d,e){"use strict";var f={showWindow:function(a){return function(){var b=$.Deferred();return a.show(b.resolve),b}},multiSelection:function(){var d={},e={};return a.point("io.ox/links/multi-selection").extend({id:"summary",index:100,draw:function(a){this.append($('<div class="summary">').html(c("<b>%1$d</b> elements selected",a.selection.length)))}}).extend({id:"links",index:200,draw:function(a){var c=$("<div>"),e=a.id,f=a.opt||{};(d[e]||(d[e]=new b.InlineLinks({id:"inline-links",ref:e+"/links/inline",dropdown:f.dropdown}))).draw.call(c,{data:a.selection,grid:a.grid}),this.append(c.children().first())}}),function(b,c,d,f,g,h){if(h=_.extend({},e,h||{}),d.length>1){var i=a.Baton({id:b,grid:g,selection:d,opt:h});c.idle().empty().append(function(){var b,c;return b=(f?$.createViewContainer(d,f):$("<div>")).on("redraw",function(){a.point("io.ox/links/multi-selection").invoke("draw",c.empty(),i)}).addClass("io-ox-multi-selection").append(c=$('<div class="box">')),a.point("io.ox/links/multi-selection").invoke("draw",c,i),b.center()})}}}(),simpleMultiSelection:function(a,b){var d=b.length;1>=d||a.idle().empty().append($('<div class="io-ox-center multi-selection-message">').append($("<div>").text(c.format(c.ngettext("%1$d item selected","%1$d items selected",d),d))))},mobileMultiSelection:function(){function b(b,d,e){var f=$("<div>");return a.point("io.ox/core/commons/mobile/multiselect").invoke("draw",f,{count:d.length}),(c[b]||(c[b]=a.point(b+"/mobileMultiSelect/toolbar"))).invoke("draw",f,{data:d,grid:e}),f}var c={};return a.point("io.ox/core/commons/mobile/multiselect").extend({id:"selectCounter",index:"100",draw:function(a){this.append($('<div class="toolbar-button select-counter">').text(a.count))}}),function(a,c,d,e,f){var g,h=$(c).closest(".window-container"),i=$(".window-toolbar .toolbar-button",h),j=$(".window-toolbar",h),k="multi-select-toolbar";g=$("#"+k).length>0?$("#"+k):$("<div>",{id:k}),_.defer(function(){d.length>0?(i.hide(),$("#"+k).remove(),j.append(g.append(b(a,d,f)))):($("#"+k).remove(),i.show())},10)}}(),wireGridAndSelectionChange:function(a,b,d,e,g,h){var i,j="";a.selection.on("change",function(k,l){function m(){var a=e.parent();1>=n&&i?a.attr("aria-label",_.escape(i)):n>1&&(i=i||a.attr("aria-label"),a.attr("aria-label",c("Selection Details")))}var n=l.length,o=JSON.stringify(_([].concat(l)).map(function(a){return{folder_id:String(a.folder_id||a.folder),id:String(a.id),recurrence_position:String(a.recurrence_position||0)}}));if(o!==j){if(1===n)e.css("height",""),d(l[0]);else if(n>1)d.cancel&&d.cancel(),e.css("height","100%"),h?f.simpleMultiSelection(e,this.unique(this.unfold())):f.multiSelection(b,e,this.unique(this.unfold()),g,a);else if(d.cancel&&d.cancel(),e.css("height","100%").idle().empty().append($('<div class="io-ox-center">').append($('<div class="io-ox-multi-selection">').append($('<div class="summary empty">').text(c("No elements selected"))))),_.device("small")){var p=e.closest(".vsplit");p.hasClass("vsplit-reverse")||p.find(".rightside-navbar a>i").last().trigger("click")}m(),j=o}}),a.selection.on("_m_change",function(){f.mobileMultiSelection(b,e,this.unique(this.unfold()),g,a)}),g&&g.on("change:id",function(b,c,d){var e=a.selection.get();e.length&&e[0].id===d&&a.selection.set({id:c.id,folder_id:c.folder_id})})},wireGridAndAPI:function(a,b,c,d){a.setAllRequest(function(){return b[c||"getAll"]({folder:this.prop("folder")})}),a.setListRequest(function(a){return b[d||"getList"](a)}),b.on("beforedelete",function(b,c){a.selection.removeFromIndex(c);var d,e=a.selection.get();e.length>0&&(_.device("small")?a.selection.clear(!0):(d=a.selection.getIndex(e[0]),a.selection.clear(!0).selectIndex(d+1),a.getIds().length===e.length&&a.selection.trigger("change",[])))})},wireGridAndWindow:function(a,b){var c=0,d=function(){a.keyboard(!0),a.selection.get().length&&a.selection.retriggerUnlessEmpty()};a.setApp(b.app),b.on("show idle",d).on("hide busy",function(){a.keyboard(!1)}).on("beforeshow",function(){null!==c&&a.scrollTop(c)}).on("beforehide",function(){c=a.scrollTop()}),b.app&&(b.app.getGrid=function(){return a}),b.state.visible&&d()},addGridToolbarFolder:function(b,e){function f(){var a=b.getWindow&&b.getWindow().state.visible;return a?e.getToolbar().find(".grid-info"):$()}function g(a){if(a){var b=f();b.empty().attr("data-folder-id",a).append($('<span class="folder-name">'),$.txt(" "),$('<span class="folder-count">')),d.get(a).done(function(b){var c=i?e.getIds().length:b.total,d=e.getToolbar().find('[data-folder-id="'+a+'"]');e.getContainer().attr("aria-setsize",c),e.meta={total:c,title:b.title},e.trigger("meta:update"),d.find(".folder-name").text(b.title),c>0&&d.find(".folder-count").text("("+c+")")})}}a.point(b.get("name")+"/vgrid/toolbar").extend({id:"info",index:200,draw:function(){this.append($('<div class="grid-info">'))}});var h=b.get("name"),i="io.ox/mail"!==h;e.on({"change:prop:folder change:mode change:ids":function(){var a=e.prop("folder"),b=e.getMode();if("all"===b)g(a);else if("search"===b){var d=f();d.find(".folder-name").text(c("Results")),d.find(".folder-count").text("("+e.getIds().length+")")}}}),d.on("update:total",function(a,c){c===b.folder.get()&&g(c)}),a.point(b.get("name")+"/vgrid/toolbar").invoke("draw",e.getToolbar()),$.when(b.folder.initialized,b.getWindow().shown).done(function(a){g(a[0])})},wireFirstRefresh:function(a,b){ox.serverConfig.persistence!==!1&&a.getWindow().on("open",function(){b.needsRefresh(a.folder.get())&&b.trigger("refresh^",a.folder.get())})},wireGridAndRefresh:function(a,b,c){var d=function(){a.refresh(!0),_.device("smartphone")&&a.selection.retrigger()},e=function(){a.repaint(),a.selection.retrigger()},f=function(){a.pending()},g=function(){b.off("refresh.all refresh:all:local",d).off("refresh.pending",f).off("refresh.list",e)},h=function(){g(),b.on("refresh.all refresh:all:local",d).on("refresh.pending",f).on("refresh.list",e).trigger("refresh.all")};c.on({show:h,hide:g}),c.state.visible&&h()},wireGridAndSearch:function(a,b,c){a.setAllRequest("search",function(){var b={sort:a.prop("sort"),order:a.prop("order")};return c.query(!0,b).then(function(a){var b=a&&a.results?a.results:[];return b})}),a.setListRequest("search",function(a){var b=[a];return $.Deferred().resolveWith(this,b)}),b.on({"search:query":function(){a.setMode("search")},"search:clear search:cancel":function(){"all"!==a.getMode()&&a.setMode("all")}})},wirePerspectiveEvents:function(a){var b=a.getWindow(),c=null;b.on("show",function(){c=b.currentPerspective,b.currentPerspective&&a.trigger("perspective:"+b.currentPerspective+":show")}),b.on("hide",function(){c=b.currentPerspective,b.currentPerspective&&a.trigger("perspective:"+b.currentPerspective+":hide")}),b.on("change:perspective",function(b,d){c&&a.trigger("perspective:"+c+":hide"),c=d,a.trigger("perspective:"+d+":show")}),b.on("change:initialPerspective",function(b,d){c=d,a.trigger("perspective:"+d+":show")})},addFolderSupport:function(a,b,c,d){function f(b){return a.folder.set(b).then(null,function(){return a.folder.setDefault()})}return a.folder.updateTitle(a.getWindow()).setType(c),b&&a.folder.updateGrid(b),a.getWindow().on("show",function(){b&&b.selection.retriggerUnlessEmpty(),_.url.hash("folder",a.folder.get())
}),d=_.url.hash("folder")||d,void 0!==d?f(d):"mail"===c?e.getUnifiedInbox().then(function(b){return null===b?a.folder.setDefault():f(b)}):a.folder.setDefault()},addPropertyCaching:function(a,b){function c(a,b){var c,d=a===f.keyprop&&"undefined"!=typeof b&&b!==e(f.keyprop);d&&(c=e(f.keyprop),c&&(h.remove(c),_.each(f.props,function(a){h.set(c,a,e(a))})))}a=a||{prop:$.noop()};var d={},e=a.prop,f=$.extend({keyprop:"folder",props:["sort","order"]},b||{}),g={},h={set:function(a,b,c){g[a]=g[a]||{},g[a][b]=c},get:function(a,b){return b?(g[a]||{})[b]:g[a]||{}},remove:function(a){g[a]={}},clear:function(){g={}}};f.props=[].concat(f.props),_.each(f.props,function(a){d[a]=!0}),_.isUndefined(a.propcache)&&(a.propcache=function(a,b,c){return c=c||e(f.keyprop),d[a]?h.get(c,a)||b:b},a.prop=function(b,d){return c(b,d),e.call(a,b,d)})},addGridFolderSupport:function(a,b){a.folder.updateGrid(b),a.getWindow().on("show",function(){b.selection.retriggerUnlessEmpty()})},addFolderView:function(a,b){ox.debug&&console.warn("Deprecated: common.addFolderView()",a,b)},vsplit:function(){var a=!1,b=function(b){b.preventDefault(),a&&(a=!1),$(this).parent().find(".rightside-inline-actions").empty(),$(this).closest(".vsplit").addClass("vsplit-reverse").removeClass("vsplit-slide"),b.data.app&&b.data.app.getGrid&&(_.device("small")&&b.data.app.getGrid().selection.trigger("changeMobile"),b.data.app.getGrid().selection.clear())},d=function(){var b=$(this);a=!0,setTimeout(function(){a&&(b.closest(".vsplit").addClass("vsplit-slide").removeClass("vsplit-reverse"),a=!1)},100)};return function(a,e){var f={};return a.addClass("vsplit").append(f.left=$('<div class="leftside">').attr({role:"navigation","aria-label":c("Item list")}).on("select",d),$('<div class="rightside-navbar">').append($('<div class="rightside-inline-actions">'),$('<a href="#" tabindex="-1">').append($('<i class="fa fa-chevron-left">'),$.txt(" "),$.txt(c("Back"))).on("click",{app:e},b)),f.right=$('<div class="rightside">')),f}}(),mediateFolderView:function(b,d){function e(a){a.preventDefault(),a.data.app.folderView.toggle(a.data.state)}function f(a){a.getWindow().nodes.main.find(".vgrid").removeClass("bottom-toolbar")}function g(a){a.getWindow().nodes.main.find(".vgrid").addClass("bottom-toolbar")}a.point(b.get("name")+"/vgrid/second-toolbar").extend({id:"default",index:100,draw:function(){this.addClass("visual-focus").append($('<a href="#" class="toolbar-item" tabindex="1">').attr("title",c("Open folder view")).append($('<i class="fa fa-angle-double-right">')).on("click",{app:b,state:!0},e))}});var h,i=b.getWindow().nodes.sidepanel;d?(i.addClass("bottom-toolbar"),h=i):(i.find(".foldertree-container").addClass("bottom-toolbar"),h=i.find(".foldertree-sidepanel")),h.append($('<div class="generic-toolbar bottom visual-focus">').append($('<a href="#" class="toolbar-item" role="button" tabindex="1">').append($('<i class="fa fa-angle-double-left" aria-hidden="true">'),$('<span class="sr-only">').text(c("Close folder view"))).on("click",{app:b,state:!1},e))),b.on({"folderview:open":f.bind(null,b),"folderview:close":g.bind(null,b)});var j=b.getGrid(),k=j.getTopbar();a.point(b.get("name")+"/vgrid/second-toolbar").invoke("draw",k,a.Baton({grid:j})),g(b),b.folderViewIsVisible()&&_.defer(f,b)}},g=$.cleanData,h=function(a){$(a).triggerHandler("dispose")};$.cleanData=function(a){return _(a).map(h),g.call(this,a)},$.createViewContainer=function(b,c,e){var f=b instanceof a.Baton?b.data:b,g=_.cid(f),h=_.ecid(f),i="recurrence_position"in f?_.ecid({id:f.id,folder:f.folder_id||f.folder}):null,j=$("<div>").attr("data-cid",_([].concat(f)).map(_.cid).join(",")),k=function(d,g){g&&(g.former_id||g.id!==f.id)&&(f=g),(e=e||(c?c.get:null))&&(f.id||(f.id=arguments[1].id),e(c.reduce(f)).done(function(c){b instanceof a.Baton?b.data=c:b=c,j&&j.triggerHandler("redraw",b)}))},l=function(a,b){f&&(f.folder_id=b),k&&k()},m=_.debounce(function(){j&&j.triggerHandler("redraw",b)},10),n=function(){j&&j.trigger("view:remove").remove()},o=function(a,b){b===a.data.folder.toString()&&c&&c.trigger("update:"+a.data.cid)};return _.isArray(f)?(d.on("update",m),c.on("delete update",m)):(d.on("update",{cid:g,folder:f.folder_id},o),c.on("delete:"+h,n),c.on("create update:"+h+(i?" update:"+i:""),k),c.on("move:"+h,l)),j.one("dispose",function(){_.isArray(f)?(d.off("update",m),c.off("delete update",m)):(d.off("update",o),c.off("delete:"+h,n),c.off("create update:"+h+(i?" update:"+i:""),k),c.off("move:"+h,l)),c=k=f=j=e=g=h=null})},$.fail=function(a,b){var d=$("<div>").addClass("io-ox-fail").append($("<span>").text(a));return b&&d.append($("<span>").text(" ")).append($("<a>",{href:"#"}).text(c("Retry")).on("click",function(a){a.preventDefault(),$(this).closest(".io-ox-center").remove(),b.apply(this,arguments)})),d.center()};var i=_.device("macos"),j='[tabindex]:not([tabindex^="-"]):visible';return $(document).on("keydown.f6",function(a){if(117===a.which&&(i||a.ctrlKey)){a.preventDefault();var b,c=$("#io-ox-core .f6-target:visible"),d=$(document.activeElement).closest(".f6-target"),e=c.index(d)||0,f=e;do{if(f+=a.shiftKey?-1:1,f>=c.length&&(f=0),0>f&&(f=c.length-1),b=c.eq(f),b.is(j)){b.focus();break}if(b=b.find(j).first(),b.length){b.focus();break}}while(e!==f)}}),f}),define("io.ox/core/upsell",["io.ox/core/capabilities","settings!io.ox/core","gettext!io.ox/core"],function(a,b,c){"use strict";function d(a,b){console.debug("upsell:requires-upgrade",b),require(["io.ox/core/tk/dialogs"],function(a){(new a.ModalDialog).build(function(){this.getHeader().append($("<h4>").text(c("Upgrade required"))),this.getContentNode().append($.txt(c("This feature is not available. In order to use it, you need to upgrade your account now.")),$.txt(" "),$.txt(c("The first 90 days are free."))),this.addPrimaryButton("upgrade",c("Get free upgrade")),this.addButton("cancel",c("Cancel"))}).setUnderlayStyle({opacity:.7,backgroundColor:"#08C"}).on("upgrade",function(){ox.trigger("upsell:upgrade",b)}).on("show",function(){ox.off("upsell:requires-upgrade",d)}).on("close",function(){ox.on("upsell:requires-upgrade",d)}).show()})}function e(a,b){console.debug("upsell:upgrade",b),alert("User decided to upgrade! (global event: upsell:upgrade)")}var f=b.get("upsell/enabled")||{},g={},h={},i={trigger:function(a){ox.trigger("upsell:requires-upgrade",a||{})},click:function(a){a.preventDefault(),i.trigger()},any:function(a){return a?_([].concat(a)).reduce(function(a,b){return a||void 0===b||i.has(b)},!1):!0},missing:function(a){return a?_([].concat(a)).chain().filter(function(a){return!i.has(a)}).flatten().value().join(" "):""},has:function(b){return b?b in g?g[b]:g[b]=a.has(b):!0},visible:function(a){return a?_([].concat(a)).reduce(function(a,b){return a||void 0===b||i.enabled(b)||i.has(b)},!1):!0},enabled:function(){function a(a,b){return a&&b in f}function b(b){return _.isString(b)?b in h?h[b]:h[b]=_(b.split(" ")).reduce(a,!0):!1}function c(a,c){return a||b(c)}return function(a){return a?_([].concat(a)).reduce(c,!1):!0}}(),captureRequiresUpgrade:function(){ox.on("upsell:requires-upgrade",d),i.captureRequiresUpgrade=$.noop},captureUpgrade:function(){ox.on("upsell:upgrade",e),i.captureUpgrade=$.noop},useDefaults:function(){i.captureRequiresUpgrade(),i.captureUpgrade()},debug:function(){console.debug("enabled",f,"capabilityCache",g,"enabledCache",h)},demo:function(a){var b=f,c=g;b.portal=b.webmail=b.contacts=b.calendar=b.infostore=b.tasks=b.publication=b.subscription=!0,c.portal=c.webmail=c.contacts=!0,c.calendar=c.infostore=c.tasks=!1,c.publication=c.subscription=!1,console.debug("Disabled inline actions regarding calendar, tasks, and files; enabled upsell instead"),a||(i.useDefaults(),require(["io.ox/portal/widgets"],function(a){a.containsType("upsell")||(a.addPlugin("plugins/portal/upsell/register"),a.add("upsell",{color:"gray",inverse:!0}),console.debug("Added upsell widget to portal"))}))},setEnabled:function(a){f[a]=!0}};return function(){var a=_.url.hash("demo")||"";a.indexOf("upsell")>-1&&i.demo()}(),i}),define("io.ox/core/ping",["io.ox/core/http","settings!io.ox/core"],function(a,b){"use strict";function c(){!ox.session||"unset"===ox.session||!ox.online||_.device("phantomjs || karma")||_.now()-ox.t0<1e4||a.ping()}function d(){j&&clearInterval(j)}function e(){"normal"!==i&&(d(),i="normal",ox.reachable=!0,ox.trigger("reachableChange"),g&&(c(),j=setInterval(c,1e3*h)))}function f(){"hectic"!==i&&(d(),ox.reachable=!1,ox.trigger("reachableChange"),i="hectic",c(),j=setInterval(c,200*h))}var g=b.get("ping/enabled",!1),h=b.get("ping/interval",30),i="none",j=null;a.on("unreachable",f),a.on("reachable",e),e()}),define("io.ox/core/relogin",["io.ox/core/session","io.ox/core/notifications","gettext!io.ox/core","settings!io.ox/core"],function(a,b,c,d){"use strict";function e(e,h,i,j){ox.online&&(g?h&&i&&f.push({request:h,deferred:i}):(f=h&&i?[{request:h,deferred:i}]:[],g=!0,require(["io.ox/core/tk/dialogs"],function(e){new e.ModalDialog({easyOut:!1,async:!0,width:400,enter:"relogin"}).build(function(){this.getPopup().addClass("relogin"),this.getHeader().append($("<h4>").text(c(j&&"SES-0205"===j.code?"Your IP address has changed":"Your session is expired")),$("<div>").text(c("Please sign in again to continue"))),this.getContentNode().append($("<label>").text(c("Password")),$('<input type="password" name="relogin-password" class="form-control">'))}).addPrimaryButton("relogin",c("Sign in")).addAlternativeButton("cancel",c("Cancel")).on("cancel",function(){ox.trigger("relogin:cancel");var a=d.get("customLocations/logout"),b=a||ox.serverConfig.logoutLocation||ox.logoutLocation||"";b=b.replace("[hostname]",window.location.hostname),_.url.redirect(b)}).on("relogin",function(){var d=this.busy();a.login(ox.user,this.getContentNode().find("input").val(),ox.secretCookie).then(function(){b.yell("close"),d.getContentNode().find("input").val(""),d.close();for(var a,c=0,e=require("io.ox/core/http");a=f[c];c++)a.request.noRetry||e.retry(a.request).done(a.deferred.resolve).fail(a.deferred.fail);g=!1,ox.trigger("relogin:success")},function(a){"LGI-0006"===a.code&&(a.error=c("Please enter correct password")),b.yell({headline:c("Failed to sign in"),type:"error",message:a.error}),d.idle(),d.getContentNode().find("input").focus().select(),ox.trigger("relogin:fail",a)})}).show(function(){this.find("input").focus()})})))}var f=[],g=!1;return ox.off("relogin:required",ox.relogin),ox.on("relogin:required",e),e}),define("io.ox/core/uuids",function(){"use strict";function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}return{randomUUID:b}}),define("io.ox/core/extPatterns/links",["io.ox/core/extensions","io.ox/core/collection","io.ox/core/extPatterns/actions","gettext!io.ox/core"],function(a,b,c,d){"use strict";function e(a){a.preventDefault();var b=a.data.extension,d=a.data.baton;d.e=a,c.invoke(b.ref,b,d)}function f(a){var b="";a.children("li").each(function(){var a=$(this),c=a.children("a").attr("data-section");void 0!==c&&(""!==b&&b!==c&&a.before('<li class="divider" role="presentation">'),b=c)})}var g=c.Action,h=function(b){_.extend(this,b);var d=this,e=function(a){a.preventDefault();var b=$(this),d=b.data("baton"),e=b.data("ref");d.e=a,c.invoke(e,this,d,a),_.defer(function(){b.tooltip("hide")})},f=function(a){var c=_.device("small")?d.mobile:d.prio,e=d.icon&&a.options.icons!==!1,f=$("<a>").addClass(d.cssClasses||"io-ox-action-link").attr({href:"#",tabindex:1,"data-action":d.id,draggable:b.draggable||!1,role:"menuitem",title:d.title||d.label||"","data-section":d.section||"default","data-prio":_.device("small")?d.mobile||"none":d.prio||"lo","data-ref":d.ref});return!b.draggable&&_.device("firefox")&&f.attr("ondragstart","return false;"),f.append(e&&"hi"===c&&$("<i>").addClass(d.icon)||d.label&&$.txt(d.label)||$()),e&&f.addClass("no-underline"),(!_.device("smartphone")&&e&&d.label||d.title)&&f.attr({"data-toggle":"tooltip","data-placement":"bottom","data-animation":"false","data-container":"body","aria-label":d.label?null:d.title||null}).tooltip().on("dispose",function(){$(this).tooltip("hide")}),f};this.draw=this.draw||function(b){b=a.Baton.ensure(b);var c=f(b);this.append(c.data({ref:d.ref,baton:b}).click(e)),d.customize&&d.customize.call(c,b)},this.drawDisabled===!0&&(this.drawDisabled=function(a){var b=f(a);this.append(b.tooltip("destroy").addClass("disabled").attr({"aria-disabled":!0}).removeAttr("href")),d.customize&&d.customize.call(b,a)})},i=function(b,c){c=c||{},c=_.extend({ref:b+"/"+c.id,draw:function(b){b=a.Baton.ensure(b),this.append($("<li>").attr({role:"presentation"}).append($("<a>").attr({"data-action":c.ref,role:"menuitem",href:"#",tabindex:1}).text(c.label).on("click",{baton:b,extension:c},e)))}},c),a.point(b).extend(c)},j=function(b){_.extend(this,b);var d,e=this,f=b.tagtype?b.tagtype:"a",g=function(a){if(d.hasClass("io-ox-busy"))return!1;a.preventDefault();var b=a.data.extension;a.data.baton.e=a,c.invoke(b.ref,b,a.data.baton)};this.draw=function(b){b=a.Baton.ensure(b);var c={href:"#",role:"button","class":"btn btn-default","data-action":e.id,tabindex:e.tabIndex};"button"===f&&(c.type="button"),this.append(d=$("<"+f+">",c).addClass(e.cssClasses).css(e.css||{}).on("click",{extension:e,baton:b},g).append(_.isString(e.label)?$.txt(e.label):$()).append(_.isString(e.icon)?$("<i>").addClass(e.icon):$()))},this.busy=function(){d.busy()},this.idle=function(){d.idle()}},k=function(a,b,d,e){return c.applyCollection(a.ref,b,d,e)},l=function(b,c,d,e,f,g){e=a.Baton.ensure(e);var h=e.$el||$('<ul class="list-unstyled" role="menubar">').addClass(b.classes||"").attr(b.attributes||{}).appendTo(d);return k(b,c,e,f).always(function(a){var b=0;_(a).each(function(a){var c=a.link;a.state===!1?_.isFunction(c.drawDisabled)&&(c.drawDisabled.call(g?$('<li role="presentation">').appendTo(h):h,e),b++):_.isFunction(c.draw)&&(c.draw.call(g?$('<li role="presentation">').appendTo(h):h,e),b++)}),0===b&&h.addClass("empty")}).then(function(){return h})},m=function(b,c,d,e,f,g){e=a.Baton.ensure(e);var h=$('<div class="btn-group">'),i=$('<nav role="presentation">').append(h).appendTo(d);return b.attributes&&i.attr(b.attributes),b.classes&&i.addClass(b.classes),k(b,c,e,f).always(function(a){var b=0;_(a).each(function(a){var c=a.link;a.state===!1?_.isFunction(c.drawDisabled)&&(c.drawDisabled.call(g?$("<li>").appendTo(h):h,e),b++):_.isFunction(c.draw)&&(c.draw.call(g?$("<li>").appendTo(h):h,e),b++)}),0===b&&h.addClass("empty")}).then(function(){return h})},n=function(c){var d=_.extend(this,c);this.draw=function(c){var e=$.makeArray(arguments);c=a.Baton.ensure(c),l(d,new b(c.data),this,c,e)}},o=function(c){var d=_.extend(this,c);this.draw=function(c){var e=$.makeArray(arguments);c=a.Baton.ensure(c),l(d,new b(c.data),this,c,e),this.children("a").addClass("btn btn-primary"),this.children(".dropdown").children("a").addClass("btn btn-primary")}},p=function(c){function e(a,b){var c=_.isArray(a.data)&&a.data.length>1,e=b.children(),h=e.children().filter('[data-prio="lo"]').parent(),i=h.find("a"),j=i.length===i.filter(".disabled").length,k=_.device("small");if(k&&e.children().filter('[data-prio="none"]').parent().remove(),h.length>1&&!j&&(!c||g.dropdown===!0)&&g.dropdown!==!1){var l;b.append($('<li class="dropdown">').append(l=$("<a>").addClass("actionlink").attr({href:"#",tabindex:1,draggable:!1,role:"menuitem","data-toggle":"dropdown","data-action":"more","aria-haspopup":!0,"aria-label":d(k?"Actions":"More")}).append(k?$.txt(d("Actions")):$('<span class="sr-only">'+d("Actions")+'</span><i aria-hidden="true" class="fa fa-bars">'),$('<i aria-hidden="true" class="fa fa-caret-down">')).on(Modernizr.touch?"touchstart":"click",function(){var a=$(this).parent().position().left;$(this).next().attr("class","dropdown-menu"+(200>a?"":" pull-right"))}),$('<ul class="dropdown-menu pull-right" role="menu">').attr("aria-label",d(k?"Actions":"More")).append(h))),_.device("firefox")&&l.attr("ondragstart","return false;"),l.dropdown(),f(b.find("ul"))}j&&h.hide(),g.customizeNode&&g.customizeNode(b),g.customize&&g.customize.call(b,a),a.$.positionDummy&&(a.$.positionDummy.before(b.children()),a.$.positionDummy.remove(),delete a.$.positionDummy),e=h=null}var g=_.extend(this,{classes:"io-ox-inline-links",attributes:{"aria-label":d("Inline menu %1$s",c.title||"")}},c);this.draw=function(c){c=a.Baton.ensure(c),c.$el&&(c.$.temp=$("<div>"),c.$.positionDummy=$('<div class="position-dummy">').hide(),c.$el.append(c.$.positionDummy));var d=l(g,new b(c.data),c.$.temp||this,c,$.makeArray(arguments),!0).done(_.lfo(!0,e,c));return delete c.$.temp,delete c.$el,d}},q=function(c){var d=_.extend(this,{classes:"io-ox-inline-buttongroup"},c);this.draw=function(e){e=a.Baton.ensure(e),m(d,new b(e.data),this,e,$.makeArray(arguments)).done(function(a){c.customizeNode&&c.customizeNode(a)})}},r=function(a,c,d){var e,g=this.data("ul");g&&(g.find('[data-action="close-menu"]')&&(e=g.find('[data-action="close-menu"]').parent().clone(!0)),c.$el=g.empty(),e&&c.$el.append(e),l(a,new b(c.data),null,c,d,!0).done(function(){f(c.$el),_.device("smartphone")&&c.$el.find('[data-prio="none"]').closest("li").remove()}))},s=function(a){var b=a.data.baton;b.data=b.model?b.model.toJSON():b.data,b.options.icons=!1,r.call($(this),a.data.options,b,a.data.args)},t=function(a,b){var c,d,e=b.label||a.label,f=$.makeArray(arguments),g=b.$el||$("<div>");return e=_.isString(e)?$.txt(e):e,this.append(g.addClass("dropdown").append(d=$('<a href="#" role="button" tabindex="1">').attr({"data-toggle":"dropdown","aria-haspopup":!0,"aria-label":a.ariaLabel?a.ariaLabel:e.textContent}).append(a.icon?$("<i>").addClass(a.icon).attr({title:e.textContent,"aria-hidden":!0}):e,a.noCaret?$():$('<i class="fa fa-caret-down">').attr({"aria-hidden":!0})),c=$('<ul class="dropdown-menu" role="menu">'))),d.dropdown(),g.data("ul",c),b.model?g.on("show.bs.dropdown",{options:a,baton:b,args:f},s):_.defer(r.bind(g),a,b,f),a.classes&&g.addClass(a.classes),a.attributes&&g.attr(a.attributes),g},u=function(b){var c=_.extend(this,b);this.draw=function(b){return b=a.Baton.ensure(b),t.call(this,c,b)}},v=function(a,c,d){a=a||{},c.$el=$('<ul class="dropdown-menu" role="menu">');var d=void 0===a.wrap?!0:!!a.wrap;return l(a||{},new b(c.data),null,c,[],d).done(function(){a.emptyCallback&&c.$el.hasClass("empty")&&a.emptyCallback(),f(c.$el)}),c.$el},w=function(a,c){var d=$.makeArray(arguments),e=$("<div>").addClass("btn-group").addClass(a.classes).attr("data-toggle",a.radio?"buttons-radio":"").appendTo(this),f=e;return l(a,new b(c.data),f,c,d,!1),e},x=function(b,c){var d=c||{};d.ref=b+"/"+d.id,a.point(b).extend(_.extend({ref:d.ref,draw:function(b){b=a.Baton.ensure(b),w.call(this,d,b)}},d))},y=function(){function c(a){a.preventDefault()}function d(a,d){var f,g,h,i=$.makeArray(arguments),j=[];return this.append(h=$('<li class="toolbar-button dropdown">').append(f=$('<a href="#" data-toggle="dropdown" title="" tabindex="1">').attr("data-ref",a.ref).addClass(a.addClass).append(a.icon()),g=$('<ul class="dropdown-menu dropdown-right-side" role="menu">'))),k(a,new b(d.data),d,i).then(function(a){return _.chain(a).filter(function(a){return a.state}).pluck("link").value()}).done(function(b){b.length>1?(_(b).chain().filter(function(a){return _.isFunction(a.draw)}).each(function(a){j.push(a.label),a.draw.call(g,d)}),f.attr({title:a.label||j.join(", "),"aria-label":a.label||j.join(", "),role:"menuitem","aria-haspopup":!0}),h.attr("role","toolbar"),a.label&&g.append($('<li class="dropdown-footer">').text(a.label))):(f.removeAttr("data-toggle"),g.remove(),1===b.length?(f.attr({title:b[0].label||"","aria-label":b[0].label||"",role:"menuitem",tabindex:1,"data-animation":"false","data-placement":"right","data-container":"body"}).on("click",{baton:d,extension:b[0]},e),_.device("touch")||f.tooltip()):f.addClass("disabled").removeAttr("tabindex").attr({"aria-disabled":!0}).on("click",c))})}function f(){return $('<i class="fa fa-magic">')}return function(b,c){c=c||{},c=_.extend({ref:b+"/"+(c.id||"default"),icon:f,draw:function(b){b=a.Baton.ensure(b),d.call(this,c,b)}},c),a.point(b).extend(c)}}();return{Action:g,Link:h,Button:j,ActionLink:i,ToolbarButtons:o,ToolbarLinks:n,InlineLinks:p,InlineButtonGroup:q,Dropdown:u,DropdownLinks:v,ButtonGroup:x,ActionGroup:y}}),define("io.ox/core/adaptiveLoader",["io.ox/core/extensions","io.ox/core/capabilities","settings!io.ox/core"],function(a,b,c){"use strict";var d;if(localStorage&&b.has("lab:adaptiveLoading")){var e=_(ox.serverConfig.capabilities).pluck("id").sort().join(","),f=c.get("language"),g=c.get("theme");d={log:function(){console.log.apply(console,arguments)},listen:function(a){d.log("listen",a),d.cache||d.init(),d.currentChunk=a,d.modules=d.cache[a]||[]},startAndLoad:function(a){return d.log("startAndLoad",a),d.cache||d.init(),d.listen(a),d.cache[a]?require(d.cache[a]):void 0},startAndEnhance:function(a,b){return d.log("startAndEnhance",a,b),d.cache||d.init(),d.listen(a),d.cache[a]&&_(d.cache[a]).each(function(a){_(b).contains(a)||b.push(a)}),d.log("enhanced",b),b},stop:function(){d.log("stop",d.currentChunk),d.cache||d.init(),d.currentChunk&&(d.cache[d.currentChunk]=_.uniq(d.modules),d.log(d.cacheKey,d.cache),localStorage.setItem(d.cacheKey,JSON.stringify(d.cache)),delete d.modules,delete d.currentChunk)},record:function(a){return d.log("record",a),d.cache||d.init(),setTimeout(function(){d.currentChunk===a&&d.stop()}),d.listen(a)},init:function(){d.log("init"),d.cacheKey="ox-adaptiveload-"+ox.base+"["+(ox.user||"anon")+"]["+e+"]["+f+"]["+g+"]",d.cache=JSON.parse(localStorage.getItem(d.cacheKey)),d.cache||(d.cache={}),d.log("cache",d.cache),$(window).on("require:require",function(a,b){d.modules&&d.modules.push(b.replace(/\.js$/,"")),d.dirty||(d.dirty=!0,setTimeout(function(){d.currentChunk&&(d.cache[d.currentChunk]=_.uniq(d.modules),d.log(d.cacheKey,d.cache),localStorage.setItem(d.cacheKey,JSON.stringify(d.cache))),d.dirty=!1},3e3))})}}}else d={listen:$.noop,startAndLoad:function(){return $.Deferred().resolve()},startAndEnhance:function(a,b){return b},stop:$.noop,record:$.noop,init:$.noop};return d}),define("io.ox/core/tk/dialogs",["io.ox/core/event","gettext!io.ox/core","less!io.ox/core/tk/dialog"],function(a,b){"use strict";function c(){return $('<div class="abs io-ox-dialog-underlay">').hide()}function d(){return $('<div class="io-ox-dialog-popup" tabindex="-1" role="dialog" aria-labelledby="dialog-title">').hide().append($('<div class="modal-header" id="dialog-title">'),$('<div class="modal-body">'),$('<div class="clearfix">'),$('<div class="modal-footer">'))}var e=function(b){var e=_.extend({width:500,underlayAction:null,defaultAction:null,easyOut:!0,center:!0,async:!1,noBusy:!1,maximize:!1,top:"50%",container:$("#io-ox-core"),tabTrap:!0,focus:!0},b),f={buttons:[],underlay:c(),popup:d(),wrapper:$('<div class="abs io-ox-dialog-wrapper">')},g=$(),h=$(),i=$.Deferred(),j=!1,k=this,l={},m=function(a){var b=$(a.target).closest(".io-ox-dialog-popup, .io-ox-sidepopup, .mce-window").length>0;b||f.popup.is(":visible")&&(a.stopPropagation(),f.popup.focus())},n=function(){if(k){e.container.removeClass("blockscroll"),k.trigger("close"),document.removeEventListener("focus",m,!0),f.popup.empty().remove(),f.underlay.remove(),f.wrapper.remove(),g=g.closest(":visible"),e.focus&&(g.hasClass("dropdown")?g.children().first().focus():g.focus()),k.events.destroy();for(var a in k)delete k[a];k.close=k.idle=$.noop,f.header=f.body=f.footer=f.underlay=f.wrapper=null,f.buttons=g=h=null,f=i=k=l=e=null}},o=function(){f.footer.find("input, select, button").add(f.body.css("opacity",.5).find("input, select, button, textarea")).each(function(a,b){b=$(b),_.isUndefined(b.data("wasDisabled"))&&(b.data("wasDisabled",b.prop("disabled")),b.prop("disabled",!0))}),h=$(document.activeElement),f.popup.focus(),j=!0},p=function(){f.footer.find("input, select, button").add(f.body.css("opacity","").find("input, select, button, textarea")).each(function(a,b){b=$(b),_.isUndefined(b.data("wasDisabled"))||(b.prop("disabled",b.data("wasDisabled")),b.removeData("wasDisabled"))}),h.focus(),j=!1},q=function(a){var b=a.data?a.data.action:a,c=e.async&&"cancel"!==b;c&&!e.noBusy&&o(),k.trigger("action "+b,l,k),!c&&k&&(i.resolveWith(f.popup,[b,l,k.getContentNode().get(0)]),n()),_.isObject(a)&&!_.browser.Safari&&(a.processed=!0)},r=function(a){var b,c,d;switch(a.which||a.keyCode){case 27:j||(a.stopPropagation(),e.easyOut&&q("cancel"));break;case 13:if(!j&&$(a.target).is("input:text, input:password"))return e.enter?_.isFunction(e.enter)?e.enter.call(k):(q(e.enter),!1):!1;break;case 9:e.tabTrap&&(b=$(this).find('[tabindex][tabindex!="-1"][disabled!="disabled"]:visible'),b.length&&(a.preventDefault(),c=$(document.activeElement),d=b.index(c)>=0?b.index(c):0,d+=a.shiftKey?-1:1,d>=b.length?d=0:0>d&&(d=b.length-1),b.eq(d).focus()))}};e.container.append(f.wrapper.append(f.underlay,f.popup)),_(["header","body","footer"]).each(function(a){f[a]=f.popup.find(".modal-"+a)}),e.addClass&&f.popup.addClass(e.addClass),a.extend(this),this.resizeBody=function(){var a=k.getPopup().position().top,b=$(document).height(),c=k.getBody().height(),d=k.getPopup().height(),e=30,f=k.getBody().find(".vgrid-cell").eq(0).outerHeight(),g=d+a+e;if(g>=b){var h=b-g,i=c+h;i>=f?k.getBody().css("height",i+"px"):k.getBody().css("height",f+"px")}},this.data=function(a){return l=void 0!==a?a:{},this},this.header=function(){return f.header.append.apply(f.header,arguments),this},this.getHeader=function(){return f.header},this.getPopup=function(){return f.popup},this.getContentNode=this.getBody=function(){return f.body},this.getContentControls=this.getFooter=function(){return f.footer},this.text=function(a){var b=f.body;return b.find(".plain-text").remove(),b.append($('<h4 class="plain-text">').text(a||"")),this},this.build=function(a){return _.isFunction(a)&&a.call(this),this},this.append=function(){return f.body.append.apply(f.body,arguments),this},this.prepend=function(a){return f.body.prepend(a),this};var s=function(a,b,c,d){d=d||{};var e={label:b,data:{action:a},click:d.click||q,dataaction:c,purelink:d.purelink,inverse:d.inverse,tabIndex:d.tabIndex||d.tabindex};d.type&&(e[d.type]=!0);var g=$.button(e);return f.buttons.push(g),g.addClass(d.classes).attr({role:"button",type:"button"})};this.addButton=function(a,b,c,d){return f.footer.prepend(s(a,b,c,d).addClass("btn-default")),this},this.addDangerButton=function(a,b,c,d){return f.footer.prepend(s(a,b,c,d).addClass("btn-danger")),this},this.addSuccessButton=function(a,b,c,d){return f.footer.prepend(s(a,b,c,d).addClass("btn-success")),this},this.addWarningButton=function(a,b,c,d){return f.footer.prepend(s(a,b,c,d).addClass("btn-warning")),this},this.addPrimaryButton=function(a,b,c,d){return f.footer.prepend(s(a,b,c,d).addClass("btn-primary")),this},this.addAlternativeButton=function(a,b,c,d){return f.footer.prepend(s(a,b,c,d).addClass("btn-default").css({"float":"left",marginLeft:0})),this},this.addButtonMobile=function(a,b,c,d){return s(a,b,c,d)},this.close=function(){!e||e.async?n():q("cancel")},this.invoke=function(a){return q(a),this},this.idle=function(){return p(),this},this.busy=function(){return o(),this},this.show=function(a){e.container.addClass("blockscroll"),e.focus&&(g=$(document.activeElement),document.addEventListener("focus",m,!0)),0===f.header.children().length&&f.header.remove();var b=function(){var a={width:parseInt(e.width||1.1*f.popup.width(),10),height:parseInt(e.height||f.popup.height(),10)};return _(["width","height"]).each(function(b){var c=e[$.camelCase("max-"+b)];e[c]&&a[b]>e[c]&&(a[b]=e[c]);var d=$(document)[b]();a[b]&&a[b]>d&&(a[b]=d)}),a},c=function(){if(f){var a=b();f.popup.css({"max-width":a.width,top:e.top||0});var c=e.substract?$("#io-ox-core").height()-e.substract-e.top:$("#io-ox-core").height()-170-e.top;f.body.css({height:c,"max-height":c})}},d=b();if(_.device("!small")){var h={"max-width":d.width+"px"};if(e.center){h.top="50%";var j=function(){if(f){var a=f.popup.height(),b=$(window).height();b<f.popup.height()&&(a=b,h.overflow="auto",h.maxHeight="100%"),h.marginTop=0-(a/2>>0)+"px",f.popup.css(h)}};$(window).off("resize.checkTop").on("resize.checkTop",j),j()}else f.popup.css("top",e.top||"0px"),e.maximize&&(c(),$(window).off("resize.maximizedpopup").on("resize.maximizedpopup",c))}_.device("smartphone")&&(f.popup.addClass("mobile-dialog"),f.footer.rowfluid=$('<div class="row">'),f.footer.append(f.footer.rowfluid),_.each(f.buttons,function(a){f.footer.rowfluid.prepend(a.addClass("btn-medium")),a.wrap('<div class="col-xs-12 col-md-3">')})),this.trigger("beforeshow"),f.underlay.show().addClass("in"),f.popup.show();var k=f.popup.find(".btn-primary").first().focus();return k.length||f.popup.find(".btn").not(".btn-danger").first().focus(),f.popup.on("keydown",r),a&&a.call(f.popup,this),this.trigger("show"),i},f.underlay.click(function(){e&&e.underlayAction&&q(e.underlayAction)}),f.popup.click(function(){e&&e.defaultAction&&q(e.defaultAction)}),this.setUnderlayAction=function(a){return e.underlayAction=a,this},this.topmost=function(){return f.underlay.addClass("topmost"),f.popup.addClass("topmost"),this},this.setUnderlayStyle=function(a){return f.underlay.css(a||{}),this},this.setDefaultAction=function(a){return e.defaultAction=a,this}},f=function(a){a=$.extend({top:"50px",center:!1},a||{}),e.call(this,a)},g=function(c){c=_.extend({modal:!1,arrow:!0,closely:!1,tabTrap:!0},c||{});var d,e,f,g,h,i,j,k,l,m,n=null,o=$(),p=$('<div class="io-ox-sidepopup-pane f6-target default-content-padding abs" tabindex="1">'),q=$('<div class="io-ox-sidepopup-close">').append($('<a class="btn-sidepopup" data-action="close" role="button" tabindex="1">').text(b(c.saveOnClose?"Save":"Close"))),r=$('<div class="io-ox-sidepopup abs">').attr("role","complementary").append(q,p),s=c.arrow===!1?$():$('<div class="io-ox-sidepopup-arrow">').append($('<div class="border">'),$('<div class="triangle">')),t=null,u=this,v=function(a){var b,d,e;9===a.which&&c.tabTrap&&(b=$(this).find('[tabindex][disabled!="disabled"]:visible'),b.length&&(a.preventDefault(),d=$(document.activeElement),e=b.index(d)>=0?b.index(d):0,e+=a.shiftKey?-1:1,e>=b.length?e=0:0>e&&(e=b.length-1),b.eq(e).focus()))},p=p.scrollable();a.extend(this),c.modal&&(m=$('<div class="io-ox-sidepopup-overlay abs">').append(r,s)),this.nodes={},this.lastTrigger=null,d=function(a){a.target&&"true"===$(a.target).attr("data-process-event")||((a.originalEvent||a).processed=!0)},e=function(a){return(a.originalEvent||a).processed===!0},i=function(a){27===a.which&&g(a)},j=function(a){a.target&&"true"===$(a.target).attr("data-process-event")||e(a)||(d(a),g(a))},k=function(a){g(a)},g=function(){u.nodes.closest&&(c.saveOnClose&&p.find(".settings-detail-pane").trigger("save"),$(document).off("keydown",i),u.nodes.closest.prop("sidepopup",l),u.nodes.click.off("click",j),r.off("view:remove remove",k),u.lastTrigger=l=null,n=setTimeout(function(){if(u.nodes.simple.length){var a,b=u.nodes.simple.find(".io-ox-sidepopup");b.length>1?(a=b.eq(-2),a.show(),$("body").scrollTop(a.attr("data-scrolltop")||0)):(u.nodes.simple.find("[data-hidden-by-sidepopup]").removeAttr("data-hidden-by-sidepopup").show(),$("body").scrollTop(u.lastSimpleScrollPos||0)),u.nodes.simple=null}c.modal?m.detach():(s.detach(),r.detach()),p.empty(),c.focus&&(o=o.closest(":visible"),o.focus()),u.trigger("close")},100))},h=function(a){a.data.target.find(".io-ox-sidepopup").trigger("close")},r.on("close",g),r.on("keydown",v),q.find(".btn-sidepopup").on("click",function(a){return p.trigger("click"),g(a),!1}).on("keydown",function(a){13===(a.keyCode||a.which)&&$(this).trigger("click")}),r.on("click",d),f=function(a,e){var f,v,w=$(this);if(o=$(document.activeElement),u.nodes={closest:t||w.parents(".io-ox-sidepopup-pane, .window-content, .window-container-center, .io-ox-dialog-popup, .notifications-overlay").first(),click:w.parents(".io-ox-sidepopup-pane, .window-body, .window-container-center, .io-ox-dialog-popup, .notifications-overlay").first(),target:t||w.parents(".window-body, .simple-window, .window-container-center, .notifications-overlay").first(),simple:w.closest(".simple-window")},v=u.nodes.closest.prop("sidepopup")||null,u.lastTrigger=v?v.lastTrigger:null,f=w.parents(".io-ox-sidepopup, .window-content, .io-ox-dialog-popup, .window-container-center, .notifications-overlay").css("zIndex"),f=parseInt(f,10),f=_.isNumber(f)?f+2:100,u.lastTrigger===this)g(a);
else{v&&v.close(),u.lastTrigger=this,l=v,u.nodes.closest.prop("sidepopup",u),d(a),clearTimeout(n),u.nodes.closest.is(".io-ox-sidepopup-pane")&&(q.find(".close-all").remove(),q.prepend($('<a class="btn-sidepopup close-all" role="button" tabindex="1" data-action="close-all">').text(b("Close all")).on("click",{target:u.nodes.target},h).on("keypress",{target:u.nodes.target},function(a){13===a.which&&h(a)}))),u.nodes.click.on("click",j),r.on("view:remove remove",k),$(document).on("keydown",i);var x,y=$("body").width(),z=w.parents(".io-ox-sidepopup").first(),A=0===z.length;x=/^(left|right)$/.test(c.side)?c.side:A&&a.pageX>y/2||z.hasClass("right")?"left":"right",r.add(s).removeClass("left right").addClass(x).css("z-index",f),s.css("zIndex",f+1),c.closely&&_.device("!small")&&r.add(s).css("left"===x?"right":"left","20%"),u.nodes.simple.length&&(u.lastSimpleScrollPos=$("body").scrollTop(),u.nodes.simple.find(".window-content:visible").attr("data-hidden-by-sidepopup","true").hide(),u.nodes.simple.find(".io-ox-sidepopup:visible").each(function(){$(this).attr("data-scrolltop",$("body").scrollTop()).hide()}),$("body").scrollTop(0)),u.nodes.target.append((c.modal?m:r).css("visibility","hidden")),(e||$.noop).call(u,p.empty(),a,w);var B=w.outerHeight(!0)/2>>0,C=u.nodes.target.offset()?u.nodes.target.offset().top:0,D=w.offset().top+B-C;s.css("top",D),(c.modal?m:r).css("visibility",""),c.modal||u.nodes.target.append(s),p.parent().focus(),u.trigger("show")}},this.delegate=function(a,b,c){return $(a).on("click.sidepopup",b,function(a){(a.originalEvent||a).processed!==!0&&f.call(this,a,c)}),$(a).on("keypress.sidepopup",b,function(a){13===a.which&&(a.originalEvent||a).processed!==!0&&f.call(this,a,c)}),this},this.undelegate=function(a){return $(a).off(".sidepopup"),this},this.setTarget=function(a){return t=$(a),this},this.show=function(a,b){return setTimeout(function(){f.call(a.target,a,b)},0),this},this.close=function(a){g(a)},this.destroy=function(){return g(),this.nodes=m=p=q=r=s=null,this}};return{ModalDialog:e,CreateDialog:f,SidePopup:g,busy:function(a){a.find("button, input").each(function(a,b){b=$(b),b.prop("disabled")?b.data("disabled",!0):b.prop("disabled",!0)})},idle:function(a){a.find("button, input").each(function(a,b){b=$(b),b.data("disabled")?b.removeData("disabled"):b.prop("disabled",!1)})}}}),define("io.ox/core/tk/draghelper",["io.ox/core/extensions"],function(a){"use strict";a.point("io.ox/core/tk/draghelper").extend({id:"counter",index:100,draw:function(a){this.append($('<span class="drag-counter">').text(a.count))}}).extend({id:"text",index:200,draw:function(a){this.append($("<span>").text(a.source.attr("data-drag-message")||a.dragMessage.call(a.container,a.data,a.source)))}})}),define("io.ox/core/page-controller",["less!io.ox/core/page-controller"],function(){"use strict";var a=function(a,b){function c(b){var c={tag:"<div>",classes:"io-ox-pagecontroller page",container:$()};b=_.extend(c,b),j.container&&(b.container=j.container),f[b.name]={$el:$(b.tag).addClass(b.classes),navbar:b.navbar,toolbar:b.toolbar,secondaryToolbar:b.secondaryToolbar,name:b.name},g.push(b.name),f[b.name].$el.attr("data-page-id",a.options.name+"/"+b.name),$(b.container).append(f[b.name].$el),b.startPage&&i.setCurrentPage(b.name)}window.trappedTaps||(window.trappedTaps=0);var d,e,f={},g=[],h=[],i=this,a=a,j=b||{},k=$('<div class="taptrap">').on("touchstart click mousedown",function(){window.trappedTaps++});this.showPage=function(a){a!==d&&i.setCurrentPage(a)},this.changePage=function(a,b){if(!f[a])return void console.warn("target page does not exist: ",a);if(a!==d){var c=_.extend({from:d,animation:_.device("smartphone")?"slideleft":"pop",disableAnimations:!1},b||{}),e=f[a].$el,g=f[c.from].$el;if(c.animation=_.device("android")?"pop":c.animation,e.trigger("pagebeforeshow",{frompage:c.from}),g.trigger("pagebeforehide",{topage:c.to}),_.device("smartphone"))try{document.activeElement&&"body"!==document.activeElement.nodeName.toLowerCase()?$(document.activeElement).blur():$("input:focus, textarea:focus, select:focus").blur()}catch(i){}h=d,d=a;var j=k.clone(!0);_.device("!smartphone")&&(j=$()),Modernizr.cssanimations&&!c.disableAnimations?(_.defer(function(){e.append(j).addClass("io-ox-core-animation in current "+c.animation).one("webkitAnimationEnd mozAnimationEnd animationend",function(){$(this).removeClass("io-ox-core-animation in "+c.animation),e.trigger("pageshow",{from:c.from,to:c.to}),j.remove()})},1),_.defer(function(){g.removeClass("current").addClass("io-ox-core-animation out inmotion "+c.animation).one("webkitAnimationEnd mozAnimationEnd animationend",function(){$(this).removeClass("io-ox-core-animation out inmotion "+c.animation),g.trigger("pagehide",{from:c.from,to:c.to})})},1)):(e.addClass("current").trigger("pageshow",{from:c.from,to:c.to}),g.removeClass("current").trigger("pagehide",{from:c.from,to:c.to})),l(a),m(a)}},this.setBackbuttonRules=function(a){e=a},this.goBack=function(){var a=h;e&&e[d]&&(a=e[d]),this.changePage(a,{animation:"slideright"})},this.addPage=function(a){return a?(c(a),this):void 0},this.getPage=function(a){return f[a]?f[a].$el:(console.error("PageController: Page "+a+" does not exist."),void console.error("PageController: Available pages are "+g.join()))},this.getPageObject=function(a){return f[a]?f[a]:(console.error("PageController: Page "+a+" does not exist."),void console.error("PageController: Available pages are "+g.join()))},this.getNavbar=function(a){return f[a]?f[a].navbar:void console.error("PageController: Page "+a+" does not exist.")},this.getAll=function(){return f},this.getToolbar=function(a){return f[a]?f[a].toolbar:void console.error("PageController: Page "+a+" does not exist.")},this.getSecondaryToolbar=function(a){return f[a]?f[a].secondaryToolbar?f[a].secondaryToolbar:void console.error("PageController: Page "+a+" does not own a secondary toolbar."):void console.error("PageController: Page "+a+" does not exist.")},this.getCurrentPage=function(){return f[d]},this.setCurrentPage=function(a){d&&f[d].$el.removeClass("current"),f[a].$el.addClass("current"),l(a),m(a),d=a},this.getPages=function(){return f},this.toggleSecondaryToolbar=function(a,b){m(a,b)};var l=function(b){var c=f[b].navbar;c&&(a.navbar.find(".toolbar-content").detach(),a.navbar.append(c.$el))},m=function(b,c){var d;c&&f[b].secondaryToolbar?d=f[b].secondaryToolbar:f[b].toolbar&&(d=f[b].toolbar),d?(a.toolbar.children().detach(),a.toolbar.append(d.$el).show(),c||d.render()):a.toolbar&&(a.toolbar.children().detach(),a.toolbar.hide())}};return a}),define("io.ox/core/toolbars-mobile",["io.ox/core/extensions"],function(a){"use strict";var b=Backbone.View.extend({show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}}),c=b.extend({tagName:"div",className:"toolbar-content",events:{"tap .navbar-action.right:not(.custom)":"onRightAction","tap .navbar-action.left:not(.custom)":"onLeftAction"},initialize:function(b){this.app=b.app,this.title=b.title?b.title:"",this.left=b.left?b.left:!1,this.right=b.right?b.right:!1,this.baton=b.baton||a.Baton({app:b.app}),this.extension=b.extension,this.hiddenElements=[]},render:function(){return this.$el.empty(),a.point(this.extension).invoke("draw",this,{left:this.left,right:this.right,title:this.title,baton:this.baton}),this.$el.find(this.hiddenElements.join()).hide(),this},setLeft:function(a){return this.left=a,this.render(),this},setTitle:function(a){return this.title=a,this.render(),this},setRight:function(a){return this.right=a,this.render(),this},onRightAction:function(a){a.preventDefault(),a.stopImmediatePropagation(),this.trigger("rightAction")},onLeftAction:function(a){a.preventDefault(),a.stopImmediatePropagation(),this.trigger("leftAction")},hide:function(a){return this.hiddenElements.push(a),this.hiddenElements=_.uniq(this.hiddenElements),this.render(),this},show:function(a){return this.hiddenElements=_.without(this.hiddenElements,a),this.render(),this},setBaton:function(a){return this.baton=a,this.render(),this}}),d=b.extend({initialize:function(b){this.app=b.app,this.page=b.page,this.baton=b.baton||a.Baton({app:b.app}),this.extension=b.extension},render:function(){return this.$el.empty(),a.point(this.extension+"/"+this.page).invoke("draw",this.$el,this.baton),this},setBaton:function(a){return this.baton=a,this.render(),this}});return{BarView:b,NavbarView:c,ToolbarView:d}}),define("io.ox/core/folder/util",["io.ox/core/api/account","settings!io.ox/mail","settings!io.ox/core"],function(a,b,c){"use strict";function d(a,b){return a>>b&(b>=28?1:127)}function e(a,b){return d(_.firstOf(a.own_rights,a,0),b||0)}function f(a){return a=a||"mail","mail"===a?b.get("folder/inbox"):c.get("folder/"+a)}function g(d,e){var f,h,i,j=0;if(_.isArray(e))return _(e).reduce(function(a,b){return a&&g(d,b)},!0);if(d.search(/\|/)>-1){var k=d.split(/\|/);for(h=k.length,f=!1;h>j;j++)if(g(k[j],e)){f=!0;break}return f}switch(d){case"private":return 1===e.type;case"public":return 2===e.type||/^(10|14|15)$/.test(e.id);case"shared":return 3===e.type;case"system":return 5===e.type;case"trash":return 16===e.type;case"mail":return"mail"===e.module;case"messaging":return"messaging"===e.module;case"calendar":return"calendar"===e.module;case"contacts":return"contacts"===e.module;case"tasks":return"tasks"===e.module;case"infostore":return"infostore"===e.module;case"account":return"system"===e.module&&/^default(\d+)?/.test(String(e.id));case"unifiedfolder":return i=e?void 0!==e.id?e.id:e:"",a.isUnifiedFolder(i);case"external":return/^default[1-9]/.test(String(e.id))&&!g("unifiedmail",e);case"defaultfolder":var l=b.get("folder");for(i in l)if(l[i]===e.id)return!0;return!1;case"insideDefaultfolder":var l=b.get("folder");for(i in l)if(0===e.id.indexOf(l[i]))return!0;return!1;case"published":return!!e["com.openexchange.publish.publicationFlag"];case"subscribed":return!!e["com.openexchange.subscribe.subscriptionFlag"];case"unlocked":case"shared-by-me":return!e.permissions||e.permissions.length<=1?!1:1===e.type||7===e.type||"infostore"===e.module&&e.created_by===ox.user_id;case"hidden":var m=c.get(["folder/hidden"],{}),i=_.isObject(e)?e.id:e;return m[i]===!0;default:return!1}}function h(a,b){return a.folder_id===b.id?!1:a.id===b.id?!1:3===a.type||3===b.type?!1:5===a.type?!1:g("defaultfolder",a)?!1:1===a.type&&1!==b.type&&1!==b.id&&7!==b.type?!1:2!==a.type||2===b.type||b.id in{2:1,10:1,15:1}?a.module!==b.module?!1:i("create:folder",a)&&i("create:folder",b)?!0:!1:!1}function i(a,b,c){if(_.isArray(b))return _(b).reduce(function(b,d){return b&&i(a,d,c)},!0);var e,f=b.own_rights,j=b.standard_folder||g("system",b),k=1===d(f,28),l="mail"===b.module,m=c&&ox.user_id!==_.firstOf(c.created_by,0)?1:0;switch(a){case"read":return d(f,7)>0&&1!==f;case"create":return d(f,0)>1;case"write":return d(f,14)>m;case"delete":return d(f,21)>m;case"rename":return!k||j?!1:1===d(f,30)?!0:l?!g("defaultfolder",b):!0;case"create:folder":return e=d(f,0),4===(4&e)||64===(64&e);case"delete:folder":case"remove:folder":return k&&!j&&!g("defaultfolder",b);case"move:folder":return h(b,c);case"import":return(127&f)>=2&&g("calendar|contacts|tasks",b);case"export":return!g("shared",b)&&g("contacts|calendar|tasks",b);case"empty":return f>>21&127&&g("mail",b);case"changepermissions":return k;case"viewproperties":return!l&&!g("account",b)&&1&b.capabilities;case"publish":return-1===_(b.supported_capabilities).indexOf("publication")?!1:"contacts"===b.module?!0:"infostore"===b.module&&i("create",b)&&1!==f&&4!==f;case"subscribe":return-1===_(b.supported_capabilities).indexOf("subscription")?!1:/^(contacts|calendar|infostore)$/.test(b.module)&&i("write",b);case"subscribe:imap":return l?b.standard_folder?!1:Boolean(b.capabilities&Math.pow(2,4)):!1;default:return!1}}return{bits:e,is:g,can:i,getDefaultFolder:f}}),define("io.ox/core/folder/sort",["io.ox/core/extensions","io.ox/core/api/account"],function(a,b){"use strict";var c=a.point("io.ox/core/folder/sort");return c.extend({id:"1",sort:function(a){if("1"===a.id){var c=a.data,d=new Array(6),e="inbox sent drafts trash spam".split(" ");_(c).find(function(a){return b.isUnified(a.id)&&!!(d[0]=a)}),_(c).each(function(a){_(e).find(function(c,e){return b.is(c,a.id)&&!!(d[e+1]=a)})}),c=_(c).reject(function(a){return b.isUnified(a.id)||b.isStandardFolder(a.id)}),c.sort(function(a,c){var d=b.isExternal(a.id),e=b.isExternal(c.id),f=a.title.toLowerCase()>c.title.toLowerCase()?1:-1;return d&&e?f:d?1:e?-1:f}),c.unshift.apply(c,_(d).compact()),a.data=c}}}),{apply:function(b,d){var e=a.Baton({id:b,data:d});return c.invoke("sort",null,e),e.data}}}),define("io.ox/core/folder/blacklist",["io.ox/core/extensions","settings!io.ox/core","settings!io.ox/files"],function(a,b,c){"use strict";function d(a,b){return a&&!!b}var e=a.point("io.ox/core/folder/filter"),f=b.get("folder/blacklist",{}),g=_(f).keys().sort();return ox.debug&&g.length>0&&console.info("Blacklisted folders:",g),e.extend({id:"blacklist",index:100,visible:function(a){var c=a.data,d=String(c.id);return f=b.get("folder/blacklist",{}),!f[d]}},{id:"dot-folders",index:200,visible:function(a){return"infostore"!==a.data.module?!0:c.get("showHidden",!1)===!0?!0:!/^\./.test(a.data.title)}}),{hash:f,filter:function(b){var c=a.Baton({data:b});return e.invoke("visible",null,c).reduce(d,!0).value()},visible:function(a){return this.filter(a)},apply:function(a){return _(a).filter(this.filter,this)}}}),define("io.ox/core/folder/title",[],function(){"use strict";return function(a,b){if(a=String(a||"").trim(),a.length<b)return a;var c=/[_-]/.test(a[0])?a[0]:!1,d=/[_-]/.test(a[a.length-1])?a[a.length-1]:!1,e=a.split(/[ _-]+/),f=a.split(/[^ _-]+/),g=a.length;for(c&&(e[1]=c+e[1],e.splice(0,1)),d&&(e[e.length-1]=d+e[e.length-1],e.splice(e.length-1,1));g>b&&e.length>2;){var h=Math.floor(e.length/2);g-=e[h].length+2,e.splice(h,1),f.splice(h+1,1),f[Math.floor(f.length/2)]="…"}return g>b?_.ellipsis(a,{charpos:"middle",max:b,length:Math.floor(b/2-1)}):_(e).map(function(a,b){return a+f[b+1]}).join("")}}),define("io.ox/core/folder/bitmask",[],function(){"use strict";var a={folder:0,read:7,write:14,modify:14,"delete":21,admin:28},b=function(b){if(_.isString(b)){if(b in a)return a[b];console.error("Typo!?",b)}return b||0};return function c(a){a=a||0;var c={get:function(c){return 0===arguments.length?a:a>>b(c)&127},set:function(c,d){return c=b(c),a&=536870911^127<<c,a|=d<<c,this}};return c}}),define("io.ox/core/folder/api",["io.ox/core/http","io.ox/core/event","io.ox/core/folder/util","io.ox/core/folder/sort","io.ox/core/folder/blacklist","io.ox/core/folder/title","io.ox/core/folder/bitmask","io.ox/core/api/account","io.ox/core/capabilities","settings!io.ox/core","settings!io.ox/mail","gettext!io.ox/core"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(a){return a=String(a),"1"===a||/^default\d+/.test(a)?0:1}function n(a,b,c){return b["index/"+a]=c,b}function o(a){delete bb.models[a.previous("id")],bb.models[a.id]=a}function p(a){bb.unfetch(a.id)}function q(a){return/^virtual/.test(a)}function r(a){return/^(contacts|calendar|tasks)$/.test(a)}function s(a,b){return(b?"all/":"")+String(a)}function t(){this.models={},this.collections={}}function u(a,b){return b=e.apply(b),b=d.apply(a,b),_(b).each(n.bind(null,a)),b}function v(a){if(a instanceof Backbone.Model){var b=a,c=b.toJSON(),d=c.id;return b.changed.total&&(cb.trigger("update:total",d,c),cb.trigger("update:total:"+d,c)),void(b.changed.unread&&(cb.trigger("update:unread",d,c),cb.trigger("update:unread:"+d,c)))}return/^account:(create|delete|unified-enable|unified-disable)$/.test(a)?z("1",{cache:!1}).done(function(){hb.refresh(),cb.trigger("refresh")}):gb}function w(a,b){this.id=a,this.getter=b}function x(b,c){b=String(b),c=_.extend({cache:!0},c);var d=bb.models[b];if(c.cache===!0&&void 0!==d&&d.has("title"))return $.when(d.toJSON());if(/^virtual/.test(b))return $.when({id:b});if("6"===b&&!i.has("gab")){var e=l("Accessing global address book is not permitted");return console.warn(e),$.Deferred().reject({error:e})}return a.GET({module:"folders",params:{action:"get",altNames:!0,id:b,timezone:"UTC",tree:m(b)}}).then(function(a){var b=bb.addModel(a);return v(b),a})}function y(b){try{return a.pause(),$.when.apply($,_(b).map(function(a){return x(a).then(null,function(){return $.when(void 0)})})).then(function(){return _(arguments).toArray()})}finally{a.resume()}}function z(b,c){b=String(b),c=_.extend({all:!1,cache:!0},c);var d=s(b,c.all),e=bb.getCollection(d);if(e.fetched&&c.cache===!0)return $.when(e.toJSON());if(fb[b]&&!c.all){var f=u(b,fb[b]);return bb.addCollection(b,f),delete fb[b],$.when(f)}var g,h,i=/^flat\/([^/]+)\/([^/]+)$/.exec(b);return i?(g=i[1],h=i[2],G({module:g,cache:c.cache}).then(function(a){return a[h]})):q(b)?hb.list(b):a.GET({module:"folders",params:{action:"list",all:c.all?"1":"0",altNames:!0,parent:b,timezone:"UTC",tree:m(b)},appendColumns:!0}).then(function(a){return a=u(b,a),bb.addCollection(d,a),a})}function A(b){var c,d=[],e=b,f=!1;if(void 0===b)return $.when([]);do d.push(c=bb.getModel(e).toJSON()),e=c.folder_id,f="1"===String(e);while(e&&!f);return f?$.when(d.reverse()):a.GET({module:"folders",params:{action:"path",altNames:!0,id:b,tree:m(b)},appendColumns:!0}).then(function(a){return _(a).filter(function(a){return bb.addModel(a),"1"!==a.id}).reverse()})}function B(b){return a.makeObject(b,"folders")}function C(a){return 3===a?"shared":2===a?"public":"private"}function D(a,b){return"flat/"+a+"/"+b}function E(a,b){return bb.getCollection(D(a,b))}function F(){return _(bb.collections).chain().keys().filter(function(a){return/^flat/.test(a)}).map(function(a){return a.split("/")[1]}).uniq().value()}function G(b){if(b=_.extend({module:void 0,cache:!0},b),ox.debug&&!b.module)return console.warn("Folder API > flat() - Missing module",b),$.Deferred().reject();var d=b.module,e=E(d,"private");return e.fetched&&b.cache===!0?$.when({"private":e.toJSON(),"public":E(d,"public").toJSON(),shared:E(d,"shared").toJSON(),sharing:E(d,"sharing").toJSON(),hidden:E(d,"hidden").toJSON()}):a.GET({module:"folders",appendColumns:!0,params:{action:"allVisible",altNames:!0,content_type:d,timezone:"UTC",tree:1}}).then(function(a){var b,e={},f=[],g=[],h=j.get(["folder/hidden"],{});return _(a).each(function(a,i){var j=_(a).chain().map(B).filter(function(a){return c.can("read",a)?h[a.id]?(f.push(a),!1):(c.is("shared-by-me",a)&&g.push(a),!0):!1}).value();b=D(d,i),j=u(b,j),bb.addCollection(b,e[i]=j,{reset:!0})}),b=D(d,"hidden"),f=u(b,f),bb.addCollection(b,e.hidden=f,{reset:!0}),b=D(d,"sharing"),g=u(b,g),bb.addCollection(b,e.sharing=g,{reset:!0}),e})}function H(b,c,d){if(_.isObject(c)&&!_.isEmpty(c)){d=_.extend({silent:!1},d);var f=bb.getModel(b).set(c,{silent:d.silent});return a.PUT({module:"folders",params:{action:"update",id:b,timezone:"UTC",tree:m(b)},data:c,appendColumns:!1}).done(function(){var a=f.toJSON();e.visible(a)||cb.trigger("warn:hidden",a)}).then(function(a){return b!==a&&f.set("id",a),d.silent||cb.trigger("update",b,a,f.toJSON()),b!==a?z(f.get("folder_id"),{cache:!1}).then(function(){return a}):void 0},function(a){return cb.get(b,{cache:!1}),a&&a.code&&"FLD-0018"===a.code&&(a.error=l("Could not save settings. There have to be at least one user with administration rights.")),d.silent||cb.trigger("update:fail",a,b),a})}}function I(a,b){if(a!==b){var c=bb.getModel(a),d=c.get("folder_id"),e=bb.getCollection(d);return e.remove(c),bb.getModel(d).set("subfolders",e.length>0),H(a,{folder_id:b}).done(function(d){bb.getModel(b).set("subfolders",!0),hb.refresh(),bb.getCollection(b).add(c),cb.trigger("move",a,d)})}}function J(b,c){return x(b).then(function(d){return c=_.extend({module:d.module,subscribed:1,title:l("New Folder")},c),a.PUT({module:"folders",params:{action:"new",autorename:!0,folder_id:b,tree:m(b)},data:c,appendColumns:!1}).then(function(a){return x(a)}).then(function(a){return(r(c.module)?G({module:c.module,cache:!1}):z(b,{cache:!1})).then(function(){return a})}).done(function(a){e.visible(a)||cb.trigger("warn:hidden",a)}).done(function(a){bb.getModel(b).set("subfolders",!0),hb.refresh(),cb.trigger("create",a),cb.trigger("create:"+b,a)}).fail(function(a){cb.trigger("create:fail",a,b)})})}function K(a){var b,c,d,e=a.get("module");r(e)?(b=C(a.get("type")),d=E(e,b),d.remove(a)):(c=a.get("folder_id"),d=bb.getCollection(c),d.remove(a),bb.getModel(c).set("subfolders",d.length>0))}function L(b){var c=bb.getModel(b),d=c.toJSON();return cb.trigger("remove:prepare",d),K(c),c.trigger("destroy"),a.PUT({module:"folders",params:{action:"delete",failOnError:!0,tree:m(b)},data:[b],appendColumns:!1}).done(function(){cb.trigger("remove",b,d),cb.trigger("remove:"+b,d),cb.trigger("remove:"+d.module,d)}).fail(function(){cb.trigger("remove:fail",b)})}function M(b){return cb.trigger("before:clear",b),a.PUT({module:"folders",appendColumns:!1,params:{action:"clear",tree:m(b)},data:[b]}).done(function(){cb.trigger("clear",b),Z()})}function N(a){this.nodeValue=_.noI18n(a.title||a.id)}function O(a){var b=document.createTextNode("");return x(a).done(N.bind(b)),b}function P(a){return _(a).chain().pluck("folder_id").uniq().value().length<=1}function Q(a){return!h.is("sent",a.folder_id)}function R(a){return _.isArray(a)&&1!==a.length?P(a)?a:_(a).filter(Q):a}function S(a){return _.isString(a)?a:a?a.folder_id:null}function T(){_.chain(arguments).flatten().map(S).compact().uniq().each(function(a){x(a,{cache:!1})})}function U(a){var b=bb.getModel(a),c=b.get("module");j.set(["folder/hidden",a],!0).save(),G({module:c,cache:!1})}function V(a){var b=bb.getModel(a),c=b.get("module");j.remove(["folder/hidden",a]).save(),G({module:c,cache:!1})}function W(a,b){b===!0?V(a):U(a)}function X(a,b){bb.getModel(a).set("unread",Math.max(0,b))}function Y(a,b){var c=bb.getModel(a);c.set("unread",Math.max(b||0,c.get("unread")))}function Z(){a.pause(),_(cb.pool.models).chain().invoke("get","folder_id").uniq().compact().without("0").each(function(a){z(a,{cache:!1})}),_(F()).each(function(a){G({module:a,cache:!1})}),a.resume()}function ab(){var a=_(h.getStandardFolders()).filter(function(a){return!/^default0/.test(a)}),b=h.getInbox(),c=bb.getCollection(b),d=_(c.pluck("id")).filter(h.isStandardFolder);return d.concat(a)}var bb,cb={};b.extend(cb);var db=Backbone.Model.extend({constructor:function(){Backbone.Model.apply(this,arguments),this.on("change:id",o)}}),eb=Backbone.Collection.extend({constructor:function(a){Backbone.Collection.apply(this,arguments),this.id=a,this.fetched=!1},comparator:function(a){return a.get("index/"+this.id)||0},model:db});_.extend(t.prototype,{addModel:function(a){var b=a.id,c=this.models[b];return void 0===c?this.models[b]=c=new db(a):c.set(a),c},addCollection:function(a,b,c){var d=_(b).map(this.addModel,this);c=c||{};var e=this.getCollection(a),f=e.fetched?"set":"reset";e[f](d),e.fetched=!0,c.reset&&e.trigger("reset")},getModel:function(a){return this.models[a]||(this.models[a]=new db({id:a}))},getCollection:function(a,b){return a=s(a,b),this.collections[a]||(this.collections[a]=new eb(a))},unfetch:function(a){if(0===arguments.length||"0"===a)return _(this.collections).each(function(a){a.fetched=!1});var b=this.collections[a];b&&(b.fetched=!1,b.each(p))}}),bb=new t,_(ox.rampup.folder).each(function(a){bb.addModel(a)});var fb={};_(ox.rampup.folderlist||{}).each(function(b,c){fb[c]=_(b).map(function(b){return _.isArray(b)?a.makeObject(b,"folders"):b})});var gb=$.when();w.prototype.concat=function(){return $.when.apply($,arguments).then(function(){return _(arguments).flatten()})},w.prototype.list=function(){var a=this.id;return this.getter().done(function(b){_(b).each(n.bind(null,a)),bb.addCollection(s(a),b),bb.getModel(a).set("subfolders",b.length>0)})};var hb={hash:{},list:function(a){var b=this.hash[a];return void 0!==b?b.list():$.Deferred().reject()},add:function(a,b){this.hash[a]=new w(a,b),bb.getModel(a).set("subfolders",!0)},concat:function(){return ox.debug&&console.warn("Deprecated! Please use this.concat()"),$.when.apply($,arguments).then(function(){return _(arguments).chain().flatten().map(n.bind(null,"concat")).value()})},refresh:function(){_(this.hash).invoke("list")}},ib=function(){function a(a){delete c[a],T(a)}function b(b){c[b]&&clearTimeout(c[b]),c[b]=setTimeout(a,d,b)}var c={},d=500;return function(a,c){var d=bb.getModel(a);d.set("unread",Math.max(0,d.get("unread")+c)),b(a)}}();ox.on("please:refresh refresh^",Z);var jb=""===k.get("namespace","INBOX/");return _.extend(cb,{FolderModel:db,FolderCollection:eb,Pool:t,pool:bb,get:x,list:z,multiple:y,path:A,flat:G,update:H,move:I,create:J,remove:L,clear:M,reload:T,hide:U,show:V,toggle:W,refresh:Z,bits:c.bits,is:c.is,can:c.can,virtual:hb,isFlat:r,isVirtual:q,getFlatCollection:E,getFlatViews:F,getDefaultFolder:c.getDefaultFolder,getStandardMailFolders:ab,getTextNode:O,getFolderTitle:f,ignoreSentItems:R,processListResponse:u,changeUnseenCounter:ib,setUnseenCounter:X,setUnseenMinimum:Y,getSection:C,Bitmask:g,propagate:v,altnamespace:jb,injectIndex:n}),cb}),define("io.ox/core/folder/node",["io.ox/backbone/disposable","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/api/account","gettext!io.ox/core"],function(a,b,c,d,e){"use strict";var f="caret",g=a.extend({tagName:"li",className:"folder selectable",indentation:30,events:{"click .folder-options":"onOptions","click .folder-arrow":"onArrowClick","dblclick .folder-label":"onToggle","mousedown .folder-arrow":"onArrowMousedown",keydown:"onKeydown"},list:function(){var a=this.options;return b.list(a.model_id,{all:a.tree.all})},reset:function(){this.isReset||(this.collection.fetched?this.onReset():this.list())},getFilter:function(){var a=this.options,b=a.filter?this:a.tree,c=a.filter||a.tree.filter;return c.bind(b,a.model_id)},onReset:function(){var a=this.options,b=this.collection.filter(this.getFilter()),c={};this.$.subfolders.children().each(function(){c[$(this).attr("data-id")]=$(this).detach().data("view")}),this.$.subfolders.append(b.map(function(a){return(c[a.id]||this.getTreeNode(a).render()).$el},this)),"1"!==this.folder&&this.model.set("subfolders",b.length>0),this.renderEmpty(),this.$.subfolders.children().each(function(){var b=$(this).data("view");b&&!c[b.folder]&&a.tree.appear(b)}),this.isReset=!0},onAdd:function(a){if(this.getFilter()(a)){var b=this.getTreeNode(a);this.$.subfolders.append(b.render().$el),this.options.tree.appear(b),this.model.set("subfolders",!0),this.renderEmpty()}},onRemove:function(a){var b=this.$.subfolders.children();b.filter('[data-id="'+$.escape(a.id)+'"]').remove(),0===b.length&&this.model.set("subfolders",!1),this.renderEmpty()},onChangeId:function(a){var c=String(a.get("id")),d=String(a.previous("id")),e=this.options.tree.selection,f=e.get();this.folder===d&&(this.folder=c),this.options.model_id===d&&(this.options.model_id=c),this.options.contextmenu_id===d&&(this.options.contextmenu_id=c),this.renderAttributes(),d===f&&this.options.tree.trigger("change",c),this.options.open=!1,this.collection&&(this.collection=b.pool.getCollection(c),this.isReset=!1,this.reset()),this.onChangeSubFolders()},onChange:function(a){void 0!==a.changed.id&&this.onChangeId(a),void 0!==a.changed[this.getIndexAttribute()]&&(this.renderAttributes(),this.options.parent.onSort&&this.options.parent.onSort()),a.changed.subfolders&&(this.options.open=!!a.changed.subfolders,this.onChangeSubFolders()),this.repaint()},toggle:function(a){this.options.open=a,this.onChangeSubFolders(),this.options.tree.trigger(a?"open":"close",this.folder)},onToggle:function(a){a.isDefaultPrevented()||(a.preventDefault(),this.toggle(!this.options.open))},hasArrow:function(){return 0===this.$.arrow.find("i.fa-fw").length},onArrowClick:function(a){return $(a.target).closest(this.$.arrow).length&&this.hasArrow()?void this.onToggle(a):void a.preventDefault()},onArrowMousedown:function(a){$(a.target).closest(this.$.arrow).length&&this.hasArrow()&&a.preventDefault()},onOptions:function(a){a.preventDefault()},hasSubFolders:function(){var a=/^virtual\/flat/.test(this.folder);return this.options.subfolders&&(a||this.model.get("subfolders")===!0)},onChangeSubFolders:function(){var a=this.options,b=this.hasSubFolders(),c=a.open&&b;this.$.arrow.toggleClass("invisible",!b).html(b?c?'<i class="fa fa-'+f+'-down">':'<i class="fa fa-'+f+'-right">':'<i class="fa fa-fw">'),b?this.$el.attr("aria-expanded",c):this.$el.removeAttr("aria-expanded"),this.$el.toggleClass("open",c),this.renderEmpty(),c&&this.reset()},onKeydown:function(a){if(!a.isDefaultPrevented()&&(37===a.which||39===a.which)&&(a.preventDefault(),this.hasSubFolders())){var b=this.options;39!==a.which||b.open?37===a.which&&b.open&&(b.open=!1,this.onChangeSubFolders()):(b.open=!0,this.onChangeSubFolders())}},getTreeNode:function(a){var b=this.options,c=b.headless||b.indent===!1?b.level:b.level+1,d={folder:a.id,icons:this.options.icons,level:c,tree:b.tree,parent:this};return new g(b.tree.getTreeNodeOptions(d,a))},functions:function(){this.onSort=_.debounce(function(){if(this.$){var a=_(this.$.subfolders.children()).sortBy(function(a){var b=$(a).attr("data-index");return parseInt(b,10)});this.$.subfolders.append(a)}},10),this.repaint=_.throttle(function(){null!==this.model&&this.render()},10)},initialize:function(a){this.functions(),this.folder=String(a.folder);var d=this.options=_.extend({arrow:!0,count:void 0,empty:!0,headless:!1,icons:!1,indent:!0,level:0,model_id:this.folder,contextmenu_id:this.folder,open:!1,sortable:!1,subfolders:!0,title:"",a11yDescription:[]},a);this.isVirtual=this.options.virtual||/^virtual/.test(this.folder),this.model=b.pool.getModel(d.model_id),this.collection=b.pool.getCollection(d.model_id,d.tree.all),this.isReset=!1,this.describedbyID=_.uniqueId("description-"),this.$={},this.$el.data("view",this),_(d.tree.open).contains(this.folder)&&(d.open=!0),d.subfolders&&this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset,sort:this.onSort}),this.listenTo(this.model,{change:this.onChange,"change:subfolders":this.onChangeSubFolders,destroy:this.destroy.bind(this)}),this.$el.attr({id:this.describedbyID,"aria-label":"","aria-level":d.level+1,"aria-selected":!1,"data-id":this.folder,"data-index":this.getIndex(),"data-model":d.model_id,"data-contextmenu-id":d.contextmenu_id,role:"treeitem",tabindex:"-1"}).append(this.$.selectable=$('<div class="folder-node" role="presentation">').css("padding-left",d.level*this.indentation).append(this.$.arrow=d.arrow?$('<div class="folder-arrow invisible"><i class="fa fa-fw"></i></div>'):[],this.$.icon=$('<div class="folder-icon"><i class="fa fa-fw"></i></div>'),this.$.label=$('<div class="folder-label">'),this.$.counter=$('<div class="folder-counter">')),this.$.a11y=$('<span class="sr-only">').attr({id:this.describedbyID}),this.$.subfolders=$('<ul class="subfolders" role="group">')),d.headless&&(this.$el.removeClass("selectable").removeAttr("tabindex"),this.$.selectable.hide()),d.sortable&&this.$el.attr("data-sortable",!0),this.isVirtual&&this.$el.addClass("virtual"),(!this.isVirtual||d.contextmenu)&&d.tree.options.contextmenu&&d.tree.app&&_.device("!smartphone")&&(this.$el.attr({"aria-haspopup":!0}),this.renderContextControl()),this.isVirtual||b.get(d.model_id),(d.empty===!1&&d.open===!1||this.isVirtual)&&this.reset();var e=this.model.toJSON(),f=c.Baton({view:this,data:e});c.point("io.ox/core/foldertree/node").invoke("initialize",this.$el,f),d.tree.options.customize.call(this.$el,f),d.tree.options.disable(e,d)&&this.$el.addClass("disabled"),this.$el.on("dispose",this.remove.bind(this))},getCounter:function(){return void 0!==this.options.count?this.options.count:this.model.get("unread")||0},renderCounter:function(){var a=this.getCounter();this.$.selectable.toggleClass("show-counter",a>0),this.$.counter.text(a)},getTitle:function(){return this.options.title||this.model.get("title")||""},renderTitle:function(){var a=this.getTitle();this.$.label.text(a)},renderA11yNode:function(){this.$.a11y.text(this.options.a11yDescription.join(". "))},renderTooltip:function(){if(!this.options.title&&this.model.has("title")){var a=this.model.toJSON(),b=[];
_.isNumber(a.total)&&a.total>=0&&b.push(e("Total: %1$d",a.total)),_.isNumber(a.unread)&&a.unread>=0&&b.push(e("Unread: %1$d",a.unread)),b=b.join(", "),b&&(b=" ("+b+")"),this.$el.attr({title:this.model.get("title")+b,"aria-label":this.model.get("title")+b})}},renderContextControl:function(){this.$.selectable.append($("<a>").addClass("folder-options contextmenu-control").attr({"data-contextmenu":this.options.contextmenu||"default","aria-label":e("Folder-specific actions"),href:"#",role:"button",tabindex:1}).append($('<i class="fa fa-bars" aria-hidden="true">'),$('<span class="sr-only">').text(e("Folder-specific actions"))))},renderAttributes:function(){this.$el.attr({"data-id":this.folder,"data-index":this.getIndex(),"data-model":this.options.model_id,"data-contextmenu-id":this.options.contextmenu_id})},getIndexAttribute:function(){var a=this.options.parent;return a&&a.collection?"index/"+a.collection.id:void 0},getIndex:function(){var a=this.getIndexAttribute();return void 0===a?0:this.model.get(a)||0},isEmpty:function(){return 0===this.$.subfolders.children().length},renderEmpty:function(){this.options.empty===!1&&this.$el.toggleClass("empty",this.isEmpty())},renderIcon:function(){var a,b=this.options;b.icons&&"mail"===b.tree.module&&(a=d.getType(this.folder)||"default",this.$.icon.addClass("visible "+a))},render:function(){return this.renderAttributes(),this.renderEmpty(),this.renderTitle(),this.renderTooltip(),this.renderCounter(),this.renderIcon(),this.onChangeSubFolders(),c.point("io.ox/core/foldertree/node").invoke("draw",this.$el,c.Baton({view:this,data:this.model.toJSON()})),this.renderA11yNode(),this},destroy:function(){var a=this.options.parent;this.$el.remove(),a.renderEmpty&&a.renderEmpty()},remove:function(){this.stopListening(),this.collection=this.model=this.options=this.$=null}});return g}),define("io.ox/core/folder/selection",[],function(){"use strict";function a(a){this.view=a,this.view.$el.on("click contextmenu",".selectable",$.proxy(this.onClick,this)).on("keydown",".selectable",$.proxy(this.onKeydown,this)),this.view.$el.addClass("dropzone").attr("data-dropzones",".selectable").on("drop",function(b,c){c.dropType=a.module,a.selection.trigger("selection:drop",c)})}return _.extend(a.prototype,{byId:function(a,b){return b=b||this.getItems(),b.filter('[data-id="'+$.escape(a)+'"]').first()},get:function(a){return this.view.$el.find(".selectable.selected").attr(a||"data-id")},set:function(a){var b=this.getItems(),c=this.byId(a),d=b.index(c);-1!==d&&this.get()!==a&&(this.resetSelected(b),this.pick(d,b,{focus:!1}))},preselect:function(a){return this.check(this.byId(a)).length>0},scrollIntoView:function(a){var b=this.byId(a);b.length&&b[0].scrollIntoView(!1)},onClick:function(a){if(!$(a.target).is(":checkbox")&&!a.isDefaultPrevented()){a.preventDefault(),"contextmenu"===a.type&&a.stopPropagation();var b=this.getItems(),c=$(a.currentTarget),d=b.index(c)||0;this.view.trigger("selection:action",b,d),c.hasClass("selected")||(this.resetTabIndex(b,b.eq(d)),this.resetSelected(b),this.pick(d,b))}},onKeydown:function(a){if($(a.target).hasClass("selectable"))switch(a.which){case 38:case 40:this.onCursorUpDown(a)}},onCursorUpDown:function(a){var b=this.getItems().filter(":visible"),c=$(document.activeElement),d=38===a.which,e=(b.index(c)||0)+(d?-1:1);if(!(e>=b.length||0>e||a.isDefaultPrevented())){if(a.preventDefault(),a.altKey&&"true"===c.parent().parent().attr("data-sortable"))return this.move(c,d);this.resetTabIndex(b,b.eq(e)),this.resetSelected(b),this.pick(e,b)}},move:function(a,b){b?a.insertBefore(a.prev()):a.insertAfter(a.next()),a.focus();var c=a.parent().parent().attr("data-id"),d=_(a.parent().children(".selectable")).map(function(a){return $(a).attr("data-id")});this.view.trigger("sort sort:"+c,d)},pick:function(a,b){var c=this.focus(a,b);this.check(c),this.triggerChange(b)},resetSelected:function(a){a.filter(".selected").removeClass("selected").attr("aria-selected",!1)},resetTabIndex:function(a,b){a=a.filter('[tabindex="1"]'),a.not(b).attr("tabindex","-1")},focus:function(a,b){b=b||this.getItems();var c=b.eq(a).attr("tabindex","1").focus();return _.device("chrome")&&c.hide(0,function(){$(this).css("display","")}),c},check:function(a){return a.addClass("selected").attr({"aria-selected":!0,tabindex:1})},uncheck:function(a){a.removeClass("selected").attr({"aria-selected":!1,tabindex:"-1"})},getItems:function(){return this.view.$el.find(".selectable")},triggerChange:_.debounce(function(a){var b=(a||this.getItems()).filter(".selected").first(),c=b.attr("data-id"),d=/^virtual/.test(c);this.view.trigger(d?"virtual":"change",c,b)},300)}),a}),define("io.ox/core/folder/tree",["io.ox/backbone/disposable","io.ox/core/folder/selection","io.ox/core/folder/api","io.ox/core/extensions","settings!io.ox/core","io.ox/core/folder/favorites","io.ox/core/folder/extensions","less!io.ox/core/folder/style"],function(a,b,c,d,e){"use strict";var f=a.extend({className:"folder-tree",events:{"click .contextmenu-control":"onToggleContextMenu","keydown .contextmenu-control":"onKeydown",'contextmenu .folder.selectable[aria-haspopup="true"], .contextmenu-control':"onContextMenu"},initialize:function(a){a=_.extend({context:"app",contextmenu:!1,customize:$.noop,disable:$.noop,abs:!0,icons:e.get("features/folderIcons",!1),root:"default0/INBOX",highlight:_.device("!smartphone"),highlightclass:"visible-selection"},a),this.all=!!a.all,this.app=a.app,this.context=a.context,this.flat=!!a.flat,this.module=a.module,this.open=a.open,this.root=a.root,this.$el.data("view",this),this.$container=$('<ul class="tree-container f6-target" role="tree">'),this.$dropdown=$(),this.$dropdownMenu=$(),this.options=a,this.$el.toggleClass(a.highlightclass,!!a.highlight),this.$el.append(this.$container),this.$el.attr({role:"navigation"}),this.selection=new b(this),a.abs&&this.$el.addClass("abs"),a.contextmenu&&_.defer(this.renderContextMenu.bind(this))},appear:function(a){var b=a.folder.replace(/\s/g,"_");this.trigger("appear:"+b,a)},onAppear:function(a,b){a=String(a).replace(/\s/g,"_"),this.once("appear:"+a,b)},preselect:function(a){void 0!==a&&this.onAppear(a,function(){_.defer(this.selection.set.bind(this.selection,a))})},filter:function(a,b){var c=this.options.filter,d=_.isFunction(c)?c.apply(this,arguments):void 0;if(void 0!==d)return d;var e=b.get("module");return e===this.module||"mail"===this.module&&/^default\d+(\W|$)/i.test(b.id)},getOpenFolders:function(){return _(this.$el.find(".folder.open")).chain().map(function(a){return $(a).attr("data-id")}).uniq().value().sort()},getTreeNodeOptions:function(a,b){return"default0/INBOX"===b.get("id")&&"virtual/standard"===a.parent.folder&&(a.subfolders=!!c.altnamespace),this.flat&&a.parent!==this&&(a.subfolders=!1),"virtual/standard"===a.parent.folder&&(a.icons=!0),a},toggleContextMenu:function(a,b,d){var e=this.$dropdown.hasClass("open");if(!e&&!_.device("smartphone")){var f=a.is(".contextmenu-control")?a.attr("data-contextmenu"):a.find(".contextmenu-control").first().attr("data-contextmenu");this.$dropdown.attr("data-contextmenu",f),_.defer(function(){var e=this.selection.get("data-contextmenu-id");c.isVirtual(e)||(this.$dropdownMenu.css({top:b,left:d,bottom:"auto"}).empty().busy(),this.$dropdown.data("previous-focus",a).find(".dropdown-toggle").dropdown("toggle"))}.bind(this))}},onToggleContextMenu:function(a){var b=$(a.currentTarget),c=b.offset(),d=c.top-7,e=c.left+b.outerWidth()+7;this.toggleContextMenu(b,d,e)},onContextMenu:function(a){a.stopPropagation(),a.preventDefault();var b=$(a.currentTarget),c=a.pageY-20,d=a.pageX+30;b.is(".contextmenu-control")&&(c=b.offset().top,d=b.offset().left+40),this.toggleContextMenu(b,c,d)},onCloseContextMenu:function(a){a.preventDefault(),this.$dropdown.hasClass("open")&&this.$dropdown.find(".dropdown-toggle").dropdown("toggle")},onKeydown:function(a){var b=this.$dropdown;switch(a.which){case 32:return a.preventDefault(),$(a.currentTarget).click(),b.find(".dropdown-menu > li:first > a").focus()}},getContextMenuId:function(a){return"io.ox/core/foldertree/contextmenu/"+(a||"default")},renderContextMenuItems:function(a){var b=this.selection.get("data-contextmenu-id"),e=this.app,f=this.module,g=this.$dropdownMenu.empty(),h=this.getContextMenuId(a),i=this;c.get(b).done(function(a){var b=new d.Baton({app:e,data:a,view:i,module:f});_.device("smartphone")&&g.append($('<li role="presentation">').append($('<a href="#" class="io-ox-action-link" data-action="close-menu" role="menuitem" aria-haspopup="true">').append($('<i class="fa fa-chevron-down" aria-hidden="true">'),$('<span class="sr-only">')))),d.point(h).invoke("draw",g,b),!_.device("smartphone")&&g.offset().top+g.outerHeight()>$(window).height()-20&&g.css({top:"auto",bottom:"20px"})})},renderContextMenu:function(){function a(a){this.$dropdownMenu.idle(),this.renderContextMenuItems(a)}function b(b){var c=$(b.target).attr("data-contextmenu");require(["io.ox/core/folder/contextmenu"],_.lfo(a.bind(this,c)))}function c(){var a=$(this).data("previous-focus");a&&a.parent().focus()}return function(){this.$el.after(this.$dropdown=$('<div class="context-dropdown dropdown" data-action="context-menu" data-contextmenu="default">').append($('<div class="abs context-dropdown-overlay">').on("contextmenu",this.onCloseContextMenu.bind(this)),this.$dropdownToggle=$('<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true">'),this.$dropdownMenu=$('<ul class="dropdown-menu" role="menu">')).on("show.bs.dropdown",b.bind(this)).on("hidden.bs.dropdown",c)),this.$dropdownToggle.dropdown()}}(),render:function(){return d.point("io.ox/core/foldertree/"+this.module+"/"+this.context).invoke("draw",this.$container,this),this}});return f}),define("io.ox/core/folder/favorites",["io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/extensions","settings!io.ox/core","gettext!io.ox/core"],function(a,b,c,d,e){"use strict";function f(a){var c=a.data.id,d=a.data.module,e=b.pool.getModel(c),f="virtual/favorites/"+d,g=b.pool.getCollection(f);e.set("index/"+f,g.length,{silent:!0}),g.add(e),g.sort()}function g(a){var c=a.data.id,d=a.data.module,e=b.pool.getModel(c),f=b.pool.getCollection("virtual/favorites/"+d);f.remove(e)}function h(a,b){return $('<a href="#" tabindex="1" role="menuitem">').attr("data-action",a).text(b).on("click",$.preventDefault)}function i(a){return a.attr("aria-disabled",!0).removeAttr("tabindex").addClass("disabled")}function j(a,b){var c=h(b.action,b.text);return b.enabled?c.on("click",b.data,b.handler):i(c),a.append($("<li>").append(c)),c}_("mail contacts calendar tasks infostore".split(" ")).each(function(f){function g(a){d.set("favorites/"+f,a).save()}function h(){g(k.pluck("id"))}var i="virtual/favorites/"+f,j=b.pool.getModel(i),k=b.pool.getCollection(i),l=d.get("favorites/"+f,[]);b.virtual.add(i,function(){return b.multiple(l).then(function(a){var c=_(a).compact();return _(c).each(b.injectIndex.bind(b,i)),j.set("subfolders",c.length>0),c.length!==a.length&&h(),c})}),k.on("add remove",h);var m={id:"favorites",index:"first",draw:function(b){this.append(new a({empty:!1,folder:i,open:!1,parent:b,sortable:!0,title:e("Favorites"),tree:b}).render().$el.addClass("favorites")),b.on("sort:"+i,g)}};c.point("io.ox/core/foldertree/"+f+"/app").extend(_.extend({},m)),c.point("io.ox/core/foldertree/"+f+"/popup").extend(_.extend({},m))}),c.point("io.ox/core/foldertree/contextmenu/default").extend({id:"toggle-favorite",index:1e3,draw:function(a){var b=a.data.id,c=a.module,h=d.get("favorites/"+c,[]),i=_(h).indexOf(b)>-1;j(this,{action:"toggle-favorite",data:{id:b,module:c},enabled:!0,handler:i?g:f,text:e(i?"Remove from favorites":"Add to favorites")})}})}),define("io.ox/core/folder/view",["io.ox/core/extensions","io.ox/core/folder/api","settings!io.ox/core","gettext!io.ox/core"],function(a,b,c,d){"use strict";function e(e){function f(){m.settings.set("folderview/visible/"+_.display(),q).save()}function g(a){void 0===a?m.settings.remove("folderview/width/"+_.display()):m.settings.set("folderview/width/"+_.display(),a),m.settings.save()}function h(){return m.settings.get("folderview/width/"+_.display())}function i(a){var b=void 0===a?"":a+"px";s.body.css("left",b),s.sidepanel.css("width",b)}function j(){i(h())}function k(){var a=m.getWindow(),b=a.options.chromeless,c=$(document).width()<=m.folderView.resize.autoHideThreshold;s.body.css("left",b||c?0:50)}function l(){var a=$(document).width();if(s.outer.is(":visible")){var b=m.folderView.resize.autoHideThreshold;!u&&q&&b>=a?(m.folderView.hide(),u=!0):u&&a>b&&(m.folderView.show(),u=!1)}}e=_.extend({firstResponder:"listView",autoHideThreshold:700},e);var m=e.app,n=e.tree,o=n.options.module,p=m.get("name")+"/folderview",q=!1,r=m.settings.get("folderview/open",{}),s=m.getWindow().nodes,t=s.sidepanel,u=!1;if(m.folderView={tree:n,isVisible:function(){return q},show:function(){q=!0,u||f(),j(),t.addClass("visible"),m.trigger("folderview:open")},hide:function(){q=!1,u||f(),k(),t.removeClass("visible").css("width",""),m.trigger("folderview:close")},toggle:function(a){void 0===a&&(a=!q),a?this.show():this.hide()},resize:function(){function a(a){var b=a.pageX-d;b>j||k>b||(m.trigger("folderview:resize"),i(f=b))}function b(a){$(this).off("mousemove.resize mouseup.resize"),a.pageX-d<.75*k?m.folderView.hide():g(f)}function c(c){c.preventDefault(),d=c.pageX-t.width(),j=$(document).width()/2,$(document).on({"mousemove.resize":a,"mouseup.resize":b})}var d,f,h=$(),j=0,k=150;return{enable:function(){t.append(h=$('<div class="resizebar">').on("mousedown.resize",c))},autoHideThreshold:e.autoHideThreshold}}()},m.folderViewIsVisible=function(){return q},$(window).on("resize",_.throttle(l,200)),a.point(p+"/options").extend({id:"defaults",index:100,rootFolderId:"1",type:void 0,view:"ApplicationFolderTree",visible:_.device("small")?!1:m.settings.get("folderview/visible/"+_.display(),!0)}),o){var v=c.get(["folder/hidden"]);void 0===v&&(v=m.settings.get("folderview/blacklist",{}),_.isObject(v)&&c.set(["folder/hidden"],v).save())}r&&r[_.display()]&&(r=r[_.display()]),r=_.isArray(r)?r:[],n.open=r;var w=m.folder.get();_.device("smartphone")?(n.$el.on(_.device("ios")?"click":"tap",".folder",_.debounce(function(a){if(!$(a.target).is(".folder-arrow, .fa")){if(m.props.get("mobileFolderSelectMode")===!0)return n.$dropdown.find(".dropdown-toggle").click();m.pages.changePage(e.firstResponder),e.respondCallback&&e.respondCallback()}},10)),w&&_.defer(n.selection.preselect.bind(n.selection,w))):(t.addClass("border-right").append(n.$el),w?_.defer(function(){b.path(w).done(function(a){var b=_(a).pluck("id").slice(0,-1);n.open=_(n.open.concat(b)).uniq()}).always(function(){return n.selection.preselect(w)?void n.selection.scrollIntoView(w):(n.once("appear:"+w,function(){n.selection.preselect(w),n.selection.scrollIntoView(w)}),void n.render())})}):n.render()),n.$(".tree-container").attr({"aria-label":d("Folders")}),_(a.point(p+"/options").all()).each(function(a){e=_.extend(a,e||{})}),function(){var a=!1;n.on("change",function(b){a=!0,m.folder.set(b),a=!1}),m.on("folder:change",function(b){a||n.selection.set(b)})}(),b.on("remove:prepare",function(a,c){var d="1"===c.folder_id?b.getDefaultFolder(c.module)||"1":c.folder_id;n.selection.set(d)}),b.on("move",function(a,b,c){n.selection.set(c)}),n.on("open close",function(){var a=this.getOpenFolders();m.settings.set("folderview/open/"+_.display(),a).save()}),window.tree=n,e.visible&&m.folderView.show()}return{initialize:e}}),define("io.ox/core/folder/extensions",["io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/api/account","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/api/user","io.ox/mail/api","gettext!io.ox/core","io.ox/core/folder/favorites","less!io.ox/core/folder/style"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){ox.load(["io.ox/core/folder/actions/add"]).done(function(b){b(a.data.folder,{module:a.data.module})})}var j="default0"+g.separator+"INBOX";b.virtual.add("virtual/standard",function(){return this.concat(b.get(j),b.list("default0"),b.list(j))}),b.virtual.add("virtual/myfolders",function(){var a=b.altnamespace?"default0":j;return b.list(a).then(function(a){return _(a).filter(function(a){return c.isStandardFolder(a.id)?!1:b.is("public|shared",a)?!1:!0})})}),b.virtual.add("virtual/remote",function(){return b.list("1").then(function(a){return _(a).filter(function(a){return c.isExternal(a.id)})})});var k={unifiedFolders:function(b){this.append(new a({empty:!1,filter:function(a,b){return/^default/.test(b.id)&&c.isUnified(b.id)},folder:"1",headless:!0,open:!0,tree:b,parent:b}).render().$el.addClass("unified-folders"))},standardFolders:function(b){this.append(new a({filter:function(a,b){return c.isStandardFolder(b.id)},folder:"virtual/standard",headless:!0,open:!0,tree:b,parent:b}).render().$el.addClass("standard-folders"))},localFolders:function(c){var d=b.altnamespace?"default0":j,e=new a({contextmenu:"myfolders",count:0,empty:!!b.altnamespace,folder:"virtual/myfolders",icons:c.options.icons,contextmenu_id:d,parent:c,title:h("My folders"),tree:c});b.on("create:"+d,function(){e.toggle(!0)}),this.append(e.render().$el)},remoteAccounts:function(b){this.append(new a({folder:"virtual/remote",headless:!0,open:!0,icons:b.options.icons,tree:b,parent:b}).render().$el.addClass("remote-folders"))},addRemoteAccount:function(){e.has("multiple_mail_accounts")&&this.append($('<div class="links">').append($('<a href="#" data-action="add-mail-account" tabindex="1" role="button">').text(h("Add mail account")).on("click",function(a){a.preventDefault(),require(["io.ox/mail/accounts/settings"],function(b){b.mailAutoconfigDialog(a)})})))},otherFolders:function(d){this.append(new a({filter:function(a,d){return c.isStandardFolder(d.id)?!1:"default0/virtual"===d.id?!1:b.altnamespace?b.is("public|shared",d.toJSON()):!0},folder:"default0",headless:!0,open:!0,icons:d.options.icons,tree:d,parent:d}).render().$el.addClass("other-folders"))},rootFolders:function(b){this.append(new a({folder:b.root,headless:!0,open:!0,tree:b,parent:b}).render().$el)}},l=100;return d.point("io.ox/core/foldertree/mail/app").extend({id:"unified-folders",index:l+=100,draw:k.unifiedFolders},{id:"standard-folders",index:l+=100,draw:k.standardFolders},{id:"local-folders",index:l+=100,draw:k.localFolders},{id:"other",index:l+=100,draw:k.otherFolders},{id:"remote-accounts",index:l+=100,draw:k.remoteAccounts},{id:"add-account",index:l+=100,draw:k.addRemoteAccount}),d.point("io.ox/core/foldertree/mail/popup").extend({id:"standard-folders",draw:k.standardFolders},{id:"local-folders",draw:k.localFolders},{id:"other",draw:k.otherFolders},{id:"remote-accounts",draw:k.remoteAccounts}),d.point("io.ox/core/foldertree/mail/subscribe").extend({id:"root-folders",draw:k.rootFolders}),d.point("io.ox/core/foldertree/mail/account").extend({id:"root-folders",draw:k.rootFolders}),d.point("io.ox/core/foldertree/mail/filter").extend({id:"standard-folders",draw:k.standardFolders},{id:"local-folders",draw:k.localFolders},{id:"other",draw:k.otherFolders}),d.point("io.ox/core/foldertree/infostore/app").extend({id:"standard-folders",index:100,draw:k.rootFolders}),d.point("io.ox/core/foldertree/infostore/popup").extend({id:"standard-folders",index:100,draw:k.rootFolders}),_("contacts calendar tasks".split(" ")).each(function(c){function g(a){require(["io.ox/core/permissions/permissions"],function(b){b.show(a.data.id)})}function j(a){var b={id:"io.ox/core/pubsub",folder:a.data.folder.id,data:a.data.folder};ox.launch("io.ox/settings/main",b).done(function(){this.setSettingsPane(b)})}var k={id:"standard-folders",index:100,draw:function(e){var f,g,i=$('<div class="links">'),j=d.Baton({module:c,view:e,context:e.context}),k="virtual/flat/"+c,l="flat/"+c,m={count:0,empty:!1,indent:!1,open:!1,tree:e,parent:e};d.point("io.ox/core/foldertree/"+c+"/links").invoke("draw",i,j),f=new a(_.extend({},m,{empty:!0,folder:k+"/private",model_id:l+"/private",title:h("Private")})),b.pool.getCollection("flat/"+c+"/private").on("add",function(){f.toggle(!0)}),b.pool.getCollection("flat/"+c+"/public").on("add",function(){f.toggle(!0)}),g=new a(_.extend({},m,{folder:k+"/public",model_id:l+"/public",title:h("Public")})),this.append(f.render().$el.addClass("section"),i,g.render().$el.addClass("section"),new a(_.extend({},m,{folder:k+"/shared",model_id:l+"/shared",title:h("Shared")})).render().$el.addClass("section"),new a(_.extend({},m,{folder:k+"/hidden",model_id:l+"/hidden",title:h("Hidden")})).render().$el.addClass("section"))}};d.point("io.ox/core/foldertree/"+c+"/app").extend(_.extend({},k)),d.point("io.ox/core/foldertree/"+c+"/popup").extend(_.extend({},k)),d.point("io.ox/core/foldertree/"+c+"/links").extend({index:200,id:"private",draw:function(a){if("app"===a.context){var c=a.module,d=b.getDefaultFolder(c);this.append($("<div>").append($('<a href="#" tabindex="1" data-action="add-subfolder" role="menuitem">').text(h("calendar"===c?"New private calendar":"New private folder")).on("click",{folder:d,module:c},i)))}}},{index:300,id:"public",draw:function(a){if("app"===a.context&&e.has("edit_public_folders")){var c=$("<div>"),d=a.module;this.append(c),b.get("2").done(function(a){b.can("create",a)&&c.append($('<a href="#" tabindex="1" data-action="add-subfolder" role="menuitem">').text(h("calendar"===d?"New public calendar":"New public folder")).on("click",{folder:"2",module:d},i))})}}}),d.point("io.ox/core/foldertree/node").extend({id:"shared-by",index:100,draw:function(a){var c=a.view.model,d=c.toJSON();/^(contacts|calendar|tasks)$/.test(d.module)&&b.is("shared",d)&&(this.find(".owner").remove(),this.addClass("shared").find(".folder-node").append($('<div class="owner">').append(f.getLink(d.created_by,d["com.openexchange.folderstorage.displayName"]).attr({tabindex:-1}))),a.view.options.a11yDescription.push(h("Shared by other users")))}},{id:"shared",index:200,draw:function(a){this.find(".folder-node:first .folder-shared:first").remove(),a.view.options.a11yDescription=a.view.options.a11yDescription.filter(function(a){return a!==h("You share this folder with other users")}),_.device("smartphone")||"infostore"!==a.data.module&&b.is("unlocked",a.data)&&(this.find(".folder-node:first").append($('<i class="fa folder-shared">').attr("title",h("You share this folder with other users")).on("click",{id:a.data.id},g)),a.view.options.a11yDescription.push(h("You share this folder with other users")))}},{id:"pubsub",index:300,draw:function(a){this.find(".folder-pubsub:first").remove(),b.is("shared",a.data)||e.has("publication")&&b.is("published|subscribed",a.data)&&(this.find(".folder-node:first").append($('<i class="fa folder-pubsub">').attr("title",h("This folder has publications and/or subscriptions")).on("click",{folder:a.data},j)),a.view.options.a11yDescription.push(h("This folder has publications and/or subscriptions")))}})}),k}),define("io.ox/core/settings/defaults",function(){"use strict";var a;a=ox.serverConfig&&ox.serverConfig.languages?_(ox.serverConfig.languages).contains("en_US")?"en_US":ox.serverConfig.languages[0]:"en_US";var b=_.getCookie("language");return b&&(a=b),{language:a,refreshInterval:3e5,autoStart:"io.ox/mail/main",autoOpenNotification:"noEmail",autoLogout:0,settings:{downloadsDisabled:!1}}}),define("io.ox/core/settingOptions/settings/defaults",function(){"use strict";return{}}),define("io.ox/mail/settings/defaults",[],function(){"use strict";var a={removeDeletedPermanently:!1,contactCollectOnMailTransport:!1,contactCollectOnMailAccess:!1,useFixedWidthFont:!1,appendVcard:!1,sendDispositionNotification:!1,appendMailTextOnReply:!0,forwardMessageAs:"Inline",messageFormat:"html",lineWrapAfter:"0",defaultSendAddress:"",autoSaveDraftsAfter:!1,allowHtmlMessages:!0,allowHtmlImages:!1,displayEmoticons:!1,isColorQuoted:!1,selectFirstMessage:!0,defaultSignature:!1,mobileSignature:void 0,mobileSignatureType:"none",threadSupport:!0,sort:"thread",order:"desc",unread:!1};return a}),define("io.ox/contacts/settings/defaults",function(){"use strict";var a={showAdmin:!1,fullNameFormat:"auto"};return a}),define("io.ox/calendar/settings/defaults",function(){"use strict";var a={interval:30,startTime:8,endTime:18,defaultReminder:15,viewView:"week:workweek",showDeclinedAppointments:!0,markFulltimeAppointmentsAsFree:!1,notifyNewModifiedDeleted:!0,notifyAcceptedDeclinedAsCreator:!1,notifyAcceptedDeclinedAsParticipant:!1,showAllPrivateAppointments:!1,deleteInvitationMailAfterAction:!0};return a}),define("io.ox/tasks/settings/defaults",function(){"use strict";var a={interval:30,notifyNewModifiedDeleted:!0,notifyAcceptedDeclinedAsCreator:!1,notifyAcceptedDeclinedAsParticipant:!1};return a}),define("io.ox/files/settings/defaults",function(){"use strict";var a={view:"fluid:icon",videoEnabled:!0,audioEnabled:!0,rootFolderId:9,showHidden:!1};return a}),define("io.ox/core/collection",["io.ox/core/folder/api"],function(a){"use strict";function b(a){var b=_.compact([].concat(a)),d=c;this.getProperties=function(){return f(b).always(function(a){d=a})},this.isResolved=function(){return d!==c},this.isLarge=function(){return b.length>=100},this.has=function(){return this.isResolved()||console.error("Using Collection.has before properties are resolved!",a,arguments),_(arguments).inject(function(a,b){return a&&d[b]===!0},!0)}}var c={},d=function(b,c,d){var e=a.bits(b,d);return 0===e?!1:1===e?c===ox.user_id:!0},e=function(a){return a?a.folder_id||a.folder:void 0},f=function(b){var c=b.length||0,f={read:!0,modify:!0,"delete":!0,create:!0,none:0===c,some:c>0,one:1===c,multiple:c>1},g=_.chain(b).map(e).compact().uniq().value();return f.toplevel=_(b).reduce(function(a,b){return a&&"folder_id"in b&&!("filename"in b)},!0),0===g.length?(f.unknown=!0,f.read=f.modify=f["delete"]=!1,$.Deferred().resolve(f)):a.multiple(g).then(function(a){for(var g=0,h=null,i=null,j=_.toHash(a,"id");c>g;g++){if(h=b[g],!(i=j[e(h)])){f.unknown=!0,f.read=f.modify=f["delete"]=f.create=!1;break}f.read=f.read&&d(i,h.created_by,7),f.modify=f.modify&&d(i,h.created_by,14),f["delete"]=f["delete"]&&d(i,h.created_by,21),f.create=f.create&&(127&i.own_rights)>=2}return f})};return b}),define("io.ox/core/extPatterns/actions",["io.ox/core/extensions","io.ox/core/upsell","io.ox/core/collection"],function(a,b,c){"use strict";var d=function(a){return function(b){return b.collection.has.apply(b.collection,a.split(/ /))}},e=function(a){return a.collection.has("one")},f=function(b,c){var f=_.extend({id:"default",index:100,requires:e},c);_.isString(f.requires)&&(f.requires=d(f.requires)),a.point(b).extend(f)},g=function(a){return!_(this).any(function(b){return _.isEqual(a,b)})},h=function(c,d,e){e=a.Baton.ensure(e),e.tracker=[].concat(e.data);var f,h,i=a.point(c),j=_(i.pluck("capabilities")).filter(function(a){return!_(a).isEmpty()}),k=0===e.tracker.length,l=i.list(),m=0,n=l.length;if(j.length&&!b.any(j))return void(b.enabled(j)&&b.trigger({type:"inline-action",id:c,missing:b.missing(j)}));for(;n>m&&!e.isPropagationStopped();m++)if(f=l[m],"default"!==f.id||!e.isDefaultPrevented()){if(!k&&0===e.tracker.length)break;if(_.isFunction(f.filter)?(h=_(e.tracker).filter(f.filter),e.tracker=_(e.tracker).filter(g,h)):h=e.tracker.slice(),h.length||k)try{_.isFunction(f.action)&&f.action.call(d,e),_.isFunction(f.multiple)&&f.multiple.call(d,h,e)}catch(o){console.error('point("'+c+'") > invoke()',o.message,{baton:e,context:d,extension:f,exception:o})}}},i=function(b,c,d){var e=!1,f=function(){e=!0},g=a.point(b).map(function(a){var g,h=!0;if(e)return $.Deferred().resolve(!1);if(_.isFunction(a.requires)){g={baton:d,collection:c,context:d.data,extension:a,point:b,stopPropagation:f};try{h=a.requires(g)}catch(i){g.exception=i,console.error('point("'+b+'") > "'+a.id+'" > processActions() > requires()',i.message,g)}}return void 0===h||h.promise||(h=$.Deferred().resolve(h)),h}).value();return $.when.apply($,g)},j=function(a){h(a.data.ref,this,a.data.selection,a)},k=function(a,b,d){var e=$.Deferred(),f=new c(b),g=a.find("[data-action]"),d=$.extend({cssDisable:!1,eventType:"click"},d);return f.getProperties().done(function(){$.when.apply($,_(g).map(function(a){a=$(a);var c=a.attr("data-action");return i(c,f,b).done(function(e){e===!1?(a.prop("disabled",!0).off(d.eventType+".action"),d.cssDisable&&a.addClass("disabled")):a.prop("disabled",!1).removeClass("disabled").off(d.eventType+".action").on(d.eventType+".action",{ref:c,selection:b},j)})})).done(e.resolve)}),e.done(function(){f=b=g=null})},l=function(c,d,e,f){if(!c)return $.when();e=a.Baton.ensure(e);var g=new $.Deferred;return d.getProperties().then(function(){var h=a.point(c).map(function(c){var g=$.Deferred();if(!c.ref)return g.resolve({link:c,state:!0});if(c.isEnabled&&!c.isEnabled.apply(c,f))return g.resolve({link:c,state:!1});var h=a.point(c.ref).pluck("capabilities");return b.visible(h)?i(c.ref,d,e).then(function(){var a=_(arguments).any(function(a){return a===!0});return{link:c,state:a}}):g.resolve({link:c,state:!1})});$.when.apply($,h.value()).done(function(){g.resolve(_(arguments).toArray()),h=null})},function(){g.resolve([])}),g};return{Action:f,invoke:h,applyCollection:l,updateCustomControls:k}}),define("io.ox/core/api/account",["settings!io.ox/mail","io.ox/core/http","io.ox/core/event"],function(a,b,c){"use strict";function d(a,b){return a=$.trim(a||""),b=l.trimAddress(b),[a!==b?a:"",b]}function e(b){if(!b)return[];if(!b.addresses)return[d(b.personal,b.primary_address)];var c=_(String(b.addresses||"").toLowerCase().split(",")).map($.trim).sort();return _(c).map(function(c){var e=c!==b.primary_address,f=e&&a.get("features/anonymousAliases",!1),g=f?"":b.personal;return d(g,c)})}var f={},g={},h=a.get("defaultseparator","/"),i=function(b){var c=_.isArray(b);b=c?b:[b];var d=/^default\d+/,e=function(b,c,e){var f="default"+b.id+h,g=c+"_fullname";if(0!==b.id||b[g])b[g]?d.test(b[g])||(b[g]=f+b[g]):b[g]=f+(b[c]||e);else{var i=a.get(["folder",c]);i||(i=a.get("folder/inbox")+h+(b[c]||e)),b[g]=i}};return _(b).each(function(a){e(a,"trash","Trash"),e(a,"sent","Sent"),e(a,"drafts","Drafts"),e(a,"spam","Spam"),e(a,"archive","Archive"),e(a,"confirmed_spam","Confirmed Spam"),e(a,"confirmed_ham","Confirmed Ham")}),c?b:b[0]},j=new RegExp("^default\\d+"+h+"[^"+h+"]+"+h),k=new RegExp("^default\\d+"+h+"[^"+h+"]+$"),l={};c.extend(l),l.isUnified=function(b){/^\d+$/.test(b)&&(b="default"+b);var c=a.get("unifiedInboxIdentifier");if(!c||"null"===c)return!1;var d=String(b).match(/^(default\d+)/);return!!d&&c===d[1]+h+"INBOX"},l.isUnifiedFolder=function(a){return k.test(a)&&l.isUnified(a)},l.isAccount=function(a){if(_.isNumber(a))return a in f;var b=String(a).match(/^default(\d+)/);return b&&b[1]in f},l.isPrimary=function(a){return/^default0/.test(a)},l.isExternal=function(a){return l.isAccount(a)&&!l.isPrimary(a)},l.getUnifiedMailboxName=function(){return this.getUnifiedInbox().then(function(a){return null===a?null:a.split(h)[0]})},l.getUnifiedInbox=function(){var b=a.get("unifiedInboxIdentifier",null);return $.when("null"===b?null:b)},l.getInbox=function(){return a.get("folder/inbox")},l.is=function(){function a(a,c){if(l.isUnified(c)){var d=b[a];return Boolean(d&&d.test(c))}return"inbox"===a?g[c]===a:_(g).some(function(b,d){var e=0===c.indexOf(d+h);return b===a&&(d===c||e)})}var b={inbox:/^default\d+\DINBOX(?:\/|$)/,sent:/^default\d+\DSent(?:\/|$)/,trash:/^default\d+\DTrash(?:\/|$)/,drafts:/^default\d+\DDrafts(?:\/|$)/,spam:/^default\d+\DSpam(?:\/|$)/};return _.memoize(function(b,c){return b=String(b||"").split("|"),c=String(c||""),_(b).reduce(function(b,d){return b||a(d,c)},!1)},function(a,b){return a+":"+b})}(),l.getFoldersByType=function(a){return _(g).chain().map(function(b,c){return b===a?c:null}).compact().value()},l.getStandardFolders=function(){return _(g).keys()},l.isStandardFolder=function(a){return void 0!==g[a]},l.getType=function(a){return g[a]},l.getTypes=function(){return g},l.inspect=function(){return{accounts:f,types:g}},l.parseAccountId=function(a,b){if("number"==typeof a)return a;if(/^default(\d+)/.test(String(a))){if(l.isUnified(a)){var c=a.replace(j,"");
if(c!==a&&/^default\d+/.test(c))return l.parseAccountId(c,b);if(b){var d=a.match(/^default(\d+)/);return d&&d.length?parseInt(d[1],10):0}return 0}return parseInt(a.replace(/^default(\d+)(.*)$/,"$1"),10)}return 0},l.getPrimaryAddress=function(a){return l.get(a||0).then(m).then(function(b){return b?0===a||l.isUnified(a)?require(["settings!io.ox/mail"]).then(function(a){var c=$.trim(a.get("defaultSendAddress",""));return[b.personal,c||b.primary_address]}):[b.personal,b.primary_address]:$.Deferred().reject(b)}).then(function(a){return d(a[0],a[1])})},l.getPrimaryAddressFromFolder=function(a){var b=this.parseAccountId(a,!0),c=l.isUnified(b);return this.getPrimaryAddress(c?0:b)},l.getDefaultDisplayName=function(){return require(["io.ox/contacts/util","io.ox/core/api/user"]).then(function(a,b){return b.get({id:ox.user_id}).then(function(b){return a.getMailFullName(b)})})};var m=function(a){return!a||a.personal&&(" "===a.personal||""!==$.trim(a.personal))?$.Deferred().resolve(a):l.getDefaultDisplayName().then(function(b){return a.personal=b,a})};return l.trimAddress=function(a){return a=$.trim(a),a.indexOf("@")>-1?a.toLowerCase():a},l.getSenderAddresses=function(a){return this.get(a||0).then(m).then(e)},l.getAllSenderAddresses=function(){return l.all().then(function(a){return $.when.apply($,_(a).map(m))}).then(function(){return _(arguments).flatten(!0)}).then(function(a){return $.when.apply($,_(a).map(e))}).then(function(){return _(arguments).flatten(!0)}).then(function(a){return a})},l.cache={},ox.rampup&&ox.rampup.accounts&&_(ox.rampup.accounts).each(function(a){var c=i(b.makeObject(a,"account"));l.cache[c.id]=c}),l.all=function(){function a(){return _(l.cache).size()>0?$.Deferred().resolve(_(l.cache).values()):b.GET({module:"account",params:{action:"all"},appendColumns:!0,processResponse:!0}).then(function(a){return a=i(a),l.cache={},_(a).each(function(a){l.cache[a.id]=i(a)}),a})}return a().done(function(a){f={},g={},_(a).each(function(a){f[a.id]=!0,g["default"+a.id+"/INBOX"]="inbox",_("sent drafts trash spam archive".split(" ")).each(function(b){var c=a[b],d=a[b+"_fullname"];g[d||c]=b})})})},l.get=function(a){var b=function(){return l.all().then(function(){return l.cache[a]})};return l.cache[a]?$.Deferred().resolve(l.cache[a]):b()},l.create=function(a){return b.PUT({module:"account",params:{action:"new"},data:a,appendColumns:!1}).then(function(a){return l.cache={},l.all().then(function(){return l.trigger("create:account",{id:a.id,email:a.primary_address,name:a.name}),require(["io.ox/core/folder/api"],function(a){a.propagate("account:create")}),a})})},l.remove=function(a){return b.PUT({module:"account",params:{action:"delete"},data:a,appendColumns:!1}).done(function(){delete l.cache[a],l.trigger("refresh.all"),l.trigger("delete"),require(["io.ox/core/folder/api"],function(a){a.propagate("account:delete")})})},l.validate=function(a,c){return c=_.extend({action:"validate"},c),b.PUT({module:"account",appendColumns:!1,params:c,data:a,processData:!1}).then(function(a){return $.Deferred().resolve(a.data)},function(a){return $.Deferred().resolve(a.data,a)})},l.update=function(a){return delete a.mail_url,delete a.transport_url,b.PUT({module:"account",params:{action:"update"},data:a,appendColumns:!1}).then(function(c){function d(){return _.isObject(c)?$.Deferred().resolve(c):b.GET({module:"account",params:{action:"get",id:a.id},appendColumns:!1})}var e=c.id;if(l.cache[e]){var f=c.unified_inbox_enabled;l.cache[e].unified_inbox_enabled!==f&&require(["io.ox/core/folder/api"],function(a){a.propagate(f?"account:unified-enable":"account:unified-disable")})}return d().done(function(a){l.cache[e]=a}).done(function(a){l.trigger("refresh.all"),l.trigger("update",a)})})},l.autoconfig=function(a){return b.POST({module:"autoconfig",params:{action:"get",email:a.email,password:a.password}})},l.configtestAll=function(){return b.GET({module:"jslob",params:{action:"all"}})},l.configtestList=function(a){return b.PUT({module:"jslob",params:{action:"list"},data:a})},l.configtestUpdate=function(a,c){return b.PUT({module:"jslob",params:{action:"update",id:c},data:a})},l.configtestSet=function(a,c){return b.PUT({module:"jslob",params:{action:"set",id:c},data:a})},l.refresh=function(){l.cache={},l.trigger("refresh.all")},ox.on("refresh^",function(){l.refresh()}),l}),define("io.ox/core/tk/selection",["io.ox/core/event","io.ox/core/extensions","io.ox/core/collection","io.ox/core/notifications","gettext!io.ox/core","io.ox/core/tk/draghelper"],function(a,b,c,d,e){"use strict";function f(a,b){return a=a.map(function(){return $.trim($(this).attr("title")||$(this).text())}),$.makeArray(a).join(b||"")}function g(a){var b=f(this.find(".selected .drag-title"),", ");return b||e.format(e.ngettext("1 item","%1$d items",a.length),a.length)}var h=function(d,e){e=_.extend({draggable:!1,dragMessage:g,dragCssClass:void 0,dragType:"",dropzone:!1,dropzoneSelector:".selectable",dropType:"",scrollpane:d,focus:"[tabindex]",tabFix:1,markable:!1},e),this.classFocus="focussed",this.classSelected="selected",a.extend(this);var f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I=this,J=!0,K=!1,L=".vgrid-cell",M={},N=!0,O=[],P={},Q={},R=Q,S=Q,T=$.noop,U=-1,V=0;if(u=function(a){return!$(a.target).hasClass("not-selectable")},v=function(a){var b=$(a.target).closest(L);return K&&b.length},w=function(a){return J&&a&&(a.metaKey||a.ctrlKey)},x=function(a){return a&&a.shiftKey&&J},y=function(a){return $(a.currentTarget).hasClass("dnd-over")},G=function(){var a,b=0;for(a in M)if(b++,b>1)return!0;return!1},f=function(){var a=I.get();I.trigger("change",a),0===a.length&&I.trigger("empty")},r=function(){var a=I.get();I.trigger("_m_change",a),0===a.length&&I.trigger("empty")},h=function(a,b,c){x(b)?(I.selectRange(S,a),R=a):(T(b)?Z(a):t(a),R=S=a,V=z(a)),c?v(b)||H?(b.preventDefault(),r()):h(a,b):f()},B=function(a){if(N&&O.length){var b=O[0];n(a),h(b.data,a),I.trigger("select:first",b.data)}},C=function(a){if(N){var b,c=z(R)-1;c>=0&&(b=O[c],n(a),h(b.data,a),I.trigger("select:previous",b.data))}},D=function(a){if(N&&O.length){var b=O.length-1,c=O[b];n(a),h(c.data,a),I.trigger("select:last",c.data)}},E=function(a){if(N){var b,c=z(R)+1;c<O.length&&(b=O[c],n(a),h(b.data,a),I.trigger("select:next",b.data))}},F=function(a){switch(I.trigger("keyboard",a,a.which),a.which){case 38:if(a.preventDefault(),$(a.target).hasClass("folder-options-badge dropdown-opened"))return;a.metaKey||a.ctrlKey?B(a):C(a);break;case 32:e.markable&&(a.preventDefault(),t(R));break;case 40:if(a.preventDefault(),$(a.target).hasClass("folder-options-badge dropdown-opened"))return;a.metaKey||a.crtlKey?D(a):E(a);break;case 9:e.markable&&ab();break;case 8:case 46:a.preventDefault(),I.trigger("selection:delete",I.get())}},i=function(a){var b,c,d;a.isDefaultPrevented()||(b=$(this),c=b.attr("data-obj-id"),d=N?(O[z(c)]||{}).data:c,void 0!==d&&v(a)&&u(a)&&h(d,a))},k=function(a){var b,c,d,e;a.isDefaultPrevented()||(b=$(this),c=b.attr("data-obj-id"),d=N?(O[z(c)]||{}).data:c,e=function(){if(void 0!==d&&!v(a)){if(w(a))return void h(d,a);o(d)?G()&&b.addClass("pending-select"):(n(),h(d,a))}},_.device("!smartphone")?setTimeout(e,50):e())},j=function(a){var b,c,e,f;a.isDefaultPrevented()||(b=$(this),c=b.attr("data-obj-id"),e=N?(O[z(c)]||{}).data:c,f=function(){void 0!==e&&b.hasClass("pending-select")&&u(a)&&(n(),h(e,a)),d.find(".pending-select").removeClass("pending-select")},_.device("!smartphone")?setTimeout(f,50):f())},l=function(a){var b,c,d;a.isDefaultPrevented()||(b=$(this),c=b.attr("data-obj-id"),d=N?(O[z(c)]||{}).data:c,H&&h(d,a,!0))},z=function(a){return N?P[I.serialize(a)]:-1},A=function(a){return $('.selectable[data-obj-id="'+I.serialize(a).replace(/\\\./g,"\\\\.")+'"]',d)},o=function(a){return void 0!==M[I.serialize(a)]},p=function(a,b){var c=I.serialize(a);M[c]=a;var f=b||A(c);return d.has(document.activeElement).length&&e.tabFix!==!1&&f.focus(),f.addClass(I.classSelected).attr({"aria-selected":"true",tabindex:e.tabFix!==!1?e.tabFix:null}).find("input.reflect-selection").prop("checked",!0).end()},q=function(a,b){a&&(p(a).intoViewport(e.scrollpane),R=a,U=z(a),S===Q&&(S=a,V=U),b!==!0&&I.trigger("select",I.serialize(a)))},s=function(a){var b=I.serialize(a);delete M[b],A(b).removeClass(I.classSelected).attr({"aria-selected":"false",tabindex:e.tabFix!==!1?-1:null}).find("input.reflect-selection").prop("checked",!1),I.trigger("deselect",b)},t=function(a){o(a)?s(a):q(a)},m=function(a){if(!d.is(":hidden")){a=a||!1,a&&I.clearIndex();var b=$(".selectable:visible",d),c=0,e=null;for(b.removeClass(I.classSelected).find("input.reflect-selection").prop("checked",!1);c<b.length;c++){e=b.eq(c);var f=e.attr("data-obj-id");a&&I.addToIndex(f),o(f)&&($("input.reflect-selection",e).prop("checked",!0),e.addClass(I.classSelected))}}},n=function(){M={},d.find(".selectable."+I.classSelected).removeClass(I.classSelected).attr({"aria-selected":"false",tabindex:e.tabFix!==!1?-1:null}),d.find(".selectable input.reflect-selection").prop("checked",!1)},e.markable){this.classMarked="marked",T=function(a){return J&&a&&(38===a.which||40===a.which)};var W,X=n,n=function(a){ab(),T(a)||X(a)},Y=function(a,b){var c=I.serialize(a);W=a;var f=b||A(c);d.has(document.activeElement).length&&e.tabFix!==!1&&f.focus();var g=f.attr("id")||_.uniqueId("option-");return f.addClass(I.classMarked).attr({tabindex:e.tabFix!==!1?e.tabFix:null,id:g}).parent('[role="listbox"]').attr("aria-activedescendant",g).end()},Z=function(a,b){a&&(Y(a).intoViewport(e.scrollpane),R=a,U=z(a),S===Q&&(S=a,V=U),b!==!0&&I.trigger("mark",I.serialize(a)))},ab=function(){if(W){var a=I.serialize(W);W=void 0,A(a).removeClass(I.classMarked).attr({tabindex:e.tabFix!==!1?-1:null}).parent('[role="listbox"]').removeAttr("aria-activedescendant"),W=void 0}}}this.serialize=function(a){return"object"==typeof a?void 0!==a.folder_id?_.cid(a):a.id:a},this.setSerializer=function(a){this.serialize=function(b){return"object"==typeof b?a(b):b}},this.init=function(a){var b=this.get(),c=_.clone(M);n(),O=new Array(a.length),P={},R=S=Q,a.length>0&&(U=-1);for(var g,h,i=0,j=a.length,k=!0;j>i;i++)g=a[i],h=this.serialize(g),O[i]={data:g,cid:h},P[h]=i,h in c&&k&&(V=U=i,R=h,k=!1);return $(".selectable",d).each(function(){var a=$(this),b=a.attr("data-obj-id");b in c?($("input.reflect-selection",a).prop("checked",!0),a.addClass(I.classSelected).attr({"aria-selected":"true",tabindex:e.tabFix!==!1?e.tabFix:null}),e.tabFix!==!1&&a.focus()):($("input.reflect-selection",a).prop("checked",!1),a.removeClass(I.classSelected).attr({"aria-selected":"false",tabindex:e.tabFix!==!1?-1:null}))}),M=c,_.isEqual(b,this.get())||f(),this},this.insertAt=function(a,b){var c=a.length,d=[],e=_(a).reduce(function(a,b){var c=I.serialize(b);return d.push({data:b,cid:c}),a||c in P},!1);e||(O.splice.apply(O,[b,0].concat(d)),_(P).each(function(a,d){a>=b&&(P[d]+=c)}),_(a).each(function(a,c){P[I.serialize(a)]=b+c}))},this.remove=function(a){_(a).each(function(a){var b=I.serialize(a),c=P[b];void 0!==c&&O.splice(c,1,null)}),O=_(O).compact(),P={},_(O).each(function(a,b){P[a.cid]=b})},this.update=function(){return m(),this},this.updateIndex=function(){return m(!0),this},this.debug=function(){console.debug("selection",{selected:M,observed:O,index:P})},this.clearIndex=function(){return O=[],P={},this},this.addToIndex=function(a){var b=this.serialize(a);return void 0===P[b]&&(P[b]=O.length,O.push({data:a,cid:b})),this},this.removeFromIndex=function(a){var b={},c=0;_([].concat(a)).each(function(a){b[I.serialize(a)]=!0}),P={},O=_(O).filter(function(a){var d=a.cid;return d in b?!1:(P[d]=c++,!0)})},this.hasIndex=function(a){return N=!!a,this},this.getObservedItems=function(){return P},this.setMultiple=function(a){return J=!!a,this},this.setEditable=function(a,b){return K=!!a,L=b||".vgrid-cell",R=S=Q,U=-1,this},this.get=function(){var a=[],b="";for(b in M)a.push(M[b]);return a},this.unique=function(a){a=a||this.get();var b={};return _(a).filter(function(a){var c=_.isString(a)?a:_.cid(a);return c in b?!1:b[c]=!0})},this.unfold=this.get,this.clear=function(a){return n(),a!==!0&&(I.trigger("clear"),f()),this},this.select=function(a){return q(a),f(),this},this.deselect=function(a){return s(a),f(),this},this.set=function(a,b){var c=this.get(),g=this,h={},i=!0;return n(),U=-1,$(".selectable",d).each(function(){var a=$(this),b=a.attr("data-obj-id");h[b]=a}),_(!a||_.isArray(a)?a:[a]).each(function(a,b){var c,d,f=g.serialize(a);f in h?(d="string"==typeof a&&N&&void 0!==(c=O[z(a)])?p(c.data,h[f]):p(a,h[f]),0===b&&d.intoViewport(e.scrollpane)):M[f]=a,i&&(U=z(f),R=f,i=!1)}),h=null,_.isEqual(c,this.get())||b===!0||f(),this},this.equals=function(a){return _.isEqual(a,this.get())},this.selectRange=function(a,b){var c,d,e;if(N){for(a=z(a),b=z(b),e=a>b,c=a;e?c>=b:b>=c;e?c--:c++)d=O[c],c===a||c===b?q(d.data):M[d.cid]=d.data;this.update()}return this},this.selectFirst=function(){return B(),this},this.selectSmart=function(){return 0===this.get().length&&this.selectFirst(),this},this.selectNext=E,this.selectAll=function(){if(N&&O.length){for(var a,b=0,c=O.length;c>b;b++)a=O[b],0===b||b===c-1?q(a.data,!0):M[a.cid]=a.data;this.update(),H?r():f()}},this.resetLastIndex=function(){V=-1},this.setLastIndex=function(a){return S=a,V=z(a),this},this.selectIndex=function(){var a=O[V];void 0!==a&&this.select(a.data)},this.selectLastIndex=function(){if(-1!==V){var a=O[V]||_.last(O);void 0!==a&&this.select(a.data)}},this.isSelected=function(a){return o(a)},this.getIndex=function(a){return z(a)},this.isEmpty=function(){return _.isEmpty(M)},this.contains=function(a){var b=[].concat(a);return!!b.length&&_(b).inject(function(a,b){return b=_.isObject(b)?I.serialize(b):b,a&&b in P},!0)},this.getLastIndex=function(){return V},this.keyboard=function(a,b){return $(a)[b?"on":"off"]("keydown",F),this},this.retrigger=function(a){if(a){var b=this.get();this.clear(),this.set(b)}else H?r():f()},this.retriggerUnlessEmpty=function(){this.get().length&&f()},this.destroy=function(){this.clear(),this.keyboard(!1),this.events.destroy(),d.off("mousedown mouseup contextmenu"),M=O=P=R=null},this.setMobileSelectMode=function(a){H=a},this.getMobileSelectMode=function(){return H},d.on("contextmenu",function(a){a.preventDefault()}).on("mousedown",".selectable",k).on("mouseup",".selectable",j).on("click",".selectable",i).on("tap",".selectable",l).on("focus",".selectable",function(){d.addClass("has-focus")}).on("blur",".selectable",function(){_.delay(function(){0===d.find(":focus").length&&d.removeClass("has-focus")},10)}),function(){function a(a){y=a.pageX+u,z=a.pageY+v,(A(w-y)>=5||A(x-z)>=5)&&(r.left=y+"px",r.top=z+"px",w=y,x=z)}function f(){d.trigger("selection:dragstart")}function g(){this.trigger("click")}function h(a){if(!a.isDefaultPrevented()){a.preventDefault();var b=$(this).find(".folder-arrow");$(this).addClass("dnd-over"),b.length&&(clearTimeout(s),s=setTimeout(g.bind(b),1500))}}function i(){clearTimeout(s),$(this).removeClass("dnd-over")}function j(c){$(document).off("mousemove.dnd",j),t=$('<div class="drag-helper">'),b.point("io.ox/core/tk/draghelper").invoke("draw",t,new b.Baton({container:d,data:p,source:q,dragMessage:e.dragMessage})),r=t[0].style,w=x=y=z=0,a(c),t.appendTo(document.body),$(document).on("mousemove.dnd",a).one("mousemove.dnd",f).on("mouseover.dnd",".folder-tree",B.over).on("mouseout.dnd",".folder-tree",B.out).on("mousemove.dnd",".folder-tree",B.move).on("mouseover.dnd",".selectable",h).on("mouseout.dnd",".selectable",i)}function k(){null!==t&&(t.remove(),t=r=null)}function l(){B.out(),$(document).off("mousemove.dnd mouseup.dnd mouseover.dnd mouseout.dnd"),$(".dropzone").each(function(){var a=$(this),b=a.attr("data-dropzones");(b?a.find(b):a).off("mouseup.dnd")}),$(".dnd-over").removeClass("dnd-over"),d.trigger("selection:dragstop"),null!==t&&k()}function m(a){if(!a.isDefaultPrevented()){a.preventDefault(),clearTimeout(s);var c=$(this).attr("data-obj-id")||$(this).attr("data-cid")||$(this).attr("data-id"),d=new b.Baton({data:p,dragType:e.dragType,dropzone:this,target:c});$(this).trigger("selection:drop",[d])}}function n(a){var b=Math.abs(a.pageX-a.data.x),d=Math.abs(a.pageY-a.data.y);if(b>15||d>15){if(p=I.unique(I.unfold()),0===p.length){var e=q.attr("data-obj-id");p=e?[_.cid(e)]:[]}var f=new c(p);f.getProperties(),f.isResolved()&&!f.has("delete")?$(document).off("mousemove.dnd mouseup.dnd"):($(".dropzone").each(function(){var a=$(this),b=a.attr("data-dropzones");(b?a.find(b):a).on("mouseup.dnd",m)}),$(document).off("mousemove.dnd").on("mousemove.dnd",j))}}function o(a){a.preventDefault(),q=$(this),$(document).on("mousemove.dnd",{x:a.pageX,y:a.pageY},n).on("mouseup.dnd",l),_.browser.IE||(e.focus?d.find(e.focus).first():d).focus()}var p,q,r,s,t=null,u=15,v=15,w=0,x=0,y=0,z=0,A=Math.abs,B=function(){var a=0,b=null;return{move:function(b){a=b.pageY-$(this).offset().top},out:function(){clearInterval(b),b=null},over:function(){if(!b){var c=this.clientHeight;b=setInterval(function(){var b=Math.round(a/c*10)-5,d=0>b?-1:1,e=Math.abs(b);e>2&&(this.scrollTop+=d*(e-2)*2)}.bind(this),5)}}}}();_.device("!touch")&&(e.draggable&&d.on("mousedown.dnd",".selectable",o),e.dropzone&&d.addClass("dropzone").attr("data-dropzones",e.dropzoneSelector).on("drop",function(a,b){b.dropType=e.dropType,I.trigger("selection:drop",b)}))}()};return h.extend=function(a,b,c){return a.selection=new h(b,c||{})},h}),define("io.ox/core/main",["io.ox/core/desktop","io.ox/core/session","io.ox/core/http","io.ox/core/api/apps","io.ox/core/extensions","io.ox/core/extPatterns/stage","io.ox/core/date","io.ox/core/notifications","io.ox/core/commons","io.ox/core/upsell","io.ox/core/capabilities","io.ox/core/ping","io.ox/core/folder/api","settings!io.ox/core","gettext!io.ox/core","io.ox/core/relogin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";function p(a){$("#io-ox-offline").text(a).stop().show().animate({bottom:"0px"},200)}function q(){$("#io-ox-offline").stop().animate({bottom:"-41px"},200,function(){$(this).hide()})}function r(){function a(){0===b&&null===d&&($("#io-ox-refresh-icon .apptitle").attr("aria-label",o("Refresh")),e?(g=g||$("#io-ox-refresh-icon").find("i"),g.hasClass("fa-spin")&&g.addClass("fa-spin-paused").removeClass("fa-spin")):$("#io-ox-refresh-icon").removeClass("io-ox-progress"))}var b=0,d=null,e=_.device("webkit || firefox || ie > 9"),f=e?500:1500,g=null;c.on("start",function(c,h,i){0===b&&(null===d&&(i.silent||($("#io-ox-refresh-icon .apptitle").attr("aria-label",o("Currently refreshing")),e?(g=g||$("#io-ox-refresh-icon").find("i"),g.hasClass("fa-spin")||g.addClass("fa-spin").removeClass("fa-spin-paused")):$("#io-ox-refresh-icon").addClass("io-ox-progress"))),clearTimeout(d),d=setTimeout(function(){d=null,a()},f)),b++}),c.on("stop",function(){b=Math.max(0,b-1),a()})}function s(){function a(a,b,c){var d;a.attr({"data-app-name":c.get("name")||c.id,"data-app-guid":c.guid}),c instanceof ox.ui.AppPlaceholder?(a.addClass("placeholder"),j.has(c.get("requires"))||a.addClass("upsell").children("a").first().prepend($('<i class="fa fa-lock">'))):(d=b.children('.placeholder[data-app-name="'+$.escape(c.get("name"))+'"]'),d.length&&a.insertBefore(d),d.remove())}function b(a){var b=_.escape(o("close for %1$s",a.get("title"))),c=$('<a href="#" class="closelink" tabindex="1" role="button" aria-label="'+b+'">').append($('<i class="fa fa-times">')).on("click",function(b){b.preventDefault(),b.stopImmediatePropagation(),a.getWindow().app.quit()}).on("focus",function(){c.attr("aria-label",b)});return c}function c(a,c,d){if(a.get("closable")&&(c.addClass("closable"),d&&c.find("a").after(b(a))),a.get("userContent")){var e=a.get("userContentClass")||"",f=a.get("userContentIcon")||"";c.addClass("user-content").addClass(e).children().first().prepend($('<i class="'+f+'">'))}}function g(){if(_.url.hash("m")){switch(_.url.hash("m")){case"task":_.url.hash({app:"io.ox/tasks"});break;case"calendar":_.url.hash({app:"io.ox/calendar",perspective:"week:week"});break;case"infostore":_.url.hash({app:"io.ox/files",perspective:"list"});break;case"contact":_.url.hash({app:"io.ox/contacts"})}_.url.hash({folder:_.url.hash("f"),id:_.url.hash("f")+"."+_.url.hash("i"),m:null,f:null,i:null})}_.device("small")&&q();var a=_.url.hash("app"),b=a&&ox.manifests.apps[p(a).app],c=void 0!==_.url.hash("mailto")&&a===ox.registry.get("mail-compose").split("/").slice(0,-1).join("/")+":compose";return b&&(b.refreshable||c)?a.split(/,/):m()}function i(a){return function(b){var c=b&&b.message||"";console.error("core: Failed to load:",a,c,b,s)}}u("core: launch()"),ox.ui.apps.on("add",function(d){if(void 0!==d.get("title")){var f,g=B("left",d.get("title"),function(){d.launch()}),h=d.get("title"),i=d.get("closable")&&!_.device("smartphone");a(g,x,d),f=d.get("name")||d.id,e.point("io.ox/core/topbar/launcher").invoke("draw",g,e.Baton({model:d,name:f})),c(d,g,!0),g=$("<li>").append($("<a>",{href:"#","data-app-name":f,"data-app-guid":d.guid,tabindex:1,role:"menuitem"}).addClass(i?"closable":"").text(o.pgettext("app",h))),i&&g.append(b(d)),y.append(g.on("click",function(a){a.preventDefault(),d.launch()})),a(g,y,d),A()}}),ox.ui.apps.on("remove",function(a){x.children('[data-app-guid="'+a.guid+'"]').remove(),y.children('[data-app-guid="'+a.guid+'"]').remove(),A()}),ox.ui.apps.on("launch resume",function(a){_.device("smartphone")&&(n.get("forceDesktopLaunchers",!1)||x.hide()),x.children().removeClass("active-app").filter('[data-app-guid="'+a.guid+'"]').addClass("active-app"),y.children().removeClass("active-app").filter('[data-app-guid="'+a.guid+'"]').addClass("active-app")}),ox.ui.apps.on("change:title",function(a,b){var d=$('[data-app-guid="'+a.guid+'"]',x);$("a.apptitle",d).text(_.noI18n(b)),c(a,d),y.find('a[data-app-guid="'+a.guid+'"]').text(_.noI18n(b)),A()}),e.point("io.ox/core/topbar/right").extend({id:"notifications",index:100,draw:function(){var a=this;ox.online?(a.append(h.attach(B,2e3)),A()):ox.one("connection:online",function(){a.append(h.attach(B,2e3)),A()})}}),e.point("io.ox/core/topbar/right").extend({id:"search-mobile",index:150,draw:function(){k.has("search")&&_.device("small")&&this.append(B("right",$('<i class="fa fa-search launcher-icon">').attr("aria-hidden","true"),function(){require(["io.ox/search/main"],function(a){a.run({reset:!0})})},o("Search")).attr("id","io-ox-search-topbar-icon").addClass("io-ox-search"))}}),e.point("io.ox/core/topbar/right").extend({id:"refresh",index:200,draw:function(){this.append(B("right",$('<i class="fa fa-refresh launcher-icon">').attr("aria-hidden","true"),function(){return z(),$.when()},o("Refresh")).attr("id","io-ox-refresh-icon"))}}),e.point("io.ox/core/topbar/right/dropdown").extend({id:"settings",index:100,draw:function(){this.append($('<li role="presentation">').append($('<a href="#" data-app-name="io.ox/settings" role="menuitem" tabindex="-1">').text(o("Settings"))).on("click",function(a){a.preventDefault(),ox.launch("io.ox/settings/main")}))}}),e.point("io.ox/core/topbar/right/dropdown").extend({id:"change-user-data",index:150,draw:function(){n.get("user/internalUserEdit",!0)!==!1&&this.append($('<li role="presentation">').append($('<a href="#" data-app-name="io.ox/settings" role="menuitem" tabindex="-1">').text(o("My contact data"))).on("click",function(a){a.preventDefault(),require(["io.ox/core/settings/user"],function(a){a.openModalDialog()})}))}}),e.point("io.ox/core/topbar/right/dropdown").extend({id:"app-specific-help",index:200,draw:function(){var a=this;a.append($('<li class="divider" aria-hidden="true" role="presentation"></li>'),$('<li role="presentation">',{"class":"io-ox-specificHelp"}).append($('<a target="_blank" href="" role="menuitem" tabindex="-1">').text(o("Help")).on("click",function(a){var b=ox.ui.App.getCurrentApp(),c=b&&b.getName(),d=_.defaults(ox.manifests.apps[c]||{},ox.manifests.apps[c+"/main"]||{},{help:{base:"help",target:"index.html"}}).help;a.preventDefault(),window.open(d.base+"/l10n/"+ox.language+"/"+d.target)})))}}),e.point("io.ox/core/topbar/right/dropdown").extend({id:"divider-before-fullscreen",index:290,draw:function(){this.append($('<li class="divider" aria-hidden="true" role="presentation">'))}}),_.device("!safari")&&e.point("io.ox/core/topbar/right/dropdown").extend({id:"fullscreen",index:300,draw:function(){if(BigScreen.enabled){var a;BigScreen.onenter=function(){a.text(o("Exit Fullscreen"))},BigScreen.onexit=function(){a.text(o("Fullscreen"))},this.append($('<li role="presentation">').append(a=$('<a href="#" data-action="fullscreen" role="menuitem" tabindex="-1">').text(o("Fullscreen"))).on("click",function(a){a.preventDefault(),BigScreen.toggle()}))}}}),e.point("io.ox/core/topbar/right/dropdown").extend({id:"about",index:400,draw:function(){this.append($('<li role="presentation">').append($('<a href="#" data-action="about" role="menuitem" tabindex="-1">').text(o("About"))).on("click",function(a){a.preventDefault(),require(["io.ox/core/about/about"],function(a){a.show()})}))}}),e.point("io.ox/core/topbar/right/dropdown").extend({id:"logout",index:1e3,draw:function(){this.append($('<li class="divider" aria-hidden="true" role="presentation"></li>'),$('<li role="presentation">').append($('<a href="#" data-action="logout" role="menuitem" tabindex="-1">').text(o("Sign out"))).on("click",function(a){a.preventDefault(),v()}))}}),e.point("io.ox/core/topbar/right").extend({id:"dropdown",index:1e3,draw:function(){var a,b;this.append($('<li class="launcher dropdown" role="presentation">').append(b=$('<a href="#" role="button" class="dropdown-toggle f6-target" data-toggle="dropdown" tabindex="1">').append($('<i class="fa fa-cog launcher-icon" aria-hidden="true">'),$('<span class="sr-only">').text(o("Settings"))),a=$('<ul id="topbar-settings-dropdown" class="dropdown-menu" role="menu">'))),e.point("io.ox/core/topbar/right/dropdown").invoke("draw",a),b.dropdown()}});var l=n.get("features/dedicatedLogoutButton",!1)===!0&&_.device("!small");l&&e.point("io.ox/core/topbar/right").extend({id:"logout-button",index:2e3,draw:function(){var a=B("right",$('<i class="fa fa-power-off launcher-icon">').attr("aria-hidden","true"),function(){v()},o("Sign out"));a.find("a").tooltip({title:o("Sign out"),placement:function(a,b){return $(window).width()-$(b).offset().left-b.offsetWidth<80?"left":"auto"}}),this.append(a)}}),e.point("io.ox/core/topbar/right").extend({id:"logo",index:1e4,draw:function(){this.append($('<div id="io-ox-top-logo-small" aria-hidden="true">'))}}),e.point("io.ox/core/topbar/launchpad").extend({id:"default",draw:function(){k.has("launchpad")&&B("left",$('<i class="fa fa-th">').attr("aria-label",o("Your Applications")),function(){require(["io.ox/launchpad/main"],function(a){x.children().removeClass("active-app"),y.children().removeClass("active-app"),x.children().first().addClass("active-app"),a.show()})}).addClass("left-corner").attr("data-app-name","launchpad")}}),e.point("io.ox/core/topbar/favorites").extend({id:"default",draw:function(){var a=d.getAllFavorites(),b=n.get("topbar/order"),c={};b?(_(a).each(function(a){c[a.id]=a}),a=_(b.split(",")).chain().map(function(a){return c[a]}).compact().value()):a.sort(function(a,b){return e.indexSorter(a,b)}),_(a).each(function(a){j.visible(a.requires)&&_.device(a.device)&&ox.ui.apps.add(new ox.ui.AppPlaceholder({id:a.id,title:a.title,requires:a.requires}))})}}),e.point("io.ox/core/topbar").extend({id:"default",draw:function(){var a=$('<ul class="launchers-secondary">');e.point("io.ox/core/topbar/right").invoke("draw",a),w.append(a),r(),e.point("io.ox/core/topbar/launchpad").invoke("draw"),e.point("io.ox/core/topbar/favorites").invoke("draw"),$(window).resize(A)}}),e.point("io.ox/core/relogin").extend({draw:function(){this.append(o("Your session is expired"),$.txt(_.noI18n(".")),$("<br>"),$("<small>").text(o("Please sign in again to continue")))}}),""===location.hash&&(location.hash="#!");var m=function(){var a=[];return"none"===n.get("autoStart")?a=[]:(a=_([].concat(n.get("autoStart"))).filter(function(a){return!_.isUndefined(a)&&!_.isNull(a)}),_.isEmpty(a)&&a.push("io.ox/mail")),a},p=function(a){var b=(a||"").split(/:/),c=b[0],d=b[1]||"";return{app:/\/main$/.test(c)?c:c+"/main",method:d}},q=function(){var a=_([].concat(n.get("autoStartMobile","io.ox/mail"))).filter(function(a){return!_.isUndefined(a)&&!_.isNull(a)});return"io.ox/mail"!==a[0]&&a.push("io.ox/mail"),a},s=e.Baton({block:$.Deferred(),autoLaunch:g()});s.autoLaunchApps=_(s.autoLaunch).chain().map(function(a){return p(a).app}).filter(function(a){return void 0!==ox.manifests.apps[a]&&!ox.manifests.isDisabled(a)}).compact().value();var C=function(){e.point("io.ox/core/desktop").invoke("draw",$("#io-ox-desktop"),{}),C=$.noop};ox.ui.windowManager.on("empty",function(a,b,c){if(b){C(),ox.ui.screens.show("desktop");var d=p(c||n.get("autoStart","io.ox/mail/main")).app;"none/main"!==d&&ox.launch(d)}else ox.ui.screens.show("windowmanager")}),requirejs.onError=function(a){console.error("requirejs",a.message,arguments)},s.loaded=$.when(s.block,e.loadPlugins().fail(i("loadPlugins")),require(s.autoLaunchApps).fail(i("autoLaunchApps")),require(["io.ox/core/api/account"]).then(function(a){var b=$.Deferred();return a.all().always(b.resolve),b},i("account"))),new f("io.ox/core/stages",{id:"first",index:100,run:function(){u('core: Stage "first"')}}),new f("io.ox/core/stages",{id:"secretCheck",index:250,run:function(){if(ox.online&&ox.rampup&&ox.rampup.oauth){var a=ox.rampup.oauth.secretCheck;a&&!a.secretWorks&&(require(["io.ox/keychain/secretRecoveryDialog"],function(a){a.show()}),ox.debug&&console.error("Couldn't decrypt accounts: ",a.diagnosis))}}}),new f("io.ox/core/stages",{id:"restore-check",index:300,run:function(a){return u('core: Stage "restore-check"'),ox.ui.App.canRestore().done(function(b){a.canRestore=b})}}),new f("io.ox/core/stages",{id:"restore-confirm",index:400,run:function(a){if(u('core: Stage "restore-confirm"'),a.canRestore){a.restoreHash=_.url.hash();var b,c,d,e=$.Deferred().done(function(){$("#background-loader").busy().fadeIn(),w.show(),b.remove(),b=null});return $("#io-ox-core").append(b=$('<div class="core-boot-dialog" tabindex="0">').append($('<div class="header">').append($("<h3>").text(o("Restore applications")),$("<div>").text(o("The following applications can be restored. Just remove the restore point if you don't want it to be restored."))),$('<ul class="list-unstyled content">'),$('<div class="footer">').append(c=$('<button type="button" class="cancel btn btn-default">').text(o("Cancel")),d=$('<button type="button" class="continue btn btn-primary">').text(o("Continue"))))),_.device("small")&&(c.addClass("btn-block btn-lg"),d.addClass("btn-block btn-lg")),ox.ui.App.getSavePoints().done(function(a){_(a).each(function(a){var b=a.description||a.module,c=$();if(a.version!==ox.version){var d=a.version||"";d=d.split(".").slice(0,-2).join("."),d&&(c=$("<span>").addClass("oldversion").text(o.noI18n("("+d+")")))}this.append($('<li class="restore-item">').append($('<a href="#" role="button" class="remove">').data(a).append($('<i class="fa fa-trash-o">')),a.icon?$('<i class="'+a.icon+'">'):$(),$("<span>").text(o.noI18n(b)),c))},b.find(".content"))}),b.on("click",".footer .btn.continue",e.resolve),b.on("click",".footer .btn.cancel",function(b){b.preventDefault(),ox.ui.App.removeAllRestorePoints().done(function(){_.url.hash(a.restoreHash),a.canRestore=!1,e.resolve()})}),b.on("click",".content .remove",function(b){b.preventDefault();var c=$(this),d=c.data("id");c.closest("li").remove(),ox.ui.App.removeRestorePoint(d).done(function(b){0===b.length&&(_.url.hash(a.restoreHash),a.canRestore=!1,e.resolve())})}),w.hide(),$("#background-loader").idle().fadeOut(function(){b.find(".btn-primary").focus()}),e}}}),new f("io.ox/core/stages",{id:"restore",index:500,run:function(a){return u('core: Stage "restore"'),a.canRestore&&(a.autoLaunch=[],a.autoLaunchApps=[]),0!==a.autoLaunch.length||a.canRestore?a.block.resolve(a.autoLaunch.length||a.canRestore||"#!"===location.hash):(C(),a.block.resolve(!0))}}),new f("io.ox/core/stages",{id:"load",index:600,run:function(a){return u('core: Stage "load"',a),a.loaded.done(function(b){u('core: Stage "load" > loaded.done'),e.point("io.ox/core/topbar").invoke("draw"),e.point("io.ox/core/topbar").isEnabled("default")||($("#io-ox-screens").css("top","0px"),w.hide()),e.point("io.ox/core/plugins").invoke("draw"),u('core: Stage "load" > autoLaunch ...'),_(a.autoLaunch).chain().map(function(a){return p(a)
}).filter(function(a){return void 0!==ox.manifests.apps[a.app]&&!ox.manifests.isDisabled(a.app)}).each(function(a,b){if(!(_.device("smartphone")&&b>0)){var c,d;u("core: autoLaunching",a.app),c=ox.launch(a.app),d=a.method,d&&c.done(function(){_.isFunction(this[d])&&this[d]()})}}),ox.ui.App.restore(),a.instantFadeOut=b}).fail(function(){console.warn('core: Stage "load" > loaded.fail!',a)})}}),new f("io.ox/core/stages",{id:"curtain",index:700,run:function(a){if(u('core: Stage "curtain"'),a.instantFadeOut)return $("#background-loader").idle().hide(),$.when();var b=$.Deferred();return $("#background-loader").idle().fadeOut(t,b.resolve),b}}),new f("io.ox/core/stages",{id:"ready",index:"last",run:function(){ox.trigger("core:ready"),s=null}}),u("core: launch > run stages"),f.run("io.ox/core/stages",s)}var t=250,u="boot"===_.url.hash("debug")?function(){console.log.apply(console,arguments)}:$.noop;u("core: Loaded"),ox.trigger("core:load"),_.stepwiseInvoke=function(a,b,c){function d(a){h.push(a)}function e(){if(0===a.length)return g.resolve(h);var i=a.shift();if(i&&_.isFunction(i[b])){var j=i[b].apply(c,f);if(j&&j.promise)return j.done(d).then(e,g.reject)}e()}if(!_.isArray(a))return $.when();var f=Array.prototype.slice.call(arguments,3),g=$.Deferred(),h=[];return e(),g.promise()};var v=function(a){a=_.extend({autologout:!1},a||{}),$("#background-loader").fadeIn(t,function(){$("#io-ox-core").hide();var c=e.point("io.ox/core/logout").list();_.stepwiseInvoke(c,"logout",this,new e.Baton(a)).then(function(){b.logout().always(function(){var b=n.get("customLocations/logout"),c=ox.serverConfig.logoutLocation||ox.logoutLocation,d=b||c+(a.autologout?"#autologout=true":"");d=d.replace("[hostname]",window.location.hostname),_.url.redirect(d)})},function(){$("#io-ox-core").show(),$("#background-loader").fadeOut(t)})})};e.point("io.ox/core/logout").extend({id:"saveRestorePoint",index:"first",logout:function(a){c.pause();var b=$.Deferred();return a.autologout||ox.online?$.when.apply($,ox.ui.apps.map(function(a){return a.saveRestorePoint()})).always(b.resolve):ox.ui.App.canRestore().then(function(a){a?($("#io-ox-core").show(),$("#background-loader").hide(),require(["io.ox/core/tk/dialogs"],function(a){(new a.ModalDialog).text(o("Unsaved documents will be lost. Do you want to sign out now?")).addPrimaryButton("Yes",o("Yes")).addButton("No",o("No")).show().then(function(a){"No"===a?b.reject():($("#io-ox-core").hide(),$("#background-loader").show(),b.resolve())})})):b.resolve()}),n.save(),c.resume(),b}}),e.point("io.ox/core/logout").extend({id:"clearCache",logout:function(){return ox.cache.clear()}}),e.point("io.ox/core/logout").extend({id:"savePendingSettings",index:"last",logout:function(){return c.pause(),$.when.apply($,_(n.getAllPendingSettings()).map(function(a){return a.save(void 0,{force:!0})})),c.resume()}}),ox.on("connection:online connection:offline",function(a){"connection:offline"===a.type?(p(o("Offline")),ox.online=!1):(q(),ox.online=!0)}),ox.on("connection:up connection:down",function(a){ox.online&&("connection:down"===a.type?p(o("Server unreachable")):q())}),ox.online||$(window).trigger("offline");var w=$("#io-ox-topbar"),x=$(".launchers",w),y=$(".launcher-dropdown ul",w);w.attr({"aria-label":o("Applications"),role:"banner"}).on("dragstart",!1).find("a.dropdown-toggle").attr({"aria-label":o("Launcher dropdown. Press [enter] to jump to the dropdown."),role:"button","aria-haspopup":"true"}),o.pgettext("app","Portal"),o.pgettext("app","Mail"),o.pgettext("app","Address Book"),o.pgettext("app","Calendar"),o.pgettext("app","Scheduling"),o.pgettext("app","Tasks"),o.pgettext("app","Drive"),o.pgettext("app","Conversations");var z,A=_.debounce(function(){var a=x.children(".launcher"),b=$(".launcher-dropdown",w),c=n.get("forceDesktopLaunchers",!1);if(_.device("smartphone")&&!c)return a.hide(),void b.show();var d=x.offset().left;x.children(".launcher:hidden").each(function(a,b){$(b).show()});var e=x.children(".launcher:visible"),f=w.find(".launchers-secondary").outerWidth(!0),g=$(document).width(),h=b.outerWidth(!0);b.hide(),e.each(function(){d+=$(this).outerWidth(!0)});var i,j=0,k=0;for(j=a.length;j>1&&(i=e.length-k,!(g>=d+f));j--){var l=x.children(".launcher:visible").last();d-=l.outerWidth(!0),l.hide(),k++,1===k&&(d+=h)}if($("li",y).hide(),k>0)for(b.show(),j=k;j>0;j--)$("li",y).eq(-j).show()},100),B=function(a,b,c,d){var e=$('<li class="launcher">');return c&&e.on("click",function(a){a.preventDefault();var b,d=$(this),e=$(document.activeElement);b=d.contents().detach(),d.css("width",d.width()+"px").text(" ").busy(),(c.call(this)||$.when()).done(function(){d.idle().empty().append(b).css("width",""),$(document.activeElement).filter("body").length>0&&e.focus()})}),e.append(function(){return _.isString(b)?$('<a href="#" class="apptitle" tabindex="1" role="menuitem">').text(o.pgettext("app",b)):"I"===b[0].tagName?$("<a>",{href:"#","class":"apptitle",tabindex:1,role:"button","aria-label":d?_.escape(d):null}).append(b):b}),e.appendTo("left"===a?x:w)};return function(){function a(){_.now()>b&&(e.point("io.ox/core/refresh").invoke("action"),e.point("io.ox/core/refresh").invoke("reset"))}var b=_.now(),c=1e4;e.point("io.ox/core/refresh").extend({action:_.throttle(function(){if(ox.online&&""!==ox.session)try{ox.trigger("refresh^")}catch(a){console.error("io.ox/core/refresh:default",a.message,a)}},c),reset:function(){b=_.now()+parseInt(n.get("refreshInterval",3e5),10)}}),z=function(){e.point("io.ox/core/refresh").invoke("action"),e.point("io.ox/core/refresh").invoke("reset")},n.on("change:refreshInterval",function(){e.point("io.ox/core/refresh").invoke("reset")}),e.point("io.ox/core/refresh").invoke("reset"),setInterval(a,1e4)}(),function(){var a,b=10,c=30,d=0,e=null,f=null,g=null,h=!1,i=function(){return Math.ceil((a+d-_.now())/1e3)},j=function(){return parseInt(n.get("autoLogout",0),10)},k=function(){clearTimeout(e),e=setTimeout(function(){v({autologout:!0})},d),a=_.now(),h=!1},l=function(){if(h&&null===g)k();else{var a=i();c>=a&&null===g&&require(["io.ox/core/tk/dialogs"],function(b){var c=a,d=function(a){return o.format(o.ngettext("You will be automatically signed out in %1$d second","You will be automatically signed out in %1$d seconds",a),o.noI18n(a))},f=$("<span>").text(d(c)),h=setInterval(function(){0>=c?v({autologout:!0}):(c--,f.text(d(c)))},1e3);clearTimeout(e),g=new b.ModalDialog({easyOut:!1}).header($("<h4>").text(o("Automatic sign out"))).append(f).topmost().addPrimaryButton("cancel",o("Cancel")).addAlternativeButton("force",o("Sign out now")).setUnderlayStyle({backgroundColor:"white",opacity:.9}).show().done(function(a){k(),clearInterval(h),g=null,"force"===a&&v()})})}},m=function(){h=!0},p=function(){d=j(),d>0&&null===e&&($(document).on("mousedown mousemove scroll touchstart touchmove keydown",m),k(),f=setInterval(l,1e3*b))},q=function(){f&&e&&(clearTimeout(e),clearInterval(f),e=f=null,$(document).off("mousedown mousemove scroll touchstart touchmove keydown",m))},r=function(){q(),p()},s=function(){b=1,c=10,j=function(){return 12e3},r()};ox.autoLogout={start:p,stop:q,restart:r,debug:s},p()}(),function(){var a={"mail-compose":"io.ox/mail/write/main"},b={};ox.registry={set:function(a,c){b[a]=c},get:function(c){return b[c]||n.get("registry/"+c)||a[c]},call:function(a,b){var c=this.get(a),d=_(arguments).toArray().slice(2);return ox.load([c]).then(function(a){return a.reuse(b,d[0])?void 0:a.getApp().launch().then(function(){return this[b].apply(this,d)})})}}}(),m.on("warn:hidden",function(a,b){b&&h.yell("info",o('Folder with name "%1$s" will be hidden. Enable setting "Show hidden files and folders" to access this folder again.',b.title))}),ox.on("http:error",function(a,b){switch(b.code){case"MSG-1000":case"MSG-1001":h.yell(b);break;case"LGI-0016":location.href=b.error}}),{logout:v,launch:s,addLauncher:B}}),define("io.ox/mail/util",["io.ox/core/extensions","io.ox/core/date","io.ox/core/util","io.ox/core/api/account","io.ox/core/capabilities","settings!io.ox/mail","settings!io.ox/contacts","gettext!io.ox/core"],function(a,b,c,d,e,f,g,h){"use strict";var i,j=_.printf,k=6e4,l=60*k,m=24*l,n=function(a,b,c){return c>1?b:a},o=function(a,c){if(!_.isNumber(a))return h("unknown");var d,e,f=$.extend({fulldate:!1,filtertoday:!0},c||{}),g=new b.Local,i=new b.Local(a),j=function(){return i.format(b.TIME)},k=function(){return i.format(b.DATE)+(f.fulldate?" "+j():"")},l=function(){return i.getDate()===g.getDate()&&i.getMonth()===g.getMonth()&&i.getYear()===g.getYear()};if(f.filtertoday&&l())return j();if(f.smart){if(d=Math.floor(a/m)*m,g=Math.floor(_.utc()/m)*m,e=Math.floor((g-d)/m),1===e)return h("Yesterday");if(6>=e)return i.format("EEEE")}return k()},p=function(a){return a=$.trim(a||""),a.indexOf("@")>-1?a.toLowerCase():a},q=/([^,;"]+|"(\\.|[^"])+")+/,r=/^[,;\s]+/,s=/^("(\\.|[^"])+"\s|[^<]+)(<[^\>]+\>)$/,t=/(^<|>$)/g,u=/[^0-9+]/g,v=/[^A-Za-z@]/g,w={};return d.getAllSenderAddresses().done(function(a){_(a).chain().pluck(1).each(function(a){w[a.toLowerCase()]=!0})}),i={getChannelSuffixes:function(){var a={msisdn:g.get("msisdn/suffix","/TYPE=PLMN")};return function(){return a}}(),getChannel:function(a,b){a=String(a||""),b=b||"undefined"==typeof b;var c=a.indexOf(i.getChannelSuffixes().msisdn)>-1,d=!b||e.has("msisdn"),f=function(){return 0===a.replace(v,"").length&&a.replace(u,"").length>0};return c||d&&f()?"phone":"email"},cleanupPhone:function(a){return a.replace(u,"")},parseRecipient:function(a){var b,d,e,f=$.trim(a);return null!==(b=f.match(s))?(e="email"===i.getChannel(b[3])?b[3].replace(t,"").toLowerCase():i.cleanupPhone(b[3]),d=c.unescapeDisplayName(b[1])):"email"===i.getChannel(f)?(e=f.replace(t,"").toLowerCase(),d=e.split(/@/)[0]):d=e=i.cleanupPhone(f),[d,e]},removeChannelSuffix:e.has("msisdn")?function(a){var b=i.getChannelSuffixes(),c=function(a){return _.each(b,function(b){a=a.replace(new RegExp(b,"ig"),"")}),a};return _.isEmpty(b)||(_.isString(a)?a=c(a):_.isArray(a)?_.each(a,function(a){a=i.removeChannelSuffix(a)}):_.isObject(a)&&(a.from&&_.isArray(a.from[0])&&a.from[0][1]&&(a.from[0][1]=c(a.from[0][1])),_.isArray(a.to)&&_.each(a.to,function(a){a[1]=c(a[1])}),_.isArray(a.nested_msgs)&&_.each(a.nested_msgs,function(a){a=i.removeChannelSuffix(a)}))),a}:_.identity,parseRecipients:function(a){var b,c,d=[];if(!a)return d;for(;null!==(b=a.match(q));){a=a.substr(b[0].length).replace(r,""),c=this.parseRecipient(b[0]);var e=c[0]===c[1];(e||c[1].indexOf("@")>-1||"phone"===i.getChannel(c[1]))&&d.push(c)}return d},serializeList:function(a,b){b=b||"from";for(var d,e,f,g,i=a[b]||[["",""]],j=0,k=i.length,l=$("<div>");k>j;j++)d={display_name:this.getDisplayName(i[j])},e=String(i[j][1]||"").toLowerCase(),"undisclosed-recipients:;"!==e&&(d.email=e),f=c.renderPersonalName(d),d.email&&f.addClass("person-link person-"+b),l.append(f),"from"===b&&"headers"in a&&"Sender"in a.headers&&(g=this.parseRecipients(a.headers.Sender),g[0][0]!==a.from[0][0]&&g[0][1]!==a.from[0][1]&&l.append($.txt(_.noI18n(" ")),h("via"),$.txt(_.noI18n(" ")),this.serializeList({sender:g},"sender"))),k-1>j&&l.append($('<span class="delimiter">').append($.txt(_.noI18n(" — "))));return l.contents()},serializeAttachments:function(a,b){for(var c=0,d=b.length,e=$(),f="",g="";d>c;c++)f=b[c].filename||"",g=ox.apiRoot+"/mail?"+$.param({action:"attachment",folder:a.folder_id,id:a.id,attachment:b[c].id,delivery:"download"}),e=e.add($("<a>",{href:g,target:"_blank"}).addClass("attachment-link").text(_.noI18n(f))),d-1>c&&(e=e.add($("<span>").addClass("delimiter").append($.txt(_.noI18n(" • ")))));return e},getDisplayName:function(a,b){if(!_.isArray(a))return"";var d=a[0],e=String(a[1]||"").toLowerCase(),f=c.unescapeDisplayName(d);return f=f.replace(/^([^,.\(\)]+),\s([^,]+)$/,"$2 $1"),b&&f&&e&&(f+=" <"+e+">"),f||e},hasFrom:function(a){return a&&_.isArray(a.from)&&a.from.length>0&&!!a.from[0][1]},getFrom:function(a,b){a=a||{},b=b||"from";var d=_(a[b]).chain().map(function(a){return i.getDisplayName(a)}).filter(function(a){return""!==a}).value();return 0===d.length?$().add($.txt(h("from"===b?"Unknown sender":"No recipients"))):(d=_(d).reduce(function(a,b){return a.add(c.renderPersonalName({name:b}).addClass("person")).add($.txt(", "))},$()),d.slice(0,-1))},formatSender:function(a,b,d){var e=_(arguments).toArray();return _.isArray(e[0])&&(d=b,a=e[0][0],b=e[0][1]),a=c.unescapeDisplayName(a),b=p(b),""===a?b:(d===!1?a:'"'+a+'"')+" <"+b+">"},getSubject:function(a,b){var c=$.trim(_.isString(a)?a:a.subject);return""===c?h("No subject"):(f.get("features/cleanSubjects",!1)&&(c=c.replace(/\[[^\[]*\]\s*/g,"")),b?c.replace(/^((re|fwd|aw|wg):\s?)((re|fwd|aw|wg):\s?)*/i,"$1"):c.replace(/^((re|fwd|aw|wg):\s?)+/i,""))},getPriority:function(a){return a&&3===a.priority?$():a&&a.priority<3?$('<span class="high"><i class="fa fa-exclamation"/></span>').attr("title",h("High priority")):$('<span class="low"><i class="fa fa-minus"/></span>').attr("title",h("Low priority"))},getAccountName:function(a){var b=window.unescape(a?a.id:"");return/^default0/.test(b)?h("Primary account"):a&&a.account_name||"N/A"},getTime:function(a,b){return o(a,b)},getDateTime:function(a,b){return b=_.extend({fulldate:!0},b),o(a,b)},getFullDate:function(a){if(!_.isNumber(a))return h("unknown");var c=new b.Local(a);return c.format(b.DATE_TIME)},getSmartTime:function(a){if(console.warn("This method is deprecated and will be removed with 7.6.0 or at any random date later"),!_.isNumber(a))return h("unknown");var b=new Date,c=b.getTimezoneOffset(),d=b.getTime()-60*c*1e3,e=d-a,f=new Date(a),g=0;return f.getDate()===b.getDate()?l>e?(g=Math.ceil(e/k),String(j(n("%d minute ago","%d minutes ago",g),g))):(g=Math.ceil(e/l),String(j(n("%d hour ago","%d hours ago",g),g))):f.getDate()===b.getDate()-1?"Yesterday":f.getDate()+"."+(f.getMonth()+1)+"."+f.getFullYear()},count:function(a){return _(a).reduce(function(a,b){return a+(b.thread?b.thread.length:1)},0)},isToplevel:function(a){return _.isObject(a)&&"folder_id"in a&&!("filename"in a)},isUnseen:function(a){return a=_.isObject(a)?a.flags:a,_.isNumber(a)?32!==(32&a):void 0},isDeleted:function(a){return a&&_.isNumber(a.flags)?2===(2&a.flags):void 0},isSpam:function(a){return a&&_.isNumber(a.flags)?128===(128&a.flags):void 0},isAnswered:function(){return _.chain(arguments||[]).flatten().compact().reduce(function(a,b){return a||1===(1&b.flags)},!1).value()},isForwarded:function(){return _.chain(arguments||[]).flatten().compact().reduce(function(a,b){return a||256===(256&b.flags)},!1).value()},isAttachment:function(a){return"undefined"!=typeof(a||{}).parent},isEmbedded:function(a){return _.isObject(a)?void 0===a.folder_id&&void 0!==a.filename:!1},byMyself:function(a){return a=a||{},a.from&&a.from.length&&String(a.from[0][1]||"").toLowerCase()in w},hasOtherRecipients:function(a){a=a||{};var b=[].concat(a.to||[],a.cc||[],a.bcc||[]),c=_(b).reduce(function(a,b){var c=String(b[1]||"").toLowerCase();return a+(!c||c in w?0:1)},0);return c>0},getInitialDefaultSender:function(){var a=_(f.get("defaultSendAddress",[]));return a._wrapped[0]},fixInlineImages:function(a){return a.replace(new RegExp('(<img[^>]+src=")'+ox.abs+ox.apiRoot),"$1/ajax").replace(new RegExp('(<img[^>]+src=")'+ox.apiRoot,"g"),"$1/ajax").replace(/on(mousedown|contextmenu)="return false;"\s?/g,"").replace(/data-mce-src="[^"]+"\s?/,"")},signatures:function(){var a=function(a){return/(<\/?\w+(\s[^<>]*)?>)/.test(a)},b=function(a){return String(a||"").replace(/(\r\n|\n|\r)/g,"\n").replace(/[\t\f\v ][\t\f\v ]+/g," ").trim()},c=function(c,d){var e=b(c),f=$("<dummy>").html(e);return d?(a(e)||f.text(e),f.html()):(a(e)||f.text(e),f.find("p").replaceWith(function(){return $(this).html()+"\n\n"}),f.find("br").replaceWith(function(){return $(this).html()+"\n"}),f.text().trim())},d=function(a){return b(a).replace(/([\-=+*°._!?\/\^]{4,})/g,"").replace(/(<\/?\w+(\s[^<>]*)?>)/g,"").trim()};return{cleanAdd:function(a,b){return c(a,!!b)},cleanPreview:function(a){return d(a)},is:function(a,b,d){var e=_(b).map(function(a){var b=c(a.content,!!d);return""===b?"<br>":b.replace(/(\r\n|\n|\r)/g,"<br>").replace(/>[\t\f\v ]+/g,">").replace(/[\t\f\v ]+</g,"<").replace(/ alt=""/,"")});return _(e).indexOf(c(a,!!d))>-1}}}(),getAttachments:function(){var a=function(a){return!("filename"in a)&&a.attachments&&1===a.attachments.length&&null===a.attachments[0].content},b=function(a,b){if(a.parent&&a.parent.needsfix){var c=b.id.split(".");b.id=b.id.split(".").length>1?c.splice(1,c.length).join("."):b.id}};return function(c){c=c||{};var d,e,f,g,h=[],i={id:c.id,folder_id:c.folder_id};for(d=0,e=(c.nested_msgs||[]).length;e>d;d++)f=c.nested_msgs[d],a(f)?(g=f.attachments[0],h.push(_.extend({},g,{mail:i,title:f.filename||"",parent:c.parent||i}))):(b(c,f),h.push({id:f.id,content_type:"message/rfc822",filename:f.filename||_.ellipsis((f.subject||"").replace(/\s+/g," "),{max:50}),title:f.filename||f.subject||"",mail:i,parent:c.parent||i,nested_message:_.extend({},f,{parent:i})}));for(c.parent&&i&&void 0===i.folder_id&&(i.id=c.parent.id,i.folder_id=c.parent.folder_id),d=0,e=(c.attachments||[]).length;e>d;d++)f=c.attachments[d],("attachment"===f.disp||/^image/.test(f.content_type))&&(b(c,f),h.push(_.extend(f,{mail:i,title:f.filename||"",parent:c.parent||i})));return h}}()}}),define("io.ox/mail/api",["io.ox/core/http","io.ox/core/cache","settings!io.ox/core","io.ox/core/api/factory","io.ox/core/folder/api","io.ox/core/api/account","io.ox/core/notifications","io.ox/mail/util","io.ox/core/api/collection-pool","io.ox/core/api/collection-loader","settings!io.ox/mail","gettext!io.ox/mail"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(a){z.threads.touch(a.toJSON())}function n(a){return k.get("allowHtmlImages",!1)?f.is("spam|trash",a.folder_id||a.folder)?!1:!0:!1}function o(a){return k.get("allowHtmlMessages",!0)?n(a)?"html":"noimg":"text"}function p(a,b){var c=y.get("detail");b=b||a,1===b.length&&(z.threads.remove(b[0]),z.threads.touch(b[0])),z.trigger("beforedelete",b),_(b).each(function(a){var b=_.cid(a),d=c.get(b);d&&c.remove(d)})}function q(b,c){var d=new FormData;return d.append("json_0",JSON.stringify(b)),_(c).each(function(a,b){d.append("file_"+b,a)}),a.UPLOAD({module:"mail",params:{action:"new"},data:d,dataType:"text"})}function r(b,c){return a.FORM({module:"mail",action:"new",data:b,form:c,field:"json_0"})}function s(a){return!h.isDeleted(a)}var t=$.when(),u="//",v=function(){var a={},b={},c={},d={},e=function(a,b){return a+(32!==(32&b.flags)?1:0)},f=function(a){return _.isString(a)?a:_.cid(a)},g=function(a){return a?a.thread?_.cid(_(a.thread).last()):b[f(a)]:""},h={getTailCID:g,addThread:function(c){var d=g(c),e=!1;a[d]&&(e=!_.isEqual(a[d],c.thread)),a[d]=c.thread,_(c.thread).each(function(a){b[_.cid(a)]=d}),e&&z.trigger("threadChanged threadChanged:"+_.ecid(c),c)},hasThread:function(a){return h.getThread(a).length>1},getThread:function(b,c){var d=f(b),e=g(b),h=a[e]||[],i=_.cid(_(h).first());return d!==i?[]:c?_.deepCopy(h):h},getThreadCID:function(a){var c=f(a);return b[c]},getThreadSize:function(a){return h.getThread(a).length||1},getUnreadCount:function(b){var c=f(b),d=a[c];return void 0===d?0:_(d.thread).inject(e,0)},update:function(c,d){function e(a){var b=_.cid(a);b in f&&d(a)}var f={};return c=_(c).chain().map(function(c){var d=_.cid(c),e=b[d];return f[d]=!0,e in a?_(a[e]).first():c}).compact().value(),z.updateAllCache(c,function(a){a.thread?_(a.thread).each(e):e(a)})},reset:function(){function a(a){var b=_.cid(a);c[b]=32!==(32&a.flags),d[b]=parseInt(a.color_label,10)||0}return function(b){_(b).each(function(b){a(b),_(b.thread).each(a)})}}(),setUnseen:function(a,b){var d=f(a);c[d]=!0,b=b||{},b.silent||z.trigger("refresh.list")},setSeen:function(a,b){var d=f(a);c[d]=!1,b=b||{},b.silent||z.trigger("refresh.list")},remove:function(b){var c=f(b),d=this.getThreadCID(c);d&&(a[d]=_(a[d]).filter(function(a){return c!==f(a)}))},isPartiallyUnseen:function(d){var e=f(d),g=a[b[e]];return g?_(g).reduce(function(a,b){return a||c[_.cid(b)]===!0},!1):!1},isUnseen:function(a){if(_.isObject(a)){var b=f(a);return b in c?!!c[b]:32!==(32&a.flags)}return!!c[a]},getThreadColorLabel:function(c){var e=f(c),g=a[b[e]];return g?_(g).reduce(function(a,b){return a||d[e]||b.color_label},0):h.getColorLabel(c)},getColorLabel:function(a){var b=f(a);return(b in d?d[b]:a.color_label)||0},setColorLabel:function(a){var b=f(a);d[b]=parseInt(a.color_label,10)||0},clear:function(){a={},b={}}};return h}(),w=_("0 1 7 10 6 3 9 2 5 8 4".split(" ")).invert(),x=function(a,b){return w[b.color_label]-w[a.color_label]},y=i.create("mail"),z=d({module:"mail",keyGenerator:function(a){return a?(a.folder_id||a.folder)+"."+a.id+"."+(a.view||z.options.requests.get.view||""):""},requests:{all:{folder:"default0/INBOX",columns:"601,600,611,102",extendColumns:"io.ox/mail/api/all",sort:"610",order:"desc",deleted:"true",cache:!1},list:{action:"list",columns:"102,600,601,602,603,604,605,607,608,610,611,614,652",extendColumns:"io.ox/mail/api/list"},get:{action:"get",embedded:"true"},getUnmodified:{action:"get",unseen:"true",view:"html",embedded:"true"},search:{action:"search",folder:"default0/INBOX",columns:"601,600,611",extendColumns:"io.ox/mail/api/all",sort:"610",order:"desc",getData:function(a,b){var c={from:603,to:604,cc:605,subject:607,text:-1},d=[];return _(b).each(function(b,e){e in c&&"on"===b&&d.push({col:c[e],pattern:a})}),d}}},cid:function(a){return(a.action||"all")+":"+a.folder+u+[a.sort,a.order,a.max||0,!!a.unseen,!!a.deleted].join(".")},fail:{get:function(a,b){"MSG-0032"===a.code&&z.updateCaches([b])}},filter:function(a){return void 0!==a.folder_id||void 0!==a.folder},pipe:{all:function(a,b){return"102"===b.sort&&(a.sort(x),"desc"===b.order&&a.reverse()),v.reset(a.data||a),a},listPost:function(a){return _(a).each(function(a){a&&(a.flags=v.isUnseen(a)?-33&a.flags:32|a.flags)}),a},get:function(a,b){return e.setUnseenCounter(a.folder_id,a.unread),_.isObject(a)&&(a.view=b.view),a}},params:{all:function(a){return"thread"===a.sort&&(a.sort=610),a}},simplify:function(a){return a.simplified.unseen=!0,a.simplified}});z.updateViewSettings=function(){z.options.requests.get.view=k.get("allowHtmlMessages",!0)?k.get("allowHtmlImages",!1)?"html":"noimg":"text",z.trigger("viewChanged")},z.tracker=v,z.separator=k.get("defaultseparator","/"),z.SENDTYPE={NORMAL:"0",REPLY:"1",FORWARD:"2",EDIT_DRAFT:"3",DRAFT:"4"},z.FLAGS={ANSWERD:1,DELETED:2,DRAFT:4,FLAGGED:8,RECENT:16,SEEN:32,USER:64,SPAM:128,FORWARDED:256},z.COLORS={NONE:0,RED:1,ORANGE:7,YELLOW:10,LIGHTGREEN:6,GREEN:3,LIGHTBLUE:9,BLUE:2,PURPLE:5,PINK:8,GRAY:4},y.get("detail").on("change:flags",function(a){var b=h.isUnseen(a.previous("flags")),c=h.isUnseen(a.get("flags"));b!==c&&e.changeUnseenCounter(a.get("folder_id"),c?1:-1)}),y.get("detail").on("remove",function(a){var b=h.isUnseen(a.get("flags"));b&&e.changeUnseenCounter(a.get("folder_id"),-1)});var A={},B=z.get,C=z.getAll,D=z.getList,E=z.search;z.get=function(a,b){var c=_.isObject(a)?_.cid(a):a,d=y.get("detail").get(c);return a.src||"noimg"!==a.view&&a.view||!d||!d.get("attachments")?(a.view||(a.view=o(a)),a.max_size=k.get("maxSize/view",102400),B.call(z,a,b&&b.cache).done(function(a){d?(d.set(a),m(d)):y.add("detail",a)})):$.when(d.toJSON())},z.getAll=function(a,b){var c=z.cid(a);return"auto"===b&&(b=A[c]!==!1),a=a||{},/^default\d+$/.test(a.folder)?$.when([]):("from-to"===a.sort&&(a.sort=f.is("sent|drafts",a.folder)?604:603),C.call(this,a,b).done(function(){A[c]=!0}))},z.getList=function(a,b,c){return D.call(this,a,b,c).then(function(a){return _.each(a,h.removeChannelSuffix),a})},z.search=function(a,b){return"from-to"===b.sort&&(b.sort=f.is("sent|drafts",b.folder)?604:603),E.call(this,a,b)},z.remove=function(b,c){return p(b,c),a.wait(a.PUT({module:"mail",params:{action:"delete",timestamp:_.then()},data:a.simplify(b),appendColumns:!1}).done(function(){var a=f.getFoldersByType("trash");_(y.getByFolder(a)).each(function(a){a.expired=!0}),e.reload(b,a),z.trigger("delete"),z.trigger("deleted-mails",b)}))},z.archive=function(b){return a.PUT({module:"mail",params:{action:"archive_folder",folder:b,days:90},appendColumns:!1}).done(function(){e.refresh(),z.trigger("refresh.all")})},z.getAllThreads=function(a,b){a=a||{},a=$.extend(a,{action:"threadedAll",columns:a.columns||"601,600,611,102",sort:a.sort||"610",sortKey:"threaded-"+(a.sort||"610"),konfetti:!0,order:a.order||"desc",includeSent:!f.is("sent|drafts",a.folder),cache:!1,max:a.max||500});var c=z.cid(a);return"auto"===b&&(b=A[c]!==!1),C.call(this,a,b,null,!1).done(function(a){_(a.data).each(v.addThread),A[c]=!0})};var F=function(b,c,d){var e=!1,f=c.folder_id||c.folder;return b=_.isArray(b)?b:[b],a.pause(),_(b).map(function(b){var g=b.folder||b.folder_id;return f&&f!==g&&(e=!0),a.PUT({module:"mail",params:{action:d||"update",id:b.id,folder:g,timestamp:_.then()},data:c,appendColumns:!1})}),a.resume().pipe(function(a){return _(b).each(function(a){z.trigger("update:"+_.ecid(a),a)}),"copy"===d||e?{list:b,response:a}:b})},G=function(a,b){return function(){var c=a.folder_id||a.folder;return $.when(z.caches.get.remove(a),z.caches.get.remove(c),z.caches.list.remove(a),z.caches.list.remove(c),z.caches.all.grepRemove(b+u))}};z.update=function(){console.error("Do not call this directly because mail is so special")},z.updateAllCache=function(){function a(a,b,c){return z.caches.all.grepKeys(a+u).then(function(a){return $.when.apply($,_(a).map(function(a){return z.caches.all.get(a).then(function(d){if(!d)return t;d.data=d.data||d;var e,f=_(d.data).chain().filter(function(a){return _.cid(a)in b}).map(function(a){return c(a),a.thread||a}).value();return e=f.length<100?[z.caches.list.merge(f),z.caches.get.merge(f)]:[z.caches.list.clear(),z.caches.get.clear()],$.when.apply($,e).then(function(){return z.caches.all.add(a,d)})})}))})}return function(b,c){var d={},e={};return _([].concat(b)).each(function(a){e[_.cid(a)]=!0,d[a.folder_id]=!0}),$.when.apply($,_(d).map(function(b,d){return a(d,e,c||_.identity)}))}}(),z.on("not-found",function(a,b){v.ignore(b),z.trigger("refresh.list")}),z.expunge=function(b){return a.PUT({module:"mail",appendColumns:!1,params:{action:"expunge"},data:[b]}).then(function(a){return z.caches.all.grepRemove(b+u).then(function(){return a})}).done(function(){z.trigger("refresh.all"),e.reload(b)})},e.on({"before:clear":function(a,b){_(y.getByFolder(b)).each(function(a){a.reset([])})},"clear remove:mail":function(){var a=f.getFoldersByType("trash");_(a).each(function(a){e.list(a,{cache:!1})}),_(y.getByFolder(a)).each(function(a){a.expired=!0})}}),z.changeColor=function(b,c,d){return b=[].concat(b),c=String(c),_(b).each(function(a){a.color_label=c,y.propagate("change",{id:a.id,folder_id:a.folder_id,color_label:parseInt(c,10)||0}),z.threads.touch(a),v.setColorLabel(a),z.trigger("update:"+_.ecid(a),a)}),a.wait(v.update(b,function(a){a.color_label=c,v.setColorLabel(a)}).then(function(){return d?t:F(b,{color_label:c})}).done(function(){z.trigger("refresh.color",b),z.trigger("refresh.all")}))},z.markUnread=function(a){return a=[].concat(a),_(a).each(function(a){v.setUnseen(a,{silent:!0}),a.flags=-33&a.flags,y.propagate("change",{id:a.id,folder_id:a.folder_id,flags:a.flags}),z.threads.touch(a),z.trigger("update:"+_.ecid(a),a)}),$.when(v.update(a,function(a){v.setUnseen(a,{silent:!0}),a.flags=-33&a.flags}).done(function(){z.trigger("refresh.list"),z.trigger("refresh.unseen",a)}),F(a,{flags:z.FLAGS.SEEN,value:!1}).done(function(){e.reload(a)}))},z.markRead=function(a){return a=[].concat(a),_(a).each(function(a){v.setSeen(a,{silent:!0}),a.flags=32|a.flags,y.propagate("change",{id:a.id,folder_id:a.folder_id,flags:a.flags,unseen:!1}),z.threads.touch(a),z.trigger("update:"+_.ecid(a),a)}),$.when(v.update(a,function(a){v.setSeen(a,{silent:!0}),a.flags=32|a.flags}).done(function(){z.trigger("refresh.list"),z.trigger("refresh.seen",a)}),F(a,{flags:z.FLAGS.SEEN,value:!0}).done(function(){e.reload(a),z.trigger("update:set-seen",a)}))},z.allSeen=function(b){return y.get("detail").each(function(a){var c=a.toJSON();c.folder_id===b&&h.isUnseen(c)&&(y.propagate("change",{id:c.id,folder_id:c.folder_id,flags:32|c.flags}),z.threads.touch(c))}),z.trigger("update:set-seen",b),a.PUT({module:"mail",params:{action:"all_seen",folder:b},appendColumns:!1}).done(function(){e.reload(b)})},z.markSpam=function(a){return p(a),this.trigger("refresh.pending"),v.clear(),_(y.getByFolder(f.getFoldersByType("spam"))).each(function(a){a.expired=!0}),F(a,{flags:z.FLAGS.SPAM,value:!0}).fail(g.yell)},z.noSpam=function(a){return p(a),this.trigger("refresh.pending"),v.clear(),_(y.getByFolder(f.getFoldersByType("inbox"))).each(function(a){a.expired=!0}),F(a,{flags:z.FLAGS.SPAM,value:!1}).fail(g.yell)},z.move=function(b,c,d){return p(b,d),_(y.getByFolder(c)).each(function(a){a.expired=!0}),a.wait(F(b,{folder_id:c}).then(function(a){for(var d,f=0,g=a.length;g>f;f++)if(a[f].error){d=a[f].error.error;break}return z.trigger("move",b,c),e.reload(c,b),d?d:void 0}))},z.copy=function(a,b){return _(y.getByFolder(b)).each(function(a){a.expired=!0}),F(a,{folder_id:b},"copy").then(function(c){return G(a,b)().then(function(){return c})}).then(function(c){for(var d,f=c.response,g=0;g<f.length;g++)if(f[g].error){f=f[g].error.error;break}return z.trigger("copy",a,b),e.reload(b),d?d:_(f).pluck("data")})},z.autosave=function(b){return a.PUT({module:"mail",params:{action:"autosave"},data:b,appendColumns:!1}).pipe(function(a){return $.Deferred().resolve(a)})},z.csid=function(){return _.uniqueId()+"."+_.now()};var H=function(b,c,d){d=$.trim(d||"text").toLowerCase(),d="text/plain"===d?"text":d,d="text/html"===d?"html":d;var e="text"===d&&Modernizr.touch&&k.get("attachOriginalMessage",!1)===!0,f=z.csid();return a.PUT({module:"mail",params:$.extend({},{action:b||"",attachOriginalMessage:e,view:d,setFrom:/reply|replyall|forward/.test(b),csid:f,embedded:c.embedded,max_size:c.max_size}),data:_([].concat(c)).map(function(a){return z.reduce(a)}),appendColumns:!1}).then(function(a){var b="",c="",e="";return a.csid=f,a.attachments&&a.attachments.length?""===a.attachments[0].content||("text/plain"===a.attachments[0].content_type?($("<div>").html(a.attachments[0].content.replace(/<(?!br)/gi,"&lt;")).contents().each(function(){b+="BR"===this.tagName?"\n":$(this).text()}),b=$.trim(b),"html"===d?(b=b.replace(/</gi,"&lt;"),_(b.split(/\n/).concat("\n")).each(function(a){/^> /.test(a)?c+=a.substr(2)+"\n":(e+=(""!==c?'<blockquote type="cite"><p>'+c+"</p></blockquote>":"")+a+"\n",c="")}),a.attachments[0].content=$.trim(e).replace(/\n/g,"<br>")):a.attachments[0].content=$.trim(b)):"text/html"===a.attachments[0].content_type&&(e=document.createElement("DIV"),e.innerHTML=a.attachments[0].content,_(e.getElementsByTagName("BLOCKQUOTE")).each(function(a){a.removeAttribute("style")}),a.attachments[0].content=e.innerHTML,e=null)):(a.attachments=a.attachments||[{}],a.attachments[0].content=""),a})};z.keepalive=function(b){return a.GET({module:"file",params:{action:"keepalive",id:b}})},z.getUnmodified=function(a){if("folder_id"in a||"folder"in a)return this.get({action:"get",id:a.id,folder:a.folder||a.folder_id,view:"html"},!1);if("parent"in a){var b=a.id,c=a.parent;return this.get({action:"get",id:a.parent.id,folder:a.parent.folder||a.parent.folder_id,view:"html"},!1).pipe(function(a){return _.chain(a.nested_msgs).filter(function(a){return a.id===b?(a.parent=c,!0):!1}).first().value()})}return console.error("api.getUnmodified(). Invalid case.",a),$.Deferred().resolve(a)},z.getSource=function(a){return this.get({action:"get",id:a.id,src:!0,folder:a.folder||a.folder_id,view:"html"},!1)},z.replyall=function(a,b){return H("replyall",a,b)},z.reply=function(a,b){return H("reply",a,b)},z.forward=function(a,b){return H("forward",a,b)},z.send=function(a,b,c){function d(a){return{args:[{"com.openexchange.groupware.contact.pairs":[{folder:a.folder_id,id:a.id}]}],identifier:"com.openexchange.contact"}}var g,h=function(a){var b,c=$.trim(a[0]||"").replace(/^["']+|["']+$/g,""),d=String(a[1]||""),e=a[2]||"";return b="/TYPE=PLMN"===e||/\/TYPE=PLMN$/.test(d),b?"<"+d+e+">":""===c||c===d?d:'"'+c+'" <'+d+">"
};return a=_.clone(a),a.from=_(a.from).map(h).join(", "),a.to=_(a.to).map(h).join(", "),a.cc=_(a.cc).map(h).join(", "),a.bcc=_(a.bcc).map(h).join(", "),a.contacts_ids&&(a.datasources=_.chain(a.contacts_ids).map(d).value()),z.trigger("beforesend",{data:a,files:b,form:c}),ox.trigger("mail:send:start",a,b),g=Modernizr.filereader&&"FormData"in window?q(a,b,g):r(a,c),g.done(function(){z.trigger("send",{data:a,files:b,form:c}),ox.trigger("mail:send:stop",a,b)}).then(function(a){if(setTimeout(function(){z.trigger("refresh.all")},3e3),_.isObject(a))return a;var b=a.indexOf("{"),c=a.lastIndexOf("}");return b>-1&&c>-1?JSON.parse(a.substr(b,c-b+1)):{}}).then(function(a){if(a.data){var b=_(a.data.toString().split(z.separator)),c=b.last(),d=b.without(c).join(z.separator);$.when(f.getUnifiedMailboxName()).done(function(a){null!==a?e.refresh():e.reload(d),z.trigger("refresh.list")})}return a})},z.saveAttachments=function(b,d){return d=d||c.get("folder/infostore"),b=_.isArray(b)?b:[b],a.pause(),_(b).each(function(b){a.PUT({module:"mail",params:{action:"attachment",id:b.mail.id,folder:b.mail.folder_id,dest_folder:d,attachment:b.id},data:{folder_id:d,description:l("Saved mail attachment")},appendColumns:!1})}),a.resume().done(function(){require(["io.ox/files/api"],function(a){a.caches.all.grepRemove(d+u),a.trigger("refresh.all")})})},z.getUrl=function(a,b){var c,d=ox.apiRoot+"/mail";if("zip"===b)return c=_(a).first(),d+"?"+$.param({action:"zip_attachments",folder:(c.parent||c.mail).folder_id,id:(c.parent||c.mail).id,attachment:_(a).pluck("id").join(","),session:ox.session});if("eml:reference"===b)return this.getUrl(_([].concat(a)).first().parent,"eml");if("eml"===b)return a=[].concat(a),c=_(a).first(),a.length>1?d+"?"+$.param({action:"zip_messages",folder:c.folder_id,id:_(a).pluck("id").join(","),session:ox.session}):d+=(c.subject?"/"+encodeURIComponent(c.subject.replace(/[\\:\/]/g,"_")+".eml"):"")+"?"+$.param($.extend(z.reduce(c),{action:"get",src:1,save:1,session:ox.session}));var e=a.filename?a.filename.replace(/[\\:\/]/g,"_").replace(/\(/g,"%28").replace(/\)/,"%29"):void 0;switch(d+=(a.filename?"/"+encodeURIComponent(e):"")+"?"+$.param({action:"attachment",folder:(a.parent||a.mail).folder_id,id:(a.parent||a.mail).id,attachment:a.id}),b){case"view":case"open":return d+"&delivery=view";case"download":return d+"&delivery=download";default:return d}};var I=0;z.checkInbox=function(){return a.GET({module:"mail",params:{action:"all",folder:"default0/INBOX",columns:"610,600,601,611",unseen:"true",deleted:"false",sort:"610",order:"desc",limit:100}}).then(function(a){v.reset(a);var b=_(a).filter(function(a){return a.received_date>I&&2!==(2&a.flags)});return z.trigger("new-mail",b,a),b.length>0?(I=b[0].received_date,z.newMailTitle(!0)):I=_.utc(),{unseen:a,recent:b||[]}})},z.refresh=function(){ox.online&&(_(A).each(function(a,b){A[b]=!1}),z.checkInbox().always(function(){z.trigger("refresh.all")}))},z.localRemove=function(a,b){var c={};_(b).each(function(a,b){var d=v.getThreadCID(b);void 0!==d&&(c[d]=b)}),a=_(a).filter(function(a){var d,e,f=_.cid(a),g=f in b,h=a.thread?a.thread.length:1;return g&&1>=h?!1:g&&h>1?(e=_(a.thread).chain().map(_.cid).inject(function(a,c){return a+(c in b?1:0)},0).value()===h,e?!1:(d=a.thread[1],_.extend(a,{folder_id:d.folder_id,id:d.id,flags:d.flags,color_label:d.color_label}),a.thread.splice(0,1),!0)):f in c?(a.thread=_(a.thread).filter(function(a){return _.cid(a)!==c[f]}),!0):!0});try{return a}finally{a=c=b=null}},z.getDefaultFolder=function(){return e.getDefaultFolder("mail")},z.getAccountIDFromFolder=function(a){var b=/^default(\d*)\b/.exec(a);return b[1]},z.beautifyMailText=function(a,b){return b=b||500,a=String(a).replace(/(\r\n|\n|\r)/gm,"").substr(0,b).replace(/-{3,}/g,"---").replace(/<br\s?\/?>(&gt;)+/gi," ").replace(/<br\s?\/?>/gi," ").replace(/<[^>]+(>|$)/g,"").replace(/(http(s?):\/\/\S+)/i,'<a href="$1" target="_blank">http$2://...</a>').replace(/&#160;/g," ").replace(/\s{2,}/g," "),$.trim(a)},z.importEML=function(b){b.folder=b.folder||z.getDefaultFolder();var c=new FormData;return c.append("file",b.file),a.UPLOAD({module:"mail",params:{action:"import",folder:b.folder,force:!0},data:c,fixPost:!0}).pipe(function(a){return z.caches.all.grepRemove(b.folder+u).pipe(function(){return z.trigger("refresh.all"),e.reload(b.folder),a})})},z.ack=function(b){return f.getPrimaryAddressFromFolder(b.folder).then(function(c){var d=c[0],e=c[1],f=d?'"'+d+'" <'+e+">":e;return a.PUT({module:"mail",params:{action:"receipt_ack"},data:_.extend({from:f},b)})})},k.on("change:allowHtmlMessages",function(a,b){z.options.requests.get.view=b?"noimg":"text",y.get("detail").each(function(a){a.unset("attachments",{silent:!0})})});var J=")(?:/|"+_.escapeRegExp(u)+")";return f.on("refresh.all create:account",function(){e.list("1",{cache:!1}).done(function(a){var b=_(a).chain().filter(function(a){return/^default/.test(a.id)&&f.isUnified(a.id)}).map(function(a){return _.escapeRegExp(a.id)}).value(),c=new RegExp("(?:"+b.join("|")+J);z.caches.all.grepRemove(c),e.pool.unfetch()})}),e.on("create",function(a,b){"mail"===b.module&&z.refresh()}),z.newMailTitle=function(){function a(){document.title=(e=!e)?l("New Mail"):document.customTitle}function b(){d||(d=setInterval(a,1500))}function c(){document.customTitle&&(document.title=document.customTitle),d&&(clearInterval(d),d=null)}var d=null,e=!1;return function(a){_.device("smartphone")||(a===!0?b():c())}}(),z.pool=y,z.resolve=function(){function a(a){return a=String(a).replace(/^thread\./,""),y.get("detail").get(a)}return function(b,c){return c?z.threads.resolve(b):_(b).chain().map(a).compact().invoke("toJSON").value()}}(),z.threads={hash:{},reverse:{},contains:function(a){return!!this.hash[a]},getModels:function(a){if(!_.isString(a))return[];var b=this.hash[a]||[a],c=y.get("detail");return _(b).chain().map(c.get,c).compact().value()},get:function(a){return _(this.getModels(a)).chain().invoke("toJSON").map(function(a,b){return a.index=b,a}).value()},head:function(a){return a.head||a},touch:function(a){a=_.isString(a)?a:_.cid(a);var b=this.reverse[a];b&&b!==a&&y.propagate("change",_.extend({timestamp:_.now()},_.cid(b)))},resolve:function(a){return _(a).chain().map(function(a){a=String(a).replace(/^thread\.(.+)$/,"$1");var b=z.threads.get(a);return b.length>0&&b}).flatten().compact().value()},clear:function(){this.hash={},this.reverse={}},add:function(a){var b=_.cid(a);this.hash[b]=a.thread||[b],_(this.hash[b]).each(function(a){this.reverse[a]=b},this)},remove:function(a){a=_.isString(a)?a:_.cid(a);var b=this.reverse[a];b&&this.hash[b]&&(this.hash[b]=_(this.hash[b]).without(a))},size:function(a){a=_.isString(a)?a:_.cid(a);var b=this.reverse[a];return b?(this.hash[b]||[a]).length:1}},z.pool.getDependentModels=function(a){return z.threads.getModels(a)},z.collectionLoader=new j({module:"mail",getQueryParams:function(a){return a.thread===!0?{action:"threadedAll",folder:a.folder,columns:"102,600,601,602,603,604,605,607,608,610,611,614,652",sort:"610",order:a.order||"desc",includeSent:!f.is("sent|drafts",a.folder),max:(a.offset||0)+300,timezone:"utc"}:{action:"all",folder:a.folder,columns:"102,600,601,602,603,604,605,607,608,610,611,614,652",sort:a.sort||"610",order:a.order||"desc",timezone:"utc"}}}),z.processThreadMessage=function(a){var b,c=a.thread||[a];c=_(b=c).filter(s),0===c.length&&(c=b.slice(0,1));var d=_(c).last(),e=c.length;a.head=_.extend({threadSize:e},a),_.extend(a,d),a.thread=_(c).map(_.cid),a.threadSize=e,d.thread=_(c).map(_.cid),z.threads.add(a),z.pool.add("detail",c)},z.collectionLoader.virtual=function(a){return/^default\d+$/.test(a.folder)?[]:void 0},z.collectionLoader.each=function(a,b,c,d){"threadedAll"===d.action?z.processThreadMessage(a):z.pool.add("detail",a)},z}),define("io.ox/mail/listview",["io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/util","io.ox/mail/api","io.ox/core/api/account","io.ox/core/tk/list","io.ox/core/folder/api","io.ox/mail/view-options","less!io.ox/mail/style"],function(a,b,c,d,e,f,g){"use strict";function h(a){"threadSize"in a||(a.threadSize=Math.max(1,_(a.thread).reduce(function(a,b){return a+(c.isDeleted(b)?0:1)},0)))}b.point("io.ox/mail/listview/item").extend({id:"default",index:100,draw:function(a){if(h(a.data),!a.app)return void b.point("io.ox/mail/listview/item/default").invoke("draw",this,a);var c=a.app.props.get("layout"),d="horizontal"===c||"list"===c;this.closest(".list-item").toggleClass("small",d),b.point("io.ox/mail/listview/item/"+(d?"small":"default")).invoke("draw",this,a)}},{id:"a11y",index:200,draw:a.a11yLabel}),b.point("io.ox/mail/listview/item/small").extend({id:"unread",index:110,draw:a.unreadClass},{id:"deleted",index:120,draw:a.deleted},{id:"col1",index:100,draw:function(b){var c=$('<div class="list-item-column column-1">');a.unread.call(c,b),this.append(c)}},{id:"col2",index:200,draw:function(b){var c=$('<div class="list-item-column column-2">');a.answered.call(c,b),0===c.children().length&&a.forwarded.call(c,b),this.append(c)}},{id:"col3",index:300,draw:function(b){var c=$('<div class="list-item-column column-3">');a.priority.call(c,b),this.append(c)}},{id:"col4",index:400,draw:function(a){var c=$('<div class="list-item-column column-4">');b.point("io.ox/mail/listview/item/small/col4").invoke("draw",c,a),this.append(c)}},{id:"col5",index:500,draw:function(a){var c=$('<div class="list-item-column column-5">');b.point("io.ox/mail/listview/item/small/col5").invoke("draw",c,a),this.append(c)}},{id:"col6",index:600,draw:function(a){var c=$('<div class="list-item-column column-6">');b.point("io.ox/mail/listview/item/small/col6").invoke("draw",c,a),this.append(c)}}),b.point("io.ox/mail/listview/item/small/col4").extend({id:"from",index:100,draw:a.from}),b.point("io.ox/mail/listview/item/small/col5").extend({id:"account",index:100,draw:a.account},{id:"flag",index:200,draw:a.flag},{id:"thread-size",index:300,draw:a.threadSize},{id:"paper-clip",index:400,draw:a.paperClip},{id:"subject",index:1e3,draw:a.subject}),b.point("io.ox/mail/listview/item/small/col6").extend({id:"date/size",index:100,draw:function(b){var c=608===b.app.props.get("sort")?"size":b.app&&b.app.props.get("exactDates")?"fulldate":"smartdate";a[c].call(this,b)}}),b.point("io.ox/mail/listview/item/default").extend({id:"picture",before:"row1",draw:function(b){b.app&&b.app.props.get("contactPictures")&&a.picture.call(this,b)}},{id:"row1",index:100,draw:function(a){var c=$('<div class="list-item-row">');b.point("io.ox/mail/listview/item/default/row1").invoke("draw",c,a),this.append(c)}},{id:"unread",index:110,draw:a.unreadClass},{id:"deleted",index:120,draw:a.deleted},{id:"row2",index:200,draw:function(a){var c=$('<div class="list-item-row">');b.point("io.ox/mail/listview/item/default/row2").invoke("draw",c,a),this.append(c)}}),b.point("io.ox/mail/listview/item/default/row1").extend({id:"date/size",index:100,draw:function(b){var c=b.app&&608===b.app.props.get("sort")?"size":b.app&&b.app.props.get("exactDates")?"fulldate":"smartdate";a[c].call(this,b)}},{id:"from",index:300,draw:a.from}),b.point("io.ox/mail/listview/item/default/row2").extend({id:"account",index:100,draw:a.account},{id:"flag",index:200,draw:a.flag},{id:"thread-size",index:300,draw:a.threadSize},{id:"paper-clip",index:400,draw:a.paperClip},{id:"priority",index:500,draw:a.priority},{id:"subject",index:1e3,draw:function(b){a.subject.call(this,b);var c=this.find(".flags");a.unread.call(c,b),a.answered.call(c,b),a.forwarded.call(c,b)}});var i=f.extend({ref:"io.ox/mail/listview",initialize:function(a){var b=this;f.prototype.initialize.call(this,a||{}),this.$el.addClass("mail-item"),this.on("collection:load",this.lookForUnseenMessage),this.listenTo(a.app.props,{"change:thread":function(a){b.threaded=a.get("thread")}})},lookForUnseenMessage:function(){if(this.collection.length){var a=this.collection.at(0).get("folder_id"),b=this.collection.reduce(function(a,b){return a+c.isUnseen(b.get("flags"))?1:0},0);g.setUnseenMinimum(a,b)}},filter:function(a){var b=a.toJSON();return!c.isDeleted(b)},reprocessThread:function(a){if(this.threaded){var b=d.threads.get(a.cid);if(a.get("thread")&&b.length!==a.get("thread").length){_.each(b,function(a){delete a.head});var c=_.extend(a.toJSON(),b[0],{thread:b,threadSize:b.length});d.processThreadMessage(c),a.set(c,{silent:!0})}}},map:function(a){this.reprocessThread(a);var b=d.threads.head(a.toJSON()),f=d.threads.get(a.cid),g=_(f).reduce(function(a,b){return a||c.isUnseen(b)},!1);b.flags=g?-33&b.flags:32|b.flags;var h=_(f).reduce(function(a,b){return a||parseInt(b.color_label||0,10)},0);b.color_label=h;var i=f.length>1,j=!i&&e.is("sent|drafts",b.folder_id),k=j?b.to:b.from;return b.picture=k&&k[0]&&k[0][1],b},getCID:function(a){return"thread."+a.cid}});return i}),define("io.ox/core/tk/list-control",["io.ox/core/tk/list","io.ox/core/extensions"],function(a,b){"use strict";function c(a,b){return"function"==typeof a&&(a=a()),0>a&&(a+=b),a}var d=Backbone.View.extend({className:"abs list-view-control",events:{"mousedown .resizebar":"onResize","mousedown .resizebar.vertical":"onVerticalResize"},onResize:function(a){a.preventDefault();var b=this.$el.parent(),e=b.siblings(".rightside"),f=a.pageX-b.width(),g=b.width()+e.width(),h=c(d.minWidth,g),i=c(d.maxWidth,g);$(document).on({"mousemove.resize":function(a){var c=Math.max(h,Math.min(a.pageX-f,i));b.css("width",c),e.css("left",c)},"mouseup.resize":function(){$(this).off("mousemove.resize mouseup.resize")}})},onVerticalResize:function(a){a.preventDefault();var b=this.$el.parent(),e=b.siblings(".rightside"),f=a.pageY-b.height(),g=b.height()+e.height(),h=c(d.minHeight,g),i=c(d.maxHeight,g);$(document).on({"mousemove.resize":function(a){var c=Math.max(h,Math.min(a.pageY-f,i));b.css("height",c),e.css("top",c)},"mouseup.resize":function(){$(this).off("mousemove.resize mouseup.resize")}})},resizable:function(){_.device("touch")||(this.$el.append('<div class="resizebar">'),this.$el.append('<div class="resizebar vertical">'))},initialize:function(a){this.listView=a.listView,this.id=a.id||"default",this.options=a},render:function(){var a=$('<div class="toolbar generic-toolbar top" role="toolbar" aria-hidden="true">'),c=b.point(this.id+"/list-view/toolbar/top"),d=$('<div class="toolbar generic-toolbar visual-focus bottom" role="toolbar">'),e=b.point(this.id+"/list-view/toolbar/bottom"),f=new b.Baton({view:this,app:this.options.app});return c.list().length&&(this.$el.addClass("toolbar-top-visible"),c.invoke("draw",a,f)),e.list().length&&(this.$el.addClass("toolbar-bottom-visible"),e.invoke("draw",d,f)),this.$el.attr({role:"navigation"}).append(a,this.listView.render().$el.addClass("abs"),d),this}});return d.minWidth=270,d.maxWidth=-250,d.minHeight=150,d.maxHeight=-100,d}),define("io.ox/mail/threadview",["io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/api/backbone","io.ox/mail/detail/view","io.ox/mail/detail/mobileView","io.ox/core/tk/list-dnd","io.ox/core/emoji/util","io.ox/core/http","gettext!io.ox/mail","less!io.ox/mail/style","io.ox/mail/listview"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";b.point("io.ox/mail/thread-view").extend({id:"navigation",index:100,draw:function(){this.$el.append($('<nav class="back-navigation generic-toolbar">').append($('<div class="button">').append($('<a href="#" class="back" tabindex="1">').append($('<i class="fa fa-chevron-left">'),$.txt(" "),$.txt(k("Back")))),$('<div class="position">'),$('<div class="prev-next">').append($('<a href="#" class="previous-mail" tabindex="1">').append('<i class="fa fa-chevron-up">'),$('<a href="#" class="next-mail" tabindex="1">').append('<i class="fa fa-chevron-down">'))).attr("role","toolbar"))}}),b.point("io.ox/mail/thread-view").extend({id:"thread-view-list",index:200,draw:function(){this.$el.append($('<div class="thread-view-list scrollable abs">').hide().append($("<h1>"),this.$messages=$('<div class="thread-view list-view">')))}}),b.point("io.ox/mail/thread-view/header").extend({id:"toggle-all",index:100,draw:function(a){a.view.collection.length<=1||this.append($('<a href="#" role="button" class="toggle-all" tabindex="1">').append('<i class="fa fa-angle-double-down">').attr({"data-toggle":"tooltip","data-placement":"left","data-animation":"false","data-container":"body",title:k("Open/close all messages")}).tooltip())}}),b.point("io.ox/mail/thread-view/header").extend({id:"subject",index:200,draw:function(a){var b=1===a.view.collection.length,c=d.getSubject(a.view.collection.at(0).toJSON(),b),e=$('<div class="subject">').text(c);this.append(e),i.processEmoji(e.html(),function(a){e.html(a)})}}),b.point("io.ox/mail/thread-view/header").extend({id:"summary",index:300,draw:function(a){var b=a.view.collection.length;1>=b||this.append($('<div class="summary">').text(k("%1$d messages in this conversation",b)))}});var l=Backbone.View.extend({tagName:"div",className:"thread-view-control abs",events:{"click .button a.back":"onBack","click .back-navigation .previous-mail":"onPrevious","click .back-navigation .next-mail":"onNext","click .toggle-all":"onToggleAll",keydown:"onKeydown"},empty:function(){this.$messages.empty(),this.$el.scrollTop(0),this.$el.find(".thread-view-list").hide(),this.model=null},updateHeader:_.debounce(function(){var a=new b.Baton({view:this}),c=this.$el.find(".thread-view-list > h1").empty();this.collection.length>0&&b.point("io.ox/mail/thread-view/header").invoke("draw",c,a),this.$el.find(".thread-view").toggleClass("multiple-messages",this.collection.length>1)},10),updatePosition:function(a){return this.$el.find(".position").text(a),this},togglePrevious:function(a){return this.$el.find(".previous-mail").toggleClass("disabled",!a),this},toggleNext:function(a){return this.$el.find(".next-mail").toggleClass("disabled",!a),this},toggleNavigation:function(a){return this.$el.toggleClass("back-navigation-visible",a),this},onToggle:_.debounce(function(){var a=this.getItems(),b=a.filter(".expanded"),c=0===b.length,d=c?"fa-angle-double-down":"fa-angle-double-up";this.$el.find(".toggle-all i").attr("class","fa "+d)},10),onToggleAll:function(a){a.preventDefault();var b=this.getItems(),c=b.filter(".expanded"),d=0===c.length;j.pause(),this.collection.each(function(a){this.toggleMail(a.cid,d)},this),j.resume()},toggleMail:function(a,b){var c=this.$messages.children('[data-cid="'+$.escape(a)+'"]'),d=c.data("view");d&&d.toggle(b)},showMail:function(a){this.toggleMail(a,!0)},autoSelectMail:function(){for(var a,b=this.collection.length-1;a=this.collection.at(b);b--)if(0===b||d.isUnseen(a.toJSON())){this.showMail(a.cid);break}},show:function(a,b){if(a=String(a).replace(/^thread\./,""),!this.model||this.model.cid!==a){var d=c.pool.get("detail").get(a);d&&(this.model&&this.stopListening(this.model),this.model=d,this.threaded=!!b,this.listenTo(this.model,"change:thread",this.onChangeModel),this.collection.reset([],{silent:!0}),this.reset())}},reset:function(){if(this.model){var a=this.threaded?c.threads.get(this.model.cid):[this.model.toJSON()];if(a.length){var b=0===this.collection.length?"reset":"set";this.collection[b||"reset"](a)}}},onReset:function(){return 0===this.collection.length?void this.empty():(this.$messages.empty(),this.$el.scrollTop(0),this.updateHeader(),this.$el.find(".thread-view-list").show(),this.$messages.append(this.collection.chain().map(this.renderListItem,this).value()),this.zIndex(),void this.autoSelectMail())},onAdd:function(a){var b=a.get("index"),c=this.getItems(),d=this.renderListItem(a);b<c.length?c.eq(b).before(d):this.$messages.append(d),d.position().top<=0&&this.$messages.scrollTop(this.$el.scrollTop()+d.outerHeight(!0)),this.zIndex(),this.updateHeader()},onRemove:function(a){var b=this.getItems(),c=b.filter('[data-cid="'+a.cid+'"]'),d=this.$messages.scrollTop();0!==c.length&&(c.position().top<d&&this.$messages.scrollTop(d-c.outerHeight(!0)),c.remove(),1===b.length?this.empty():this.updateHeader())},onPoolRemove:function(a){this.collection.remove(a)},onChangeModel:function(){this.reset()},onBack:function(a){a.preventDefault(),this.trigger("back")},onPrevious:function(a){a.preventDefault(),this.trigger("previous")},onNext:function(a){a.preventDefault(),this.trigger("next")},onClick:function(a){var b=$(a.currentTarget).attr("data-cid");this.showMail(b)},onKeydown:function(a){switch(a.which){case 38:a.shiftKey&&this.onNext(a),a.altKey&&this.focusMessage(a,-1);break;case 40:a.shiftKey&&this.onPrevious(a),a.altKey&&this.focusMessage(a,1)}},focusMessage:function(a,b){var c=this.getItems(),d=$(document.activeElement).closest(".list-item"),e=c.index(d);a.preventDefault(),e+=b,0>e||e>=c.length||(d.data("view").toggle(!1),c.eq(e).focus().data("view").toggle(!0),c.eq(e).get(0).scrollIntoView(!0))},initialize:function(){this.model=null,this.threaded=!0,this.collection=new e.Collection,this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset}),this.listenTo(c.pool.get("detail"),{remove:this.onPoolRemove}),this.$messages=$(),this.$el.on("toggle",".list-item",this.onToggle.bind(this)),h.enable({container:this.$el,draggable:!0,selectable:".detail-view-header",simple:!0})},getItems:function(){return this.$messages.children(".list-item")},render:function(){return b.point("io.ox/mail/thread-view").invoke("draw",this),this},renderListItem:function(a){var b=new f.View({tagName:"article",data:a.toJSON(),disable:{"io.ox/mail/detail":"subject"}});return b.render().$el.attr({tabindex:"1"})},zIndex:function(){var a=this.getItems(),b=a.length;a.each(function(a){$(this).css("zIndex",b-a)})}});b.point("io.ox/mail/mobile/thread-view").extend({id:"thread-view-list",index:100,draw:function(){this.$el.append($('<div class="thread-view-list scrollable abs">').hide().append($("<h1>"),this.$messages=$('<ul class="thread-view list-view">')))}}),b.point("io.ox/mail/mobile").extend({id:"remove-halo-link",index:100,customize:function(){var a=this.$el.find(".person-link");_(a).each(function(b){var c=$("<span>").text($(b).text());c.addClass(a.attr("class")),c.addClass("sp").removeClass("halo-link"),$(b).after(c)}),a.remove()}});var m=l.extend({initialize:function(){this.model=null,this.collection=new e.Collection,this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset}),this.$messages=$()},renderListItem:function(a){var c=new g.HeaderView({tagName:"li",data:a.toJSON(),disable:{"io.ox/mail/detail":["subject","actions"],"io.ox/mail/detail/header":["flag-picker","unread-toggle"]}});return c.render().$el.attr({role:"listitem",tabindex:"1"}),b.point("io.ox/mail/mobile").invoke("customize",c),c.$el},renderMail:function(a){a=String(a).replace(/^thread\.(.+)$/,"$1");var b=c.pool.get("detail").get(a);if(b){var d=new g.DetailView({tagName:"li",data:b.toJSON()});return this.mail=b.toJSON(),d.render().toggle().$el.attr({role:"listitem",tabindex:"1"})}},render:function(){return b.point("io.ox/mail/thread-view/header").disable("toggle-all"),b.point("io.ox/mail/thread-view").invoke("draw",this),this}});return{Desktop:l,Mobile:m}}),define("io.ox/mail/actions",["io.ox/core/extensions","io.ox/core/extPatterns/links","io.ox/mail/api","io.ox/mail/util","gettext!io.ox/mail","settings!io.ox/core","io.ox/core/folder/api","io.ox/core/notifications","io.ox/core/print","io.ox/contacts/api","io.ox/core/api/account","io.ox/core/extPatterns/actions","settings!io.ox/mail"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";function n(a,b,d){new q("io.ox/mail/actions/"+a,{id:a,requires:"toplevel some",multiple:function(e,f){require(["io.ox/core/folder/actions/move"],function(h){h.item({all:e,api:c,button:b,list:g.ignoreSentItems(e),module:"mail",root:"1",settings:m,success:d,target:f.target,title:b,type:a})})}})}var o=function(a){return _.contains(k.getFoldersByType("drafts"),a)},p=function(a){return o(a.folder_id)||(4&a.flags)>0},q=b.Action;new q("io.ox/mail/actions/unselect",{requires:function(a){return a.collection.has("toplevel","multiple")&&!a.baton.isThread},multiple:function(a,b){b.grid&&b.grid.selection.clear()}}),new q("io.ox/mail/actions/compose",{id:"compose",requires:function(){return!0},action:function(a){ox.registry.call("mail-compose","compose",{folder_id:a.app.folder.get()})}}),new q("io.ox/mail/actions/delete",{id:"delete",requires:"toplevel some delete",multiple:function(a){var b=a.slice();a=g.ignoreSentItems(a);var d=m.get("removeDeletedPermanently")||_(a).any(function(a){return k.is("trash",a.folder_id)}),f=e.ngettext("Do you want to permanently delete this mail?","Do you want to permanently delete these mails?",a.length);d?require(["io.ox/core/tk/dialogs"],function(d){(new d.ModalDialog).append($("<h4>").text(f)).addPrimaryButton("delete",e("Delete"),"delete",{tabIndex:"1"}).addButton("cancel",e("Cancel"),"cancel",{tabIndex:"1"}).on("delete",function(){c.remove(a,b).fail(h.yell)}).show()}):c.remove(a,b).fail(function(b){"MSG-0039"===b.code?require(["io.ox/core/tk/dialogs"],function(b){(new b.ModalDialog).header($("<h4>").text(e("Mail quota exceeded"))).append($("<div>").text(e("Emails cannot be put into trash folder while your mail quota is exceeded.")),$("<div>").text(f)).addPrimaryButton("delete",e("Delete"),"delete",{tabIndex:"1"}).addButton("cancel",e("Cancel"),"cancel",{tabIndex:"1"}).on("delete",function(){c.remove(a,{force:!0})}).show()}):h.yell(b)})}}),new q("io.ox/mail/actions/reply-all",{id:"reply-all",requires:function(a){if(a.collection.has("toplevel","some")&&(a.collection.has("one")||a.baton.isThread)){var b=a.baton.first();return d.hasOtherRecipients(b)&&!p(b)}},action:function(a){ox.registry.call("mail-compose","replyall",a.first())}}),new q("io.ox/mail/actions/reply",{id:"reply",requires:function(a){if(a.collection.has("toplevel","some")&&(a.collection.has("one")||a.baton.isThread)){var b=a.baton.first();return d.hasFrom(b)&&!p(b)}},action:function(a){ox.registry.call("mail-compose","reply",a.first())}}),new q("io.ox/mail/actions/forward",{id:"forward",requires:function(a){return a.collection.has("toplevel","some")},action:function(a){ox.registry.call("mail-compose","forward",a.isThread?a.first():a.data)}}),new q("io.ox/mail/actions/edit",{id:"edit",requires:function(a){if(a.collection.has("toplevel")&&(a.collection.has("one")||a.baton.isThread)){var b=a.baton.first();return b&&p(b)}},action:function(a){var b=a.first(),c=!1;_.each(ox.ui.apps.models,function(a){a.refId===b.id&&(c=!0,a.launch())}),c!==!0&&ox.registry.call("mail-compose","edit",b)}}),new q("io.ox/mail/actions/source",{id:"source",requires:function(a){return a.collection.has("some")&&a.collection.has("toplevel")&&(a.collection.has("one")||a.baton.isThread)?!0:void 0},action:function(a){var b=a.first();require(["io.ox/core/tk/dialogs"],function(a){new a.ModalDialog({width:700}).addPrimaryButton("close",e("Close"),"close",{tabIndex:"1"}).header($("<h4>").text(e("Mail source")+": "+(b.subject||""))).append($('<textarea class="form-control mail-source-view" rows="15" readonly="readonly">').on("keydown",function(a){27!==a.which&&a.stopPropagation()})).show(function(){c.getSource(b).done(function(a){this.find("textarea").val(a||"").css({visibility:"visible",cursor:"default"}),this.idle()}.bind(this))})})}}),new q("io.ox/mail/actions/print",{requires:function(a){return _.device("smartphone")?!1:a.collection.has("some")&&(a.collection.has("read")||!a.collection.has("toplevel"))},multiple:function(a){i.request("io.ox/mail/print",a)}}),n("move",e("Move"),{multiple:e("Mails have been moved"),single:e("Mail has been moved")}),n("copy",e("Copy"),{multiple:e("Mails have been copied"),single:e("Mail has been copied")}),new q("io.ox/mail/actions/markunread",{id:"markunread",requires:function(a){return a.collection.has("toplevel")?_(a.baton.array()).reduce(function(a,b){return a||!d.isUnseen(b)},!1):void 0},multiple:function(a){a=g.ignoreSentItems(a),c.markUnread(a)}}),new q("io.ox/mail/actions/markread",{id:"markread",requires:function(a){return a.collection.has("toplevel")?_(a.baton.array()).reduce(function(a,b){return a||d.isUnseen(b)},!1):void 0},multiple:function(a){a=g.ignoreSentItems(a),c.markRead(a)}}),new q("io.ox/mail/actions/spam",{capabilities:"spam",requires:function(a){return a.collection.has("toplevel","some")?_(a.baton.array()).reduce(function(a,b){return a===!1?!1:k.isPrimary(b.folder_id)?k.is("spam",b.folder_id)?!1:d.isSpam(b)?!1:!0:!1},!0):!1},multiple:function(a){c.markSpam(a)}}),new q("io.ox/mail/actions/nospam",{capabilities:"spam",requires:function(a){return a.collection.has("toplevel","some")?_(a.baton.array()).reduce(function(a,b){return a===!1?!1:k.isPrimary(b.folder_id)?k.is("spam",b.folder_id)||d.isSpam(b):!1},!0):!1},multiple:function(a){c.noSpam(a)}}),new q("io.ox/mail/actions/preview-attachment",{id:"preview",requires:function(a){return require(["io.ox/preview/main"]).pipe(function(b){var c=_.getArray(a.context);return a.collection.has("some")&&_.device("!smartphone")&&_(c).reduce(function(a,c){return a||new b.Preview({filename:c.filename,mimetype:String(c.content_type||"").split(";")[0],attachment:!0}).supportsPreview()},!1)})},multiple:function(a,b){var d=a[0].parent.adjustid||"";a[0].id=_.isFunction(d)?d(a[0].id):a[0].id,require(["io.ox/core/tk/dialogs","io.ox/preview/main"],function(d,e){new d.SidePopup({tabTrap:!0}).show(b.e,function(b){_(a).each(function(a){var d=new e.Preview({data:a,filename:a.filename,parent:a.parent,mimetype:a.content_type,dataURL:c.getUrl(a,"view"),downloadURL:c.getUrl(a,"download")},{width:b.parent().width(),height:"auto"});d.supportsPreview()&&(b.append($("<h4>").addClass("mail-attachment-preview").text(a.filename)),d.appendTo(b),b.append($("<div>").text(" ")))})})})}}),new q("io.ox/mail/actions/open-attachment",{id:"open",requires:"one",multiple:function(a){_(a).each(function(a){var b=c.getUrl(a,"view");window.open(b)})}}),new q("io.ox/mail/actions/slideshow-attachment",{id:"slideshow",requires:function(a){return a.collection.has("multiple")&&_(a.context).reduce(function(a,b){return a||/\.(gif|bmp|tiff|jpe?g|gmp|png)$/i.test(b.filename)},!1)},multiple:function(a,b){require(["io.ox/files/carousel"],function(d){var e=/\.(gif|bmp|tiff|jpe?g|gmp|png)$/i,f=_(a).map(function(a){var b=c.getUrl(a,"view");return e.test(a.filename)||(b+="&format=preview_image&session="+ox.session),{url:b,filename:a.filename}}),g=0;b.startItem&&_(f).each(function(a,c){-1!==a.url.indexOf("attachment="+b.startItem.id)&&(g=c)}),d.init({fullScreen:!1,baton:{allIds:f,startIndex:g},attachmentMode:!0,useSelectionAsStart:!0})})}}),new q("io.ox/mail/actions/download-attachment",{id:"download",requires:function(a){return _.device("!ios")&&a.collection.has("some")},multiple:function(a){var b=1===a.length?c.getUrl(_(a).first(),"download"):c.getUrl(a,"zip");require(["io.ox/core/download"],function(a){a.url(b)})}}),new q("io.ox/mail/actions/save-attachment",{id:"save",capabilities:"infostore",requires:"some",multiple:function(a){require(["io.ox/mail/actions/attachmentSave"],function(b){b.multiple(a)})}}),new q("io.ox/mail/actions/vcard",{id:"vcard",capabilities:"contacts",requires:function(a){if(!a.collection.has("one"))return!1;var b=a.context,c=/\.vcf$/i.test(b.filename),d=/^text\/(x-)?vcard/i.test(b.content_type),e=/^text\/directory/i.test(b.content_type);return c&&e||d},action:function(a){var b=_.isArray(a.data)?_.first(a.data):a.data;require(["io.ox/core/api/conversion"]).done(function(a){a.convert({identifier:"com.openexchange.mail.vcard",args:[{"com.openexchange.mail.conversion.fullname":b.parent.folder_id},{"com.openexchange.mail.conversion.mailid":b.parent.id},{"com.openexchange.mail.conversion.sequenceid":b.id}]},{identifier:"com.openexchange.contact.json",args:[]}).then(function(a){if(!_.isArray(a)||0===a.length)return void h.yell("error",e("Failed to add. Maybe the vCard attachment is invalid."));var b=a[0],c=f.get("folder/contacts");b.mark_as_distributionlist?require(["io.ox/contacts/distrib/main"],function(a){a.getApp(b).launch().done(function(){this.create(c,b)})}):require(["io.ox/contacts/edit/main"],function(a){b.folder_id=c,a.reuse("edit",b)||a.getApp(b).launch()
})},function(a){h.yell(a)})})}}),new q("io.ox/mail/actions/ical",{id:"ical",capabilities:"calendar",requires:function(a){var b=_.isArray(a.context)?_.first(a.context):a.context,c=b.filename&&!!b.filename.match(/\.ics$/i),d=b.content_type&&!!b.content_type.match(/^text\/calendar/i),e=b.content_type&&!!b.content_type.match(/^application\/ics/i);return c||d||e},action:function(a){var b=_.isArray(a.data)?_.first(a.data):a.data;require(["io.ox/core/api/conversion"]).done(function(a){a.convert({identifier:"com.openexchange.mail.ical",args:[{"com.openexchange.mail.conversion.fullname":b.parent.folder_id},{"com.openexchange.mail.conversion.mailid":b.parent.id},{"com.openexchange.mail.conversion.sequenceid":b.id}]},{identifier:"com.openexchange.ical",args:[{"com.openexchange.groupware.calendar.folder":f.get("folder/calendar")},{"com.openexchange.groupware.task.folder":f.get("folder/tasks")}]}).done(function(){h.yell("success",e("The appointment has been added to your calendar"))}).fail(h.yell)})}}),new q("io.ox/mail/actions/save",{id:"saveEML",requires:function(a){return _.device("!ios")&&a.collection.has("some","read")},multiple:function(a){require(["io.ox/core/download"],function(b){var d,e=_(a).first();if(!_.isObject(e.parent))return 1===a.length?b.mail(e):b.mails(a);if(e.msgref&&_.isObject(e.parent))d=c.getUrl(a,"eml:reference");else{var f=e.parent.adjustid||"";e.id=_.isFunction(f)?f(e.id):e.id,d=c.getUrl(e,"download")}b.url(d)})}}),new q("io.ox/mail/actions/add-to-portal",{capabilities:"portal",requires:"one toplevel",action:function(a){require(["io.ox/portal/widgets"],function(b){b.add("stickymail",{plugin:"mail",props:$.extend({id:a.data.id,folder_id:a.data.folder_id,title:a.data.subject},a.data.parent||{})}),h.yell("success",e("This mail has been added to the portal"))})}}),new q("io.ox/mail/actions/sendmail",{requires:"some",action:function(a){var b=a.data;ox.registry.call("mail-compose","compose",{folder_id:b.folder_id,to:b.to.concat(b.cc).concat(b.from)})}}),new q("io.ox/mail/actions/createdistlist",{id:"create-distlist",capabilities:"contacts",requires:"some",action:function(a){var b,c=a.data,d=[].concat(c.to,c.cc,c.from),e=$.Deferred(),g=[],h=ox.user_id,i=f.get("folder/contacts"),k=function(a){require(["io.ox/contacts/distrib/main"],function(b){b.getApp().launch().done(function(){this.create(i,{distribution_list:a})})})};d=_(d).chain().map(function(a){return a[1]}).uniq().value(),b=d.length,_(d).each(function(a){j.search(a).done(function(c){var d,f=c[0];f?(d={id:f.id,folder_id:f.folder_id,display_name:f.display_name,mail:f.email1,mail_field:1},f.internal_userid!==h?g.push(d):b-=1):(d={display_name:a,mail:a,mail_field:0},g.push(d)),g.length===b&&e.resolve()})}),e.done(function(){k(g)})}}),new q("io.ox/mail/actions/invite",{id:"invite",capabilities:"calendar",requires:"some",action:function(a){var b,c=a.data,e=[],g=[],h=ox.user_id,i=f.get("folder/calendar"),k=c.to.concat(c.cc).concat(c.from),l=$.Deferred(),m=function(a,b){require(["io.ox/calendar/edit/main"],function(c){c.getApp().launch().done(function(){a=_.filter(a,function(a){return a.mail?"phone"!==d.getChannel(a.mail,!1):!0});var c={participants:a,title:b,folder_id:i};this.create(c),this.model.toSync=c})})};_(k).each(function(a){e.push(a[1])}),b=e.length,_(e).each(function(a){j.search(a).done(function(c){var d=c[0]?c[0]:{email1:a,display_name:a},e={id:d.internal_userid,type:1},f={type:5,display_name:d.display_name,mail:d.email1};d.internal_userid!==h?g.push(void 0!==d.internal_userid&&0!==d.internal_userid?e:0===d.internal_userid?f:f):b-=1,g.length===b&&l.resolve()})}),l.done(function(){m(g,c.subject)})}}),new q("io.ox/mail/actions/reminder",{id:"reminder",capabilities:"tasks",requires:"one toplevel",action:function(a){var b=a.data;require(["io.ox/core/tk/dialogs","io.ox/tasks/api","io.ox/tasks/util"],function(a,c,g){var i,j,k,l=new Date,m=(new a.ModalDialog).addPrimaryButton("create",e("Create reminder"),"create",{tabIndex:"1"}).addButton("cancel",e("Cancel"),"cancel",{tabIndex:"1"});m.getHeader().append($("<h4>").text(e("Remind me")));var n=m.getBody();n.append($('<div class="form-group">').append($("<label>").text(e("Subject")),i=$('<input class="form-control">',{type:"text",value:e("Mail reminder")+": "+b.subject,tabindex:"1","aria-labelledby":"subject"}).focus(function(){this.select()})),$('<div class="form-group">').append($("<label>").text(e("Note")),j=$('<textarea class="form-control">',{rows:"5",value:e("Mail reminder for")+": "+b.subject+" \n"+e("From")+": "+d.formatSender(b.from[0]),tabindex:"1","aria-labelledby":"note"}).focus(function(){this.select()})),$('<div class="form-group">').append($('<label id="remindme">').text(e("Remind me")),k=$('<select class="form-control">',{name:"dateselect",tabindex:"1","aria-labelledby":"remindme"}).append(g.buildDropdownMenu({time:l}))));var o=m.show();i.focus(),o.done(function(a){if("create"===a){var b=g.computePopupTime(k.val(),!0);c.create({title:i.val(),folder_id:f.get("folder/tasks"),alarm:b.alarmDate,note:j.val(),status:1,recurrence_type:0,percent_completed:0}).done(function(){h.yell("success",e("Reminder has been created"))})}})})}}),new b.ActionGroup("io.ox/mail/links/toolbar",{id:"default",index:100,icon:function(){return $('<i class="fa fa-pencil accent-color">')}}),new b.ActionLink("io.ox/mail/links/toolbar/default",{index:100,id:"compose",label:e("Compose new mail"),ref:"io.ox/mail/actions/compose"});var r=0;a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",id:"reply",mobile:"hi",label:e("Reply"),ref:"io.ox/mail/actions/reply",section:"standard"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",id:"reply-all",mobile:"hi",label:e("Reply All"),ref:"io.ox/mail/actions/reply-all",drawDisabled:!0,section:"standard"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",id:"forward",mobile:"hi",label:e("Forward"),ref:"io.ox/mail/actions/forward",section:"standard"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",id:"edit",mobile:"hi",label:e("Edit"),ref:"io.ox/mail/actions/edit",section:"standard"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",id:"delete",mobile:"hi",label:e("Delete"),ref:"io.ox/mail/actions/delete",section:"standard"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",mobile:"hi",id:"markunread",label:e("Mark unread"),ref:"io.ox/mail/actions/markunread",section:"flags"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+1,prio:"hi",mobile:"hi",id:"markread",label:e("Mark read"),ref:"io.ox/mail/actions/markread",section:"flags"})),new q("io.ox/mail/actions/label",{id:"label",requires:"toplevel some",multiple:$.noop}),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"hi",mobile:"hi",id:"spam",label:e("Mark as spam"),ref:"io.ox/mail/actions/spam",section:"flags"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+1,prio:"hi",mobile:"hi",id:"nospam",label:e("Not spam"),ref:"io.ox/mail/actions/nospam",section:"flags"})),a.point("io.ox/mail/links/inline").extend(new b.Link({id:"sendmail",index:r+=100,prio:"lo",label:e("Send new mail"),ref:"io.ox/mail/actions/sendmail",section:"recipients"})),a.point("io.ox/mail/links/inline").extend(new b.Link({id:"invite-to-appointment",index:r+=100,prio:"lo",label:e("Invite to appointment"),ref:"io.ox/mail/actions/invite",section:"recipients"})),a.point("io.ox/mail/links/inline").extend(new b.Link({id:"save-as-distlist",index:r+=100,prio:"lo",label:e("Save as distribution list"),ref:"io.ox/mail/actions/createdistlist",section:"recipients"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"lo",id:"move",label:e("Move"),ref:"io.ox/mail/actions/move",section:"file-op"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"lo",id:"copy",label:e("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"none",id:"print",label:e("Print"),ref:"io.ox/mail/actions/print",section:"export"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"none",id:"saveEML",label:e("Save as file"),ref:"io.ox/mail/actions/save",section:"export"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"none",id:"source",label:e("View source"),ref:"io.ox/mail/actions/source",section:"export"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"lo",id:"reminder",label:e("Reminder"),ref:"io.ox/mail/actions/reminder",section:"keep"})),a.point("io.ox/mail/links/inline").extend(new b.Link({index:r+=100,prio:"lo",mobile:"none",id:"add-to-portal",label:e("Add to portal"),ref:"io.ox/mail/actions/add-to-portal",section:"keep"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"vcard",mobile:"high",index:50,label:e("Add to address book"),ref:"io.ox/mail/actions/vcard"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"ical",mobile:"high",index:50,label:e("Add to calendar"),ref:"io.ox/mail/actions/ical"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"slideshow",index:100,mobile:"high",label:e("Slideshow"),ref:"io.ox/mail/actions/slideshow-attachment"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"preview",index:200,mobile:"high",label:e("Preview"),ref:"io.ox/mail/actions/preview-attachment"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"open",index:300,mobile:"high",label:e("Open in browser"),ref:"io.ox/mail/actions/open-attachment"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"download",index:400,mobile:"high",label:e("Download"),ref:"io.ox/mail/actions/download-attachment"})),a.point("io.ox/mail/attachment/links").extend(new b.Link({id:"save",index:500,mobile:"high",label:e("Save to Drive"),ref:"io.ox/mail/actions/save-attachment"})),a.point("io.ox/mail/dnd/actions").extend({id:"importEML",index:10,label:e("Drop here to import this mail"),action:function(a,b){b.queues.importEML.offer(a,{folder:b.folder.get()})}})}),define("io.ox/mail/toolbar",["io.ox/core/extensions","io.ox/core/extPatterns/links","io.ox/core/extPatterns/actions","io.ox/core/tk/flag-picker","io.ox/mail/api","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/toolbar","io.ox/core/tk/upload","io.ox/core/dropzone","io.ox/core/notifications","gettext!io.ox/mail","io.ox/mail/actions","less!io.ox/mail/style","io.ox/mail/folderview-extensions"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(){if(this.model){var a=this.$el.find('[data-name="contactPictures"]').parent(),b=this.model.get("layout");"vertical"===b||"compact"===b?a.show():a.hide()}}function m(a,b){b.preventDefault(),require(["io.ox/mail/statistics"]).done(function(b){b.open(a)})}var n=a.point("io.ox/mail/classic-toolbar/links"),o={compose:{prio:"hi",mobile:"hi",label:k("Compose"),title:k("Compose new email"),drawDisabled:!0,ref:"io.ox/mail/actions/compose"},reply:{prio:"hi",mobile:"lo",icon:"fa fa-reply",label:k("Reply to sender"),drawDisabled:!0,ref:"io.ox/mail/actions/reply"},"reply-all":{prio:"hi",mobile:"lo",icon:"fa fa-reply-all",label:k("Reply to all recipients"),drawDisabled:!0,ref:"io.ox/mail/actions/reply-all"},forward:{prio:"hi",mobile:"lo",icon:"fa fa-mail-forward",label:k("Forward"),drawDisabled:!0,ref:"io.ox/mail/actions/forward"},"delete":{prio:"hi",mobile:"lo",icon:"fa fa-trash-o",label:k("Delete"),drawDisabled:!0,ref:"io.ox/mail/actions/delete"},spam:{prio:"hi",mobile:"lo",icon:"fa fa-ban",label:k("Mark as spam"),ref:"io.ox/mail/actions/spam"},nospam:{prio:"hi",mobile:"lo",icon:"fa fa-thumbs-up",label:k("Not spam"),ref:"io.ox/mail/actions/nospam"},color:{prio:"hi",mobile:"none",icon:"fa fa-bookmark",label:k("Set color"),drawDisabled:!0,ref:"io.ox/mail/actions/color",customize:function(a){d.attach(this,{data:a.data})}},edit:{prio:"hi",mobile:"lo",label:k("Edit draft"),ref:"io.ox/mail/actions/edit"},markunread:{prio:"lo",mobile:"lo",label:k("Mark as unread"),ref:"io.ox/mail/actions/markunread",section:"flags"},markread:{prio:"lo",mobile:"lo",label:k("Mark as read"),ref:"io.ox/mail/actions/markread",section:"flags"},move:{prio:"lo",mobile:"lo",label:k("Move"),ref:"io.ox/mail/actions/move",section:"file-op"},copy:{prio:"lo",mobile:"lo",label:k("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"},print:{prio:"lo",mobile:"lo",label:k("Print"),ref:"io.ox/mail/actions/print",section:"export"},saveEML:{prio:"lo",mobile:"lo",label:k("Save as file"),ref:"io.ox/mail/actions/save",section:"export"},source:{prio:"lo",mobile:"none",label:k("View source"),ref:"io.ox/mail/actions/source",section:"export"},reminder:{prio:"lo",mobile:"none",label:k("Reminder"),ref:"io.ox/mail/actions/reminder",section:"keep"},"add-to-portal":{prio:"lo",mobile:"none",label:k("Add to portal"),ref:"io.ox/mail/actions/add-to-portal",section:"keep"}};new c.Action("io.ox/mail/actions/color",{requires:"some",action:$.noop});var p=0;_(o).each(function(a,c){a.id=c,a.index=p+=100,n.extend(new b.Link(a))}),a.point("io.ox/mail/classic-toolbar").extend(new b.InlineLinks({attributes:{},classes:"",dropdown:!0,index:200,id:"toolbar-links",ref:"io.ox/mail/classic-toolbar/links"})),a.point("io.ox/mail/classic-toolbar").extend({id:"view-dropdown",index:1e4,draw:function(a){if(!_.device("smartphone")){var b=new f({model:a.app.props,label:k("View"),tagName:"li"}).header(k("Layout")).option("layout","vertical",k("Vertical")).option("layout","compact",k("Compact")).option("layout","horizontal",k("Horizontal")).option("layout","list",k("List")).divider().header(k("Options")).option("folderview",!0,k("Folder view")).option("checkboxes",!0,k("Checkboxes")).option("contactPictures",!0,k("Contact pictures")).option("exactDates",!0,k("Exact dates")).divider().link("statistics",k("Statistics"),m.bind(null,a.app)).listenTo(a.app.props,"change:layout",l);this.append(b.render().$el.addClass("pull-right").attr("data-dropdown","view")),l.call(b)}}}),a.point("io.ox/mail/mediator").extend({id:"toolbar",index:1e4,setup:function(b){if(!_.device("smartphone")){var c=new g({title:b.getTitle(),tabindex:1});b.getWindow().nodes.body.addClass("classic-toolbar-visible").prepend(c.render().$el),b.updateToolbar=_.queued(function(b){if(!b)return $.when();var d=this.props.get("thread");b=e.resolve(b,d),b=1===b.length?b[0]:b;var f=a.Baton({$el:c.$list,data:b,isThread:d,app:this}),g=a.point("io.ox/mail/classic-toolbar").invoke("draw",c.$list.empty(),f);return $.when.apply($,g.value()).then(function(){c.initButtons()})},10)}}}),a.point("io.ox/mail/mediator").extend({id:"update-toolbar",index:10200,setup:function(a){_.device("smartphone")||(a.updateToolbar(),a.listView.on("selection:change change",function(){a.updateToolbar(a.listView.selection.get())}))}})}),define("io.ox/mail/import",["io.ox/core/extensions","io.ox/mail/api","io.ox/core/tk/upload","io.ox/core/dropzone","io.ox/core/notifications","gettext!io.ox/mail"],function(a,b,c,d,e,f){"use strict";a.point("io.ox/mail/mediator").extend({id:"import-eml",index:"last",setup:function(a){if(a.settings.get("features/importEML")!==!1){var g=a.getWindow();a.queues={importEML:c.createQueue({start:function(){g.busy()},progress:function(a){return b.importEML({file:a.file,folder:a.options.folder}).done(function(a){var b=_(a.data||[]).first()||{};"Error"in b?e.yell("error",b.Error):e.yell("success",f("Mail has been imported"))})},stop:function(){g.idle()},type:"importEML"})};var h=new d.Inplace({caption:f("Drop EML file here for import"),filter:/\.eml$/i});h.on({show:function(){a.right.removeClass("preview-visible"),a.listControl.$el.stop().hide()},hide:function(){a.listControl.$el.fadeIn("fast")},drop:function(b){a.queues.importEML.offer(b,{folder:a.folder.get()})},invalid:function(){e.yell("error",f("Mail was not imported. Only .eml files are supported."))}}),a.left.append(h.render().$el.addClass("abs"))}}})}),define("io.ox/mail/folderview-extensions",["io.ox/core/extensions","io.ox/core/capabilities","gettext!io.ox/mail"],function(a,b,c){"use strict";function d(a){a.preventDefault(),require(["io.ox/mail/accounts/settings"],function(b){b.mailAutoconfigDialog(a)})}var e="io.ox/mail/folderview";b.has("multiple_mail_accounts")&&a.point(e+"/sidepanel/links").extend({id:"add-account",index:300,draw:function(){_.device("!smartphone")&&this.append($("<div>").append($('<a href="#" data-action="add-mail-account" tabindex="1" role="button">').text(c("Add mail account")).on("click",d)))}})}),define("io.ox/mail/mobile-navbar-extensions",["io.ox/core/extensions"],function(a){"use strict";a.point("io.ox/mail/mobile/navbar").extend({id:"btn-left",index:100,draw:function(a){a.left&&this.$el.append($('<div class="navbar-action left">').append($("<a>").append($('<i class="fa fa-chevron-left">'),a.left)))}}),a.point("io.ox/mail/mobile/navbar").extend({id:"header",index:200,draw:function(a){this.$el.append($('<div class="navbar-title">').text(a.title))}}),a.point("io.ox/mail/mobile/navbar").extend({id:"btn-right",index:300,draw:function(a){a.right&&this.$el.append($('<div class="navbar-action right">').append($("<a>").append(a.right)))}})}),define("io.ox/mail/mobile-toolbar-actions",["io.ox/core/extensions","io.ox/core/extPatterns/links","io.ox/mail/api","gettext!io.ox/mail"],function(a,b,c,d){"use strict";function e(a,c){var d=0;_(c).each(function(c){var e=k[c];e.id=c,e.index=d+=100,a.extend(new b.Link(e))}),d=0}var f=a.point("io.ox/mail/mobile/toolbar/listView"),g=a.point("io.ox/mail/mobile/toolbar/listView/multiselect"),h=a.point("io.ox/mail/mobile/toolbar/threadView"),i=a.point("io.ox/mail/mobile/toolbar/detailView"),j=a.point("io.ox/mail/mobile/toolbar/submenuActions"),k={compose:{prio:"hi",mobile:"hi",label:d("Compose"),icon:"fa fa-edit",drawDisabled:!0,ref:"io.ox/mail/actions/compose",cssClasses:"io-ox-action-link mobile-toolbar-action"},reply:{prio:"hi",mobile:"hi",icon:"fa fa-reply",label:d("Reply to sender"),drawDisabled:!0,ref:"io.ox/mail/actions/reply",cssClasses:"io-ox-action-link mobile-toolbar-action"},"reply-all":{prio:"hi",mobile:"hi",icon:"fa fa-reply-all",label:d("Reply to all recipients"),drawDisabled:!0,ref:"io.ox/mail/actions/reply-all",cssClasses:"io-ox-action-link mobile-toolbar-action"},forward:{prio:"hi",mobile:"hi",icon:"fa fa-mail-forward",label:d("Forward"),drawDisabled:!0,ref:"io.ox/mail/actions/forward",cssClasses:"io-ox-action-link mobile-toolbar-action"},"delete":{prio:"hi",mobile:"hi",icon:"fa fa-trash-o",label:d("Delete"),drawDisabled:!0,ref:"io.ox/mail/actions/delete",cssClasses:"io-ox-action-link mobile-toolbar-action"},move:{prio:"hi",mobile:"hi",label:d("Move"),icon:"fa fa-sign-in",drawDisabled:!0,ref:"io.ox/mail/actions/move",section:"file-op",cssClasses:"io-ox-action-link mobile-toolbar-action"},markunread:{prio:"hi",mobile:"hi",drawDisabled:!0,label:d("Mark as unread"),ref:"io.ox/mail/actions/markunread",section:"flags"},markread:{prio:"hi",mobile:"hi",drawDisabled:!0,label:d("Mark as read"),ref:"io.ox/mail/actions/markread",section:"flags"},copy:{prio:"hi",mobile:"hi",label:d("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"}};e(j,["markread","markunread"]),e(f,["compose"]),e(h,["compose"]),e(i,["reply","reply-all","delete","forward"]),e(g,["delete","forward","move"]),i.extend(new b.Dropdown({id:"test",index:900,noCaret:!0,icon:"fa fa-bars",label:d("Actions"),ariaLabel:d("Actions"),ref:"io.ox/mail/links/inline",classes:"io-ox-action-link mobile-toolbar-action"})),g.extend(new b.Dropdown({index:50,label:$("<span>").text(d("Mark as")),noCaret:!0,ref:"io.ox/mail/mobile/toolbar/submenuActions"})),a.point("io.ox/mail/mobile/navbar/links").extend(new b.Link({prio:"hi",mobile:"hi",label:d("Edit draft"),ref:"io.ox/mail/actions/edit"})),a.point("io.ox/mail/mobile/navbar/links/action").extend(new b.ToolbarLinks({classes:"navbar-action right",index:100,id:"edit-draft-button",ref:"io.ox/mail/mobile/navbar/links"}));var l=_.debounce(function(b){if(b){var d=this.props.get("thread");b=c.resolve(b,d),0===b.length&&(d=!1),b=1===b.length?b[0]:b;var e=a.Baton({data:b,isThread:d,app:this}),f=this.pages.getCurrentPage();f.navbar.setBaton(e),f.toolbar&&f.toolbar.setBaton(e),f.secondaryToolbar&&f.secondaryToolbar.setBaton(e)}},10);g.extend({id:"update-button-states",index:1e4,draw:function(a){0===a.data.length?$(".mobile-toolbar-action",this).addClass("ui-disabled"):$(".mobile-toolbar-action",this).removeClass("ui-disabled")}}),a.point("io.ox/mail/mediator").extend({id:"toolbar-mobile",index:10100,setup:function(a){_.device("smartphone")&&(a.updateToolbar=l)}}),a.point("io.ox/mail/mediator").extend({id:"update-toolbar-mobile",index:10300,setup:function(b){_.device("smartphone")&&(b.updateToolbar(),b.listView.on("selection:change change",function(){"folderView"!==b.pages.getCurrentPage().name&&b.updateToolbar(b.listView.selection.get())}),b.threadView.$el.on("showmail",function(){var c=a.Baton({data:b.threadView.mail,isThread:!1,app:b});b.pages.getCurrentPage().toolbar.setBaton(c)}))}}),a.point("io.ox/mail/mediator").extend({id:"change-mode-toolbar-mobile",index:10400,setup:function(a){_.device("smartphone")&&a.props.on("change:checkboxes",function(b,c){var d=a.pages.getCurrentPage();a.pages.toggleSecondaryToolbar(d.name,c)})}})}),define("io.ox/core/util",["io.ox/core/extensions"],function(a){"use strict";var b=30,c=/(\S{30,})/g,d=/(\S{30})/g,e=/([^.,;:-=()]+[.,;:-=()])/;a.point("io.ox/core/person").extend({id:"default",index:100,draw:function(a){a.html!==!1?this.append(a.html):this.text(a.halo.name)}});var f=/((https?|ftps?)\:\/\/[^\s"]+)/gim,g={renderPersonalName:function(b,c){b=_.extend({$el:void 0,html:!1,tagName:"span"},b);var d={name:b.full_name||b.display_name||b.name,email:b.email,email1:b.email,user_id:b.user_id},e=new a.Baton({data:c||{},halo:d,html:b.html}),f=b.$el||(d.email||d.user_id?$('<a href="#" class="halo-link" tabindex="1">').attr("title",d.email).data(d):$("<"+b.tagName+">"));return a.point("io.ox/core/person").invoke("draw",f.empty(),e),f},unescapeDisplayName:function(a){for(a=$.trim(a||"");a.length>1&&/^["'\\\s]/.test(a[0])&&a[0]===a.substr(-1);)a=$.trim(a.substr(1,a.length-2));return a=a.replace(/\\"/g,'"')},urlify:function(a){return a.replace(f,function(a){var b="";return a=a.replace(/([.,;!?>]+)$/,function(a,c){return b=c,""}),'<a href="'+a+'" target="_blank">'+g.breakableHTML(a)+"</a>"+b})},breakableHTML:function(a){var f=String(a||"").replace(c,function(a){return _(a.split(e)).map(function(a){return 0===a.length?"":a.length<b?a+"​":a.replace(d,"$1​")}).join("")});return _(f.split("​")).map(_.escape).join("<wbr>")},breakableText:function(a){var b=String(a||"").replace(/(\S{20})/g,"$1​");return"​"===b[b.length-1]&&(b=b.slice(0,-1)),b},isValidMailAddress:function(){function a(a){if(""===a)return!0;var j=a.lastIndexOf("@");if(0>=j)return!1;var k=a.substr(0,j),l=a.substr(j+1);return k.length>64&&k.length>0?!1:l.length>255?!1:!b.test(k)&&(c.test(k)||e.test(k)||f.test(k)||d.test(k))?!1:g.test(l)||h.test(l)||i.test(l)?!0:!1}var b=/^"[^"]+"$/,c=/@/,d=/["\\,:; ]/,e=/^\./,f=/\.\./,g=/^\[(\d{1,3}\.){3}\d{1,3}\]$/,h=/^\[IPv6(:\w{0,4}){0,8}\]$/i,i=/[a-z0-9]$/i;return function(b){return a($.trim(b))}}(),isValidPhoneNumber:function(){function a(a){return""===a?!0:c.test(a)?!1:b.test(a)}var b=/^\+?[0-9 .,;\-\/\(\)\*\#]+$/,c=/^\+\d{0,2}$/;return function(b){return a($.trim(b))}}()};return g}),define("io.ox/core/api/factory",["io.ox/core/http","io.ox/core/cache","io.ox/core/event","io.ox/core/extensions"],function(a,b,c,d){"use strict";var e="//",f=function(a){var b=_.copy(a,!0);return b.folder=b.folder||b.folder_id,delete b.folder_id,b},g="id: folder_id:folder folder: recurrence_position:".split(" "),h=function(a){return _.isObject(a)?_(g).reduce(function(b,c){var d=c.split(":"),e=d[0],f=d[1]||d[0];return e in a&&(b[f]=a[e]),b},{}):a},i=function(d){d=$.extend(!0,{id:null,keyGenerator:null,module:"",mapping:{},requests:{all:{action:"all",timezone:"utc"},list:{action:"list",timezone:"utc"},get:{action:"get",timezone:"utc"},search:{action:"search",timezone:"utc"},remove:{action:"delete"}},cid:function(a){return a.folder+e+(a.sortKey||a.sort)+"."+a.order+"."+(a.max||a.limit||0)},done:{},fail:{},pipe:{},params:{},filter:null},d||{}),d.id=d.id||d.module,_.each(d.requests,function(a){a.extendColumns&&(a.columns=i.extendColumns(a.extendColumns,d.module,a.columns),delete a.extendColumns)});var g={all:new b.SimpleCache(d.id+"-all"),list:new b.ObjectCache(d.id+"-list",!1,d.keyGenerator),get:new b.ObjectCache(d.id+"-get",!1,d.keyGenerator)},j={},k={},l={DELIM:e,options:d,cid:d.cid,getAll:function(b,c,e,f){var h=$.extend({},d.requests.all,b||{}),i=d.cid(h);c=void 0===c?!0:!!c,e=e||g.all;var m=function(){var b=d.params.all?d.params.all(_.copy(h,!0)):h;return a.GET({module:d.module,params:b,processResponse:void 0===f?!0:f}).then(function(a){var c=$.when();return/(^5,|,5,|5$)/.test(b.columns)?$.when.apply($,_(a).map(function(a){var b=_.cid(a);return void 0===k[b]?(k[b]=a.last_modified,c):a.last_modified>k[b]?(k[b]=a.last_modified,$.when(l.caches.list.remove(b),l.caches.get.remove(b)).done(function(){l.trigger("update:"+_.ecid(a),a)})):void 0})).then(function(){return a}):a}).then(function(a){return(d.pipe.all||_.identity)(a,h)}).then(function(a){return $.when(e.add(i,a)).then(function(){return a})})},n=function(){ox.serverConfig.persistence!==!1&&(i in j||(j[i]=!0,setTimeout(function(){l.refresh()},5e3)))};return(c?e.get(i,m,n):m()).then(d.pipe.allPost).done(d.done.all||$.noop)},getList:function(b,c,e){b=b?[].concat(b):[],d.filter&&(b=_(b).filter(d.filter)),e=e||{},c=void 0===c?!0:!!c;var f=function(){var c=_.extend({},d.requests.list);return e.allColumns&&(c.columns=a.getAllColumns(d.module,!0)),e.unseen&&(c.unseen=!0),a.fixList(b,a.PUT({module:d.module,params:c,data:a.simplify(b)})).then(function(a){return(d.pipe.list||_.identity)(a)}).then(function(a){var b=e.allColumns?"add":"merge";return $.when(g.list.add(a),g.get[b](a)).then(function(){return a})})};return 0===b.length?$.Deferred().resolve([]).done(d.done.list||$.noop):(c?g.list.get(b,f):f()).then(d.pipe.listPost).done(d.done.list||$.noop)},get:function(b,c){var e=$.extend({},d.requests.get,b);c=void 0===c?!0:!!c;var h=function(){return a.GET({module:d.module,params:f(e)}).then(function(a){return(d.pipe.get||_.identity)(a,e)}).then(function(a){return c?$.when(g.get.add(a),g.list.merge(a).done(function(a){a&&l.trigger("refresh.list")})).then(function(){return a}):a}).fail(function(a){_.call(d.fail.get,a,e,d)})};return(c?g.get.get(e,h,d.pipe.getCache):h()).then(d.pipe.getPost).done(d.done.get||$.noop)},localRemove:function(a,b,c){return _(a).filter(function(a){return b[c(a)]!==!0})},updateCaches:function(a,c){a=a||[],a=_.isArray(a)?a:[a];var d,f={},g={},h=b.defaultKeyGenerator;return _(a).each(function(a){f[h(a)]=g[a.folder_id]=!0}),a.length<100?(d=_(g).map(function(a,b){var c=l.caches.all;return c.grepKeys(b+e).then(function(a){return $.when.apply($,_(a).map(function(a){return c.get(a).then(function(b){return b?("data"in b?b.data=l.localRemove(b.data,f,h):b=l.localRemove(b,f,h),c.add(a,b)):$.when()})}))})}),a.length&&(d.push(l.caches.list.remove(a)),d.push(l.caches.get.remove(a)))):(d=[l.caches.all.clear()],a.length&&(d.push(l.caches.list.clear()),d.push(l.caches.get.clear()))),l.resetTrashFolders&&d.push(l.resetTrashFolders()),$.when.apply($,d).done(function(){c||_(a).each(function(a){l.trigger("delete:"+_.ecid(a))}),f=g=d=a=null})},remove:function(b,c){b=b||[],b=_.isArray(b)?b:[b],c=_.extend({local:!1,force:!1},c||{});var f=$.extend({},d.requests.remove,{timestamp:_.then()}),g=a.simplify(b);c.force&&(f.harddelete=!0);var h=function(a){var c={};return _(b).each(function(a){c[a.folder_id]=a.folder_id}),$.when.apply($,_(c).map(function(a){return l.caches.all.grepRemove(a+e)})).then(function(){return $.Deferred()[a.error?"reject":"resolve"](a)})},i=function(){l.trigger("refresh.all"),l.trigger("delete",b)};return l.trigger("beforedelete",b),l.updateCaches(b).then(function(){return l.trigger("refresh:all:local"),c.local!==!0?a.PUT({module:d.module,params:f,data:g,appendColumns:!1}).then(h,h).always(i):i()})},needsRefresh:function(a,b,c){return g.all.keys(a+e+b+"."+c).then(function(a){return null!==a})},reduce:h,caches:g};return l.getMapping=function(b,c){c=c||"ids";var e,f=d.mapping[b]||[],g=[].concat(_.clone(f));return"names"===c&&(e=a.getColumnMapping(d.module),g=_.map(g,function(a){return e[a]})),g},d.requests.search&&(l.search=function(b,c){var e,f=$.extend({},d.requests.search,c||{}),g=f.getData;return c=c||{},d.requests.search.omitFolder&&c.omitFolder!==!1&&delete f.folder,delete f.omitFolder,delete f.getData,f.extra&&f.extra.length&&(e=[].concat(f.columns),_.each(f.extra,function(a){e=e.concat(l.getMapping(a))}),f.columns=_.uniq(e).join(",")),delete f.extra,a.PUT({module:d.module,params:f,data:g(b,c)}).then(function(a){return(d.pipe.search||_.identity)(a)})}),d.requests.advancedsearch&&(l.advancedsearch=function(b,c){var e=$.extend({},d.requests.advancedsearch,c||{}),f=e.getData;return c=c||{},d.requests.advancedsearch.omitFolder&&c.omitFolder!==!1&&delete e.folder,delete e.omitFolder,delete e.getData,a.PUT({module:d.module,params:e,data:f(b,c)}).then(function(a){return a})}),c.extend(l),l.refresh=function(){return ox.online?$.when(l.caches.all.clear(),l.caches.list.clear()).done(function(){l.trigger("refresh.all")}):$.when()},ox.on("refresh^",function(){l.refresh()}),l.Model=Backbone.Model.extend({constructor:function(){Backbone.Model.apply(this,arguments),this.cid=_.cid(this.attributes)}}),l.Collection=Backbone.Collection.extend({comparator:"index",model:l.Model}),l};return i.reduce=h,i.extendColumns=function(b,c,e){var f={},g={},h=a.getColumnMapping(c);return _.each(h,function(a,b){g[a]=b}),_.each(e.split(","),function(a){f[a]=1}),_.chain(d.point(b).invoke("columns")).flatten(!0).each(function(a){f[g[a]||a]=1}),_.keys(f).join()},i}),define("io.ox/core/api/collection-pool",["io.ox/core/api/backbone"],function(a){"use strict";function b(a,b){h||i||(_(g[a]).each(function(a){var c=a.collection.get(b.cid);c&&(h=!0,a.collection.remove(c))}),h=!1)}function c(a,b){h||(_(g[a]).each(function(a){var c,d=a.collection.get(b.cid);d&&(h=!0,c=b.toJSON(),delete c.index,d.set(c))}),h=!1)}function d(a){var b={};_(a).each(function(c,d){"detail"!==d&&(c.collection.expired?(c.collection.reset(),delete a[d]):c.collection.each(function(a){b[a.cid]=!0,_(this.getDependentModels(a.cid)).each(function(a){b[a.cid]=!0})},this))},this);var c=this.get("detail").filter(function(a){return!b[a.cid]});this.get("detail").remove(c,{silent:!0}),c=b=null,_(a).each(function(a,b){"detail"!==b&&(a.collection.expired=!0)})}function e(e){var f=g[e]||(g[e]={});this.getCollections=function(){return f},this.get=function(d){var g=f[d];return g?(g.access=_.now(),g.collection):(f[d]={access:_.now(),collection:new a.Collection},f[d].collection.expired=!1,f[d].collection.cid=d,f[d].collection.on({remove:b.bind(this,e),change:c.bind(this,e)}))},this.getModule=function(){return e},ox.on("refresh^",_.throttle(d.bind(this,f),5e3))}var f={},g={},h=!1,i=!1;return e.create=function(a){return f[a]||(f[a]=new e(a))},e.inspect=function(){_(f).each(function(a,b){var c=0,d=a.getCollections();_(d).each(function(a){c+=_(a.collection).size()}),console.debug("Pool:",b,"Model count:",c,"Collections:",d)})},e.preserve=function(a){i=!0,a&&a(),i=!1},_.extend(e.prototype,{getDefault:function(){return new a.Collection},propagate:function(b,d){"change"===b&&c.call(this,this.getModule(),new a.Model(d))},add:function(a,b){var c=this.get(a);c.add(b,{merge:!0})},resolve:function(a){var b=this.get("detail");return _([].concat(a)).map(function(a){var c=_.cid(a);return b.get(c)||{}})},getDetailModel:function(b){var c,d=_.cid(b),e=this.get("detail");return(c=e.get(d))?c:(c=new a.Model(b),void 0!==b.folder_id&&void 0===b.parent&&e.add(c),c)},grep:function(a){return _(this.getCollections()).chain().filter(function(b,c){return c.indexOf(a)>-1
}).pluck("collection").value()},getByFolder:function(a){return this.grep("folder="+a)},getDependentModels:function(){return[]}}),e}),define("io.ox/core/api/collection-loader",["io.ox/core/api/collection-pool","io.ox/core/http"],function(a,b){"use strict";function c(a){var b={};return _(a).each(function(a){b[a]=!0}),b}function d(b){function d(b,c,d,e){a.preserve(function(){var a=g[c];b[a](e)});var f="load"===c&&e.length<d||"paginate"===c&&e.length<=1;f&&b.trigger("complete"),b.trigger(c)}function e(a,b,c){a.trigger(b+":fail",c)}function f(a,b){var c="paginate"===b?this.collection.length-1:0;this.collection.trigger("before:"+b);var f=_.lfo(d,this.collection,b,this.LIMIT),g=_.lfo(e,this.collection,b),h=this;return this.fetch(a).done(function(d){if("paginate"===b&&h.collection.length>0){var e=_(d).first(),g=h.collection.last().toJSON();if(g.head&&(g=g.head),_.cid(e)!==_.cid(g))return h.done(),a.thread="threadedAll"===a.action,void h.reload(a,h.LIMIT)}h.addIndex(c,a,d),h.done(),f(d)}).fail(function(a){h.done(),g(a)})}_.extend(this,{columns:"1,20",module:"mail",ignore:"limit max"},b),this.pool=a.create(this.module),this.ignore=c(String(this.ignore).split(" ")),this.collection=null,this.loading=!1,this.load=function(a){var b,c=this.LIMIT;return a=this.getQueryParams(a||{}),a.limit="0,"+c,b=this.collection=this.getCollection(a),this.loading=!1,b.length>0&&!b.expired?(_.defer(function(){b.trigger(b.length<c?"reset load complete":"reset load")}),b):(this.loading=!0,b.expired=!1,_.defer(f.bind(this),a,"load"),b)},this.paginate=function(a){var b=this.collection;if(this.loading)return b;var c=Math.max(0,b.length-1);return a=this.getQueryParams(_.extend({offset:c},a)),a.limit=c+","+(c+this.LIMIT+1),this.loading=!0,b.expired=!1,_.defer(f.bind(this),a,"paginate"),b},this.reload=function(a,b){var c=this.collection;return this.loading?c:(a=this.getQueryParams(_.extend({offset:0},a)),a.limit="0,"+Math.max(c.length+(b||0),this.LIMIT),this.loading=!0,c.expired=!1,_.defer(f.bind(this),a,"reload"),c)}}function e(a){return!this.ignore[a]}function f(a){return a+"="+this[a]}var g={load:"reset",paginate:"add",reload:"set"};return _.extend(d.prototype,{LIMIT:30,cid:function(a){return _(a||{}).chain().keys().filter(e,this).map(f,a).value().sort().join("&")||"default"},getDefaultCollection:function(){return this.pool.getDefault()},getCollection:function(a){var b=this.cid(a);return this.pool.get(b)},before:function(){},each:function(){},after:function(){},addIndex:function(a,b,c){this.before(a,b,c),_(c).each(function(c,d){c.index=a+d,this.each(c,d,a,b)},this),this.after(a,b,c)},virtual:function(){return!1},fetch:function(a){var c=this.module,d=c+"/"+_.param(_.extend({session:ox.session},a)),e=ox.rampup[d],f=this.virtual(a);return e?(delete ox.rampup[d],$.when(e)):f?$.when(f):b.wait().then(function(){return b.GET({module:c,params:a})})},getQueryParams:function(){return{}},done:function(){this.loading=!1}}),d}),define("io.ox/mail/common-extensions",["io.ox/core/extensions","io.ox/core/extPatterns/links","io.ox/core/extPatterns/actions","io.ox/core/emoji/util","io.ox/mail/util","io.ox/mail/api","io.ox/core/api/account","io.ox/core/date","io.ox/core/strings","io.ox/core/folder/title","io.ox/core/notifications","io.ox/contacts/api","io.ox/core/api/collection-pool","io.ox/core/tk/flag-picker","io.ox/core/capabilities","settings!io.ox/mail","gettext!io.ox/mail"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"use strict";var r={a11yLabel:function(a){var b=a.data,c=f.threads.size(b),d=1>=c?"":", "+q.format("Thread contains %1$d messages",q.noI18n(c)),g=b.from||[["",""]],h=_.escape($.trim(b.subject)),i=e.isUnseen(b)?q("Unread")+", ":"",j=i+e.getDisplayName(g[0])+", "+h+", "+e.getTime(b.received_date)+d+(b.attachment?", "+q("has attachments"):"");this.attr({"aria-hidden":!0}).parent().attr({"aria-label":_.escape(j)})},picture:function(a){var b=a.data,c=b.from,d=_.device("retina")?80:40;this.append(l.pictureHalo($('<div class="contact-picture" aria-hidden="true">'),{email:b.picture||c&&c[0]&&c[0][1],width:d,height:d,scaleType:"cover"}))},date:function(a,b){var c,d=a.data,f=d.received_date;_.isNumber(f)&&(c=new h.Local(f),this.append($('<time class="date">').attr("datetime",c.format("yyyy-MM-dd hh:mm")).text(_.noI18n(e.getDateTime(f,b)))))},smartdate:function(a){r.date.call(this,a,{fulldate:!1,smart:!0})},fulldate:function(a){r.date.call(this,a,{fulldate:!0,smart:!1})},from:function(a){var b=a.data,c=!b.threadSize||1===b.threadSize,d=c&&g.is("sent|drafts",b.folder_id)?"to":"from";this.append($('<div class="from">').append(e.getFrom(b,d)))},size:function(a){var b=a.data;_.isNumber(b.size)&&this.append($('<span class="size">').text(i.fileSize(b.size,1)))},unreadClass:function(a){var b=e.isUnseen(a.data);this.closest(".list-item").toggleClass("unread",b)},deleted:function(a){this.parent().toggleClass("deleted",e.isDeleted(a.data))},flag:function(a){var b=a.data.color_label;0>=b||this.append($('<i class="flag flag_'+b+' fa fa-bookmark" aria-hidden="true">'))},threadSize:function(a){if(a.options.threaded===!0||a.app&&a.app.props.get("thread")!==!1){var b=f.threads.size(a.data);1>=b||this.append($('<div class="thread-size" aria-hidden="true">').append($('<span class="number drag-count">').text(_.noI18n(b))))}},paperClip:function(a){a.data.attachment&&this.append($('<i class="fa fa-paperclip has-attachments" aria-hidden="true">'))},priority:function(a){var b=a.data;this.append($('<span class="priority" aria-hidden="true">').append(e.getPriority(b)))},unread:function(a){var b=e.isUnseen(a.data);b&&this.append('<i class="icon-unread fa fa-envelope" aria-hidden="true">')},answered:function(a){var b=a.data,c=_.cid(b),d=f.threads.get(c),g=e.isAnswered(d,b);g&&this.append('<i class="icon-answered fa fa-reply" aria-hidden="true">')},forwarded:function(a){var b=a.data,c=_.cid(b),d=f.threads.get(c),g=e.isForwarded(d,b);g&&this.append('<i class="icon-forwarded fa fa-mail-forward" aria-hidden="true">')},subject:function(a){var b,c=a.data,f=1===a.data.threadSize,g=e.getSubject(c,f);this.append($('<div class="subject">').append($('<span class="flags">'),b=$('<span class="drag-title">').text(g))),d.processEmoji(_.escape(g),function(a){b.html(a)})},title:function(a){var b=e.getSubject(a.data);this.closest(".list-item").attr("title",b)},account:function(a){g.isUnifiedFolder(a.data.folder_id)&&this.append($('<span class="account-name">').text(a.data.account_name||""))},recipients:function(){var a=function(a){a.preventDefault(),$(this).find(".show-all-recipients").remove(),$(this).children().show()};return function(b){var c=b.data,d=c.cc&&c.cc.length>0,f=c.to&&c.to.length>0,g=c.bcc&&c.bcc.length>0,h=f||d||g,i=$('<div class="recipients">');if(!h)return void this.append(i.append($.txt(_.noI18n(" "))));f&&i.append($('<span class="io-ox-label">').append($.txt(q("To")),$.txt(_.noI18n("  "))),e.serializeList(c,"to"),$.txt(_.noI18n("   "))),d&&i.append($('<span class="io-ox-label">').append($.txt(q.pgettext("CC","Copy")),_.noI18n("  ")),e.serializeList(c,"cc"),$.txt(_.noI18n("   "))),g&&i.append($('<span class="io-ox-label">').append($.txt(q("Bcc")),_.noI18n("  ")),e.serializeList(c,"bcc"),$.txt(_.noI18n("   "))),this.append(i);var j=i.find(".person-link");j.length>3&&(i.children().slice(4).hide(),i.append($('<a href="#" class="show-all-recipients">').text(q("and %1$d others",j.length-2))),i.on("click",a))}}(),attachmentList:function(){function d(c,d){var e=new b.InlineLinks({dropdown:!1,ref:"io.ox/mail/attachment/links"});return e.draw.call(c,a.Baton({data:d}))}var e,g=function(){var c,d,e=this.$(".file"),g=this.model.toJSON();new b.Dropdown({label:this.model.getShortTitle(),noCaret:!0,ref:"io.ox/mail/attachment/links"}).draw.call(e,a.Baton({context:this.model.collection.toJSON(),data:g,$el:e})),e.on("show.bs.dropdown",function(a){var b,c,d=$(a.relatedTarget),e=d.offset(),f=d.siblings(".dropdown-menu");b=e.top+d.height(),f.css({top:e.top+d.height(),bottom:"auto",left:e.left}),b+f.height()>$(window).height()&&f.css({top:"auto",bottom:"20px"}),c=$('<div class="dropdown-overlay">').append(f),_.device("touch")&&c.on("click",{link:d},function(a){a.data.link.dropdown("toggle")}),d.data("overlay",c),$("body").append(c)}),e.on("hide.bs.dropdown",function(a){var b=$(a.relatedTarget),c=b.data("overlay");b.parent().append(c.children()),c.remove()}),c=f.getUrl(g,"download"),d=(this.model.get("content_type")||"unknown").split(/;/)[0],this.$el.attr({title:this.model.getTitle(),draggable:!0,"data-downloadurl":d+":"+this.model.getTitle().replace(/:/g,"")+":"+ox.abs+c}).on("dragstart",function(a){$(this).css({display:"inline-block"}),a.originalEvent.dataTransfer.setData("DownloadURL",this.dataset.downloadurl)})};return function(b){if(0===b.attachments.length)return $.when();var f=this,h=$.Deferred();return require(["io.ox/core/attachments/view"],function(i){_.once(function(){e=i.View.extend({renderContent:g})})();var j=b.attachments.map(function(a){return a.group="mail",a}),k=new i.Collection(j),l=new i.List({AttachmentView:e,collection:k,el:f,preview:b.preview});f.append(l.render().$el),l.renderInlineLinks=function(){var a=this.getValidModels(),b=this.$header.find(".links").empty();a.length>=1&&d(b,_(a).invoke("toJSON"))},l.listenTo(l.collection,"add remove reset",l.renderInlineLinks),l.renderInlineLinks(),l.$el.on("click","li.item",function(b){var d,e,f,g=$(b.currentTarget);g.attr("data-original")&&(d=g.attr("data-id"),e=k.get(d).toJSON(),f=a.Baton({startItem:e,data:j}),c.invoke("io.ox/mail/actions/slideshow-attachment",null,f))}),h.resolve(l)},h.reject),h}}(),flagPicker:function(a){n.draw(this,a)},unreadToggle:function(){function a(a){a.preventDefault();var b=a.data.view,c=b.model.toJSON(),d=a.data.node;e.isUnseen(c)?(f.markRead(c),d.attr("aria-label",q("This E-mail is read, press to mark it as unread."))):(f.markUnread(c),d.attr("aria-label",q("This E-mail is unread, press to mark it as read.")))}return function(b){if(!e.isEmbedded(b.data)){var c=q(e.isUnseen(b.data)?"This E-mail is unread, press to mark it as read.":"This E-mail is read, press to mark it as unread."),d=$('<a href="#" role="button" class="unread-toggle" tabindex="1" aria-label="'+c+'"><i class="fa" aria-hidden="true"/></a>');this.append(d.on("click",{view:b.view,node:d},a))}}}(),externalImages:function(){function a(a){a.preventDefault();var b=a.data.view;b.trigger("load"),b.$el.find(".external-images").remove(),f.getUnmodified(_.cid(b.model.cid)).done(function(a){b.trigger("load:done"),b.model.set(a)})}function b(a){return 1!==a.get("modified")||e.isEmbedded(a.toJSON())?void this.find(".external-images").remove():void this.append($('<div class="notification-item external-images">').append($('<button type="button" class="btn btn-primary btn-sm" tabindex="1">').text(q("Show images")),$('<div class="comment">').text(q("External images have been blocked to protect you against potential spam!"))))}return function(c){b.call(this,c.model),this.on("click",".external-images",{view:c.view},a),c.view.listenTo(c.model,"change:modified",b.bind(this))}}(),phishing:function(){function a(a){this.find(".phishing").length||_(a.get("headers")).find(function(a,c){return b.contains(c)?(this.append($('<div class="alert alert-error phishing">').text(q("Warning: This message might be a phishing or scam mail"))),!0):void 0},this)}var b=_(p.get("phishing/headers",["phishing-test"]));return function(b){a.call(this,b.model),b.view.listenTo(b.model,"change:headers",a.bind(this))}}(),dispositionNotification:function(){function a(a){a.preventDefault();var b=a.data.view,c=_.cid(b.model.cid);b.model.set("disp_notification_to",""),d[b.model.cid]=!0,f.ack({folder:c.folder_id,id:c.id}).done(function(){k.yell("success",q("A read receipt has been sent"))})}function b(a){a.preventDefault();var b=a.data.view;d[b.model.cid]=!0}function c(a){this.find(".disposition-notification").remove(),d[a.cid]||a.get("disp_notification_to")&&p.get("sendDispositionNotification",!1)&&(g.is("drafts",a.get("folder_id"))||this.append($('<div class="alert alert-info disposition-notification">').append($('<button type="button" class="close" data-dismiss="alert">&times;</button>'),$('<button type="button" class="btn btn-primary btn-sm" tabindex="1">').text(q("Send a read receipt")),$('<div class="comment">').text(q("The sender wants to get notified when you have read this email")))))}var d={};return function(d){c.call(this,d.model),this.on("click",".disposition-notification .btn",{view:d.view},a),this.on("click",".disposition-notification .close",{view:d.view},b),d.view.listenTo(d.model,"change:disp_notification_to",c.bind(this))}}(),subscriptionNotification:function(){function a(a){if(a.has("headers")&&a.get("headers")["X-OX-PubURL"]){var b=this;require(["io.ox/core/pubsub/notifications/subscription"],function(c){c.call(b,a)})}}return function(b){a.call(this,b.model),b.view.listenToOnce(b.model,"change:headers",a.bind(this))}}()};return r}),define("io.ox/core/tk/list",["io.ox/core/tk/list-selection","io.ox/core/tk/list-dnd","io.ox/core/extensions"],function(a,b,c){"use strict";function d(){return $.when()}var e={13:"enter",27:"escape",32:"space",37:"cursor:left",38:"cursor:up",39:"cursor:right",40:"cursor:down"},f=Backbone.View.extend({tagName:"ul",className:"list-view scrollpane f6-target",scaffold:$('<li class="list-item selectable" tabindex="-1" role="option" aria-selected="false"><div class="list-item-checkmark"><i class="fa fa-checkmark" aria-hidden="true"/></div><div class="list-item-content"></div></li>'),busyIndicator:$('<li class="busy-indicator"><i class="fa fa-chevron-down"/></li>'),events:{"focus .list-item":"onItemFocus","blur .list-item":"onItemBlur",click:"onKeepFocus","keydown .list-item":"onItemKeydown",scroll:"onScroll"},onItemFocus:function(){this.$el.removeAttr("tabindex"),this.$el.addClass("has-focus")},onItemBlur:function(){this.$el.attr("tabindex",1),this.$el.removeClass("has-focus")},onKeepFocus:function(a){a.target===this.el&&a.pageX&&this.getItems().filter(".selected").focus()},onItemKeydown:function(a){e[a.which]&&this.trigger(e[a.which],a)},onScroll:_.debounce(function(){if(this.options.pagination&&!this.isBusy&&!this.complete){var a=this.$el.height(),b=this.$el.scrollTop(),c=this.$el.prop("scrollHeight"),d=c-(b+a);d>a||(this.addBusyIndicator(),d>1||this.processPaginate())}},50),onComplete:function(){this.toggleComplete(!0)},processPaginate:function(){!this.options.pagination||this.isBusy||this.complete||this.paginate()},getCID:function(a){return a.cid},onModelChange:function(){this.load()},empty:function(){this.idle(),this.toggleComplete(!1),this.$el.empty(),this.selection.reset(),this.$el.scrollTop(0)},onReset:function(){this.empty(),this.$el.append(this.collection.map(this.renderListItem,this)),this.trigger("reset",this.collection,this.firstReset),this.firstReset&&(this.trigger("first-reset",this.collection),this.firstReset=!1)},onAdd:function(a){this.idle();var b=a.has("index")?a.get("index"):this.collection.indexOf(a),c=this.getItems(),d=this.renderListItem(a);b<c.length?(c.eq(b).before(d),d[0].offsetTop<=this.el.scrollTop&&(this.el.scrollTop+=d.outerHeight(!0))):this.$el.append(d),this.selection.add(this.getCID(a),d),this.trigger("add",a,b)},onRemove:function(a){var b=this.getItems(),c=this.getCID(a),d=b.filter('[data-cid="'+$.escape(c)+'"]'),e=d.hasClass("selected");if(0!==d.length){if(e&&this.options.preserve)return void d.addClass("preserved");d[0].offsetTop<this.el.scrollTop&&(this.el.scrollTop-=d.outerHeight(!0)),this.selection.remove(c,d),d.remove(),e&&this.selection.triggerChange(),b.length>1&&this.$el.trigger("scroll"),this.trigger("remove",a)}},onSort:function(){function a(a){return a&&parseInt(a.getAttribute("data-index"),10)}return function(){var b,c,d,e,f,g,h,i,j={};for(b=this.getItems().toArray(),c=_(b).sortBy(a),d=0,e=0,f=c.length;f>d;d++)if(g=c[d],h=b[e],j[d]=!0,g===h){do i=a(b[++e]);while(j[i])}else h&&this.el.insertBefore(g,h)}}(),onChange:function(a){var b=this.$el.find('li[data-cid="'+$.escape(this.getCID(a))+'"]'),d=this.getBaton(a),e=a.changed.index;void 0!==e&&b.attr("data-index",e),c.point(this.ref+"/item").invoke("draw",b.children().eq(1).empty(),d),this.trigger("change",a)},initialize:function(c){this.options=_.extend({pagination:!0,draggable:!1,preserve:!1},c),this.ref=this.ref||c.ref,this.app=c.app,this.selection=new a(this),this.model=new Backbone.Model,this.isBusy=!1,this.complete=!1,this.firstReset=!0,this.options.draggable&&b.enable({draggable:!0,container:this.$el,selection:this.selection}),this.model.on("change",_.debounce(this.onModelChange,10),this),_.bindAll(this,"busy","idle"),_.device("!smartphone")&&this.$el.addClass("visible-selection")},forwardCollectionEvents:function(a){var b=_(arguments).toArray().slice(1);b.unshift("collection:"+a),this.trigger.apply(this,b)},setCollection:function(a){return this.stopListening(this.collection),this.collection=a,this.toggleComplete(!1),this.listenTo(a,{all:this.forwardCollectionEvents,add:this.onAdd,change:this.onChange,remove:this.onRemove,reset:this.onReset,sort:this.onSort,"before:load":this.busy,load:this.idle,"load:fail":this.idle,"before:paginate":this.busy,paginate:this.idle,"paginate:fail":this.idle,complete:this.onComplete,reload:this.idle}),this.selection.reset(),this.trigger("collection:set"),this},toggleComplete:function(a){this.options.pagination||(a=!0),this.$el.toggleClass("complete",a),this.complete=!!a},toggleCheckboxes:function(a){this.$el.toggleClass("hide-checkboxes",void 0===a?void 0:!a)},getItems:function(){return this.$el.find(".list-item")},connect:function(a){this.stopListening(this.collection),this.collection=a.getDefaultCollection(),this.loader=a,this.load=function(){this.empty(),a.load(this.model.toJSON()),this.setCollection(a.collection)},this.paginate=function(){a.paginate(this.model.toJSON())},this.reload=function(){a.reload(this.model.toJSON())}},load:d,paginate:d,reload:d,render:function(){return this.$el.attr({"aria-multiselectable":!0,"data-ref":this.ref,role:"listbox",tabindex:1}),_.device("phantomjs")&&this.$el.addClass("no-transition"),this},redraw:function(){var a=c.point(this.ref+"/item"),b=this.collection;this.getItems().each(function(c,d){if(!(c>=b.length)){var e=b.at(c),f=this.getBaton(e);a.invoke("draw",$(d).children().eq(1).empty(),f)}}.bind(this))},renderListItem:function(a){var b=this.scaffold.clone(),d=this.getBaton(a);return b.attr({"data-cid":this.getCID(a),"data-index":a.get("index")}),c.point(this.ref+"/item").invoke("draw",b.children().eq(1),d),b},map:_.identity,getBaton:function(a){var b=this.map(a);return c.Baton({data:b,model:a,app:this.app,options:this.options})},getBusyIndicator:function(){return this.$el.find(".busy-indicator")},addBusyIndicator:function(){var a=this.getBusyIndicator();return a.length?a:this.busyIndicator.clone().appendTo(this.$el)},removeBusyIndicator:function(){this.getBusyIndicator().remove()},busy:function(){return this.isBusy?void 0:(this.addBusyIndicator().addClass("io-ox-busy").find("i").remove(),this.isBusy=!0,this)},idle:function(){return this.isBusy?(this.removeBusyIndicator(),this.isBusy=!1,this):void 0},getPosition:function(){return this.selection.getPosition()},hasNext:function(){if(!this.collection)return!1;var a=this.getPosition()+1;return a<this.collection.length||!this.complete},next:function(){this.hasNext()?this.selection.next():this.processPaginate()},hasPrevious:function(){if(!this.collection)return!1;var a=this.getPosition()-1;return a>=0},previous:function(){this.hasPrevious()?this.selection.previous():this.$el.scrollTop(0)},focus:function(){var a=this.getItems().filter(".selected").focus();0===a.length&&this.$el.focus()}});return f}),define("io.ox/mail/view-options",["io.ox/core/extensions","io.ox/backbone/mini-views/dropdown","io.ox/core/api/account","gettext!io.ox/mail"],function(a,b,c,d){"use strict";function e(a,b){a.attr("class",b?"fa fa-check-square-o":"fa fa-square-o").parent().attr("aria-checked",b)}function f(a){if("click"===a.type||32===a.keyCode){a.preventDefault();var b=$(this).find("i"),c=a.data.baton.app.listView.selection;b.hasClass("fa-check-square-o")?c.selectNone():c.selectAll()}}function g(a){a.preventDefault(),a.data.app.folderView.toggle(a.data.state)}function h(a){a.getWindow().nodes.main.find(".list-view-control").removeClass("toolbar-bottom-visible")}function i(a){a.getWindow().nodes.main.find(".list-view-control").addClass("toolbar-bottom-visible")}a.point("io.ox/mail/view-options").extend({id:"sort",index:100,draw:function(a){this.data("view").option("sort",610,d("Date")).option("sort","from-to",d(c.is("sent|drafts",a.app.folder.get())?"To":"From")).option("sort",651,d("Unread")).option("sort",608,d("Size")).option("sort",607,d("Subject")).option("sort",102,d("Color"))}}),a.point("io.ox/mail/view-options").extend({id:"order",index:200,draw:function(){this.data("view").divider().option("order","asc",d("Ascending")).option("order","desc",d("Descending"))}}),a.point("io.ox/mail/view-options").extend({id:"thread",index:300,draw:function(a){a.app.settings.get("threadSupport",!0)!==!1&&this.data("view").divider().option("thread",!0,d("Conversations"))}}),a.point("io.ox/mail/list-view/toolbar/top").extend({id:"dropdown",index:1e3,draw:function(c){var e=new b({label:d.pgettext("dropdown","Sort by"),model:c.app.props});a.point("io.ox/mail/view-options").invoke("draw",e.$el,c),this.append(e.render().$el.addClass("grid-options toolbar-item pull-right").on("dblclick",function(a){a.stopPropagation()}))}}),a.point("io.ox/mail/list-view/toolbar/top").extend({id:"select-all",index:100,draw:function(a){this.append($('<a href="#" class="toolbar-item select-all" role ="checkbox" aria-checked="false" tabindex="1">').append($('<i class="fa fa-square-o" aria-hidden="true">'),$.txt(d("Select all"))).on("click",{baton:a},f).on("dblclick",function(a){a.stopPropagation()}).on("keydown",{baton:a},f));var b=this.find(".select-all > i");a.view.listView.on({"selection:all":function(){e(b,!0)},"selection:subset":function(){e(b,!1)}})}}),a.point("io.ox/mail/list-view/toolbar/bottom").extend({id:"toggle-folderview",index:100,draw:function(a){this.append($('<a href="#" class="toolbar-item" tabindex="1">').attr("title",d("Open folder view")).append($('<i class="fa fa-angle-double-right">')).on("click",{app:a.app,state:!0},g));var b=a.app.getWindow().nodes.sidepanel;b.addClass("bottom-toolbar"),b.append($('<div class="generic-toolbar bottom visual-focus">').append($('<a href="#" class="toolbar-item" role="button" tabindex="1">').append($('<i class="fa fa-angle-double-left" aria-hidden="true">'),$('<span class="sr-only">').text(d("Close folder view"))).on("click",{app:a.app,state:!1},g))),a.app.on({"folderview:open":h.bind(null,a.app),"folderview:close":i.bind(null,a.app)}),a.app.folderViewIsVisible()&&_.defer(h,a.app)}})}),define("io.ox/core/api/backbone",[],function(){"use strict";var a=Backbone.Model.extend({idAttribute:"cid",constructor:function(){Backbone.Model.apply(this,arguments),this.cid=_.cid(this.attributes)},toString:function(){return"Model("+this.cid+")"}}),b=Backbone.Collection.extend({comparator:"index",model:a});return{Model:a,Collection:b}}),define("io.ox/mail/detail/view",["io.ox/backbone/disposable","io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/api/collection-pool","io.ox/mail/detail/content","io.ox/core/extPatterns/links","io.ox/core/emoji/util","gettext!io.ox/mail","less!io.ox/mail/style","io.ox/mail/actions"],function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=0;c.point("io.ox/mail/detail").extend({id:"unread-class",index:k+=100,draw:b.unreadClass}),c.point("io.ox/mail/detail").extend({id:"subject",index:k+=100,draw:function(a){var b=e.getSubject(a.data),c=$('<h1 class="subject">').text(b);i.processEmoji(_.escape(b),function(a){c.html(a)}),this.append(c)}}),c.point("io.ox/mail/detail").extend({id:"header",index:k+=100,draw:function(a){var b=$('<header class="detail-view-header" role="heading">');c.point("io.ox/mail/detail/header").invoke("draw",b,a),this.append(b)}});var l=0;c.point("io.ox/mail/detail/header").extend({id:"picture",index:l+=100,draw:b.picture}),c.point("io.ox/mail/detail/header").extend({id:"drag-support",index:l+=100,draw:function(a){this.attr({"data-drag-data":_.cid(a.data),"data-drag-message":e.getSubject(a.data)})}}),c.point("io.ox/mail/detail/header").extend({id:"unread-toggle",index:l+=100,draw:b.unreadToggle});var m=_.device("smartphone")?"io.ox/mail/detail":"io.ox/mail/detail/header";c.point(m).extend(new h.Dropdown({id:"actions",index:_.device("smartphone")?50:l+=100,classes:_.device("smartphone")?"":"actions pull-right",label:j("Actions"),ariaLabel:j("Actions"),icon:_.device("smartphone")?void 0:"fa fa-bars",noCaret:!0,ref:"io.ox/mail/links/inline"})),c.point("io.ox/mail/detail/header").extend({id:"date",index:l+=100,draw:b.fulldate}),c.point("io.ox/mail/detail/header").extend({id:"from",index:l+=100,draw:function(a){this.append($('<div class="from">').append(e.serializeList(a.data,"from")))}}),c.point("io.ox/mail/detail/header").extend({id:"flag-picker",index:l+=100,draw:b.flagPicker}),c.point("io.ox/mail/detail/header").extend({id:"priority",index:l+=100,draw:b.priority}),c.point("io.ox/mail/detail/header").extend({id:"paper-clip",index:l+=100,draw:b.paperClip}),c.point("io.ox/mail/detail/header").extend({id:"recipients",index:l+=100,draw:b.recipients}),c.point("io.ox/mail/detail").extend({id:"notifications",index:k+=100,draw:function(a){var b=$('<section class="notifications">');c.point("io.ox/mail/detail/notifications").invoke("draw",b,a),this.append(b)}});var n=0;c.point("io.ox/mail/detail/notifications").extend({id:"phishing",index:n+=100,draw:b.phishing}),c.point("io.ox/mail/detail/notifications").extend({id:"disposition-notification",index:n+=100,draw:b.dispositionNotification}),c.point("io.ox/mail/detail/notifications").extend({id:"external-images",index:n+=100,draw:b.externalImages}),c.point("io.ox/mail/detail/notifications").extend({index:n+=100,id:"subscribe",draw:b.subscriptionNotification}),c.point("io.ox/mail/detail").extend({id:"body",index:k+=100,draw:function(){var a;this.append($('<section class="attachments">'),a=$('<section class="body user-select-text">')),a.on("dispose",function(){var a=$(this).find(".content");a[0]&&a[0].children.length>0&&(a[0].innerHTML="")})}}),c.point("io.ox/mail/detail/attachments").extend({id:"attachment-list",index:100,draw:b.attachmentList}),c.point("io.ox/mail/detail/body").extend({id:"content",index:1e3,draw:function(a){var b=g.get(a.data),c=b.content;b.isLarge||b.processedEmoji||"text/html"!==b.type||i.processEmoji(c.innerHTML,function(b,d){a.processedEmoji=!d.loaded,a.processedEmoji||(c.innerHTML=b)}),this.idle().append(c)}}),c.point("io.ox/mail/detail/body").extend({id:"max-size",after:"content",draw:function(a){var b=_(a.data.attachments).some(function(a){return a.truncated});if(b){var c="api/mail?"+$.param({action:"get",view:"document",folder:a.data.folder_id,id:a.data.id,session:ox.session});this.append($('<div class="max-size-warning">').append($.txt(j("This message has been truncated due to size limitations.")),$.txt(" "),$('<a role="button" target="_blank">').attr("href",c).text("Show entire message")))}}});var o=f.create("mail"),p=a.extend({className:"list-item mail-item mail-detail f6-target",events:{keydown:"onToggle","click .detail-view-header":"onToggle"},onChangeFlags:function(){this.$el.toggleClass("unread",e.isUnseen(this.model.get("flags")))},onChangeAttachments:function(){var a=this.model.toJSON(),b=c.Baton({data:a,attachments:e.getAttachments(a)}),d=this.$el.find("section.attachments").empty();c.point("io.ox/mail/detail/attachments").invoke("draw",d,b),ox.trigger("mail:detail:attachments:render",this)},onChangeContent:function(){var a=this.model.toJSON(),b=c.Baton({data:a,attachments:e.getAttachments(a)}),d=this.$el.find("section.body").empty();c.point("io.ox/mail/detail/body").invoke("draw",d,b),ox.trigger("mail:detail:body:render",this)},onToggle:function(a){if(!("keydown"===a.type&&13!==a.which||$(a.target).closest("a").length||$(a.target).hasClass("dropdown-menu")||0===this.$el.siblings().length)){this.$el.find(".collapsed-blockquote").hide(),this.$el.find(".blockquote-toggle").show();var b=$(a.currentTarget).closest("li").data("cid");this.toggle(b)}},onUnseen:function(){var a=this.model.toJSON();e.isToplevel(a)&&d.markRead(a)},onLoad:function(a){if(null!==this.model){var b=this.model.get("unseen")||e.isUnseen(this.model.get("flags"));this.$el.find("section.body").removeClass("loading"),this.trigger("load:done"),this.onChangeAttachments(),this.onChangeContent(),a&&this.model.set(a),b?this.onUnseen():d.trigger("update:set-seen",[{id:this.model.get("id"),folder_id:this.model.get("folder_id")}])}},onLoadFail:function(){this.trigger("load:done"),this.$el&&this.$el.attr("data-loaded",!1).removeClass("expanded")},toggle:function(a){var b=this.$el;return void 0===a?(b.toggleClass("expanded"),b.attr("aria-expanded",!b.attr("aria-expanded"))):(b.toggleClass("expanded",a),b.attr("aria-expanded",a)),this.$el.trigger("toggle"),"false"===b.attr("data-loaded")&&b.hasClass("expanded")&&(b.attr("data-loaded",!0),b.find("section.body").addClass("loading"),this.trigger("load"),this.loaded?this.onLoad():d.get(_.cid(this.model.cid)).then(this.onLoad.bind(this),this.onLoadFail.bind(this))),this},expand:function(){return this.toggle(!0)},initialize:function(a){this.options=a||{},this.model=o.getDetailModel(a.data),this.loaded=a.loaded||!1,this.listenTo(this.model,"change:flags",this.onChangeFlags),this.listenTo(this.model,"change:attachments",this.onChangeContent),this.on({load:function(){this.$el.find("section.body").empty().busy()},"load:done":function(){this.$el.find("section.body").idle()}})},redraw:function(){this.$el.empty(),this.render(),this.$el.hasClass("expanded")&&(this.onChangeAttachments(),this.onChangeContent())},render:function(){var a=this.model.toJSON(),b=c.Baton({data:a,model:this.model,view:this}),d=e.getSubject(a),f=e.hasFrom(a)?j("Email from %1$s: %2$s",e.getDisplayName(a.from[0]),d):d;return _(this.options.disable).each(function(a,c){_.isArray(a)?_(a).each(function(a){b.disable(c,a)}):b.disable(c,a)}),this.$el.attr({"data-cid":this.model.cid,"aria-expanded":"false","data-loaded":"false"}),this.$el.prepend($('<h2 class="sr-only">').text(f)),this.$el.data({view:this,model:this.model}),c.point("io.ox/mail/detail").invoke("draw",this.$el,b),ox.trigger("mail:detail:render",this),this}});return{View:p}}),define("io.ox/mail/detail/mobileView",["io.ox/mail/detail/view","io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/mail/detail/content","io.ox/core/extPatterns/links","gettext!io.ox/mail","less!io.ox/mail/style"],function(a,b,c,d,e,f,g,h){"use strict";var i=0;c.point("io.ox/mail/mobile/detail").extend({id:"unread-class",index:i+=100,draw:b.unreadClass}),c.point("io.ox/mail/mobile/detail").extend({id:"header",index:i+=100,draw:function(a){var b=$('<header class="mobile-detail-view-mail detail-view-header" role="heading">');c.point("io.ox/mail/mobile/detail/header").invoke("draw",b,a),this.append(b)}});var j=0;c.point("io.ox/mail/mobile/detail/header").extend({id:"drag-support",index:j+=100,draw:function(a){this.attr({"data-drag-data":_.cid(a.data),"data-drag-message":e.getSubject(a.data)})}}),c.point("io.ox/mail/mobile/detail/header").extend({id:"actions",index:j+=100,draw:b.actions}),c.point("io.ox/mail/mobile/detail/header").extend({id:"from",index:j+=100,draw:function(a){this.append($('<div class="from">').append(e.serializeList(a.data,"from")))}}),c.point("io.ox/mail/mobile/detail/header").extend({id:"priority",index:j+=100,draw:b.priority}),c.point("io.ox/mail/mobile/detail/header").extend({id:"paper-clip",index:j+=100,draw:b.paperClip}),c.point("io.ox/mail/mobile/detail/header").extend({id:"recipients",index:j+=100,draw:b.recipients}),c.point("io.ox/mail/mobile/detail/header").extend({id:"subject",index:j+=100,draw:function(a){var b=e.getSubject(a.data);
this.append($('<h1 class="subject">').text(b))}}),c.point("io.ox/mail/mobile/detail/header").extend({id:"date",index:j+=100,draw:b.fulldate}),c.point("io.ox/mail/mobile/detail/header").extend({id:"unread-toggle",index:j+=100,draw:b.unreadToggle}),c.point("io.ox/mail/mobile/detail/header").extend({id:"flag-picker",index:j+=100,draw:b.flagPicker}),c.point("io.ox/mail/mobile/detail").extend({id:"notifications",index:i+=100,draw:function(a){var b=$('<section class="notifications">');c.point("io.ox/mail/detail/notifications").invoke("draw",b,a),this.append(b)}}),c.point("io.ox/mail/mobile/detail").extend({id:"body",index:i+=100,draw:function(){this.append($('<section class="attachments">'),$('<section class="body user-select-text">'))}}),c.point("io.ox/mail/mobile/detail/attachments").extend({id:"attachment-list",index:100,draw:b.attachmentList}),c.point("io.ox/mail/mobile/detail/attachments").extend({id:"attachment-preview",index:200,draw:b.attachmentPreview}),c.point("io.ox/mail/mobile/detail/body").extend({id:"content",index:1e3,draw:function(a){var b=f.get(a.data);this.idle().append(b.content)}});var k=a.View.extend({events:{"click .detail-view-header":"onClick"},onClick:function(){this.$el.trigger("showmail")},toggle:function(){return this}}),l=a.View.extend({showMail:function(){var a=this.$el;return"false"===a.attr("data-loaded")&&(a.attr("data-loaded",!0),a.find("section.body").addClass("loading"),this.trigger("load"),d.get(_.cid(this.cid)).then(this.onLoad.bind(this),this.onLoadFail.bind(this))),this},onChangeAttachments:function(){var a=this.model.toJSON(),b=c.Baton({data:a,attachments:e.getAttachments(a)}),d=this.$el.find("section.attachments").empty();c.point("io.ox/mail/mobile/detail/attachments").invoke("draw",d,b)},onChangeContent:function(){var a=this.model.toJSON(),b=c.Baton({data:a,attachments:e.getAttachments(a)}),d=this.$el.find("section.body").empty();c.point("io.ox/mail/mobile/detail/body").invoke("draw",d,b)},render:function(){var a=this.model.toJSON(),b=c.Baton({data:a,model:this.model,view:this}),d=e.getSubject(a),f=e.hasFrom(a)?h("Email from %1$s: %2$s",e.getDisplayName(a.from[0]),d):d;return _(this.options.disable).each(function(a,c){_.isArray(a)?_(a).each(function(a){b.disable(c,a)}):b.disable(c,a)}),this.$el.attr({"aria-label":f,"data-cid":this.cid,"data-loaded":"false"}),this.$el.data({view:this,model:this.model}),this.baton=b,c.point("io.ox/mail/mobile/detail").invoke("draw",this.$el,b),this}});return{HeaderView:k,DetailView:l}}),define("io.ox/core/tk/list-dnd",["io.ox/core/extensions","io.ox/core/collection","gettext!io.ox/core","io.ox/core/tk/draghelper"],function(a,b,c){"use strict";function d(a,b){return a=a.map(function(){return $.trim($(this).attr("title")||$(this).text())}),$.makeArray(a).join(b||"")}function e(a){var b=d(this.find(".selected .drag-title"),", ");return b||c.format(c.ngettext("1 item","%1$d items",a.length),a.length)}function f(c){function d(a){C=a.pageX+y,D=a.pageY+z,(E(A-C)>=5||E(B-D)>=5)&&(u.left=C+"px",u.top=D+"px",A=C,B=D)}function f(){w.trigger("selection:dragstart")}function g(){this.trigger("click")}function h(a){if(!a.isDefaultPrevented()){a.preventDefault();var b=$(this).find(".folder-arrow");$(this).addClass("dnd-over"),b.length&&(clearTimeout(v),v=setTimeout(g.bind(b),1500))}}function i(){clearTimeout(v),$(this).removeClass("dnd-over")}function j(b){$(document).off("mousemove.dnd",j);var e=t.reduce(function(a,b){var c=$(b).find(".drag-count");return a+(c.length?parseInt(c.text(),10):1)},0);x=$('<div class="drag-helper">'),a.point("io.ox/core/tk/draghelper").invoke("draw",x,new a.Baton({container:w,count:e||r.length,data:r,source:s,dragMessage:c.dragMessage})),u=x[0].style,A=B=C=D=0,d(b),x.appendTo(document.body),$(document).one("mousemove.dnd",f).on("mousemove.dnd",d).on("mouseover.dnd",".folder-tree",F.over).on("mouseout.dnd",".folder-tree",F.out).on("mousemove.dnd",".folder-tree",F.move).on("mouseover.dnd",c.dropzoneSelector,h).on("mouseout.dnd",c.dropzoneSelector,i).on("keyup.dnd",l)}function k(){null!==x&&(x.remove(),x=u=null)}function l(a){27===a.which&&m()}function m(){F.out(),$(document).off("mousemove.dnd mouseup.dnd mouseover.dnd mouseout.dnd keyup.dnd"),$(".dropzone").each(function(){var a=$(this),b=a.attr("data-dropzones");(b?a.find(b):a).off("mouseup.dnd")}),$(".dnd-over").removeClass("dnd-over"),w.trigger("selection:dragstop"),null!==x&&k(),s=t=r=null}function n(b){if(!b.isDefaultPrevented()){b.preventDefault(),clearTimeout(v);var d=$(this).attr("data-model")||$(this).attr("data-id")||$(this).attr("data-cid")||$(this).attr("data-obj-id"),e=new a.Baton({data:r,dragType:c.dragType,dropzone:this,target:d});$(this).trigger("selection:drop",[e])}}function o(a){var b=Math.abs(a.pageX-a.data.x),c=Math.abs(a.pageY-a.data.y);(b>15||c>15)&&$(document).off("mousemove.dnd").on("mousemove.dnd",j)}function p(a){return _.cid(a.replace(/^thread./,""))}function q(a){s=$(this),t=_(w.find(".selected")),r=s.attr("data-drag-data")?[s.attr("data-drag-data")]:t.map(function(a){return $(a).attr("data-cid")});var c=new b(_(r).map(p));c.getProperties(),(!c.isResolved()||c.has("delete"))&&($(".dropzone").each(function(){var a=$(this),b=a.attr("data-dropzones");(b?a.find(b):a).on("mouseup.dnd",n)}),$(document).on("mousemove.dnd",{x:a.pageX,y:a.pageY},o).on("mouseup.dnd",m),a.preventDefault())}c=_.extend({container:$(),data:null,draggable:!1,dragMessage:e,dragType:"",dropzone:!1,dropzoneSelector:".selectable",dropType:"",selection:null,selectable:".selectable",simple:!1},c);var r,s,t,u,v,w=c.container||$(),x=null,y=15,z=15,A=0,B=0,C=0,D=0,E=Math.abs,F=function(){var a=0,b=null;return{move:function(b){a=b.pageY-$(this).offset().top},out:function(){clearInterval(b),b=null},over:function(){if(!b){var c=this.clientHeight;b=setInterval(function(){var b=Math.round(a/c*10)-5,d=0>b?-1:1,e=Math.abs(b);e>2&&(this.scrollTop+=d*(e-2)*2)}.bind(this),5)}}}}();c.draggable&&w.on("mousedown.dnd",c.selectable,q),c.dropzone&&(null===c.selection&&console.error("list-dnd: Selection required for dropzone!",c),w.addClass("dropzone").attr("data-dropzones",c.dropzoneSelector).on("drop",function(a,b){b.dropType=c.dropType,c.selection.trigger("selection:drop",b)}))}return{enable:_.device("touch")?$.noop:f}}),define("io.ox/core/print",["io.ox/core/http","io.ox/core/notifications","gettext!io.ox/core"],function(a,b,c){"use strict";function d(a){return(a||"").replace(/[#%&§\/$*!`´'"=:@+\^\\.+?{}|]/g,"_")}function e(a,b){var e="print_"+_.now();return window[e]=function(e){try{var f=a.selector||"script",g=$(e.body).find('[type="text/template"]').filter(f).html(),h=(a.title||"").trim();$(e.body).html(_.template(g,b)),e.title=d(ox.serverConfig.pageTitle)+d(h.length?" "+h:"")+" "+c("Printout")}catch(i){console.error(i)}},e}function f(){for(var a in i)i[a].closed&&(delete i[a],delete window[a])}var g="default.tmpl",h={mail:"super-mail-template.tmpl",contacts:"super-contacts-template.tmpl",tasks:"super-tasks-template.tmpl"},i={},j={request:function(a,b){function d(){require([a]).then(function(c){_.isFunction(c.open)?c.open(b,e):console.error('Missing function "open" in:',a,c)},function(){console.error("Failed to load print manager")})}var e;return _.device("desktop")?(e=this.openURL(ox.base+"/busy.html"),d()):ox.load(["io.ox/core/tk/dialogs"]).done(function(a){var b=$("<iframe>",{src:ox.base+"/busy.html",frameborder:0}).css({width:"100%",height:"100%"}),f=.9*window.innerHeight,g=new a.ModalDialog({width:.9*window.innerWidth,height:f}).addPrimaryButton("print",c("Print"),null,{click:function(){e.print()}}).addButton("cancel",c("Cancel"));f-=100,g.getBody().css({height:f,maxHeight:f}),g.append(b).show().done(function(a){"print"===a&&e.print()}),e=b[0].contentWindow,d()}),e},smart:function(d){d=_.extend({get:$.noop,selection:[],i18n:{},file:ox.base+"/print.html"},d),d.selection=_.chain(d.selection).toArray().compact(),a.pause(),$.when.apply($,_.chain(d.selection).map(function(a){return _.isString(a)?a:_.cid(a)}).uniq().map(function(a,b){return d.get(_.cid(a)).then(function(a){return d.process?d.process(a,b,d):a})}).value()).done(function(){var a=_.chain(arguments).toArray(),b=a.value().length;d.filter&&(a=a.filter(d.filter)),d.sortBy&&(a=a.sortBy(d.sortBy)),a=a.value();var c=e(d,{data:a,i18n:d.i18n,length:a.length,filtered:b-a.length}),g=d.file+"?"+c;_.defer(function(){d.window?(d.window.location=g,i[c]=d.window):i[c]=j.openURL(g),f()})}).fail(function(){d.window&&d.window.close(),b.yell({type:"error",headline:c("Error"),message:c.ngettext("Cannot print this item","Cannot print these items",d.selection.length)})}),a.resume()},getWindowOptions:function(){var a={width:750,height:Math.min(screen.availHeight-100,1050),top:40};return a.left=(screen.availWidth-a.width)/2>>0,a.string="width="+a.width+",height="+a.height+",left="+a.left+",top="+a.top+",menubar=no,toolbar=no,location=no,scrollbars=yes,status=no",a},getWindow:function(a){var b="print_"+_.now(),c=this.getWindowOptions(a),d=window.open(a,b,c.string);return d},open:function(a,b,c){var d,e={action:"get"};return"printCalendar"===a&&delete e.action,_.isArray(b)?e.data=JSON.stringify(b):_.isObject(b)&&(e.folder=b.folder_id||b.folder,e.id=b.id),e.format="template",e.template=h[a]||g,e.session=ox.session,d=ox.apiRoot+"/"+a+"?"+$.param(_.extend(e,c)),this.getWindow(d)},openURL:function(a){return this.getWindow(a||ox.base+"/blank.html")},interim:function(a){return console.warn("Temporary solution; replace by open()",a),this.openURL(a)}};return j}),define("io.ox/contacts/api",["io.ox/core/extensions","io.ox/core/http","io.ox/core/api/factory","io.ox/core/notifications","io.ox/core/cache","io.ox/contacts/util","l10n/ja_JP/io.ox/collation","settings!io.ox/contacts","io.ox/core/date"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(a){var b=$.Deferred();return require(["io.ox/core/api/user"],function(c){$.when(c.caches.get.remove({id:a.user_id}),c.caches.all.clear(),c.caches.list.remove({id:a.user_id})).pipe(function(){b.resolve()},function(){b.reject()})}),b}function k(a,b){(""===a[b]||void 0===a[b])&&delete a[b]}var l={},m={email:["555","556","557"],telephone:["542","543","545","546","548","549","551","552","553","559","560","561","562","563","564","567","568"],cellular:["551","552"],fax:["544","550","554"],addresses:"506 507 508 509 510 523 525 526 527 528 538 539 540 541".split(" ")},n=function(a){return a.id?(a.birthday&&1===new i.UTC(a.birthday).getYear()&&(a.birthday=f.julianToGregorian(a.birthday)),a):(_(a).each(function(a){a.birthday&&1===new i.UTC(a.birthday).getYear()&&(a.birthday=f.julianToGregorian(a.birthday))}),a)};m.msisdn=h.get("msisdn/columns",m.cellular);var o=c({module:"contacts",mapping:m,requests:{all:{action:"all",folder:"6",columns:"20,1,101,607",extendColumns:"io.ox/contacts/api/all",sort:"607",order:"asc",admin:function(){return h.get("showAdmin",!1)}},list:{action:"list",columns:"20,1,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607,5,2",extendColumns:"io.ox/contacts/api/list"},get:{action:"get"},search:{action:"search",columns:"20,1,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607,5,2",extendColumns:"io.ox/contacts/api/list",sort:"609",getData:function(b,c){c=c||{},b+="*";var d={orSearch:!0,admin:h.get("showAdmin",!1),emailAutoComplete:!!c.emailAutoComplete},e=!0,f={names:{display_name:b,first_name:b,last_name:b,email1:b,email2:b,email3:b},addresses:{street_home:b,postal_code_home:b,city_home:b,state_home:b,country_home:b,street_business:b,postal_code_business:b,city_business:b,state_business:b,country_business:b,street_other:b,postal_code_other:b,city_other:b,state_other:b,country_other:b},phones:{telephone_business1:b,telephone_business2:b,telephone_home1:b,telephone_home2:b,telephone_other:b,fax_business:b,telephone_callback:b,telephone_car:b,telephone_company:b,fax_home:b,cellular_telephone1:b,cellular_telephone2:b,fax_other:b,telephone_isdn:b,telephone_pager:b,telephone_primary:b,telephone_radio:b,telephone_telex:b,telephone_ttytdd:b,telephone_ip:b,telephone_assistant:b}};return _(c).each(function(a,b){_(f).chain().keys().contains(b).value()&&"on"===a&&(d=_(d).extend(f[b]),e=!1)}),e&&(d=_(d).extend(f.names)),a.point("io.ox/contacts/api/search").invoke("getData",d,b,c),d}},advancedsearch:{action:"advancedSearch",columns:"20,1,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607",extendColumns:"io.ox/contacts/api/list",sort:"607",getData:function(b,c){var d,e={names:"display_name first_name last_name yomiFirstName yomiLastName company yomiCompany email1 email2 email3".split(" "),addresses:"street_home postal_code_home city_home state_home country_home street_business postal_code_business city_business state_business country_business street_other postal_code_other city_other state_other country_other".split(" "),phones:"telephone_business1 telephone_business2 telephone_home1 telephone_home2 telephone_other fax_business telephone_callback telephone_car telephone_company fax_home cellular_telephone1 cellular_telephone2 fax_other telephone_isdn telephone_pager telephone_primary telephone_radio telephone_telex telephone_ttytdd telephone_ip telephone_assistant".split(" ")},f=["or"],g=!0;return c=c||{},b.indexOf("*")+b.indexOf("?")<-1&&(b="*"+b+"*"),_(c).each(function(a,c){_(e).chain().keys().contains(c).value()&&"on"===a&&(_(e[c]).each(function(a){f.push(["=",{field:a},b])}),g=!1)}),g&&_(e.names).each(function(a){f.push(["=",{field:a},b])}),d={filter:f},a.point("io.ox/contacts/api/search").invoke("getData",d,b,c),d}}},pipe:{all:function(a){if("ja_JP"===ox.language)return a.sort(g.sorter),a;for(var b,c=0,d=0;b=a[c++];)""===b.sort_name&&d++;return d>0&&(a=a.slice(d).concat(a.slice(0,d))),a},listPost:function(a){return _(a).each(function(a){o.caches.get.dedust(a,"last_modified")}),o.trigger("list:ready"),a},get:n,search:n,advancedsearch:n}});o.create=function(a,c){k(a,"email1"),k(a,"email2"),k(a,"email3"),a.birthday&&1===new i.UTC(a.birthday).getYear()&&(a.birthday=f.gregorianToJulian(a.birthday));var d,e=a.tempAttachmentIndicator,g={module:"contacts",data:a,appendColumns:!1,fixPost:!0};return delete a.tempAttachmentIndicator,c?window.FormData&&c instanceof window.File?(d="UPLOAD",g.data=new FormData,g.data.append("file",c),g.data.append("json",JSON.stringify(a)),g.params={action:"new"}):(d="FORM",g.form=c,g.action="new"):(d="PUT",g.params={action:"new"}),b[d](g).then(function(b){return b=b.data||b,o.get({id:b.id,folder:a.folder_id})}).then(function(a){return $.when(o.caches.all.grepRemove(a.folder_id+o.DELIM),p.clear()).then(function(){return e&&o.addToUploadList(_.ecid(a)),o.trigger("create",{id:a.id,folder:a.folder_id}),o.trigger("refresh.all"),a})})},o.update=function(a){var c=a.data.tempAttachmentIndicator;return delete a.data.tempAttachmentIndicator,_.isEmpty(a.data)?c?$.when().then(function(){return o.addToUploadList(_.ecid(a)),o.trigger("update:"+_.ecid(a)),o.trigger("update",a),{folder_id:a.folder,id:a.id}}):$.when():(a.data.birthday&&1===new i.UTC(a.data.birthday).getYear()&&(a.data.birthday=f.gregorianToJulian(a.data.birthday)),b.PUT({module:"contacts",params:{action:"update",id:a.id,folder:a.folder,timestamp:_.then(),timezone:"UTC"},data:a.data,appendColumns:!1}).then(function(){return o.get({id:a.id,folder:a.folder},!1).then(function(b){return $.when(o.caches.get.add(b),o.caches.all.grepRemove(a.folder+o.DELIM),o.caches.list.remove({id:a.id,folder:a.folder}),p.clear(),b.user_id?j(b):"").done(function(){c&&o.addToUploadList(_.ecid(b)),o.trigger("update:"+_.ecid(b),b),o.trigger("update",b),o.trigger("refresh.all")})})}))},o.editNewImage=function(a,c,d){var e=function(b){return $.when(o.caches.get.clear(),o.caches.list.clear(),p.clear()).then(function(){o.trigger("refresh.list"),o.trigger("update:"+_.ecid(a)),o.trigger("update:image",{id:a.id,folder:a.folder_id})}),b};if("FormData"in window&&d instanceof window.File){var f=new FormData;return f.append("file",d),f.append("json",JSON.stringify(c)),b.UPLOAD({module:"contacts",params:{action:"update",id:a.id,folder:a.folder_id,timestamp:_.then()},data:f,fixPost:!0}).then(e)}return b.FORM({module:"contacts",action:"update",form:d,data:c,params:{id:a.id,folder:a.folder_id,timestamp:_.then()}}).then(e)},o.remove=function(a){return o.trigger("beforedelete",a),a=_.isArray(a)?a:[a],b.PUT({module:"contacts",params:{action:"delete",timestamp:_.then(),timezone:"UTC"},appendColumns:!1,data:_(a).map(function(a){return{folder:a.folder_id,id:a.id}})}).then(function(){return $.when(o.caches.all.clear(),o.caches.list.remove(a),p.clear())}).fail(function(a){d.yell("error",a.error)}).done(function(){_(a).map(function(a){o.trigger("delete:"+_.ecid(a),a),o.trigger("delete",a)}),o.trigger("refresh.all")})},o.on("refresh^",function(){o.caches.get.clear()});var p=new e.SimpleCache("contacts-fetching");o.clearFetchCache=function(){return p.clear()},o.getByEmailaddress=function(a){return a=a||"",p.get(a).then(function(c){return null!==c?c:""===a?{}:b.PUT({module:"contacts",params:{action:"search",admin:h.get("showAdmin",!1),columns:"20,1,500,501,502,505,520,555,556,557,569,602,606,524,592",timezone:"UTC"},sort:609,data:{email1:a,email2:a,email3:a,orSearch:!0,exactMatch:!0}}).then(function(b){return b=b.filter(function(a){return!a.mark_as_distributionlist}),b.length?(b.sort(function(a,b){return b.image1_url?1:-1}),b.sort(function(a,b){return"6"===b.folder_id?1:-1}),b=b[0],b.image1_url&&(b.image1_url=b.image1_url.replace(/^https?\:\/\/[^\/]+/i,"").replace(/^\/ajax/,ox.apiRoot)),p.add(a,b)):p.add(a,{})})})},o.pictureHalo=function(){function a(a,c){return _.defer(function(){var e=a.closest(".scrollpane");e.length?a.attr("data-original",c).lazyload({container:e,effect:"show",error:function(){a.css("background-image","url("+d+")"),a=e=null},load:function(f,g,h){1===h.width?a.css("background-image","url("+d+")"):b[c]=c,a=e=null}}):$(new Image).on("load error",function(f){var g=1===this.width||"error"===f.type;g||(b[c]=c),a.css("background-image","url("+(g?d:c)+")"),a=e=null,$(this).off()}).attr("src",c)}),a}var b={},c=ox.t0,d=ox.base+"/apps/themes/default/dummypicture.png";return o.on("update:image",function(){c=_.now()}),function(){var e,f,g,h,i=_(arguments).toArray();if(1===i.length?f=_.clone(i[0]):(e=i[0],f=_.clone(i[1])),o.looksLikeResource(f)?h=ox.base+"/apps/themes/default/dummypicture_resource.png":o.looksLikeGroup(f)||o.looksLikeDistributionList(f)?h=ox.base+"/apps/themes/default/dummypicture_group.png":_.isString(f.image1_url)&&""!==f.image1_url?(g=$.extend({},{width:f.width,height:f.height,scaleType:f.scaleType}),h=f.image1_url.replace(/^\/ajax/,ox.apiRoot)+"&"+$.param(g)):f.email||f.contact_id||f.id||f.internal_userid||(h=d),h)return e?a(e,h,f):h;f.internal_userid||f.userid||f.user_id?(delete f.contact_id,delete f.folder_id,delete f.folder,delete f.id):(delete f.internal_userid,delete f.userid,delete f.user_id),g=$.extend({},{email:f.email&&String(f.email).toLowerCase()||f.mail&&String(f.mail).toLowerCase()||f.email1&&String(f.email1).toLowerCase(),folder:f.folder_id||f.folder,id:f.contact_id||f.id,internal_userid:f.internal_userid||f.userid||f.user_id,width:f.width,height:f.height,scaleType:f.scaleType,uniq:c});for(var j in g)g.hasOwnProperty(j)&&!g[j]&&delete g[j];return h=ox.apiRoot+"/halo/contact/picture?"+$.param(g),e?b[h]?e.css("background-image","url("+b[h]+")"):(a(e,h,f),f=null,e):h}}(),o.getDisplayName=function(a,b){b=_.extend({halo:!0,stringify:"getDisplayName",tagName:"a"},b);var c,d,e,g=a.display_name||"",h=$("<"+b.tagName+">").text(" "),i=a.email;return c=function(c){b.halo&&/\@/.test(a.email)&&h.addClass("halo-link").attr("href","#").data({display_name:c,email1:i}),h.text(_.noI18n(c+" "))},d=function(){_.defer(function(){h=c=d=e=b=null})},e=function(a){return _.isArray(a)&&(a=a[0]),_.isString(a)?c(a):void(a&&(c(_.isEmpty(a)?g:f[b.stringify](a)),d()))},a&&a.full_name?(e(a.full_name),d()):a&&(a.last_name||a.first_name)?(e(a),d()):o.getByEmailaddress(a.email).done(e).fail(d),h};var q=function(a,c,e){return a=_.isArray(a)?a:[a],b.pause(),_(a).map(function(a){return b.PUT({module:"contacts",params:{action:c||"update",id:a.id,folder:a.folder_id||a.folder,timezone:"UTC",timestamp:a.timestamp||_.then()},data:{folder_id:e},appendColumns:!1})}),b.resume().then(function(b){var c=$.Deferred();return _(b).each(function(a){a.error&&(d.yell(a.error),c.reject(a.error))}),"rejected"===c.state()?c:$.when.apply($,_(a).map(function(a){return $.when(o.caches.all.grepRemove(e+o.DELIM),o.caches.all.grepRemove(a.folder_id+o.DELIM),o.caches.list.remove({id:a.id,folder:a.folder_id}))}))}).done(function(){o.trigger("refresh.all")})};return o.move=function(a,b){return q(a,"update",b)},o.copy=function(a,b){return q(a,"copy",b)},o.birthdays=function(a){var c=_.now(),d=_.extend({action:"birthdays",start:c,end:c+6048e5,columns:"1,20,500,501,502,503,504,505,511",timezone:"UTC"},a||{});return b.GET({module:"contacts",params:d}).then(n)},o.looksLikeResource=function(a){return"mailaddress"in a&&"description"in a},o.looksLikeGroup=function(a){return"members"in a},o.looksLikeDistributionList=function(a){return!!a.mark_as_distributionlist},o.uploadInProgress=function(a){return l[a]||!1},o.addToUploadList=function(a){l[a]=!0},o.removeFromUploadList=function(a){delete l[a],o.trigger("update:"+a)},o.autocomplete=function(){function a(a){return a.length>=g}function c(b){return(_(b.split(" ")).find(a)||"").substr(0,g)}function d(a){var b=c(a),d=f.cache[b],e=a.split(" ");if(d)return d.then(function(a){return _(a).filter(function(a){return _(e).every(function(b){return _(a.fulltext).some(function(a){return 0===a.indexOf(b)})})})})}function e(a,b){var d=c(a);f.cache[d]=b.then(function(a){return _(a).map(function(a){return a.fulltext=_(i).map(function(b){return String(a[b]||"").toLowerCase()}),a.fulltext=_(a.fulltext).compact(),a})})}function f(a,f){a=$.trim(a).toLowerCase();var g="1,2,5,20,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607,551,552";f=_.extend({admin:!1,email:!0,sort:"609",columns:g,cache:!0},f);var h=f.cache&&d(a);return h?h:(e(a,b.GET({module:"contacts",params:{action:"autocomplete",query:c(a),admin:f.admin,email:f.email,sort:f.sort,columns:f.columns}})),d(a))}var g=Math.max(1,h.get("search/minimumQueryLength",3)),i="display_name email1 email2 email3 first_name last_name".split(" ");return f.cache={},f}(),o.on("create update delete",function(){o.autocomplete.cache={}}),o}),define("io.ox/core/tk/flag-picker",["io.ox/mail/api","io.ox/core/folder/api","gettext!io.ox/mail"],function(a,b,c){"use strict";var d={NONE:c("None"),RED:c("Red"),BLUE:c("Blue"),GREEN:c("Green"),GRAY:c("Gray"),PURPLE:c("Purple"),LIGHTGREEN:c("Light green"),ORANGE:c("Orange"),PINK:c("Pink"),LIGHTBLUE:c("Light blue"),YELLOW:c("Yellow")},e={NONE:0,RED:1,BLUE:2,GREEN:3,GRAY:4,PURPLE:5,LIGHTGREEN:6,ORANGE:7,PINK:8,LIGHTBLUE:9,YELLOW:10},f="fa fa-bookmark-o",g="fa fa-bookmark",h={appendDropdown:function(a,b){a.after($('<ul class="dropdown-menu" role="menu">').on("click","a",{data:b},h.change).append(_(e).map(function(a,b){return $("<li>").append($('<a href="#" tabindex="1" role="menuitem">').append(a>0?$('<span class="flag-example">').addClass("flag_bg_"+a):$(),$.txt(d[b])).attr("data-color",a))}))),a.addClass("dropdown-toggle").attr({"aria-haspopup":"true","data-toggle":"dropdown",role:"button"}),a.parent().addClass("dropdown flag-picker")},draw:function(a,b){var d,e=b.data,h=Math.max(0,e.color_label||0);a.append($("<div>").append(d=$('<a href="#" tabindex="1" title="'+c("Set color")+'">').append($('<i class="flag-dropdown-icon">').attr({"data-color":h,title:c("Set color")}).addClass("flag_"+h+" "+(h?g:f))))),this.appendDropdown(d,e),b.view&&b.view.listenTo(b.model,"change:color_label",this.update)},change:function(c){c.preventDefault();var d=c.data.data,e=$(c.currentTarget).attr("data-color")||"0",f=$(this).closest(".flag-picker");d=b.ignoreSentItems(d),a.changeColor(d,e),f.find(".dropdown-toggle").focus()},update:function(a){var b=Math.max(0,a.get("color_label")||0),c="flag-dropdown-icon ";c+=0===b?f:g,c+=" flag_"+b,this.$el.find(".flag-dropdown-icon").attr({"class":c,"data-color":b})},attach:function(a,b){this.appendDropdown(a,b.data)}};return h}),define("io.ox/backbone/disposable",[],function(){"use strict";var a=Backbone.View.extend({constructor:function(){Backbone.View.prototype.constructor.apply(this,arguments),this.$el.data("view",this),this.$el.on("dispose",function(){this.dispose(!0)}.bind(this))},dispose:function(a){a||this.$el.off().removeData(),this.trigger("dispose"),this.off().stopListening();for(var b in this)this.hasOwnProperty(b)&&(this[b]=null);this.disposed=!0}});return a}),define("io.ox/backbone/mini-views/abstract",[],function(){"use strict";var a=Backbone.View.extend({initialize:function(a){var b=this.options=a||{};b.id&&!b.name&&(b.name=b.id),this.$el.on("dispose",function(a){this.dispose(a)}.bind(this)),this.$el.data("view",this),this.model&&b.name&&(this.name=b.name,this.listenTo(this.model,"valid:"+b.name,this.valid),this.listenTo(this.model,"invalid:"+b.name,this.invalid)),this.setup&&this.setup(b)},valid:function(){this.$el.trigger("valid")},invalid:function(a,b){this.$el.trigger("invalid",[a,b])},dispose:function(){this.stopListening(),this.model=null}});return a}),define("io.ox/backbone/mini-views/dropdown",["io.ox/backbone/mini-views/abstract"],function(a){"use strict";var b=a.extend({tagName:"div",className:"dropdown",onClick:function(a){a.preventDefault();var b=$(a.currentTarget),c=b.attr("data-name"),d=b.data("value"),e=b.data("toggle");void 0!==d&&this.model.set(c,e===!0?!this.model.get(c):d)},setup:function(){this.$ul=$('<ul class="dropdown-menu" role="menu">'),this.$ul.on("click","a",$.proxy(this.onClick,this)),this.model&&this.listenTo(this.model,"change",this.update)},update:function(){var a=this.$ul;this.model&&(_(this.model.changed).each(function(b,c){var d=a.find('[data-name="'+c+'"]');d.children("i").attr("class","fa fa-fw fa-none"),d.each(function(){var a=$(this);a.filter("[role=menuitemcheckbox][aria-checked]").attr({"aria-checked":_.isEqual(a.data("value"),b)}),_.isEqual(a.data("value"),b)&&a.children("i").attr("class","fa fa-fw fa-check")})},this),this.label())},label:function(){},stringify:function(a){return _.isObject(a)?JSON.stringify(a):a},append:function(a){return this.$ul.append($("<li>").attr({role:"presentation"}).append(a)),this},option:function(a,b,c){var d;return this.append(d=$('<a href="#">').attr({role:"menuitemcheckbox","aria-checked":_.isEqual(this.model.get(a),b),"data-name":a,draggable:!1,"data-value":this.stringify(b),"data-toggle":_.isBoolean(b)}).data("value",b).append($('<i class="fa fa-fw">').attr({"aria-hidden":!0}).addClass(_.isEqual(this.model.get(a),b)?"fa-check":"fa-none"),_.isFunction(c)?c():$("<span>").text(c))),_.device("firefox")&&d.attr("ondragstart","return false;"),this},link:function(a,b,c){var d=$('<a href="#" draggable="false">').attr("data-name",a).text(b).on("click",c);return _.device("firefox")&&d.attr("ondragstart","return false;"),this.append(d)},header:function(a){return this.$ul.append($('<li class="dropdown-header" role="sectionhead">').text(a)),this},divider:function(){return this.$ul.append('<li class="divider" role="separator">'),this},render:function(){var a,b=_.isFunction(this.options.label)?this.options.label():$.txt(this.options.label),c=this.options.aria?this.options.aria:null;return _.isString(b)&&(c+=" "+b),this.$el.append(a=$("<a>").attr({href:"#",tabindex:1,draggable:!1,role:"menuitem","aria-haspopup":!0,"aria-label":c,"data-toggle":"dropdown"}).append($('<span class="dropdown-label">').append(b),this.options.caret?$('<i aria-hidden="true" class="fa fa-caret-down">'):[]),this.$ul),_.device("firefox")&&a.attr("ondragstart","return false;"),a.dropdown(),this.label(),this}});return b}),define("io.ox/backbone/mini-views/toolbar",["io.ox/backbone/disposable","gettext!io.ox/core"],function(a,b){"use strict";var c=a.extend({className:"classic-toolbar-container",events:{"mousedown ul.classic-toolbar>li>a":"onMousedown","keydown ul.classic-toolbar>li>a":"onKeydown"},initialize:function(a){var b={tabindex:0};this.options=_.extend(b,a)},render:function(){return this.$el.attr({role:"navigation",title:b("Inline menu %1$s",this.options.title||"")}).append(this.$list=$("<ul>").attr({role:"toolbar",title:b("Actions")}).addClass("classic-toolbar")),this},initButtons:function(){this.$links=this.$el.find("ul.classic-toolbar>li>a").attr({role:"button",tabindex:-1}),this.$links.first().attr({tabindex:this.options.tabindex})},onMousedown:function(a){this.$links.attr("tabindex",-1),$(a.currentTarget).attr("tabindex",this.options.tabindex)},onKeydown:function(a){if(/(32|37|38|39|40)/.test(a.which)&&!a.altKey&&!a.ctrlKey&&!a.shiftKey){var b=this.$links.index($(document.activeElement))||0;if(!(0>b)){switch(a.which){case 32:$(a.currentTarget).click();break;case 37:case 38:b-=1;break;case 39:b+=1}this.$links.attr("tabindex",-1).eq(b%=this.$links.length).attr("tabindex",this.options.tabindex).focus()}}}});return c}),define("io.ox/core/tk/upload",["io.ox/core/event","io.ox/core/notifications","gettext!io.ox/core"],function(a,b,c){"use strict";function d(a){return a.originalEvent&&a.originalEvent.dataTransfer&&(_.browser.Firefox&&"dragleave"!==a.type?"none"!==a.originalEvent.dataTransfer.dropEffect:"none"===a.originalEvent.dataTransfer.dropEffect)&&(_(a.originalEvent.dataTransfer.types).contains("Files")||_(a.originalEvent.dataTransfer.types).contains("application/x-moz-file"))}function e(e){require(["less!io.ox/core/tk/upload"]);var f,g,h=this,i=$('<div class="abs io-ox-dropzone-multiple-overlay">').on("click",k),j=function(a){return!d(a)||$("body > .io-ox-dialog-wrapper").length>0?void 0:(clearTimeout(g),$("body").addClass("io-ox-dropzone-active").append(i),!1)},k=function(){return $("body").removeClass("io-ox-dropzone-active"),i.detach(),!1},l=function(){var a=$('<div class="io-ox-dropzone-action">');return i.append(a),a};a.extend(this),_(e.actions||[]).each(function(a){var d=l();d.append($('<div class="dropzone">').on({dragenter:function(){f&&f.removeClass("io-ox-dropzone-hover"),f=d,d.addClass("io-ox-dropzone-hover")},dragleave:function(a){_.browser.IE?$(a.target).hasClass("dropzone")||$(a.target).hasClass("dndignore")||d.removeClass("io-ox-dropzone-hover"):d.removeClass("io-ox-dropzone-hover")},drop:function(d){d=d.originalEvent||d;var g=d.dataTransfer.files;if(f&&f.removeClass("io-ox-dropzone-hover"),_.browser.Chrome&&_.browser.Chrome>21)for(var i=d.dataTransfer.items,j=0;j<i.length;j++){var l=i[j].webkitGetAsEntry();if(l.isDirectory)return b.yell("error",c("Uploading folders is not supported.")),k(d),!1}if("importEML"===e.actions[0].id)for(var j=0;j<g.length;j++){var m=/(\.eml)$/i;if(!m.test(g[j].name))return b.yell("error",c("Mail was not imported. Only .eml files are supported.")),k(d),!1}for(var j=0,n=g.length;n>j;j++)"mailAttachment"===e.actions[0].id?h.trigger("drop",g[j]):h.trigger("drop",a.id,g[j],a);return h.trigger("drop-multiple",a,$.makeArray(g)),k(d),!1}}).append($('<span class="dndignore">').html(a.label)))});var m=!1;this.remove=function(){m&&(m=!1,$(document).off("dragenter",j).off("drop",k),i.off("dragenter dragover dragend dragleave drop"))},this.include=function(){m||(m=!0,$(document).on("dragenter",j),i.on({dragenter:function(){return clearTimeout(g),!1},dragover:function(a){var b,c=a.originalEvent;try{b=c.dataTransfer.effectAllowed}catch(d){}return c.dataTransfer.dropEffect="move"===b||"linkMove"===b?"move":"copy",clearTimeout(g),a.preventDefault(),!1},dragleave:function(a){g=setTimeout(function(){k(a)},200),a.stopPropagation()},drop:function(a){return a.preventDefault(),k(a),!1}}))}}function f(){this.enabled=!1,this.bind=$.noop,this.unbind=$.noop,this.remove=$.noop,this.include=$.noop}function g(d){d?d.progress||console.warn('The delegate to a queue should implement a "progress" method!'):console.warn("No delegate supplied to file processing queue."),d=_.extend({start:$.noop,stop:$.noop,progress:function(){return $.when()},type:!1},d||{}),a.extend(this);var e=[],f=0,g=!1;this.next=function(){if(!g){if(0===e.length||e.length<=f)return this.stop();
g=!0;var a=this;0===f&&this.start(),this.progress().always(function(){g=!1,f++,a.queueChanged()})}},this.offer=function(a,f){var g,h=!0,i=this;_([].concat(a)).each(function(a){e.push({file:a,options:f||{}})}),require(["settings!io.ox/core","io.ox/core/strings"],function(a,f){var j=a.get("properties");if(j&&"importEML"!==d.type){var k=0,l=j.infostoreMaxUploadSize,m=j.infostoreQuota;_.each(e,function(a){var d=a.file;return g=d.name,k+=d.size,l>0&&d.size>l?(h=!1,b.yell("error",c('The file "%1$s" cannot be uploaded because it exceeds the maximum file size of %2$s',g,f.fileSize(l))),void i.stop()):m>0&&k>m-j.infostoreUsage?(h=!1,b.yell("error",c('The file "%1$s" cannot be uploaded because it exceeds the quota limit of %2$s',g,f.fileSize(m))),void i.stop()):void 0})}h&&i.queueChanged()})},this.length=0,this.queueChanged=function(){this.length=e.length,this.trigger("changed",this),this.next()},this.dump=function(){console.info("this",this,"file",e[f],"position",f,"files",e)},this.start=function(){ox.autoLogout.stop(),d.start(e[f],f,e),this.trigger("start",e[f],f,e)},this.progress=function(){var a=d.progress(e[f],f,e);return this.trigger("progress",a,e[f],f,e),a},this.stop=function(){ox.autoLogout.start(),d.stop(e[f],f,e),this.trigger("stop",e[f],f,e),e=[],f=0,g=!1}}return{dnd:{enabled:Modernizr.draganddrop,createDropZone:function(a){return a=a||{},this.enabled?new e(a):new f(a.node)}},createQueue:function(a){return new g(a)}}}),define("io.ox/core/dropzone",[],function(){"use strict";var a="dragenter dragover dragleave drop",b=Backbone.View.extend({className:"inplace-dropzone",events:{drop:"onDrop","dragenter .dropzone-overlay":"onDragenter","dragover .dropzone-overlay":"onDragover","dragleave .dropzone-overlay":"onDragleave"},onLeave:function(a){this.leaving&&this.hide(a)},onDrag:function(a){if(this.$el.parent().is(":visible"))switch(a.type){case"dragenter":case"dragover":return this.stop(a),this.leaving=!1,this.visible||this.show(a),!1;case"dragleave":this.leaving=!0,clearTimeout(this.timeout),this.timeout=setTimeout(this.onLeave.bind(this),100,a);break;case"drop":return this.stop(a),this.hide(),!1}},stop:function(a){a.preventDefault(),a.stopPropagation()},show:function(a){this.isFile(a)&&(this.visible=!0,this.$el.show(),this.trigger("show"))},hide:function(){this.visible=!1,this.$el.hide().removeClass("dragover"),this.trigger("hide")},initialize:function(b){this.options=b,this.visible=!1,this.leaving=!1,this.timeout=-1,$(document).on(a,$.proxy(this.onDrag,this)),this.$el.on("dispose",function(a){this.dispose(a)}.bind(this))},isFile:function(a){var b=a.originalEvent.dataTransfer;return _.browser.Firefox?"dragleave"===a.type?"none"===b.dropEffect:"none"!==b.dropEffect:_(b.types).contains("Files")||_(b.types).contains("application/x-moz-file")},getFiles:function(a){var b=_(a.originalEvent.dataTransfer.files).toArray(),c=this.options.filter;return _.isRegExp(c)?_(b).filter(function(a){return c.test(a.name)}):b},onDragenter:function(a){$(a.currentTarget).parent().addClass("dragover")},onDragover:function(a){a.originalEvent.dataTransfer.dropEffect="copy"},onDragleave:function(a){$(a.currentTarget).parent().removeClass("dragover")},onDrop:function(a){var b=this.getFiles(a);this.trigger(b.length>0?"drop":"invalid",b,a)},render:function(){return this.$el.hide().append($('<div class="abs dropzone-caption">').text(this.options.caption||""),$('<div class="abs dropzone-dragover"><i class="fa fa-check"></i></div>'),$('<div class="abs dropzone-overlay">')),this},dispose:function(){this.stopListening(),$(document).off(a,this.onDrag)}});return{Inplace:b}}),define("io.ox/core/strings",["gettext!io.ox/core"],function(a){"use strict";function b(){c=[a("B"),a("KB"),a("MB"),a("GB"),a("TB"),a("PB"),a("EB"),a("ZB"),a("YB")]}var c;return{shortenUri:function(a,b){a=void 0!==a&&null!==a?a:"";var c=a.replace(/^https?:\/\//,""),d=c.length-b;if(0>=d)return c;var e=c.length/2,f=e-d/2-1,g=e+d/2+1;return c.substring(0,f)+"..."+c.substring(g,c.length)},fileSize:function(d,e){c||b();var f=0,g=c.length;e>10&&(e=10);for(var h=Math.pow(10,e||0);d>1024&&g>f;)d/=1024,f++;return a("%1$d %2$s",Math.round(d*h,1)/h,c[f])}}}),define("io.ox/core/attachments/backbone",["io.ox/core/folder/title","io.ox/core/capabilities"],function(a,b){"use strict";var c=function(){var a,b=0,c=$.Deferred(),d=function(){b=Math.floor(b+a/10),c.notify({loaded:b,total:a}),b/a>=1?c.resolve({data:["133713371337"]}):_.delay(d,1e3)};this.upload=function(b){return a=b.size,d(),c}},d=/\.(pdf|do[ct]x?|xlsx?|p[po]tx?)$/i,e=/\.(gif|bmp|tiff|jpe?g|gmp|png)$/i,f={localFile:function(a){var b=$.Deferred(),c=2*(_.device("retina")?240:120);return require(["io.ox/contacts/widgets/canvasresize"],function(d){d(a.fileObj,{width:c,height:c,crop:!1,quality:80,callback:function(c){var d=_.clone(a.get("meta"));d.previewUrl=c,b.resolve(d.previewUrl),a.set("meta",d)}})}),b},file:function(a){var b=$.Deferred(),c=_.device("retina")?240:120;return require(["io.ox/files/api"],function(d){var f=_.clone(a.get("meta"));f.previewUrl=d.getUrl(a.toJSON(),"view")+"&scaleType=cover&width="+c+"&height="+c,e.test(a.get("filename"))||(f.previewUrl+="&format=preview_image&session="+ox.session),b.resolve(f.previewUrl),a.set("meta",f)},b.reject),b},mail:function(a){var b=$.Deferred(),c=_.device("retina")?240:120;return require(["io.ox/mail/api"],function(d){var f=_.clone(a.get("meta"));f.previewUrl=d.getUrl(a.toJSON(),"view")+"&scaleType=cover&width="+c+"&height="+c,e.test(a.get("filename"))||(f.previewUrl+="&format=preview_image&session="+ox.session),b.resolve(f.previewUrl),a.set("meta",f)},b.reject),b}},g=Backbone.Model.extend({defaults:function(){return{filename:"",disp:"attachment",uploaded:1,meta:{}}},initialize:function(a){a instanceof window.Blob&&(this.fileObj=a,this.set("filename",a.name,{silent:!0}),this.set("uploaded",0,{silent:!0}),this.set("file_size",a.size,{silent:!0}))},getTitle:function(){return this.get("filename")},getShortTitle:function(){return a(this.getTitle(),30)},getSize:function(){return this.get("file_size")||this.get("size")||0},getExtension:function(){var a=String(this.get("filename")||"").split(".");return 1===a.length?"":a.pop().toLowerCase()},isFileAttachment:function(){return"attachment"===this.get("disp")||"inline"===this.get("disp")&&this.get("filename")},needsUpload:function(){return 0===this.get("uploaded")},previewUrl:function(){var a,c=b.has("document_preview"),g=this.get("filename");if(!this.isFileAttachment())return null;if(!(e.test(g)||c&&d.test(g)))return null;if(a=this.get("meta").previewUrl)return a;var h=f[this.get("group")];return h?h(this):null},upload:function(){if("FormData"in window){var a=new FormData;a.append("file",this.fileObj);var b=(new c).upload(this.fileObj),d=this;b.then(function(){var a="appsuite/v=7.6.0.20140716.154321/apps/themes/default/dummypicture.png",b=_.clone(d.get("meta"));b.previewUrl=b.previewUrl||a,d.set("meta",b),d.trigger("upload:complete")},function(){},function(a){d.set("uploaded",a.loaded/a.total)})}}}),h=Backbone.Collection.extend({model:g,fileAttachments:function(){return this.filter(function(a){return a.isFileAttachment()})}});return{Model:g,Collection:h}}),define("io.ox/core/attachments/view",["io.ox/core/attachments/backbone","io.ox/core/strings","gettext!io.ox/core","less!io.ox/core/attachments/style"],function(a,b,c){"use strict";var d=Backbone.View.extend({scrollStep:120,openByDefault:!1,events:{"click .toggle-details":"onToggleDetails","click .toggle-mode":"onToggleMode","click .scroll-left":"scrollLeft","click .scroll-right":"scrollRight"},initialize:function(a){this.options=_.extend({AttachmentView:f,editable:!1,mode:"list"},a),this.listenTo(this.collection,"add",this.addAttachment),this.$el.addClass("mail-attachment-list").addClass(_.device("touch")?"touch":""),this.options.editable&&this.$el.addClass("editable"),this.$header=$('<header role="heading">'),this.$list=$('<ul class="inline-items">'),this.$preview=$('<ul class="inline-items preview">'),this.isListRendered=!1,this.listenTo(this.collection,"add remove reset",function(){var a=this.getValidModels().length;this.$el.toggleClass("empty",0===a),this.updateScrollControls(),this.renderSummary(a)}),this.$el.toggleClass("empty",0===this.getValidModels().length)},render:function(){return this.renderHeader(),this.$el.append(this.$header,$('<div class="list-container">').append(this.$list),$('<div class="preview-container">').append($('<button type="button" class="scroll-left"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>'),$('<button type="button" class="scroll-right"><i class="fa fa-chevron-right" aria-hidden="true"></i></button>'),this.$preview)),this.updateScrollControls(),this.openByDefault&&this.toggleDetails(),this},renderHeader:function(){this.$header.append($('<a href="#" class="toggle-details" tabindex="1">').append($('<i class="fa toggle-caret" aria-hidden="true">'),$('<i class="fa fa-paperclip" aria-hidden="true">'),$('<span class="summary">')),$('<span class="links">'),$('<a href="#" class="pull-right toggle-mode">').append('<i class="fa">')),this.renderSummary()},renderSummary:function(a){a=a||this.getValidModels().length,this.$header.find(".summary").text(c.format(c.ngettext("%1$d attachment","%1$d attachments",a),a))},renderList:function(){function a(a,b,c){b.append(_(a).map(this.renderAttachment.bind(this,c)))}var b=this.getValidModels();a.call(this,b,this.$list,"list"),a.call(this,b,this.$preview,"preview"),this.isListRendered=!0},renderAttachment:function(a,b){return new this.options.AttachmentView({mode:a,model:b}).render().$el},addAttachment:function(a){this.isListRendered&&(this.$list.append(this.renderAttachment("list",a)),this.$preview.append(this.renderAttachment("preview",a)))},filter:function(a){return a.isFileAttachment()},getValidModels:function(){return this.collection.filter(this.filter,this)},toggleDetails:function(){this.$el.toggleClass("open"),this.isListRendered||this.renderList()},onToggleDetails:function(a){a.preventDefault(),this.toggleDetails()},onToggleMode:function(a){a.preventDefault(),this.$el.toggleClass("show-preview"),this.$preview.trigger("scroll"),this.updateScrollControls()},scrollLeft:function(){this.scrollList(-1)},scrollRight:function(){this.scrollList(1)},scrollList:function(a){var b=this.getScrollIndex()+a,c=this.getMaxScrollIndex();0>b||b>c||(this.updateScrollControls(b),this.$preview.stop(!0,!1).animate({scrollLeft:b*this.scrollStep},"fast"))},getScrollIndex:function(){return Math.round(this.$preview.scrollLeft()/this.scrollStep)},getMaxScrollIndex:function(){var a=this.$preview.width(),b=this.$preview.prop("scrollWidth");return Math.max(0,Math.ceil((b-a)/this.scrollStep))},updateScrollControls:function(a,b){void 0===a&&(a=this.getScrollIndex());var b=this.getMaxScrollIndex();this.$(".scroll-left").attr("disabled",0>=a?"disabled":null),this.$(".scroll-right").attr("disabled",a>=b?"disabled":null)}}),e=Backbone.View.extend({className:"preview",initialize:function(){this.listenTo(this.model,"change:meta",function(){this.$el.hasClass("lazy")||(this.$(".fallback").remove(),this.render())})},lazyload:function(){_.defer(function(){this.$el.lazyload({container:this.$el.closest("ul"),effect:"fadeIn"})}.bind(this))},getColor:function(a){return/^do[ct]x?$/.test(a)?"#2C5897":/^xlsx?$/.test(a)?"#1D7047":/^p[po]tx?$/.test(a)?"#D04423":/^pdf$/.test(a)?"#C01E07":/^(zip|gz|gzip|tgz)$/.test(a)?"#FF940A":void 0},fallback:function(){var a,b=this.model.getExtension();b&&(a=this.getColor(b),this.$el.append($('<div class="abs fallback">').css({color:a&&"white",backgroundColor:a}).text(b)))},render:function(){var a=this.model.previewUrl();return _.isString(a)?(this.$el.addClass("lazy").attr("data-original",a),this.lazyload()):this.fallback(),this}}),f=Backbone.View.extend({tagName:"li",className:"item",events:{"click .remove":"onRemove"},attributes:function(){return{"data-id":this.model.get("id")}},initialize:function(a){this.options=_.extend({mode:"list"},a),this.preview="preview"===this.options.mode&&new e({model:this.model,el:this.el}),this.listenTo(this.model,{"change:uploaded":function(a){var b=a.get("uploaded")*this.$el.width();this.$(".progress").width(b)},"upload:complete":function(){this.render()},remove:this.onRemoveModel})},onRemove:function(a){a.preventDefault(),this.model.collection.remove(this.model)},onRemoveModel:function(){this.remove()},render:function(){return this.$el.append($('<span class="file">'),$('<span class="filesize">'),this.model.needsUpload()?$('<div class="progress">'):$()),this.preview&&this.preview.render(),this.preview||this.renderFileSize(),this.renderContent(),this.renderControls(),this},renderFileSize:function(){var a=this.model.getSize();a&&this.$(".filesize").text(" ("+b.fileSize(a)+")")},renderContent:function(){this.$(".file").text(this.model.getShortTitle())},renderControls:function(){this.$el.append($('<a href="#" class="control remove" tabindex="1">').attr("title",c("Remove attachment")).append($('<i class="fa fa-trash-o">')))}});return{List:d,View:f,Preview:e,Model:a.Model,Collection:a.Collection}}),define("io.ox/core/api/user",["io.ox/core/http","io.ox/core/api/factory","io.ox/contacts/util","io.ox/core/date","io.ox/core/capabilities"],function(a,b,c,d,e){"use strict";var f=function(a){return a.id?(a.birthday&&1===new d.UTC(a.birthday).getYear()&&(a.birthday=c.julianToGregorian(a.birthday)),a):(_(a).each(function(a){a.birthday&&1===new d.UTC(a.birthday).getYear()&&(a.birthday=c.julianToGregorian(a.birthday))}),a)},g=b({module:"user",keyGenerator:function(a){return String(a.id)},requests:{all:{columns:"1,20,500",extendColumns:"io.ox/core/api/user/all",sort:"500",order:"asc"},list:{action:"list",columns:"1,20,500,501,502,505,524,555,606,614",extendColumns:"io.ox/core/api/user/list"},get:{action:"get"},search:{action:"search",columns:"1,20,500,524",extendColumns:"io.ox/core/api/user/search",sort:"500",order:"asc",getData:function(a){return{pattern:a}}}},pipe:{get:f,search:f}});return ox.rampup.user&&ox.rampup.user.id===ox.user_id&&g.caches.get.add(ox.rampup.user),g.update=function(b){return _.isEmpty(b.data)?$.when():void require(["io.ox/contacts/api"],function(f){return b.data.birthday&&1===new d.UTC(b.data.birthday).getYear()&&(b.data.birthday=c.gregorianToJulian(b.data.birthday)),a.PUT({module:"user",params:{action:"update",id:b.id,folder:b.folder,timestamp:b.timestamp||_.then()},data:b.data,appendColumns:!1}).pipe(function(){return g.get({id:b.id},!1).pipe(function(a){return $.when(g.caches.get.add(a),g.caches.all.clear(),g.caches.list.remove({id:b.id}),f.caches.get.remove({folder_id:a.folder_id,id:a.contact_id}),f.caches.all.grepRemove(b.folder+f.DELIM),f.caches.list.remove({id:a.contact_id,folder:b.folder}),f.clearFetchCache()).done(function(){g.trigger("update:"+_.ecid(a),a),g.trigger("update",a),g.trigger("refresh.list"),6===a.folder_id&&e.has("!gab")||f.get({folder_id:a.folder_id,id:a.contact_id}).done(function(a){f.trigger("update:"+_.ecid(a),a),f.trigger("update",a)})})})})})},g.editNewImage=function(b,c,d){var e=function(a){return $.when(g.caches.get.clear(),g.caches.all.clear(),g.caches.list.clear()).pipe(function(){g.trigger("refresh.list"),g.trigger("update",{id:b.id})}),a};if("FormData"in window&&d instanceof window.File){var f=new FormData;return f.append("file",d),f.append("json",JSON.stringify(c)),a.UPLOAD({module:"user",params:{action:"update",id:b.id,timestamp:b.timestamp||_.then()},data:f,fixPost:!0}).pipe(e)}return a.FORM({module:"user",action:"update",form:d,data:c,params:{id:b.id,folder:b.folder_id,timestamp:b.timestamp||_.then()}}).pipe(e)},g.getName=function(a){return g.get({id:a}).pipe(function(a){return _.noI18n(a.display_name||a.email1||"")})},g.getGreeting=function(a){return g.get({id:a}).pipe(function(a){return _.noI18n(a.first_name||a.display_name||a.email1||"")})},g.getTextNode=function(a){var b=document.createTextNode(_.noI18n(""));return g.get({id:a}).done(function(a){b.nodeValue=_.noI18n(a.display_name||a.email1)}).always(function(){_.defer(function(){b=null})}),b},g.getLink=function(a,b){return b=b?$.txt(_.noI18n(b)):g.getTextNode(a),$('<a href="#" class="halo-link">').append(b).data({internal_userid:a})},g.getCurrentUser=function(){return require(["io.ox/core/settings/user"]).then(function(a){return a.getCurrentUser()})},g}),define("io.ox/contacts/util",["io.ox/core/util","settings!io.ox/contacts","gettext!io.ox/contacts","io.ox/core/date"],function(a,b,c,d){"use strict";function e(a,b){var c=new Array(a);return c[a-1]=_.noI18n(b),{format:_.noI18n("%"+a+"$s"),params:c}}function f(a){return/^(<span class="title">)?(dr\.?|prof\.?)/i.test(a)?a:""}function g(a){var b,c,e,f=new d.UTC(a);return b=Math.floor(f.getMonth()<2?(f.getYear()-1)/100:f.getYear()/100),c=Math.floor(b/4),e=b%4,Math.abs((3*c+e-2)*d.DAY)}var h={getSortName:function(a){return a=_.pick(a,"first_name","last_name","display_name"),this.getFullName(a).toLowerCase()},getFullNameFormat:function(d){if(d.last_name&&d.first_name){var g,h=f(d.title),i=b.get("fullNameFormat","auto"),j=[_.noI18n(d.first_name),_.noI18n(d.last_name)];return h&&j.push(_.noI18n(h)),g="firstname lastname"===i?h?"%3$s %1$s %2$s":"%1$s %2$s":"lastname, firstname"===i?h?"%3$s %2$s, %1$s":"%2$s, %1$s":c(h?"%3$s %2$s, %1$s":"%2$s, %1$s"),{format:g,params:j}}return d.last_name?e(2,d.last_name):d.first_name?e(1,d.first_name):d.display_name?e(4,a.unescapeDisplayName(d.display_name)):{format:_.noI18n(""),params:[]}},getFullName:function(a,b){var d,e=a;return b===!0&&(e={},_(["title","first_name","last_name","display_name"]).each(function(b){a[b]&&(e[b]='<span class="'+b+'">'+_.escape(a[b])+"</span>")})),d=this.getFullNameFormat(e),c.format(d.format,d.params)},getDisplayName:function(b){return b.display_name?a.unescapeDisplayName(b.display_name):b.last_name&&b.first_name?b.last_name+", "+b.first_name:b.last_name||b.first_name||""},getMailFullNameFormat:function(b){return b.last_name&&b.first_name?{format:c.pgettext("mail address","%1$s %2$s"),params:[_.noI18n(b.first_name),_.noI18n(b.last_name)]}:b.last_name?e(2,b.last_name):b.first_name?e(1,b.first_name):b.display_name?e(4,a.unescapeDisplayName(b.display_name)):{format:_.noI18n(""),params:[]}},getMailFullName:function(a){var b=h.getMailFullNameFormat(a);return c.format(b.format,b.params)},getMailFormat:function(a){return a.email1?e(1,a.email1):a.email2?e(2,a.email2):a.email3?e(3,a.email3):{format:_.noI18n(""),params:[]}},getMail:function(a){return a?(a.email1||a.email2||a.email3||a.mail||"").toLowerCase():""},getJob:function(a){var b=_([a.company,a.position]).compact();return b.length?b.join(", "):a.email1||""},nameSort:function(a,b){var c,d;return c=void 0===a.display_name?a.mail:a.display_name.toLowerCase(),d=void 0===b.display_name?b.mail:b.display_name.toLowerCase(),d>c?-1:c>d?1:0},calcMailField:function(a,b){var c,d;return d=[a.email1,a.email2,a.email3],_.each(d,function(a,d){b===a&&(c=d+1)}),c},gregorianToJulian:function(a){return new d.UTC(a-g(a)).getTime()},julianToGregorian:function(a){return new d.UTC(a+g(a)).getTime()}};return h}),define("l10n/ja_JP/io.ox/collation",function(){"use strict";var a,b=["あ い う え お ゔ","か き く け こ が ぎ ぐ げ ご","さ し す せ そ ざ じ ず ぜ ぞ","た ち つ て と だ ぢ づ で ど","な に ぬ ね の","は ひ ふ へ ほ ば び ぶ ぺ ぼ ぱ ぴ ぷ ぺ ぽ","ま み む め も","や ゆ よ","ら り る れ ろ","わ ゐ を ゑ ん"],c={},d={},e=0,f=[],g=/^[a-zäöü]/i;return _(b).each(function(a){f.push(a[0]),_(a.split(" ")).each(function(b){c[b]=e++,d[b]=a[0]})}),a=function(a,b){return a=a.sort_name[0],b=b.sort_name[0],void 0===a&&void 0===b?0:void 0===a?1:void 0===b?-1:a in c&&b in c?c[a]-c[b]:a in c?-1:b in c?1:(a=a.toUpperCase(),b=b.toUpperCase(),g.test(a)||g.test(b)?g.test(a)?g.test(b)?b>a?-1:a>b?1:0:1:-1:b>a?-1:a>b?1:0)},{sorter:a,index:f,isKana:function(a){return void 0!==d[a]},getKanaLabel:function(a){return d[a]||""}}}),define("io.ox/core/tk/list-selection",["settings!io.ox/core"],function(a){"use strict";function b(a){this.view=a,this.behavior=e,this.view.$el.on("keydown",c,$.proxy(this.onKeydown,this)).on(d?"tap":"mousedown click",c,$.proxy(this.onClick,this)).on("focus",$.proxy(function(){var a=this.getItems(),b=a.filter('[tabindex="1"]'),c=a.index(b),d=this.get();d.length<=1?this.select(c>-1?c:0):this.focus(c,a)},this)).on(d?"tap":"click",c,$.proxy(function(a){this.isMultiple(a)||this.triggerAction(a)},this)).on("dblclick",c,$.proxy(function(a){this.triggerDouble(a)},this)).on("contextmenu",function(a){a.preventDefault()}),d&&this.view.$el.on("swipeleft",c,$.proxy(this.onSwipeLeft,this)).on("swiperight",c,$.proxy(this.onSwipeRight,this)).on("tap",".swipe-left-content",$.proxy(this.onTapRemove,this))}var c=".selectable",d=_.device("touch"),e=a.get("selectionMode","normal"),f={get:function(){return _(this.view.$el.find(c+".selected")).map(function(a){return $(a).attr("data-cid")})},getItems:function(){return this.view.$el.find(c)},getNode:function(a){this.getItems().filter('[data-cid="'+a+'"]')},getPosition:function(a){return a=a||this.getItems(),a.index(a.filter(".precursor"))},check:function(a){a.addClass("selected").attr("aria-selected",!0)},uncheck:function(a){a.removeClass("selected no-checkbox").attr({"aria-selected":!1,tabindex:"-1"})},toggle:function(a){a.hasClass("selected")?this.uncheck(a):this.check(a)},set:function(a){if(_.isArray(a)){var b=this.getItems(),c={},d=this,e=-1;this.clear(),_(a).each(function(a){var b="string"==typeof a?a:_.cid(a);c[b]=!0}),b.each(function(a){var b=$(this),f=b.attr("data-cid");f in c&&(d.check(b),e=a)}),e>-1&&b.eq(e).attr("tabindex","1")}},triggerAction:function(a){var b=$(a.currentTarget).attr("data-cid");this.view.trigger("selection:action",[b])},triggerDouble:function(a){var b=$(a.currentTarget).attr("data-cid");this.view.trigger("selection:doubleclick",[b])},triggerChange:function(a){a=a||this.getItems();var b=this.get(),c="selection:change";0===b.length?c+=" selection:empty":1===b.length?c+=" selection:one":b.length>1&&(c+=" selection:multiple"),c+=a.length>0&&a.length===b.length?" selection:all":" selection:subset",this.view.trigger(c,b)},clear:function(a){a=a||this.getItems(),this.resetTabIndex(a),this.resetCheckmark(a),this.reset()},reset:function(){this.triggerChange()},add:function(){},remove:function(a,b){b=b||this.getNode(a),b.is(".selected")&&this.triggerChange()},isRange:function(a){return a&&a.shiftKey},isCheckmark:function(a){return a&&$(a.target).is(".list-item-checkmark, .fa.fa-checkmark")},isMultiple:function(a){return a&&(a.metaKey||a.ctrlKey||this.isCheckmark(a))},resetTabIndex:function(a,b){a=a.filter('[tabindex="1"]'),a.not(b).attr("tabindex","-1")},resetCheckmark:function(a){a.filter(".selected").removeClass("selected no-checkbox"),_.defer(function(){a.filter(".preserved").not(".selected").fadeOut("fast",function(){$(this).remove()})})},resetSwipe:function(a){var b=a.filter(".swipe-left");return b.removeClass("swipe-left").find(".swipe-left-content").remove(),!!b.length},focus:function(a,b){b=b||this.getItems();var c=b.eq(a).attr("tabindex","1").focus();return _.device("chrome")&&c.hide(0,function(){$(this).show()}),c},pick:function(a,b,c){var d;b=b||this.getItems(),this.isRange(c)?this.pickRange(a,b):(b.removeClass("precursor"),d=this.focus(a,b).addClass("precursor"),this.isMultiple(c)?this.pickMultiple(d,b):this.pickSingle(d))},pickRange:function(a,b){var c=this.getPosition(b),d=Math.min(a,c),e=Math.max(a,c);this.check(b.slice(d,e+1)),this.focus(a,b)},pickMultiple:function(a,b){a.hasClass("selected no-checkbox")?a.removeClass("no-checkbox"):(b.filter(".no-checkbox").removeClass("selected no-checkbox").attr("aria-selected",!1),this.toggle(a))},pickSingle:function(a){this.check(a)},select:function(a,b){b=b||this.getItems(),a>=b.length||(this.resetCheckmark(b),this.resetTabIndex(b,b.eq(a)),this.pick(a,b),this.selectEvents(b))},selectEvents:function(a){this.triggerChange(a)},selectAll:function(a){a=a||this.getItems();var b=a.slice(0,a.length);b.removeClass("no-checkbox"),this.check(b),this.focus(0,a),this.triggerChange(a)},selectNone:function(){this.clear(),this.triggerChange()},move:function(a){var b=this.getItems(),c=this.getPosition()+a;0>c?c=0:c>=b.length&&(c=b.length-1),this.select(c,b),this.view.trigger("selection:action",this.get())},previous:function(){this.move(-1)},next:function(){this.move(1)},dodge:function(){var a=this.getItems(),b=a.filter(".selected"),c=b.length,d=a.index(b.first()),e=this.select.bind(this);return a.length===c?this.clear():d+c===a.length?e(d-1,a):void a.slice(d).each(function(b){return $(this).hasClass("selected")?void 0:(e(d+b,a),!1)})},onCursorUpDown:function(a){var b=this.getItems(),c=$(document.activeElement),d=(b.index(c)||0)+(38===a.which?-1:1);if(!(0>d)){if(d>=b.length)return this.view.$el.scrollTop(16777215);a.preventDefault(),d=this.isMultiple(a)?38===a.which?0:-1:d,this.resetTabIndex(b,b.eq(d)),this.resetCheckmark(b),this.pick(d,b,a),this.isMultiple(a)||this.isRange(a)?this.triggerChange(b):this.selectEvents(b)}},onPageUpDown:function(a){a.preventDefault();var b,c=this.getItems(),d=c.first().outerHeight();d&&(b=Math.floor(this.view.$el.height()/d),this.move(33===a.which?-b:b))},onKeydown:function(a){switch(a.which){case 13:this.triggerAction(a);break;case 65:case 97:(a.ctrlKey||a.metaKey)&&(a.preventDefault(),this.selectAll());break;case 8:case 46:a.preventDefault(),this.view.trigger("selection:delete",this.get());break;case 38:case 40:this.onCursorUpDown(a);break;case 33:case 34:this.onPageUpDown(a)}},onClick:function(a){if("tap"===a.type&&(a.preventDefault(),a.stopPropagation()),!("mousedown"===a.type&&!this.isMultiple(a)&&$(a.currentTarget).is(".selected")||"click"===a.type&&this.isMultiple(a)&&!d)){var b=this.getItems(),c=$(a.currentTarget),e=b.index(c)||0,f=this.get();d&&this.resetSwipe(b)||a.isDefaultPrevented()&&"tap"!==a.type||(this.isMultiple(a)||this.resetCheckmark(b),this.resetTabIndex(b,b.eq(e)),this.pick(e,b,a),_.isEqual(f,this.get())||this.triggerChange(b))}},onSwipeLeft:function(a){var b=$(a.currentTarget);b.hasClass("swipe-left")||(this.resetSwipe(this.getItems()),this.renderInplaceRemove(b),b.addClass("swipe-left"))},onSwipeRight:function(a){this.resetSwipe($(a.currentTarget))},inplaceRemoveScaffold:$('<div class="swipe-left-content"><i class="fa fa-trash-o"/></div>'),renderInplaceRemove:function(a){a.append(this.inplaceRemoveScaffold.clone())},onTapRemove:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=$(a.currentTarget).closest(c),d=b.attr("data-cid");this.view.trigger("selection:delete",[d])},onFocus:function(){},getBehavior:function(){return this.behavior}},g={pickSingle:function(a){a.addClass("selected no-checkbox").attr("aria-selected",!0)},onKeydown:function(a){if(32===a.which){a.preventDefault();var b=this.getItems().filter(".selected");1===b.length?b.find(".list-item-checkmark").trigger("mousedown"):0===b.length&&(b=$(this.getItems()[this.getItems().index($(document.activeElement))]),b.find(".list-item-checkmark").trigger("mousedown"))}else f.onKeydown.call(this,a)},onClick:function(a){var b=this.get();f.onClick.call(this,a),_.isEqual(b,this.get())&&"mousedown"===a.type&&this.isMultiple(a)&&this.triggerChange(this.getItems())},selectEvents:function(a){var b=this.view.app.props.get("layout")||"list";"list"===b?this.triggerChange(a):this.view.trigger("selection:change selection:action",this.get())}};return _.extend(b.prototype,f),"alternative"===e&&_.extend(b.prototype,g),b}),define("io.ox/mail/detail/content",["io.ox/mail/api","io.ox/core/util","io.ox/core/emoji/util","io.ox/core/extensions","io.ox/core/capabilities","settings!io.ox/mail","gettext!io.ox/mail","io.ox/mail/detail/links"],function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){_(a.querySelectorAll(b)).each(c)}function i(a,b){for(;a;)if(a=a.parentNode,a&&a.matches(b))return!0;return!1}function j(a){var b=3===a.nodeType&&String(a.nodeValue).trim()||"",c=b?b+" ":"";return _(a.childNodes).each(function(a){"STYLE"!==a.tagName&&(c+=j(a))}),c}function k(a){return $(a).parent().hasClass("blockquote-toggle")}function l(a,b){if("absolute"!==getComputedStyle(b).position)return a;if(k(b))return a;var c=$(b).position();return c&&(a.x=Math.max(a.x,c.left+b.offsetWidth),a.y=Math.max(a.y,c.top+b.offsetHeight),a.found=!0),a}function m(a,b){var c={x:a.scrollWidth,y:a.scrollHeight,found:!1},d=a.offsetWidth,e=a.offsetHeight;!b&&(c.x>=d||c.y>=e)&&(c=_(a.querySelectorAll("*")).reduce(l,c)),c.found&&($(a).css("overflow-x","auto"),c.y>e&&$(a).css("height",Math.round(c.y)+"px")),$(a).one("resize",function(){m(this,b)})}var n=function(a){var b,c=String(a||"").split(/<br\s?\/?>/i),d=!1,e=/^&gt;( |$)/i,f=0,g=c.length,h=[];for(a="";g>f;f++)b=c[f],e.test(b)?d?h.push(b.replace(e,"")):(d=!0,h=[b.replace(e,"")]):d?(h=$.trim(h.join("\n")).replace(/\n/g,"<br>"),a=a.replace(/<br>$/,"")+'<blockquote type="cite"><p>'+h+"</p></blockquote>"+b,d=!1):a+=b+"<br>";return a.replace(/<br>$/,"")},o=/^text\/html$/i,p=/(&quot;([^&]+)&quot;|"([^"]+)"|'([^']+)')(\s|<br>)+&lt;([^@]+@[^&\s]+)&gt;/g,q=/(<img[^>]+src=")\/ajax/g,r=function(){var a={":-)":"&#x1F60A;",":)":"&#x1F60A;",";-)":"&#x1F609;",";)":"&#x1F609;",":-D":"&#x1F603;",":D":"&#x1F603;",":-|":"&#x1F614;",":|":"&#x1F614;",":-(":"&#x1F61E;",":(":"&#x1F61E;"},b=/(&quot)?([:;]-?[(|)D])(\W|$)/g;return function(c){return f.get("displayEmoticons")&&e.has("emoji")&&(c=c.replace(b,function(b,c,d){if(c)return b;var e=$("<div>").html(a[d]).text();return e?e:d})),c}}(),s=/^https?:\S+$/i,t=function(a){return a=$.trim(a).replace(/[\n\r]/g,"").replace(/^\s*(<br\s*\/?>\s*)+/g,"").replace(/(<br\/?>\s*){3,}/g,"<br><br>").replace(/<\/blockquote>\s*(<br\/?>\s*)*<blockquote[^>]+>/g,"<br><br>").replace(p,function(){var a=_(arguments).toArray();return/<br\/?>/.test(a[0])?a[0]:/@/.test(a[2])?a[0]:'<a href="mailto:'+a[6]+'" target="_blank">'+a[2]+(a[3]||"")+"</a>"}),a=_(a.split(/(<[^>]+>)/)).map(function(a){return"<"===a[0]?a:s.test(a)?a:a=r(a)}).join(""),f.get("isColorQuoted",!0)&&(a=n(a)),a};d.point("io.ox/mail/detail/source").extend({id:"empty",index:100,process:function(a){""===a.source&&(a.stopPropagation(),a.source='<div class="no-content">'+g("This mail has no content")+"</div>")}}),d.point("io.ox/mail/detail/source").extend({id:"images",index:200,process:function(a){a.source=a.source.replace(q,"$1"+ox.apiRoot)}}),d.point("io.ox/mail/detail/source").extend({id:"emoji",index:300,process:function(a){a.processedEmoji=!1,a.source=c.processEmoji(a.source,function(b,c){a.processedEmoji=!c.loaded,a.source=b})}}),d.point("io.ox/mail/detail/source").extend({id:"plain-text-links",index:300,process:function(a){a.isLarge||(a.source=a.source.replace(/(<a href="https?:\/\/[^"]+" target="_blank">https?:\/\/[^<]+<\/a>) &lt;<a href="https?:\/\/[^"]+" target="_blank">https?:\/\/[^<]+<\/a>&gt;/g,"$1"))}}),d.point("io.ox/mail/detail/source").extend({id:"remove-wbr",index:400,process:function(a){a.isLarge||(a.source=a.source.replace(/<wbr>/g,""))}});var u=function(a){return/target/.test(a)?a.replace(/(target="[^"]*")/i,'target="_blank"'):a.replace(">",' target="_blank">')};d.point("io.ox/mail/detail/source").extend({id:"link-target",index:500,process:function(a){a.source=a.source.replace(/<a[^>]*href=(?:\"|\')(https?:\/\/[^>]+)(?:\"|\')[^>]*>/g,u)}}),d.point("io.ox/mail/detail/source").extend({id:"white-space",index:600,process:function(a){a.isLarge||(a.source=a.source.replace(/^(<div[^>]+>)(\s|&nbsp;|\0x20|<br\/?>|<p[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/p>|<div[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/div>)+/g,"$1").replace(/\s*<\/html>\s*$/g,"").replace(/(\s|&nbsp;|\0x20|<br\/?>|<p[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/p>|<div[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/div>)+<\/div>$/g,""))}}),d.point("io.ox/mail/detail/content").extend({id:"pseudo-blockquotes",index:100,process:function(a){a.isHTML&&h(this,'div[style*="none none none solid"][style*="1.5pt"]',function(a){$(a).replaceWith($('<blockquote type="cite">').append($(a).contents()))})}}),d.point("io.ox/mail/detail/content").extend({id:"nested",index:500,process:function(b){if(b.isHTML){var c=b.data;!("folder_id"in c)&&"filename"in c&&h(this,'img[src^="cid:"]',function(d){var e,f="<"+String(d.getAttribute("src")||"").substr(4)+">",g=_.chain(b.data.attachments).filter(function(a){return a.cid===f
}).first().value();g&&(e=a.getUrl(_.extend(g,{mail:c.parent}),"view"),d.setAttribute("src",e))})}}}),d.point("io.ox/mail/detail/content").extend({id:"fixed-width",index:600,process:function(a){a.isText&&f.get("useFixedWidthFont",!1)&&$(this).addClass("fixed-width-font")}}),d.point("io.ox/mail/detail/content").extend({id:"color-quotes",index:700,process:function(){f.get("isColorQuoted",!0)&&$(this).addClass("colorQuoted")}}),d.point("io.ox/mail/detail/content").extend({id:"clean-blockquotes",index:800,process:function(){h(this,"blockquote",function(a){a.removeAttribute("style"),a.removeAttribute("type")})}}),d.point("io.ox/mail/detail/content").extend({id:"link-target",index:900,process:function(){h(this,"a",function(a){var b=$(a).filter('[href^="mailto:"]').addClass("mailto-link").attr("target","_blank"),c=b.text();c.search(/^mailto:/)>-1&&(c=c.substring(7),c=c.split(/\?/,2)[0],b.text(c))})}});var v=function(a){a.preventDefault(),$(this).hide().prev().slideDown("fast",function(){$(a.delegateTarget).trigger("resize")})};return d.point("io.ox/mail/detail/content").extend({id:"auto-collapse",index:1e3,process:function(a){a.options.autoCollapseBlockquotes!==!1&&f.get("features/autoCollapseBlockquotes",!0)===!0&&(h(this,"blockquote",function(a){if(!i(a,"blockquote")){var b=j(a);b.length>300&&(b=b.substr(0,300)+"…",$(a).addClass("collapsed-blockquote").after($('<div class="blockquote-toggle">').append($('<i class="fa fa-ellipsis-h" tabindex="1">').attr("title",g("Show quoted text")),$.txt(b))))}}),$(this).on("click",".blockquote-toggle",v))}}),{get:function(a,b){if(!a||!a.attachments)return{content:$(),isLarge:!1,type:"text/plain"};var e,f=new d.Baton({data:a,options:b||{},source:"",type:"text/plain"});try{_(a.attachments).find(function(a){return/^text\/(plain|html)$/i.test(a.content_type)?(f.type=a.content_type,!0):!1}),_(a.attachments).each(function(a){"inline"===a.disp&&a.content_type===f.type&&(f.source+=a.content)}),f.source=$.trim(f.source),f.isHTML=o.test(f.type),f.isText=!f.isHTML,f.isLarge=f.source.length>1024*(_.device("chrome >= 30")?64:32),d.point("io.ox/mail/detail/source").invoke("process",$(),f),f.isHTML?(e=document.createElement("DIV"),e.className="content noI18n",e.innerHTML=f.source,h(e,"script, base, meta",function(a){a.parentNode.remove(a)})):(e=document.createElement("DIV"),e.className="content plain-text noI18n",e.innerHTML=t(f.source),f.processedEmoji||c.processEmoji(f.source,function(a,b){f.processedEmoji=!b.loaded,e.innerHTML=t(a)})),f.isLarge||d.point("io.ox/mail/detail/content").invoke("process",e,f),/absolute/i.test(f.source)&&setTimeout(m,10,e,f.isLarge)}catch(g){console.error("mail.getContent",g.message,g,a)}return{content:e,isLarge:f.isLarge,type:f.type,processedEmoji:f.processedEmoji}}}}),define("io.ox/core/emoji/util",["settings!io.ox/mail/emoji"],function(a){"use strict";var b,c=function(c){var d=b.converterFor({from:"all",to:"unified"});return c=d(c),c=b.unifiedToImageTag(c,{forceEmojiIcons:a.get("forceEmojiIcons",!1)})};return{processEmoji:function(a,d){function e(a,b){return d&&d(a,{loaded:!!b}),a}var f=a.length>1024*(_.device("chrome >= 30")?64:32),g=/[\xa9\xae\u203c\u2049\u20e3\u2122-\uffff]/.test(a);return f||!g?e(a):b?e(c(a)):(require(["io.ox/emoji/main"],function(d){b=d,e(c(a),!0)}),a)},imageTagsToUnified:function(a){var b=$("<div>").append(a);return b.find("img[data-emoji-unicode]").each(function(a,b){$(b).replaceWith($(b).attr("data-emoji-unicode"))}),b.html()}}}),define("io.ox/mail/detail/links",["io.ox/mail/api","io.ox/core/util","io.ox/core/emoji/util","io.ox/core/extensions","settings!io.ox/mail","gettext!io.ox/mail"],function(a,b,c,d,e,f){"use strict";function g(a){var b=a.match(/^https?:\/\/([^\/#]+)/i);return null===b||0===b.length?!1:"test"===b[1]?!0:_(ox.serverConfig.hosts).indexOf(b[1])>-1}function h(a){var b=$();return a.prefix&&(b=b.add(l(a.prefix))),b=b.add(a.replacement),a.suffix&&(b=b.add(l(a.suffix))),$(a.node).replaceWith(b),b}function i(a){var b=a.nodeValue.match(q);if(null===b||0===b.length)return a;var c=b[1],d=b[2],e=b[4];d=d.replace(/([.,;!?]+)$/,function(a,b){return e=b+e,""});var f=$('<a href="#" target="_blank">').attr("href",d).text(d);return{node:a,prefix:c,replacement:f,suffix:e}}function j(a){var b=a.nodeValue.match(s);if(null===b||0===b.length)return a;var c=b[1],d=b[2],e=b[4],f=$('<a href="#" class="mailto-link" target="_blank">').attr("href","mailto:"+d).data({address:d}).text(d);return{node:a,prefix:c,replacement:f,suffix:e}}function k(a){var b=a.nodeValue.match(u);if(null===b||0===b.length)return a;var c=b[1],d=b[4],e=b[7],f=b[8],g=$('<a href="#" class="mailto-link" target="_blank">').attr("href","mailto:"+e).data({address:e,name:d}).text(d);return{node:a,prefix:c,replacement:g,suffix:f}}function l(a){if(_.isString(a)&&(a=$.txt(a)),3===a.nodeType){for(var b in v){var c=v[b];if(c.test(a))return h(c.process(a))}return a}}$(document).on("click",".deep-link-files",function(a){a.preventDefault();var b=$(this).data();b.id?ox.load(["io.ox/core/tk/dialogs","io.ox/files/api","io.ox/files/fluid/view-detail","io.ox/core/notifications"]).done(function(c,d,e,f){var g=new c.SidePopup({tabTrap:!0}),h={getName:function(){return"io.ox/files"},folder:_.extend({set:function(a){ox.launch("io.ox/files/main",{folder:a,perspective:"fluid:list"}).done(function(){var b=this;ox.ui.Perspective.show(b,"fluid:list").done(function(){b.folder.get()===a?b.selection.set(a):b.folder.set(a).done(function(){b.selection.set(a)})})})},getData:function(){return $.Deferred().resolve(b)}},b)};g.show(a,function(a){a.busy(),d.get(_.cid(b.id)).done(function(b){a.idle().append(e.draw(b,h))}).fail(function(a){g.close(),f.yell(a)})})}):ox.launch("io.ox/files/main",{folder:b.folder,perspective:"fluid:list"}).done(function(){var a=this,c=b.folder,d=b.id;ox.ui.Perspective.show(a,"fluid:list").done(function(){a.folder.get()===c?a.selection.set(d):a.folder.set(c).done(function(){a.selection.set(d)})})})}),$(document).on("click",".deep-link-contacts",function(a){a.preventDefault();var b=$(this).data();ox.launch("io.ox/contacts/main",{folder:b.folder}).done(function(){var a=this,c=b.folder,d=b.id;a.folder.get()===c?a.getGrid().selection.set(d):a.folder.set(c).done(function(){a.getGrid().selection.set(d)})})}),$(document).on("click",".deep-link-calendar",function(a){a.preventDefault();var b=$(this).data();b.id?ox.load(["io.ox/core/tk/dialogs","io.ox/calendar/api","io.ox/calendar/view-detail"]).done(function(c,d,e){new c.SidePopup({tabTrap:!0}).show(a,function(a){a.busy(),d.get(b).done(function(b){a.idle().append(e.draw(b))})})}):ox.launch("io.ox/calendar/main",{folder:b.folder,perspective:"list"}).done(function(){var c=this,d=b.folder;ox.ui.Perspective.show(c,"week:week").done(function(e){c.folder.get()===d?e.view.trigger("showAppointment",a,b):c.folder.set(d).done(function(){e.view.trigger("showAppointment",a,b)})})})}),$(document).on("click",".deep-link-tasks",function(a){a.preventDefault();var b=$(this).data();ox.launch("io.ox/tasks/main",{folder:b.folder}).done(function(){var a=this,c=b.folder,d=b.id;a.folder.get()===c?a.getGrid().selection.set(d):a.folder.set(c).done(function(){a.getGrid().selection.set(d)})})}),$(document).on("click",".mailto-link",function(a){a.preventDefault();var b,c,d,e=$(this),f=e.data(),g={};if(f.address)b=f.address,c=f.name||f.address;else{d=e.attr("href").substr(7).split(/\?/,2),b=d[0],c=e.text(),g=_.deserialize(d[1]);for(var h in g)g[h.toLowerCase()]=g[h]}ox.registry.call("mail-compose","compose",{to:[[c,b]],subject:g.subject||"",attachments:[{content:g.body||""}]})});var m,n,o;!function(){var a="all prefix link app params param name suffix".split(" "),b={contacts:"contacts",calendar:"calendar",task:"tasks",infostore:"files"},c={contacts:f("Contact"),calendar:f("Appointment"),tasks:f("Task"),files:f("File")},d={contacts:f("Address Book"),calendar:f("Calendar"),tasks:f("Tasks"),files:f("Folder")},e=/^([\s\S]*)(http[^#]+#!?&?app=io\.ox\/(contacts|calendar|tasks|files)((&(folder|id|perspective)=[^&\s]+)+))([\s\S]*)$/i,h=/^([\s\S]*)(http[^#]+#m=(contacts|calendar|tasks|infostore)((&(f|i)=[^&\s]+)+))([\s\S]*)$/i;m=function(a){return e.test(a)||h.test(a)},n=function(c){var d=String(c).match(e.test(c)?e:h),f=_.object(a,d),g=_.deserialize(f.params,"&");return f.app=b[f.app]||f.app,$.extend(f,{folder:g.f,id:g.i},{folder:g.folder,id:g.id,perspective:g.perspective})},o=function(a){var b=n(a.nodeValue),e=$('<a role="button" href="#" target="_blank" class="deep-link btn btn-primary btn-xs" style="font-family: Arial; color: white; text-decoration: none;">').attr("href",b.link).text("id"in b?c[b.app]:d[b.app]);return g(b.link)&&e.addClass("deep-link-"+b.app).data(b),$(a).parent().attr("href")===b.link&&(a=$(a).parent().get(0)),{node:a,prefix:b.prefix,replacement:e,suffix:b.suffix}}}();var p=/^([\s\S]*)((http|https|ftp|ftps)\:\/\/\S+)([\s\S]*)$/i,q=/^([\s\S]*)((http|https|ftp|ftps)\:\/\/\S+)([\s\S]*)$/i,r=/^([\s\S]*?)([^"\s<,:;\(\)\[\]]+@([a-z0-9äöüß\-]+\.)+[a-z]{2,})([\s\S]*)$/i,s=/^([\s\S]*?)([^"\s<,:;\(\)\[\]]+@([a-z0-9äöüß\-]+\.)+[a-z]{2,})([\s\S]*)$/i,t=/^([\s\S]*?)(&quot;([^&]+)&quot;|"([^"]+)"|'([^']+)')(\s|<br>)+<([^@]+@[^&]+)>([\s\S]*)$/,u=/^([\s\S]*?)(&quot;([^&]+)&quot;|"([^"]+)"|'([^']+)')(\s|<br>)+<([^@]+@[^&]+)>([\s\S]*)$/,v={deeplink:{test:function(a){return-1===a.nodeValue.indexOf("http")?!1:m(a.nodeValue)},process:o},"mail-address-complex":{test:function(a){return-1===a.nodeValue.indexOf("@")?!1:t.test(a.nodeValue)&&0===$(a).closest("a").length},process:k},"mail-address":{test:function(a){return-1===a.nodeValue.indexOf("@")?!1:r.test(a.nodeValue)&&0===$(a).closest("a").length},process:j},url:{test:function(a){return-1===a.nodeValue.indexOf("http")?!1:p.test(a.nodeValue)&&0===$(a).closest("a").length},process:i},"long-character-sequences":{test:function(a){var b=a.nodeValue;return b.length>=30&&/\S{30}/.test(b)},process:function(a){return{node:a,replacement:$.parseHTML(b.breakableHTML(a.nodeValue))}}}};return d.point("io.ox/mail/detail/content").extend({id:"links",index:100,process:function(a){a.isLarge||($(this).contents().each(function(){l(this)}),$(this).find("*:not(style)").contents().each(function(){l(this)}))}}),{handlers:v,isDeepLink:m,parseDeepLink:n,processDeepLink:o,processTextNode:l}}),define("io.ox/mail/main",["io.ox/mail/util","io.ox/mail/api","io.ox/core/commons","io.ox/mail/listview","io.ox/core/tk/list-control","io.ox/mail/threadview","io.ox/core/extensions","io.ox/core/extPatterns/actions","io.ox/core/api/account","io.ox/core/notifications","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/core/capabilities","io.ox/core/folder/tree","io.ox/core/folder/view","gettext!io.ox/mail","settings!io.ox/mail","io.ox/mail/actions","io.ox/mail/mobile-navbar-extensions","io.ox/mail/mobile-toolbar-actions","io.ox/mail/toolbar","io.ox/mail/import","less!io.ox/mail/style","io.ox/mail/folderview-extensions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"use strict";var r=ox.ui.createApp({name:"io.ox/mail",title:"Mail"});return r.mediator({"pages-mobile":function(a){if(!_.device("!smartphone")){var b=a.getWindow().nodes.main,c=$('<div class="mobile-navbar">'),d=$('<div class="mobile-toolbar">');a.navbar=c,a.toolbar=d,a.pages=new l(a),a.getWindow().nodes.body.addClass("classic-toolbar-visible").append(c,d),a.pages.addPage({name:"folderTree",container:b,navbar:new k.NavbarView({app:a,extension:"io.ox/mail/mobile/navbar"})}),a.pages.addPage({name:"listView",container:b,startPage:!0,navbar:new k.NavbarView({app:a,extension:"io.ox/mail/mobile/navbar"}),toolbar:new k.ToolbarView({app:a,page:"listView",extension:"io.ox/mail/mobile/toolbar"}),secondaryToolbar:new k.ToolbarView({app:a,page:"listView/multiselect",extension:"io.ox/mail/mobile/toolbar"})}),a.pages.addPage({name:"threadView",container:b,navbar:new k.NavbarView({app:a,extension:"io.ox/mail/mobile/navbar"}),toolbar:new k.ToolbarView({app:a,page:"threadView",extension:"io.ox/mail/mobile/toolbar"})}),a.pages.addPage({name:"detailView",container:b,navbar:new k.NavbarView({app:a,extension:"io.ox/mail/mobile/navbar"}),toolbar:new k.ToolbarView({app:a,page:"detailView",extension:"io.ox/mail/mobile/toolbar"})}),a.pages.setBackbuttonRules({listView:"folderTree",threadView:"listView"})}},"navbars-mobile":function(a){_.device("smartphone")&&(a.pages.getNavbar("listView").setLeft(p("Folders")).setRight(p("Edit")),a.pages.getNavbar("folderTree").setTitle(p("Folders")).setLeft(!1).setRight(p("Edit")),a.pages.getNavbar("detailView").setTitle("").setLeft(p("Back")),a.pages.getNavbar("threadView").setTitle(p("Thread")).setLeft(p("Back")),a.pages.showPage("listView"))},"toolbars-mobile":function(){_.device("smartphone")&&(r.pages.getNavbar("listView").on("leftAction",function(){r.pages.goBack()}),r.pages.getNavbar("threadView").on("leftAction",function(){r.pages.goBack()}),r.pages.getNavbar("detailView").on("leftAction",function(){r.pages.goBack()}),r.pages.getNavbar("listView").on("rightAction",function(){r.props.set("checkboxes",!r.props.get("checkboxes"))}))},"pages-desktop":function(a){_.device("smartphone")||(a.pages=new l(a),a.getWindow().nodes.main.addClass("vsplit"),a.pages.addPage({name:"listView",container:a.getWindow().nodes.main,classes:"leftside"}),a.pages.addPage({name:"detailView",container:a.getWindow().nodes.main,classes:"rightside"}))},"folder-view":function(a){if(!_.device("smartphone")){var b=new n({app:a,module:"mail",contextmenu:!0});o.initialize({app:a,tree:b}),a.folderView.resize.enable()}},"folder-view-toggle":function(a){_.device("smartphone")||a.getWindow().nodes.main.on("dblclick",".list-view-control .toolbar",function(){a.folderView.toggle()})},props:function(a){a.props=new Backbone.Model({layout:_.device("smartphone")?"vertical":a.settings.get("layout","vertical"),checkboxes:_.device("smartphone")?!1:a.settings.get("showCheckboxes",!0),contactPictures:_.device("smartphone")?!1:a.settings.get("showContactPictures",!1),exactDates:a.settings.get("showExactDates",!1),mobileFolderSelectMode:!1})},"toggle-folder-editmode":function(a){if(!_.device("!smartphone")){var b=function(){var b=a.pages.getPage("folderTree"),c=a.props.get("mobileFolderSelectMode"),d=p(c?"Edit":"Cancel");a.props.set("mobileFolderSelectMode",!c),a.pages.getNavbar("folderTree").setRight(d),b.toggleClass("mobile-edit-mode",!c)};a.toggleFolders=b}},"folder-view-mobile":function(a){if(_.device("!smartphone"))return a;var b=a.pages.getNavbar("folderTree"),c=a.pages.getPage("folderTree");b.on("rightAction",function(){a.toggleFolders()});var d=new n({app:a,module:"mail",root:"1",contextmenu:!0});o.initialize({app:a,tree:d}),c.append(d.render().$el)},vsplit:function(a){var b=a.pages.getPage("listView"),c=a.pages.getPage("detailView");a.left=b.addClass("border-right"),a.right=c.addClass("mail-detail-pane").attr({role:"complementary","aria-label":p("Mail Details")})},"list-view":function(a){a.listView=new d({app:a,draggable:!0,ignoreFocus:!0,preserve:!0}),a.listView.model.set({folder:a.folder.get()}),a.listView.model.set("thread",!0),window.list=a.listView},"list-view-checkboxes":function(a){_.device("smartphone")||a.listView.toggleCheckboxes(a.props.get("checkboxes"))},"list-view-checkboxes-mobile":function(a){_.device("smartphone")&&(a.props.set("checkboxes",!1),a.listView.toggleCheckboxes(!1))},"auto-scroll":function(b){b.listView.on("add",function(c,d){if(0===d&&a.isUnseen(c.toJSON())){var e=b.listView.$el.height()/2;b.listView.$el.scrollTop()>e||b.listView.$el.scrollTop(0)}})},"get-view-options":function(a){a.getViewOptions=function(b){var c=a.settings.get(["viewOptions",b]);return _.extend({sort:610,order:"desc",thread:!1},c)}},"prop-folderview":function(a){a.props.set("folderview",_.device("smartphone")?!1:a.settings.get("folderview/visible/"+_.display(),!0))},"change:sort":function(a){a.props.on("change:sort",function(b,c){var b=a.listView.model;"from-to"===c&&(c=i.is("sent|drafts",b.get("folder"))?604:603),b.set("order",/^(610|608)$/.test(c)?"desc":"asc",{silent:!0}),a.props.set("order",b.get("order")),610!==c&&a.props.set("thread",!1),b.set("sort",c)})},"change:order":function(a){a.props.on("change:order",function(b,c){a.listView.model.set("order",c)})},"change:thread":function(a){a.props.on("change:thread",function(b,c){a.listView.collection&&(a.listView.collection.expired=!0),c===!0?(a.props.set("sort",610),a.listView.model.set("thread",!0)):a.listView.model.set("thread",!1)})},"store-view-options":function(a){a.props.on("change",_.debounce(function(){var b=a.folder.get(),c=a.props.toJSON();a.settings.set(["viewOptions",b],{sort:c.sort,order:c.order,thread:c.thread}).set("layout",c.layout).set("showContactPictures",c.contactPictures).set("showExactDates",c.exactDates),_.device("!smartphone")&&a.settings.set("showCheckboxes",c.checkboxes),a.settings.save()},500))},"restore-view-options":function(a){var b=a.getViewOptions(a.folder.get());a.props.set(b)},"list-view-control":function(a){a.listControl=new e({id:"io.ox/mail",listView:a.listView,app:a}),a.left.append(a.listControl.render().$el.attr("aria-label",p("Item list")).find(".toolbar").attr("aria-label",p("Item list options")).end()),a.listControl.resizable()},"thread-view":function(a){_.device("smartphone")||(a.threadView=new f.Desktop,a.right.append(a.threadView.render().$el))},"thread-view-mobile":function(a){_.device("smartphone")&&(a.threadView=new f.Mobile,a.threadView.$el.on("showmail",function(b){var c=$(b.target).data().cid;a.showMail(c),a.pages.changePage("detailView")}),a.pages.getPage("threadView").append(a.threadView.render().$el))},"selection-message":function(a){a.right.append($('<div class="io-ox-center multi-selection-message"><div></div></div>'))},navigation:function(a){a.threadView.on({back:function(){a.right.removeClass("preview-visible"),a.listView.focus()},previous:function(){a.listView.previous()},next:function(){a.listView.next()}})},position:function(a){function b(){var b=a.listView;a.threadView.updatePosition(b.getPosition()+1).togglePrevious(b.hasPrevious()).toggleNext(b.hasNext())}a.listView.on("selection:change",b),b()},"folder:change":function(a){a.folderView.tree.on("selection:action",function(){"list"===a.props.get("layout")&&a.threadView.trigger("back")}),a.on("folder:change",function(b){if(!a.props.get("mobileFolderSelectMode")){var c=a.getViewOptions(b),d=$(a.left[0]).find('.dropdown.grid-options .dropdown-menu [data-value="from-to"] span'),e=i.is("sent|drafts",b);a.props.set(c),a.listView.model.set("folder",b),a.folder.getData(),d.text(e?p("To"):p("From"))}})},"folder:change-mobile":function(a){_.device("smartphone")&&a.on("folder:change",function(){a.props.get("mobileFolderSelectMode")||a.folder.getData().done(function(b){a.pages.getNavbar("listView").setTitle(b.title)})})},"show-mail":function(a){_.device("smartphone")||(a.showMail=function(b){a.threadView.show(b,a.props.get("thread"))})},"show-mail-mobile":function(a){_.device("smartphone")&&(a.showMail=function(b){a.pages.getPage("detailView").empty().append(a.threadView.renderMail(b))})},"mobile-show-thread-overview":function(a){a.showThreadOverview=function(b){a.threadView.show(b,a.props.get("thread"))}},"show-empty":function(a){a.showEmpty=function(){a.threadView.empty(),a.right.find(".multi-selection-message div").text(p("No message selected"))}},"show-multiple":function(a){_.device("smartphone")||(a.showMultiple=function(c){a.threadView.empty(),c=b.resolve(c,a.props.get("thread")),a.right.find(".multi-selection-message div").text(p("%1$d messages selected",c.length))})},"show-multiple-mobile":function(a){_.device("!smartphone")||(a.showMultiple=function(c){a.threadView.empty(),c?(c=b.resolve(c,a.props.get("thread")),a.pages.getCurrentPage().navbar.setTitle(p("%1$d selected",c.length)),a.pages.getCurrentPage().secondaryToolbar.render()):a.folder.getData().done(function(b){a.pages.getCurrentPage().navbar.setTitle(b.title)})})},"selection-mobile":function(a){_.device("smartphone")&&a.listView.on({"selection:empty":function(){a.props.get("checkboxes")&&a.showMultiple(!1)},"selection:one":function(b){a.props.get("checkboxes")&&a.showMultiple(b)},"selection:multiple":function(b){a.props.get("checkboxes")&&a.showMultiple(b)},"selection:action":function(b){if(1===a.listView.selection.get().length&&!a.props.get("checkboxes")){var c=b[0].substr(7),d=this.collection.get(c).get("threadSize")>1;d?(a.showThreadOverview(b[0]),a.pages.changePage("threadView")):(a.showMail(b[0]),a.pages.changePage("detailView"))}}})},selection:function(a){function b(b){return a.right.removeClass("selection-empty selection-one selection-multiple preview-visible".replace(b,"")).addClass(b)}if(!_.device("smartphone")){var c=_.debounce(function(c,d){if("list"===a.props.get("layout")&&"action"===c)return b("selection-one preview-visible"),void a.showMail(d[0]);if("list"===a.props.get("layout")&&"one"===c)return void b("selection-one");switch(c){case"empty":b("selection-empty"),a.showEmpty();break;case"one":case"action":b("selection-one"),a.showMail(d[0]);break;case"multiple":b("selection-multiple"),a.showMultiple(d)}},100);a.listView.on({"selection:empty":function(){c("empty")},"selection:one":function(b){var d="one";"alternative"===a.listView.selection.getBehavior()&&(d="multiple"),c(d,b)},"selection:multiple":function(a){c("multiple",a)},"selection:action":function(b){1===a.listView.selection.get().length&&c("action",b)}})}},"change:layout":function(a){a.props.on("change:layout",function(b,c){a.threadView.toggleNavigation("list"===c)}),a.threadView.toggleNavigation("list"===a.props.get("layout"))},"apply-layout":function(a){_.device("smartphone")||(a.applyLayout=function(){var b,c,d=a.props.get("layout"),e=a.getWindow().nodes;"vertical"===d||"compact"===d?e.main.addClass("preview-right").removeClass("preview-bottom preview-none"):"horizontal"===d?e.main.addClass("preview-bottom").removeClass("preview-right preview-none"):"list"===d&&e.main.addClass("preview-none").removeClass("preview-right preview-bottom"),a.left.css({width:"",height:""}),a.right.css({left:"",top:""}),b=e.body.find(".classic-toolbar-container"),c="classic-toolbar-visible","compact"===d?(e.body.removeClass(c),a.right.addClass(c).prepend(b)):(a.right.removeClass(c),e.body.addClass(c).prepend(b)),"list"===d||"list"!==a.props.previousAttributes().layout||a.right.hasClass("preview-visible")||a.listView.selection.triggerChange()},a.props.on("change:layout",function(){a.applyLayout(),a.listView.redraw()}),a.getWindow().on("show:initial",function(){a.applyLayout()}))},refresh:function(a){b.on("refresh.all",function(){a.listView.reload()})},"auto-select":function(b){_.device("smartphone")||b.listView.on("first-reset",function(){_.defer(function(){b.listView.collection.find(function(c,d){return a.isUnseen(c.get("flags"))?void 0:(b.listView.selection.select(d),!0)})})})},"init-navbarlabel-mobile":function(a){_.device("smartphone")&&a.listView.on("first-reset",function(){a.folder.getData().done(function(b){a.pages.getNavbar("listView").setTitle(b.title)})})},prefetch:function(c){var d=q.get("prefetch/count",5);!_.isNumber(d)||0>=d||(c.prefetch=function(c){var e=require("io.ox/core/http");e.pause(),c.chain().filter(function(b){return!a.isDeleted(b)}).slice(0,d).each(function(c){var d,e,f=c.get("thread")||[c.toJSON()];for(d=f.length-1;e=f[d];d--)if(_.isString(e)&&(e=_.cid(e)),(0===d||a.isUnseen(e))&&!a.isDeleted(e)){b.get({unseen:!0,id:e.id,folder:e.folder_id});break}}),e.resume()},c.listView.on("first-reset",c.prefetch))},"connect-loader":function(a){a.listView.connect(b.collectionLoader)},"before-delete":function(a){function c(a,b){if(1!==a.length)return!1;if(1!==b.length)return!1;var c=_.cid(a[0]),d=String(b[0]).replace(/^thread\./,"");return c!==d}_.device("smartphone")||b.on("beforedelete",function(b,d){c(d,a.listView.selection.get())||a.listView.selection.dodge()})},"before-delete-mobile":function(a){_.device("smartphone")&&b.on("beforedelete",function(){"detailView"===a.pages.getCurrentPage().name&&a.pages.goBack(),a.listView.selection.selectNone()})},"drag-drop":function(){r.getWindow().nodes.outer.on("selection:drop",function(a,c){c.isThread=1===c.data.length&&/^thread\./.test(c.data[0]),c.data=b.resolve(c.data,r.props.get("thread")),h.invoke("io.ox/mail/actions/move",null,c)})},"selection-delete":function(){r.listView.on("selection:delete",function(a){var c=g.Baton({data:a});c.isThread=1===c.data.length&&/^thread\./.test(c.data[0]),c.data=b.resolve(c.data,r.props.get("thread")),h.invoke("io.ox/mail/actions/delete",null,c)})},"selection-doubleclick":function(a){_.device("smartphone")||a.listView.on("selection:doubleclick",function(a){ox.launch("io.ox/mail/detail/main",{cid:a[0]})})},"change:folderview":function(a){_.device("smartphone")||(a.props.on("change:folderview",function(b,c){a.folderView.toggle(c)}),a.on("folderview:close",function(){a.props.set("folderview",!1)}),a.on("folderview:open",function(){a.props.set("folderview",!0)}))},"change:checkboxes":function(a){_.device("smartphone")||("alternative"===a.listView.selection.getBehavior()?a.listView.toggleCheckboxes(!0):a.props.on("change:checkboxes",function(b,c){a.listView.toggleCheckboxes(c)}))},"change:checkboxes-mobile":function(a){_.device("!smartphone")||(a.listControl.$el.toggleClass("toolbar-top-visible",!1),a.props.on("change:checkboxes",function(b,c){a.listView.toggleCheckboxes(c),a.listControl.$el.toggleClass("toolbar-top-visible",c),c?a.pages.getNavbar("listView").setRight(p("Cancel")).hide(".left"):(a.pages.getNavbar("listView").setRight(p("Edit")).show(".left"),a.folder.getData().done(function(b){a.pages.getCurrentPage().navbar.setTitle(b.title)}),a.listView.selection.selectNone())}))},"change:contactPictures":function(a){a.props.on("change:contactPictures",function(){a.listView.redraw()})},"change:exactDates":function(a){a.props.on("change:exactDates",function(){a.listView.redraw()})},"fix-mobile-lazyload":function(a){_.device("!smartphone")||a.pages.getPage("detailView").on("pageshow",function(){$(this).find("li.lazy").trigger("scroll")})},"inplace-search":function(a){if(!_.device("smartphone")&&m.has("search")){var c=a.getWindow(),d=c.nodes.sidepanel;d.addClass("top-toolbar"),c.facetedsearch.ready.done(function(d){require(["io.ox/core/api/collection-loader"],function(e){var f=new e({module:"mail",mode:"search",fetch:function(b){var c=b.limit.split(","),e=parseInt(c[0]),f=parseInt(c[1])-e;d.model.set({start:e,size:f,extra:1},{silent:!0});var g=this,b={sort:a.props.get("sort"),order:a.props.get("order")};return d.apiproxy.query(!0,b).then(function(a){a=a||{};var b=a.results||[],c=a.request||{};return g.collection.search={next:0!==b.length&&b.length===c.data.size},b})},cid:function(){return"search/"+d.model.getCompositeId()+"&sort="+a.props.get("sort")+"&order="+a.props.get("order")},each:function(a){b.processThreadMessage(a)}}),g=function(){var b=c.facetedsearch.view,d=a.listView.setCollection;a.listView.connect(f),a.listView.setCollection=function(a){return b.stopListening(),b.listenTo(a,"add reset remove",b.trigger.bind(b,"query:resultready",a)),d.apply(this,arguments)}};c.facetedsearch.ready.done(function(){var b=c.facetedsearch.view;b.on({query:_.debounce(function(b,d){d===a.get("name")&&("search"!==a.listView.loader.mode&&g(),c.facetedsearch.view.model.set({start:0,size:30,extra:1},{silent:!0}),a.listView.load(),c.facetedsearch.focus())},10),focus:function(){}})}),c.on("search:cancel",function(){a.listView.connect(b.collectionLoader),a.listView.load()})})})}}}),r.setLauncher(function(){var a=ox.ui.createWindow({name:"io.ox/mail",title:"Inbox",chromeless:!0,facetedsearch:m.has("search")});_.url.hash().mailto&&ox.registry.call("mail-compose","compose"),r.setWindow(a),r.settings=q,window.mailapp=r,c.addFolderSupport(r,null,"mail",r.options.folder).always(function(){r.mediate(),a.show()}).fail(function(a){var b=a&&a.error?a.error+" ":"";b+=p("Application may not work as expected until this problem is solved."),j.yell("error",b)})}),{getApp:r.getInstance}}),define(ox.base+"/precore.js",{});